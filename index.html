<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart HSR | لوحة القيادة التنفيذية</title>
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--color-navy:#0A1931;--color-teal:#18A5A2;--color-light-teal:#ACE2E1;--color-gray-bg:#F7F9FC;--color-shadow-base:rgba(10,25,49,.4)}
    body{font-family:'Tajawal',sans-serif;background:var(--color-gray-bg);color:var(--color-navy)}
    .ai-button-primary{background:var(--color-teal);color:#fff;transition:.3s;box-shadow:0 6px 15px rgba(24,165,162,.5)}
    .ai-button-primary:hover{transform:translateY(-2px)}
    .ai-button-secondary{background:var(--color-navy);color:#fff;transition:.3s}
    .kpi-card-professional{border-radius:1.5rem;overflow:hidden;transition:.3s}
    .kpi-card-professional:hover{transform:translateY(-8px) scale(1.02)}
    .kpi-open-gradient{background:linear-gradient(135deg,#EF4444 0%,#B91C1C 100%);color:#fff}
    .kpi-closed-gradient{background:linear-gradient(135deg,#10B981 0%,#18A5A2 100%);color:#fff}
    .kpi-images-gradient{background:linear-gradient(135deg,#3B82F6 0%,#0A1931 100%);color:#fff}
    .loading-spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid var(--color-light-teal);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal{display:none;position:fixed;z-index:100;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
    .modal-content{background:#fff;padding:30px;border-radius:1.5rem;width:90%;max-width:800px}
    .image-container{position:relative;overflow:hidden;border-radius:.75rem;box-shadow:0 4px 10px var(--color-shadow-base)}
    .comparison-wrapper{position:relative;border-radius:.75rem;overflow:hidden}
    .comparison-wrapper .after-image{position:absolute;inset:0;width:50%;overflow:hidden}
    .comparison-wrapper .comparison-divider{position:absolute;inset:0 auto 0 50%;width:4px;background:var(--color-teal);transform:translateX(-50%);cursor:grab;z-index:10}
    .communication-draft{white-space:pre-wrap;text-align:right;direction:rtl;border-right:4px solid var(--color-teal);padding-right:1rem;background:#f8fafc}
    @media print{.no-print,#observationsList,#hero,#operational-dashboard,#ai-features,footer,.modal{display:none !important}}
  </style>
</head>
<body class="text-gray-800">
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex justify-start mb-6 no-print">
      <button id="logout-btn" class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="smartLogout()">
        <i data-lucide="log-out" class="w-4 h-4 ml-2"></i> تسجيل الخروج
      </button>
    </div>

    <section id="hero" class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 no-print">
      <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900">Smart HSR <span style="color:var(--color-teal)">Dashboard</span></h1>
      <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">نظام المراقبة وإدارة الجودة الرقمي</h2>
      <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">منصة تنفيذية ذكية لإدارة الجودة والمراقبة الرقمية.</p>
    </section>

    <section id="observations-log" class="my-20">
      <div class="text-center mb-12 no-print">
        <h3 class="text-4xl md:text-5xl font-extrabولد text-gray-900 mb-3">سجل الملاحظات التفاعلي</h3>
        <button id="add-observation-btn" class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto" onclick="openModal('smartInputModal')">
          <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> إضافة ملاحظة جديدة (الإدخال الذكي)
        </button>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">
        <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
          <h4 class="text-2xl font-bold mb-4" style="color:var(--color-teal)">تصفية الملاحظات</h4>
          <select id="observationFilter" class="w-full p-3 border border-gray-300 rounded-xl" onchange="handleFilterChange()">
            <option value="الكل">عرض كل الملاحظات</option>
            <option value="جديد">جديد</option>
            <option value="قيد التنفيذ">قيد التنفيذ</option>
            <option value="تمت المعالجة">تمت المعالجة</option>
            <option value="جودة">جودة</option>
            <option value="صيانة">صيانة</option>
            <option value="سلامة">سلامة</option>
            <option value="بيئة">بيئة</option>
          </select>
          <h4 class="text-2xl font-bold mt-8 mb-3">الملاحظات</h4>
          <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            <div class="text-center text-gray-500 mt-10">... جاري تحميل البيانات ...</div>
          </div>
        </div>

        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">
          <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
            <h2 class="text-3xl font-extrabold text-gray-900">تقرير Smart HSR التنفيذي</h2>
            <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
          </div>

          <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2" style="color:var(--color-teal)">عرض التفاصيل والتحليل (AI)</h4>

          <div id="observationDetail" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">العنوان:</span><span id="detailTitle" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">التصنيف:</span><span id="detailType" class="block font-bold text-teal-600"></span></div>
              <div class="p-2"><span class="block text-gray-500">الموقع:</span><span id="detailLocation" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">التاريخ:</span><span id="detailDate" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">الحالة:</span><span id="detailStatus" class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span></div>
              <div class="p-2"><span class="block text-gray-500">المعرف:</span><span id="detailID" class="block font-bold text-gray-800"></span></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
              <h5 class="text-xl font-bold mb-3">وصف الملاحظة</h5>
              <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
              <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                <h6 class="font-bold text-teal-700">خطة العمل المقترحة (AI)</h6>
                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
              </div>
            </div>

            <div id="resolutionNoteContainer" class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
              <h5 class="text-xl font-bold mb-3 text-green-700">📝 المذكرة الختامية للإغلاق</h5>
              <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
              <img id="beforeImage" class="before-image w-full h-auto" alt="قبل">
              <div id="afterImageContainer" class="after-image">
                <img id="afterImage" class="w-full h-auto" alt="بعد">
              </div>
              <div id="comparisonDivider" class="comparison-divider no-print"></div>
            </div>

            <div id="mediaContainer" class="image-container mb-6 hidden">
              <div id="mediaContent" class="w-full h-auto rounded-xl"></div>
              <span class="image-label">مرفق الملاحظة</span>
            </div>

            <div id="noImageMessage" class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
              لا تتوفر صورة أو فيديو لهذه الملاحظة.
            </div>

            <div id="aiAnalysisSection" class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
              <h5 class="text-xl font-bold mb-4">أدوات التحليل الذكي</h5>
              <div class="flex flex-wrap gap-3 no-print">
                <button id="vision-btn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold" onclick="analyzeImage('vision')">تحليل الصور (Vision)</button>
                <button id="pdf-report-btn" class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold" onclick="generatePdfReport()">توليد تقرير PDF</button>
              </div>
              <div id="aiResultContainer" class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color:var(--color-teal)"></h6>
                <div id="aiResultContent" class="text-gray-700"></div>
              </div>
            </div>

            <div id="actionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
              <button id="updateStatusBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full" onclick="alert('قيد التنفيذ (تجريبي)')">تحديث إلى "قيد التنفيذ"</button>
              <button id="completeObservationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full" onclick="openModal('closeoutModal')">الإغلاق التنفيذي (صورة بعد)</button>
              <button id="alreadyCompletedBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full hidden" disabled>الملاحظة مغلقة</button>
            </div>
          </div>

          <div id="detailPlaceholder" class="text-center space-y-4">
            <p class="text-gray-500 mt-16 text-lg">اختر ملاحظة من القائمة لعرض التفاصيل.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="operational-dashboard" class="my-20 no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3">📊 مؤشرات الأداء</h3>
        <p class="mt-3 text-lg text-gray-600">تتبع البلاغات وحالة التوثيق بالصور.</p>
      </div>
      <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
    </section>

    <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
      <div class="text-xs text-gray-500">
        <p class="mb-2">&copy; 2025 Smart HSR. جميع الحقوق محفوظة.</p>
        <p id="userInfo">جارٍ التوصيل بـ Firebase…</p>
      </div>
    </footer>
  </main>

  <!-- Modals -->
  <div id="smartInputModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b">وحدة الإدخال الذكي للملاحظات</h2>
      <div id="modalStep1">
        <p class="text-lg text-gray-600 mb-4">أدخل تفاصيل الملاحظة وارفع صورة/فيديو</p>
        <textarea id="rawObservationInput" rows="5" class="w-full p-4 border border-gray-300 rounded-xl" placeholder="وصف الملاحظة..." oninput="checkSmartInputState()"></textarea>
        <div class="mt-4">
          <p id="locationStatus" class="text-sm font-semibold text-gray-500">الموقع الجغرافي: لم يتم التحديد</p>
          <input type="hidden" id="inputLatitude"><input type="hidden" id="inputLongitude">
          <button id="getLocationBtn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="getLocation()" type="button">تحديد الموقع الحالي</button>
        </div>
        <div class="mt-4">
          <p id="fileStatus" class="text-sm font-semibold text-gray-500">لم يتم اختيار ملف بعد</p>
          <input type="file" id="fileUploadInput" accept="image/*,video/*" class="hidden" onchange="handleFileUpload(event)">
          <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="document.getElementById('fileUploadInput').click()" type="button">اختيار ملف</button>
        </div>
        <div class="mt-6 text-center">
          <button id="processSmartInputBtn" class="ai-button-primary rounded-full px-8 py-3 text-lg font-bold" onclick="processSmartInput()" disabled>حفظ وتوليد تقرير</button>
        </div>
      </div>
      <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-2xl font-bold mb-4">تمت الإضافة</h3>
        <div id="modalResultContent"></div>
        <div class="mt-6 text-center">
          <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold" onclick="closeModal('smartInputModal')">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div id="closeoutModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">🔒 الإغلاق التنفيذي للملاحظة #<span id="closeoutId"></span></h2>
      <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
        <h3 class="text-xl font-bold mb-3">1) صورة بعد الإصلاح (إلزامية)</h3>
        <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">لم يتم اختيار ملف بعد <span class="text-red-500 font-bold">(إلزامي)</span></p>
        <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden" onchange="handleAfterFileUpload(event)">
        <button class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="document.getElementById('afterFileUploadInput').click()" type="button">اختيار صورة الإغلاق</button>
        <h3 class="text-xl font-bold mt-6 mb-3">2) المذكرة الختامية</h3>
        <textarea id="resolutionNoteInput" rows="4" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="الإجراءات التي تم اتخاذها..."></textarea>
      </div>
      <div class="mt-6 text-center">
        <button id="finalCloseoutBtn" class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold" onclick="completeObservation()" disabled>تأكيد الإغلاق</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Frontend State (no Firebase data here; we'll bind it later) ======
    window.observationsData = [];
    window.currentSelectedObservation = null;
    const statusMap = {"PENDING":{color:'bg-red-600',text:'قيد الانتظار'},"IN_PROGRESS":{color:'bg-yellow-600',text:'قيد التنفيذ'},"COMPLETED":{color:'bg-green-600',text:'تمت المعالجة'}};
    let currentFile=null,currentFileUrl=null,currentAfterFile=null,currentAfterFileUrl=null;

    function calculateKPIs(){
      const total=observationsData.length;
      const open=observationsData.filter(o=>o.status!=='COMPLETED').length;
      const closed=total-open;
      const withImg=observationsData.filter(o=>o.hasImage).length;
      return {totalReports:total, openReports:open, closedReports:closed, reportsWithImages:withImg};
    }
    function renderKPIs(){
      const k=document.getElementById('kpiContainer'); k.innerHTML='';
      const x=calculateKPIs();
      const items=[
        {title:'إجمالي الملاحظات', value:x.totalReports, icon:'clipboard-list', gradientClass:'kpi-closed-gradient'},
        {title:'ملاحظات مفتوحة/انتظار', value:x.openReports, icon:'alert-triangle', gradientClass:'kpi-open-gradient'},
        {title:'ملاحظات مغلقة/معالجة', value:x.closedReports, icon:'check-circle', gradientClass:'kpi-closed-gradient'},
        {title:'ملاحظات موثقة بالصور', value:x.reportsWithImages, icon:'image', gradientClass:'kpi-images-gradient'}
      ];
      items.forEach(kpi=>{k.innerHTML+=`
        <div class="kpi-card-professional p-6 ${kpi.gradientClass} flex items-center justify-between shadow-2xl">
          <div><p class="text-sm md:text-md font-medium">${kpi.title}</p><p class="text-4xl md:text-5xl font-extrabold mt-1">${kpi.value}</p></div>
          <i data-lucide="${kpi.icon}" class="w-10 h-10 opacity-70"></i>
        </div>`});
      try{lucide.createIcons()}catch{}
      const u=document.getElementById('userInfo'); if(u) u.textContent='بيانات مباشرة من Firestore ✅';
    }
    function renderObservationsList(observations){
      const list=document.getElementById('observationsList'); list.innerHTML='';
      if(!observations.length){ list.innerHTML='<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-xl">لا توجد بيانات.</div>'; return; }
      observations.forEach(obs=>{
        const statusInfo=statusMap[obs.status]||{color:'bg-gray-500',text:obs.status};
        const isSelected=obs.id===(currentSelectedObservation?currentSelectedObservation.id:null)?'active':'';
        list.innerHTML+=`
          <div class="observation-item p-3 rounded-lg flex justify-between items-center ${isSelected}" onclick="showObservationDetail('${obs.id}')">
            <div>
              <p class="text-md font-bold text-gray-800 truncate max-w-[220px]">${obs.title||'—'}</p>
              <p class="text-xs text-gray-500 mt-1">${obs.date||''} | ${obs.type||''}</p>
            </div>
            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.color} text-white">${statusInfo.text}</span>
          </div>`;
      });
    }
    function showObservationDetail(id){
      currentSelectedObservation=observationsData.find(o=>o.id===id);
      if(!currentSelectedObservation) return;
      document.querySelectorAll('.observation-item').forEach(el=>el.classList.remove('active'));
      const card=[...document.querySelectorAll('.observation-item')].find(c=>c.getAttribute('onclick')===`showObservationDetail('${id}')`);
      if(card) card.classList.add('active');

      const s=statusMap[currentSelectedObservation.status]||{color:'bg-gray-500',text:currentSelectedObservation.status};
      document.getElementById('detailTitle').textContent=currentSelectedObservation.title||'';
      document.getElementById('printTitle').textContent=`الملاحظة: ${currentSelectedObservation.title||''}`;
      document.getElementById('detailType').textContent=currentSelectedObservation.type||'';
      document.getElementById('detailDate').textContent=currentSelectedObservation.date||'';
      document.getElementById('detailID').textContent=currentSelectedObservation.id||'';
      document.getElementById('detailLocation').textContent=currentSelectedObservation.location||'';
      const ds=document.getElementById('detailStatus'); ds.textContent=s.text; ds.className=`inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${s.color}`;
      document.getElementById('detailDescription').innerHTML=(currentSelectedObservation.details||'').replace(/\\n/g,'<br>');
      document.getElementById('actionPlan').textContent=currentSelectedObservation.actionPlan||'';
      document.getElementById('actionPlanContainer').classList.toggle('hidden', !currentSelectedObservation.actionPlan);

      document.getElementById('mediaContainer').classList.add('hidden');
      document.getElementById('imageComparisonWrapper').classList.add('hidden');
      document.getElementById('noImageMessage').classList.add('hidden');
      document.getElementById('resolutionNoteContainer').classList.add('hidden');

      const mediaContent=document.getElementById('mediaContent'); mediaContent.innerHTML='';

      if(currentSelectedObservation.status==='COMPLETED' && currentSelectedObservation.afterImagePath){
        document.getElementById('imageComparisonWrapper').classList.remove('hidden');
        document.getElementById('beforeImage').src=currentSelectedObservation.imagePath||'';
        document.getElementById('afterImage').src=currentSelectedObservation.afterImagePath||'';
      } else if(currentSelectedObservation.hasImage){
        document.getElementById('mediaContainer').classList.remove('hidden');
        if(currentSelectedObservation.isVideo){
          const mime=currentSelectedObservation.fileMimeType||'video/mp4';
          mediaContent.innerHTML=`<video controls class="w-full h-auto rounded-xl shadow-lg border-4 border-gray-300"><source src="${currentSelectedObservation.imagePath}" type="${mime}"></video>`;
        } else {
          mediaContent.innerHTML=`<img class="w-full h-auto rounded-xl shadow-lg" alt="صورة الملاحظة" src="${currentSelectedObservation.imagePath}">`;
        }
      } else {
        document.getElementById('noImageMessage').classList.remove('hidden');
      }

      const isCompleted=currentSelectedObservation.status==='COMPLETED';
      document.getElementById('updateStatusBtn').classList.toggle('hidden', isCompleted);
      document.getElementById('completeObservationBtn').classList.toggle('hidden', isCompleted);
      document.getElementById('alreadyCompletedBtn').classList.toggle('hidden', !isCompleted);

      document.getElementById('detailPlaceholder').classList.add('hidden');
      document.getElementById('observationDetail').classList.remove('hidden');
      document.getElementById('aiResultContainer').classList.add('hidden');
    }
    function handleFilterChange(){
      const v=document.getElementById('observationFilter').value;
      let filtered=[...observationsData];
      if(v!=='الكل'){
        const map={"جديد":"PENDING","قيد التنفيذ":"IN_PROGRESS","تمت المعالجة":"COMPLETED","جودة":"QUALITY","صيانة":"MAINTENANCE","سلامة":"SAFETY","بيئة":"ENVIRONMENT"};
        const key=map[v]||v;
        filtered=observationsData.filter(o=>o.type===key || o.status===key);
      }
      renderObservationsList(filtered);
      if(filtered.length) showObservationDetail(filtered[0].id);
    }
    function getLocation(){
      const s=document.getElementById('locationStatus'); const btn=document.getElementById('getLocationBtn'); s.innerHTML='<span class="text-yellow-600">جاري التحديد…</span>'; btn.disabled=true;
      navigator.geolocation?.getCurrentPosition((pos)=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        document.getElementById('inputLatitude').value=lat; document.getElementById('inputLongitude').value=lon;
        s.innerHTML=`<span class="text-green-600">تم التحديد:</span> ${lat.toFixed(4)}, ${lon.toFixed(4)}`; btn.disabled=false; checkSmartInputState();
      },()=>{s.textContent='تعذر تحديد الموقع'; btn.disabled=false;});
    }
    function checkSmartInputState(){
      const raw=document.getElementById('rawObservationInput').value.trim(); const lat=document.getElementById('inputLatitude').value;
      document.getElementById('processSmartInputBtn').disabled = !(raw.length || currentFile || lat);
    }
    function handleFileUpload(e){
      const file=e.target.files[0];
      if(file){ currentFile=file; const r=new FileReader(); r.onload=(ev)=>{ currentFileUrl=ev.target.result; checkSmartInputState(); }; r.readAsDataURL(file);
        document.getElementById('fileStatus').textContent=`تم اختيار الملف: ${file.name}`;
      }else{ currentFile=null; currentFileUrl=null; document.getElementById('fileStatus').textContent='لم يتم اختيار ملف'; checkSmartInputState();}
    }
    function processSmartInput(){ // will call Firebase patch below
      window._processSmartInput && window._processSmartInput();
    }
    function generatePdfReport(){ window.print(); }
    function openModal(id){ document.getElementById(id).style.display='flex'; if(id==='closeoutModal'){ document.getElementById('closeoutId').textContent=currentSelectedObservation?.id||''; clearAfterUpload(); } }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    function clearAfterUpload(){ currentAfterFile=null; currentAfterFileUrl=null; document.getElementById('afterFileUploadInput').value=''; document.getElementById('afterFileStatus').innerHTML='لم يتم اختيار ملف بعد <span class="text-red-500 font-bold">(إلزامي)</span>'; document.getElementById('resolutionNoteInput').value=''; document.getElementById('finalCloseoutBtn').disabled=true; }
    function handleAfterFileUpload(e){ const f=e.target.files[0]; if(f){ currentAfterFile=f; const r=new FileReader(); r.onload=(ev)=>{ currentAfterFileUrl=ev.target.result; document.getElementById('finalCloseoutBtn').disabled=false;}; r.readAsDataURL(f); document.getElementById('afterFileStatus').innerHTML=`<span class="text-green-600">تم اختيار الملف:</span> ${f.name}`;} else { clearAfterUpload(); } }
    function completeObservation(){ window._completeObservation && window._completeObservation(); }
    function smartLogout(){ try{ if(window.SmartHSR?.logout){ SmartHSR.logout().finally(()=>location.href='login.html'); } else { location.href='login.html'; } }catch{ location.href='login.html'; } }
    function initApp(){ renderKPIs(); lucide?.createIcons?.(); }
    window.onload=initApp;
  </script>

  <!-- ========= Firebase (Fixed to 12.4.0) ========= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp, query, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRrBnPYtdc86JffEQHERf732uAif7vwho",
      authDomain: "smart-hsr-6c2cf.firebaseapp.com",
      databaseURL: "https://smart-hsr-6c2cf-default-rtdb.firebaseio.com",
      projectId: "smart-hsr-6c2cf",
      storageBucket: "smart-hsr-6c2cf.appspot.com",
      messagingSenderId: "399213527987",
      appId: "1:399213527987:web:4531958edfe9dbb95a81c6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    onAuthStateChanged(auth, (user)=>{
      if(!user){
        try{
          const here=(location.pathname||'').toLowerCase();
          if(!here.endsWith('login.html')) location.href='login.html';
        }catch{}
      } else {
        const u=document.getElementById('userInfo'); if(u) u.textContent=`متصل كـ ${user.email} ✅`;
      }
    });

    window.SmartHSR = {
      auth, db, storage,
      emailSignup:(email,pass)=>createUserWithEmailAndPassword(auth,email,pass).then(c=>c.user),
      emailLogin:(email,pass)=>signInWithEmailAndPassword(auth,email,pass).then(c=>c.user),
      logout:()=>signOut(auth),
      onAuth:(fn)=>onAuthStateChanged(auth,fn),
      observeObservations(cb){
        const qy=query(collection(db,'observations'), orderBy('createdAt','desc'));
        return onSnapshot(qy, s=>cb(s.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      async addObservation({type,title,details,priority,lat,lng,file}={}){
        const isVideo=file ? (file.type||'').startsWith('video'):false;
        const mediaMime=file ? file.type:null;
        const refDoc=await addDoc(collection(db,'observations'),{
          type:type||'QUALITY',
          title:title||'—',
          details:details||'',
          status:'PENDING',
          location:(lat!=null&&lng!=null)?`${(+lat).toFixed(5)}, ${(+lng).toFixed(5)}`:'',
          actionPlan:null,
          riskAssessment:{priority:(priority||'Medium'), timeframe:(priority==='High'?'24h':'72h')},
          hasImage:!!file, isVideo, mediaUrl:null, mediaMime,
          afterImageUrl:null, resolutionNote:null,
          createdAt: serverTimestamp()
        });
        if(file){
          const p=`observations/${refDoc.id}/${isVideo?'before.mp4':'before.jpg'}`;
          const r=ref(storage,p);
          await uploadBytesResumable(r,file);
          const url=await getDownloadURL(r);
          await updateDoc(doc(db,'observations',refDoc.id),{ mediaUrl:url });
        }
        return refDoc.id;
      },
      updateStatus:(id,status)=>updateDoc(doc(db,'observations',id),{status}),
      async completeObservation(id, afterFile, note){
        if(afterFile){
          const p=`observations/${id}/after.jpg`;
          const r=ref(storage,p);
          await uploadBytes(r,afterFile);
          const url=await getDownloadURL(r);
          await updateDoc(doc(db,'observations',id),{
            status:'COMPLETED', afterImageUrl:url, resolutionNote:(note||`تم الإغلاق في ${new Date().toLocaleString('ar-SA')}`)
          });
        }else{
          await updateDoc(doc(db,'observations',id),{ status:'COMPLETED', resolutionNote:(note||`تم الإغلاق في ${new Date().toLocaleString('ar-SA')}`)});
        }
      },
      async deleteObservation(id){
        await updateDoc(doc(db,'observations',id),{}).catch(()=>{});
        await deleteObject(ref(storage,`observations/${id}/before.jpg`)).catch(()=>{});
        await deleteObject(ref(storage,`observations/${id}/after.jpg`)).catch(()=>{});
      },
      async getKpis(){
        const s=await getDocs(query(collection(db,'observations')));
        const arr=s.docs.map(d=>({id:d.id, ...d.data()}));
        const total=arr.length;
        const open=arr.filter(x=>x.status!=='COMPLETED').length;
        const closed=total-open;
        const withImg=arr.filter(x=>x.mediaUrl).length;
        return { total, open, closed, withImg };
      }
    };

    // Live binding
    SmartHSR.observeObservations((rows)=>{
      const mapped=rows.map(r=>{
        let ts=Date.now();
        try{ if(r.createdAt?.toMillis) ts=r.createdAt.toMillis(); else if(r.createdAt?.seconds) ts=r.createdAt.seconds*1000; }catch{}
        const dateStr=new Date(ts).toISOString().slice(0,10);
        return {
          id:r.id,type:r.type||'QUALITY',date:dateStr,title:r.title||'—',status:r.status||'PENDING',
          details:r.details||'',hasImage:!!r.mediaUrl,isComparative:!!r.afterImageUrl,location:r.location||'',
          isVideo:!!r.isVideo,imagePath:r.mediaUrl||'',fileMimeType:r.mediaMime||'',actionPlan:r.actionPlan||'',
          riskAssessment:r.riskAssessment||{priority:'Medium',timeframe:'72h'},resolutionNote:r.resolutionNote||null,
          afterImagePath:r.afterImageUrl||null,createdAt:ts,ai:r.ai||null
        };
      });
      window.observationsData = mapped;
      renderKPIs();
      handleFilterChange();
    });

    // Hook "Add" UI -> Firestore
    window._processSmartInput = async function(){
      const raw=document.getElementById('rawObservationInput').value.trim();
      const lat=document.getElementById('inputLatitude').value; const lon=document.getElementById('inputLongitude').value;
      const file=currentFile;
      const title= raw ? raw.slice(0,70) : (file?`ملاحظة (${file.name})`:'ملاحظة جديدة');
      const id=await SmartHSR.addObservation({type:'MAINTENANCE', title, details:raw, priority:'High', lat, lng:lon, file});
      document.getElementById('modalStep1').classList.add('hidden');
      document.getElementById('modalResult').classList.remove('hidden');
      document.getElementById('modalResultContent').innerHTML='<div class="p-4 bg-green-50 rounded-xl border border-green-200 text-center">تمت الإضافة ✅</div>';
      currentFile=null; currentFileUrl=null;
    };

    // Hook "Complete" UI -> Firestore
    window._completeObservation = async function(){
      if(!currentSelectedObservation){ alert('اختر ملاحظة'); return; }
      if(!currentAfterFile){ alert("أرفق صورة 'بعد'"); return; }
      const note=document.getElementById('resolutionNoteInput').value.trim();
      await SmartHSR.completeObservation(currentSelectedObservation.id, currentAfterFile, note);
      closeModal('closeoutModal'); clearAfterUpload();
      alert('تم الإغلاق ✅');
    };
  </script>

  <!-- ========= Gemini AI (optional; reads & writes to Firestore) ========= -->
  <script type="module">
    const GEMINI_API_KEY = "AIzaSyCstRnAY_9TO9f4l49TTHEjVaoqjtZriJk"; // بدّل بمفتاحك الصحيح إن لزم
    async function urlToBase64(url){
      const resp=await fetch(url); const blob=await resp.blob();
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onloadend=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(blob); });
    }
    function extractAI(text){
      const out={ summary:(text||'').trim() }; const lc=(text||'').toLowerCase();
      if(lc.includes('pothole')||lc.includes('asphalt')||lc.includes('حفر')) out.category='PAVEMENT';
      if(lc.includes('high')||lc.includes('عالي')) out.severity='HIGH'; else if(lc.includes('medium')||lc.includes('متوسط')) out.severity='MEDIUM'; else out.severity='LOW';
      out.confidence = lc.length>50 ? 0.8 : 0.6;
      const m=(text||'').match(/(?:ينبغي|يُنصح|التوصية|المعالجة|fix|repair|inspect|clean).{0,140}/i); if(m) out.action=m[0];
      return out;
    }
    async function analyzeObservationById(id){
      try{
        const { doc, getDoc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js");
        const db=SmartHSR.db; const dref=doc(db,'observations',id); const snap=await getDoc(dref);
        if(!snap.exists()) return false;
        const data=snap.data(); if(!data?.mediaUrl) return false;
        const base64=await urlToBase64(data.mediaUrl);
        const body={ contents:[{ parts:[ {text:`حلّل الصورة التالية لملاحظة طرق.`}, {inline_data:{mime_type:data.mediaMime||'image/jpeg', data:base64}} ] }] };
        const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const json=await res.json(); const text=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\\n')||'';
        const ai=extractAI(text);
        await updateDoc(dref,{ ai:{summary:ai.summary||null,category:ai.category||null,severity:ai.severity||null,action:ai.action||null,confidence:ai.confidence??null,analyzedAt: serverTimestamp()} });
        return true;
      }catch(e){ console.error(e); return false; }
    }
    (function enhanceAddObservation(){
      const orig=SmartHSR.addObservation;
      SmartHSR.addObservation = async function(opts){
        const id=await orig.call(SmartHSR,opts||{});
        try{ if(opts?.file){ await analyzeObservationById(id); } }catch{}
        return id;
      };
    })();

    window.analyzeImage = async function(tool){
      const obs=window.currentSelectedObservation;
      const titleEl=document.getElementById('aiResultTitle');
      const box=document.getElementById('aiResultContainer');
      const content=document.getElementById('aiResultContent');
      titleEl.textContent='نتيجة التحليل:'; box.classList.remove('hidden');
      if(!obs){ content.textContent='اختر ملاحظة.'; return; }
      if(obs.ai){
        const conf=(obs.ai.confidence!=null)? Math.round(obs.ai.confidence*100)+'%' : '-';
        content.innerHTML = `<div class="communication-draft"><b>ملخص:</b> ${obs.ai.summary||'-'}<br><b>تصنيف:</b> ${obs.ai.category||'-'}<br><b>الخطورة:</b> ${obs.ai.severity||'-'} • <b>الثقة:</b> ${conf}<br><b>توصية:</b> ${obs.ai.action||'-'}</div>`;
      } else if (obs.imagePath){
        content.innerHTML = `<div class="text-gray-600">جاري طلب التحليل للصورة الفعلية… أعد النقر بعد ثوانٍ.</div>`;
        try{ await analyzeObservationById(obs.id); }catch(e){ console.error(e); }
      } else {
        content.textContent='لا توجد صورة.';
      }
    };
  </script>
</body>
</html>
