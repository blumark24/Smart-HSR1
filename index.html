<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>

  <!-- META -->
  <meta name="description" content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
  <meta name="keywords" content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
  <meta name="author" content="Smart HSR">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
  <meta property="og:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar_SA">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
  <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ">

  <!-- ASSETS -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <!-- STYLES (ููุณ ุชุตูููู ุชูุงูุงู) -->
  <style>
    :root { --color-navy:#0A1931; --color-teal:#18A5A2; --color-light-teal:#ACE2E1; --color-gray-bg:#F7F9FC; --color-shadow-base:rgba(10,25,49,.4);}
    body { font-family:'Tajawal',sans-serif; background-color:var(--color-gray-bg); color:var(--color-navy);}
    .kpi-open-gradient{background:linear-gradient(135deg,#EF4444 0%,#B91C1C 100%);color:#fff;box-shadow:0 10px 20px rgba(185,28,28,.4)}
    .kpi-closed-gradient{background:linear-gradient(135deg,#10B981 0%,#18A5A2 100%);color:#fff;box-shadow:0 10px 20px rgba(24,165,162,.4)}
    .kpi-images-gradient{background:linear-gradient(135deg,#3B82F6 0%,#0A1931 100%);color:#fff;box-shadow:0 10px 20px rgba(59,130,246,.4)}
    .kpi-missing-gradient{background:linear-gradient(135deg,#FCD34D 0%,#F97316 100%); color:var(--color-navy); box-shadow:0 10px 20px rgba(253,211,77,.4)}
    .kpi-card-professional{transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; transform:perspective(1px) translateZ(0)}
    .kpi-card-professional::before{content:""; position:absolute; bottom:0; left:0; right:0; height:5px; background-color:rgba(255,255,255,.2); transition:height .3s}
    .kpi-card-professional:hover{transform:translateY(-8px) scale(1.02); z-index:10}
    .kpi-card-professional:hover::before{height:100%; opacity:.1}
    .ai-button-primary{background:var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5)}
    .ai-button-primary:hover:not(:disabled){background:#148f8c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(24,165,162,.8)}
    .ai-button-secondary{background:var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6)}
    .ai-button-secondary:hover:not(:disabled){background:#1a3053; transform:translateY(-2px); box-shadow:0 6px 15px rgba(10,25,49,.8)}
    .ai-button-vision{background:#9333ea; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(147,51,234,.5)}
    .ai-button-vision:hover:not(:disabled){background:#7e22ce; transform:translateY(-2px); box-shadow:0 8px 20px rgba(147,51,234,.8)}
    .ai-button-root-cause{background:#881337; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(136,19,55,.5)}
    .ai-button-root-cause:hover:not(:disabled){background:#9f1239; transform:translateY(-2px); box-shadow:0 8px 20px rgba(136,19,55,.8)}
    .ai-button-comm{background:#F97316; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(249,115,22,.5)}
    .ai-button-comm:hover:not(:disabled){background:#ea580c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(249,115,22,.8)}
    .ai-button-grounding{background:#10B981; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(16,185,129,.5)}
    .ai-button-grounding:hover:not(:disabled){background:#059669; transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.8)}
    .loading-spinner{border:4px solid rgba(255,255,255,.3); border-top:4px solid var(--color-light-teal); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:8px}
    .ai-button-primary .loading-spinner,.ai-button-vision .loading-spinner,.ai-button-comm .loading-spinner,.ai-button-grounding .loading-spinner,.ai-button-secondary .loading-spinner,.ai-button-root-cause .loading-spinner{border-top:4px solid #0A1931}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .image-container{position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base)}
    .image-label{position:absolute; bottom:0; right:0; background:var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem}
    .observation-item{transition:.2s; border-right:4px solid transparent; cursor:pointer}
    .observation-item:hover{background:#E6F3F3; border-right-color:var(--color-teal)}
    .observation-item.active{background:#E6F3F3; border-right-color:var(--color-navy); box-shadow:0 0 10px rgba(0,0,0,.1)}
    .comparison-wrapper{position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem}
    .comparison-wrapper img,.comparison-wrapper video{display:block; width:100%; height:auto}
    .comparison-wrapper .after-image{position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden}
    .comparison-wrapper .after-image img,.comparison-wrapper .after-image video{position:absolute; top:0; left:0; width:100%; height:auto}
    .comparison-wrapper .comparison-divider{position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; transition:width .1s}
    .comparison-wrapper .comparison-divider:active{cursor:grabbing}
    .comparison-wrapper .comparison-divider-handle{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; background:#fff; border:3px solid var(--color-teal); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 15px rgba(0,0,0,.3)}
    .comparison-label{position:absolute; z-index:5; padding:.5rem 1rem; font-size:.875rem; font-weight:700; color:#fff; border-radius:.5rem; opacity:.9; box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .label-before{top:10px; right:10px; background:#B91C1C}
    .label-after{top:10px; left:10px; background:#10B981}
    .communication-draft{white-space:pre-wrap; text-align:right; direction:rtl; font-family:'Tajawal',sans-serif; border-right:4px solid var(--color-teal); padding-right:1rem; line-height:1.8; background:#f8fafc}
    .kpi-insight-container{border-radius:1.5rem; box-shadow:0 10px 30px rgba(0,0,0,.1); border-top:5px solid var(--color-navy)}
    .source-link{color:#0d9488; text-decoration:none; transition:color .2s}
    .source-link:hover{color:var(--color-navy); text-decoration:underline}
    audio{width:100%; margin-top:10px}
    .modal{display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.6); align-items:center; justify-content:center}
    .modal-content{background:#fefefe; margin:5% auto; padding:30px; border-radius:1.5rem; width:90%; max-width:800px; box-shadow:0 10px 40px rgba(0,0,0,.3); animation:slide-up .3s ease-out; position:relative}
    .input-group-wrapper{display:flex; gap:1rem}
    .input-group{flex-grow:1; text-align:center}
    @media print{
      body{background:#fff!important; color:#000!important; width:210mm; min-height:297mm; margin:0}
      .no-print,#observationsList,#hero,#operational-dashboard,#ai-features,footer,.modal{display:none!important}
      #observationDetail{display:block!important; max-width:100%!important; margin:0!important; padding:0!important; box-shadow:none!important; border:none!important}
      .kpi-insight-container,.bg-white{box-shadow:none!important; border:none!important; padding:0!important; margin:0!important}
      .comparison-wrapper{cursor:default}
      .comparison-divider,.comparison-label{display:none!important}
      .comparison-wrapper .after-image{width:100%!important; overflow:visible!important}
      .comparison-wrapper .after-image img{position:static!important}
      .grid.grid-cols-1.md\3a grid-cols-3{display:block!important; border:1px solid #ccc; margin-bottom:10px}
      .grid.grid-cols-1.md\3a grid-cols-3>div{border:none!important; padding:5px}
      .print-logo{display:block!important}
    }
  </style>
</head>

<body class="text-gray-800">

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex justify-start mb-6 no-print">
      <button id="logout-btn" class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center shadow-lg transition duration-300 transform hover:scale-105" onclick="smartLogout()" title="ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุขูู">
        <i data-lucide="log-out" class="w-4 h-4 ml-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ
      </button>
    </div>

    <!-- HERO -->
    <section id="hero" class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
      <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight" style="color:var(--color-navy);">
        Smart HSR <span style="color:var(--color-teal);">Dashboard</span>
      </h1>
      <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</h2>
      <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">
        "ููุตุฉ ุชูููุฐูุฉ ุฐููุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงููุฑุงูุจุฉ ุงูุฑูููุฉุ ุชููุฑ ุฑุคูุฉ ุฏูููุฉ ููุฃุฏุงุก ูุชุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงููุจูู ุนูู ุงูุจูุงูุงุช."
      </p>
    </section>

    <!-- OBSERVATIONS -->
    <section id="observations-log" class="my-20">
      <div class="text-center mb-12 no-print">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ุณุฌู ุงูููุงุญุธุงุช ุงูุชูุงุนูู: ุฏูุฉ ุงูุตูุฑุฉ ูุงููุต</h3>
        <p class="mt-3 text-lg text-gray-600">ุนุฑุถ ุชูุตููู ููููุงุญุธุงุช ุงูููุฏุงููุฉ ูุน ุฃุฏูุงุช ุงูุชุญููู ุงูุขูู.</p>
        <button id="add-observation-btn" class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto" onclick="openModal('smartInputModal')">
          <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ (ุงูุฅุฏุฎุงู ุงูุฐูู)
        </button>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">
        <!-- List + Filter -->
        <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
          <h4 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ุชุตููุฉ ุงูููุงุญุธุงุช</h4>
          <select id="observationFilter" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300" onchange="handleFilterChange()">
            <option value="ุงููู">ุนุฑุถ ูู ุงูููุงุญุธุงุช</option>
            <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
            <option value="ููุฏ ุงูุชูููุฐ">ููุฏ ุงูุชูููุฐ</option>
            <option value="ุชูุช ุงููุนุงูุฌุฉ">ุชูุช ุงููุนุงูุฌุฉ</option>
            <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option>
            <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
            <option value="ุณูุงูุฉ">ุณูุงูุฉ</option>
            <option value="ุจูุฆุฉ">ุจูุฆุฉ</option>
          </select>

          <h4 class="text-2xl font-bold mt-8 mb-3" style="color:var(--color-navy);">ุงููููุงุญุธููุงุช</h4>
          <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            <div class="text-center text-gray-500 mt-10">... ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ...</div>
          </div>
        </div>

        <!-- Details -->
        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">
          <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
            <h2 class="text-3xl font-extrabold text-gray-900" style="color:var(--color-navy);">ุชูุฑูุฑ Smart HSR ุงูุชูููุฐู</h2>
            <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
          </div>

          <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2" style="color:var(--color-teal);">
            ุนุฑุถ ุงูุชูุงุตูู ูุงูุชุญููู (AI Insights)
          </h4>

          <div id="observationDetail" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุงูุนููุงู:</span><span id="detailTitle" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุงูุชุตููู:</span><span id="detailType" class="block font-bold text-teal-600"></span></div>
              <div class="p-2"><span class="block text-gray-500">ุงููููุน:</span><span id="detailLocation" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุชุงุฑูุฎ ุงูุจูุงุบ:</span><span id="detailDate" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุญุงูุฉ ุงููุนุงูุฌุฉ:</span><span id="detailStatus" class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span></div>
              <div class="p-2"><span class="block text-gray-500">ูุนุฑู ุงูุจูุงุบ:</span><span id="detailID" class="block font-bold text-gray-800"></span></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
              <h5 class="text-xl font-bold mb-3" style="color:var(--color-navy);">ูุตู ุงูููุงุญุธุฉ</h5>
              <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
              <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                <h6 class="font-bold text-teal-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ (HSR Vision AI ๐คโจ)</h6>
                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
              </div>
            </div>

            <div id="resolutionNoteContainer" class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
              <h5 class="text-xl font-bold mb-3 text-green-700">๐ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู</h5>
              <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
              <img id="beforeImage" class="before-image w-full h-auto" alt="ุตูุฑุฉ ูุจู ุงูุฅุตูุงุญ" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
              <div id="afterImageContainer" class="after-image"><img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="></div>
              <div id="comparisonDivider" class="comparison-divider no-print"><div class="comparison-divider-handle"><i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i></div></div>
              <span class="comparison-label label-before no-print">ูุจู</span><span class="comparison-label label-after no-print">ุจุนุฏ</span>
            </div>

            <div id="mediaContainer" class="image-container mb-6 hidden"><div id="mediaContent" class="w-full h-auto rounded-xl"></div><span class="image-label">ูุฑูู ุงูููุงุญุธุฉ</span></div>

            <div id="noImageMessage" class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
              <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> ูุง ุชุชููุฑ ุตูุฑุฉ ุฃู ููุฏูู ููุฐู ุงูููุงุญุธุฉ.
            </div>

            <div id="aiAnalysisSection" class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
              <h5 class="text-xl font-bold mb-4" style="color:var(--color-navy);">ุฃุฏูุงุช ุงูุชุญููู ุงูุฐูู (HSR Vision AI ๐คโจ)</h5>
              <div class="flex flex-wrap gap-3 no-print">
                <button id="vision-btn" class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="analyzeImage('vision')">
                  <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
                </button>
                <button id="root-cause-btn" class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="analyzeImage('root-cause')">
                  <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู
                </button>
                <button id="comm-btn" class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generateCommunicationDraft()">
                  <i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
                </button>
                <button id="pdf-report-btn" class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generatePdfReport()">
                  <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ุชูููุฏ ุชูุฑูุฑ PDF
                </button>
              </div>

              <div id="aiResultContainer" class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color:var(--color-teal);"></h6>
                <div id="aiResultContent" class="text-gray-700"></div>
              </div>
            </div>

            <div id="actionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
              <button id="updateStatusBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="alert('ุชู ุชุญููู ุงูุญุงูุฉ ุฅูู ููุฏ ุงูุชูููุฐ (ุชุฌุฑูุจู)')">
                ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ููุฏ ุงูุชูููุฐ"
              </button>
              <button id="completeObservationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="openModal('closeoutModal')">
                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> ุงูุฅุบูุงู ุงูุชูููุฐู (ุตูุฑุฉ ุจุนุฏ)
              </button>
              <button id="alreadyCompletedBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden" disabled>
                <i data-lucide="check" class="w-4 h-4 ml-2"></i> ุงูููุงุญุธุฉ ูุบููุฉ ูููุซูุฉ
              </button>
            </div>
          </div>

          <div id="detailPlaceholder" class="text-center space-y-4">
            <p class="text-gray-500 mt-16 text-lg">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุงูุตูุฑุฉ ูุงููุฐูุฑุฉ ุงูุชูุตูููุฉ.</p>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01"/>
            </svg>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="operational-dashboard" class="my-20 no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุญูููุฉ (Vital Metrics)</h3>
        <p class="mt-3 text-lg text-gray-600">ุชุชุจุน ุงูุจูุงุบุงุช ูุญุงูุฉ ุงูุชูุซูู ุจุงูุตูุฑ ูุถูุงู ููุงุกุฉ ุงูุฅุบูุงู.</p>
      </div>

      <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200">
          <p class="text-xl font-medium text-gray-500">ุฌุงุฑู ุงูุชุญููู...</p>
          <p class="text-5xl font-extrabold text-gray-700 mt-2">--</p>
        </div>
      </div>

      <div class="mt-12 text-center">
        <button id="kpi-insight-button" class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="generateKpiInsights()">
          <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (HSR Vision AI ๐คโจ)
        </button>
        <div id="kpi-insight-result" class="mt-6 text-sm"></div>
      </div>
    </section>

    <!-- AI features (static) -->
    <section id="ai-features" class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">๐ง ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุตููู ุงูุนูููุฉ</h3>
        <p class="mt-3 text-lg text-gray-600">ุงุณุชูุฏ ูู ููุงุฐุฌ HSR Vision AI ๐ค ูุชุญููู ุงูุจูุงูุงุช ุฅูู ูุฑุงุฑุงุช ูุงุจูุฉ ููุชูููุฐ.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#9333ea;">๐๏ธ</span><h4 class="font-extrabold text-lg mb-1" style="color:var(--color-navy);">ุชุญููู ุงูุฑุคูุฉ</h4>
          <p class="text-xs text-gray-600">ูุตู ุงููุดููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">โ๏ธ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุฎุทุฉ ุนูู ุขููุฉ</h4>
          <p class="text-xs text-gray-600">ุชูููุฏ ุฎุทูุงุช ุชูููุฐูุฉ ููุนุงูุฌุฉ ุงูููุงุญุธุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">๐จ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชูููู ุงููุฎุงุทุฑ</h4>
          <p class="text-xs text-gray-600">ุชุญุฏูุฏ ุงูุฃููููุฉ ูุงูุฅุทุงุฑ ุงูุฒููู ูู ูููู JSON.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#881337;">๐ฌ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู</h4>
          <p class="text-xs text-gray-600">ุงูุชุฑุงุญ ุณุจุจ ุฌุฐุฑู ููุตูุญุฉ ููุงุฆูุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#F97316;">โ๏ธ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุตูุงุบุฉ ุงูุงุชุตุงู</h4>
          <p class="text-xs text-gray-600">ุชูููุฏ ูุณูุฏุฉ ุฃูุฑ ุนูู ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-navy);">๐</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชูุฑูุฑ ุงูุฅุบูุงู ุงูุตูุชู</h4>
          <p class="text-xs text-gray-600">ุชูุฎูุต ุงูุชูุฑูุฑ ูุชุญูููู ุฅูู ููู ุตูุชู.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#10B981;">๐</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุงูุจุญุซ ุนู ุงููุนุงููุฑ</h4>
          <p class="text-xs text-gray-600">ุงุณุชุฎุฏุงู ุงูุจุญุซ ุงููุฏุนูู ูุงุณุชุญุถุงุฑ ุงููุนุงููุฑ ุงูุนุงูููุฉ.</p>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
      <div class="max-w-6xl mx-auto px-4">
        <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color:var(--color-navy);">ุงุจุฏุฃ ุฑุญูุฉ ุงูุชุญูู ุงูุฑููู ูุน Smart HSR</h3>
        <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">ูุธุงู ุฐูู ููุญูู ุจูุงูุงุช ุงูููุฏุงู ุฅูู ูุฑุงุฑุงุช ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฐููุฉ</p>
        <a href="http://wa.me/966507006849" target="_blank" class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">ุงุทูุจ ุนุฑุถูุง ุชุฌุฑูุจููุง ุงูุขู</a>
        <div class="mt-12 pt-8 border-t border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
            <div><h4 class="font-bold text-gray-800 mb-2">ุญูู ุงููุธุงู</h4><p>ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">ุงูุฏุนู ุงูููู</h4><p>Blumark24@gmail.com</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">ุงููุจูุนุงุช ูุงูุงุณุชูุณุงุฑุงุช</h4><p>0507006849</p></div>
          </div>
          <div class="text-xs text-gray-500">
            <p class="mb-2">&copy; 2025 Smart HSR. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            <p id="userInfo">ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุฎุฏูุฉ...</p>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- MODALS -->
  <div id="smartInputModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color:var(--color-navy);">ูุญุฏุฉ ุงูุฅุฏุฎุงู ุงูุฐูู ููููุงุญุธุงุช (Smart HSR)</h2>

      <div id="modalStep1">
        <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุฃุฏุฎู ุชูุงุตูู ุงูููุงุญุธุฉ (ุงููุตุ ุงููููุนุ ุงูุตูุฑุฉ)</p>
        <textarea id="rawObservationInput" rows="5" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm" placeholder="ูุซุงู: ููุฌุฏ ุชุฌูุน ููููุงู ุนูู ุทุฑูู ุงูุฎุฏูุฉ ุนูุฏ ุงููููู 52..." oninput="checkSmartInputState()"></textarea>

        <div class="mt-4 input-group-wrapper">
          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">ุงููููุน ุงูุฌุบุฑุงูู (GPS):</label>
            <p id="locationStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ</p>
            <input type="hidden" id="inputLatitude"><input type="hidden" id="inputLongitude">
            <button id="getLocationBtn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="getLocation()" type="button">
              <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู
            </button>
          </div>

          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ ุงูููุงุญุธุฉ:</label>
            <p id="fileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
            <!-- ููุงุญุธุฉ: ุชู ุชูููุฏ ุงูุฑูุน ููุตูุฑ ููุท ูุถูุงู ุงูุญูุธ ุงูุฏุงุฆู ุนุจุฑ ImgBB -->
            <input type="file" id="fileUploadInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('fileUploadInput').click()" type="button">
              <i data-lucide="upload" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ููู
            </button>
          </div>
        </div>

        <div class="mt-6 text-center">
          <button id="processSmartInputBtn" class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="processSmartInput()" disabled>
            <i data-lucide="cpu" class="w-5 h-5 ml-2"></i> ุจุฏุก ุงูุชุญููู ุงูุฐูู ูุชูููุฏ ุงูุชูุฑูุฑ
          </button>
        </div>
      </div>

      <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงูุจูุงูุงุช</h3>
        <div id="modalResultContent"></div>
        <div class="mt-6 text-center">
          <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold" onclick="closeModal('smartInputModal')">ุฅุบูุงู ููุฑุงุฌุนุฉ ุงูุชูุฑูุฑ ุงูุฌุฏูุฏ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="closeoutModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">๐ ููุญุฉ ุงูุฅุบูุงู ุงูุชูููุฐู ููููุงุญุธุฉ #<span id="closeoutId"></span></h2>
      <p class="text-lg text-gray-600 mb-4">ูุฅุบูุงู ุงูููุงุญุธุฉุ ูุฌุจ ุชูุซูู ุนูููุฉ ุงูุฅุตูุงุญ ุจู <b>ุตูุฑุฉ "ุจุนุฏ ุงูุฅุตูุงุญ"</b> ููุฐูุฑุฉ ุฎุชุงููุฉ.</p>

      <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
        <h3 class="text-xl font-bold mb-3" style="color:var(--color-navy);">1. ุชูุซูู ุตูุฑุฉ ุงูุฅุบูุงู (After Photo)</h3>
        <div class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white hover:border-red-500 transition-colors">
          <label class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ <b>ุจุนุฏ ุงูุฅุตูุงุญ/ุงููุนุงูุฌุฉ</b> (<span class="text-red-500 font-bold">ุฅูุฒุงูู</span>):</label>
          <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
          <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden" onchange="handleAfterFileUpload(event)">
          <button class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('afterFileUploadInput').click()" type="button">
            <i data-lucide="camera" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ุตูุฑุฉ ุงูุฅุบูุงู
          </button>
        </div>

        <h3 class="text-xl font-bold mt-6 mb-3" style="color:var(--color-navy);">2. ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ</h3>
        <textarea id="resolutionNoteInput" rows="4" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm" placeholder="ุงูุชุจ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ..."></textarea>
      </div>

      <div class="mt-6 text-center">
        <button id="finalCloseoutBtn" class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto transition-colors" onclick="completeObservation()" disabled>
          <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ุชุฃููุฏ ุงูุฅุบูุงู ุงูููุงุฆู ููููุงุญุธุฉ
        </button>
      </div>
    </div>
  </div>

<!-- APP LOGIC (Firebase + Firestore + ImgBB) -->
<script type="module">
// =============================
// ุฅุนุฏุงุฏ Firebase ุงูุฑุณูู (ูุดุฑูุนู ุงูุญุงูู)
// =============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, serverTimestamp, query, orderBy } 
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
  authDomain: "gen-lang-client-0349944917.firebaseapp.com",
  projectId: "gen-lang-client-0349944917",
  storageBucket: "gen-lang-client-0349944917.firebasestorage.app",
  messagingSenderId: "883065484771",
  appId: "1:883065484771:web:c907bb5a51f68caad75cd6",
  measurementId: "G-V8WG5M8V5B"
};

// ุชููุฆุฉ Firebase
let app, db, FIREBASE_READY = false;
try {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  FIREBASE_READY = !!db;
  document.getElementById('userInfo').textContent = 'โ ุชู ุงูุงุชุตุงู ุจู Firebase ุจูุฌุงุญ.';
} catch (e) {
  console.warn('Firebase init failed:', e);
  document.getElementById('userInfo').textContent = 'โ๏ธ ุชุดุบูู ูุญูู ุจุฏูู Firebase.';
}

// =============================
// ุฃุฏูุงุช ุนุงูุฉ
// =============================
function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent=text; }
function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
function hide(id){ const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
function unhide(id){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
function cryptoRandom(){ return (crypto.getRandomValues(new Uint32Array(2)).join('')); }

async function uploadImageBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// =============================
// ูุชุบูุฑุงุช ุนุงูุฉ
// =============================
let observationsData = [];
let currentSelectedObservation = null;
let currentFile = null;

// =============================
// ูุงุฌูุฉ Firestore
// =============================
async function loadFromFirestore(){
  if(!FIREBASE_READY) return;
  const q=query(collection(db,"observations"),orderBy("createdAt","desc"));
  const s=await getDocs(q);
  const arr=[];
  s.forEach(d=>{ arr.push({...d.data(),docId:d.id}); });
  observationsData=arr;
}

async function addObservationToFirestore(payload){
  if(!FIREBASE_READY) return null;
  const ref=await addDoc(collection(db,"observations"),{...payload,createdAt:serverTimestamp()});
  return ref.id;
}

async function updateObservationInFirestore(docId,fields){
  if(!FIREBASE_READY) return;
  await updateDoc(doc(db,"observations",docId),fields);
}
</script> <!-- ุงุบูุงู ุณูุฑุจุช Firebase -->
  <script>
// โ ุฏูุงู ุงููุงุฌูุฉ ุงูุฃุณุงุณูุฉ ุงูุนุงูุฉ (ููุณุช ุฏุงุฎู module)
function hide(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('hidden');
}

function unhide(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('hidden');
}

function setHTML(id, html) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = html;
}

function setText(id, text) {
  const el = document.getElementById(id);
  if (el) el.textContent = text;
}
</script> <!-- ุงุบูุงู ุณูุฑุจุช Firebase -->

  <!-- โ ููุง ูุถูู ููุฏ ุชูููุฏ ุงููุนุฑู ุงูุนุดูุงุฆู -->
<script>
// โ ุฏุงูุฉ ุชูููุฏ ูุนุฑู ุนุดูุงุฆู ูุฑูุฏ (ID)
function cryptoRandom() {
  return crypto.getRandomValues(new Uint32Array(2)).join('');
}
</script>

  <script>
// โ ุนุฑุถ ุชูุงุตูู ุงูููุงุญุธุฉ ูู ุงููุณู ุงูุฃููู
function showObservationDetail(docId) {
  const obs = observationsData.find(o => o.docId === docId);
  if (!obs) return;

  currentSelectedObservation = obs;
  unhide("observationDetail");
  hide("detailPlaceholder");

  setText("detailTitle", obs.title || "โ");
  setText("detailType", obs.type || "โ");
  setText("detailLocation", obs.location || "โ");
  setText("detailDate", obs.date || "โ");
  setText("detailID", obs.displayId || "โ");

  const st = {
    PENDING: "bg-red-600",
    IN_PROGRESS: "bg-yellow-500",
    COMPLETED: "bg-green-600"
  }[obs.status] || "bg-gray-400";

  const statusEl = document.getElementById("detailStatus");
  statusEl.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${st}`;
  statusEl.textContent = obs.status || "โ";

  setText("detailDescription", obs.details || "โ");

  // โ ุฅุธูุงุฑ ุชุญููู ุงูุฐูุงุก ุงูุตูุงุนู ุฅู ููุฌุฏ
  const aiContainerId = "aiSavedAnalysis";
  let container = document.getElementById(aiContainerId);
  if (!container) {
    const div = document.createElement("div");
    div.id = aiContainerId;
    div.className = "bg-blue-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-blue-400";
    div.innerHTML = `
      <h5 class="text-xl font-bold mb-3 text-blue-800">๐ ุชุญููู ุงูุฐูุงุก ุงูุตูุงุนู ุงููุญููุธ</h5>
      <p id="aiAnalysisText" class="text-gray-700 leading-relaxed"></p>
    `;
    const detailSection = document.getElementById("observationDetail");
    detailSection.insertBefore(div, document.getElementById("aiAnalysisSection"));
  }

  if (obs.aiAnalysis) {
    unhide(aiContainerId);
    setText("aiAnalysisText", obs.aiAnalysis);
  } else {
    hide(aiContainerId);
  }

  lucide.createIcons();
}
</script>  <!-- ุงุบูุงู ุณูุฑุจุช Firebase -->

<script>
const GEMINI_API_KEY = "AIzaSyCstRnAY_9TO9f4l49TTHEjVaoqjtZriJk";
</script>


<!-- โ ุฏุงูุฉ ุชุญููู ุงูุตูุฑุฉ ุจุงูุฑุคูุฉ (Gemini Vision) -->
<script>
window.analyzeImage = async function() {
  const obs = window.currentSelectedObservation;
  if (!obs || !obs.imagePath) {
    alert("โ ูุง ุชูุฌุฏ ุตูุฑุฉ ููุชุญููู!");
    return;
  }

  setText("aiResultTitle", "๐ ุฌุงุฑู ุงูุชุญููู ุจุงูุฑุคูุฉ ุงูุฐููุฉ...");
  setHTML("aiResultContent", `
    <div class="loading-spinner" style="margin: 0 auto;"></div>
    <p class="text-center mt-3">ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ ุจุงุณุชุฎุฏุงู HSR Vision AI...</p>
  `);
  unhide("aiResultContainer");

  try {
    const response = await fetch(
    "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=" + GEMINI_API_KEY,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{
            parts: [
              {
                text: `ูู ุจุชุญููู ุงูุตูุฑุฉ ุงูุชุงููุฉ ูู ุณูุงู ุจูุฏู ููุฉุ ูุฃุนุทูู ุงููุชูุฌุฉ ูู ุตูุบุฉ ูุงุถุญุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุชุชุถูู ุงูููุงุท ุงูุชุงููุฉ:
                1. ูุตู ูุฎุชุตุฑ ุฌุฏุงู ูููุดูุฏ (ูุซู: "ุนููุฏ ุฅูุงุฑุฉ ูุงุฆู" ุฃู "ุญูุฑุฉ ูู ุงูุทุฑูู" ุฃู "ุชุดููุงุช ูู ุงูุฃุณููุช").
                2. ุชุญุฏูุฏ ููุน ุงููุดููุฉ (ุตูุงูุฉุ ุฅูุงุฑุฉุ ุทุฑูุ ุฃุดุฌุงุฑุ ุณูุงูุฉ).
                3. ุงูุฅุฌุฑุงุก ุงูููู ุงูููุชุฑุญ ููุญู (ูุซู: "ุฅุนุงุฏุฉ ุชุซุจูุช ุงูุนููุฏ" ุฃู "ุฅุนุงุฏุฉ ุณููุชุฉ ุงูููุทุน ุงููุชุถุฑุฑ").
                4. ุชูููู ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ (ููุฎูุถุฉ / ูุชูุณุทุฉ / ูุฑุชูุนุฉ).`
              },
              { inline_data: { mime_type: "image/jpeg", data: await toBase64FromUrl(obs.imagePath) } }
            ]
          }]
        })
      }
    );

    const data = await response.json();
    const analysis = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "โ ูู ูุชู ุชุญููู ุงูุตูุฑุฉ ุจูุฌุงุญ.";

    // โ ุนุฑุถ ุงููุชูุฌุฉ ูููุณุชุฎุฏู
    setText("aiResultTitle", "โ ูุชูุฌุฉ ุงูุชุญููู ุงูุชูุตููู (HSR Vision AI):");
    setHTML("aiResultContent", `<div class="communication-draft">${analysis}</div>`);

    // โ ุญูุธ ุงููุชูุฌุฉ ุชููุงุฆููุง ุฏุงุฎู Firestore (ุฅู ููุฌุฏ ุงุชุตุงู)
    if (FIREBASE_READY && obs.docId) {
      await updateObservationInFirestore(obs.docId, {
        aiAnalysis: analysis,
        lastAnalyzedAt: new Date().toISOString()
      });
      console.log("โ ุชู ุญูุธ ูุชูุฌุฉ ุงูุชุญููู ุฏุงุฎู ุงูููุงุญุธุฉ:", obs.docId);
    }

  } catch (error) {
    console.error(error);
    setText("aiResultTitle", "โ ูุดู ุงูุชุญููู");
    setHTML("aiResultContent", `<p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.</p>`);
  }
};
</script>


<!-- โ ุฏูุงู ุงููุงุฌูุฉ ุงูุฃุณุงุณูุฉ -->
<script>
// =============================
// โ ุฏูุงู ุงููุงุฌูุฉ ุงูุฃุณุงุณูุฉ (ุชุนููุถ ุงููุงูุต)
// =============================

// ๐น ุชุณุฌูู ุงูุฎุฑูุฌ
window.smartLogout = function() {
  const btn = document.getElementById('logout-btn');
  if (!btn) return;
  btn.disabled = true;
  btn.innerHTML = '<div class="loading-spinner" style="border-top:4px solid var(--color-teal);"></div> ุฌุงุฑู ุชุณุฌูู ุงูุฎุฑูุฌ...';
  btn.classList.add('flex','justify-center','items-center');
  setTimeout(() => {
    alert('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ โ');
    window.location.href = "login.html";
  }, 1000);
};

// ๐น ูุชุญ ุงูููุฏุงู
window.openModal = function(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "flex";
};

// ๐น ุฅุบูุงู ุงูููุฏุงู
window.closeModal = function(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "none";
};

// ๐น ุชูููุฏ ุชูุฑูุฑ KPI
window.generateKpiInsights = function() {
  const kpiDiv = document.getElementById('kpi-insight-result');
  if (!kpiDiv) return;
  kpiDiv.innerHTML = `
    <div class="p-4 bg-white rounded-xl shadow">
      <p class="text-lg font-bold text-teal-700 mb-2">ููุฎุต ุชูููุฐู ุณุฑูุน:</p>
      <p class="text-gray-700">โ ุชูุช ูุนุงูุฌุฉ ูุนุธู ุงูููุงุญุธุงุช. ููุตู ุจุชุณุฑูุน ุชูุซูู ุงูุตูุฑ ุงูุฎุชุงููุฉ ูุชุญุณูู ุงูุฃุฏุงุก ุงูุนุงู.</p>
    </div>
  `;
};
</script>

<script>
function getLocation() {
  const status = document.getElementById('locationStatus');
  if (!navigator.geolocation) {
    status.textContent = "ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน";
    return;
  }
  status.textContent = "ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...";
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      document.getElementById('inputLatitude').value = pos.coords.latitude;
      document.getElementById('inputLongitude').value = pos.coords.longitude;
      status.textContent = `ุชู ุชุญุฏูุฏ ุงููููุน (${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)})`;
    },
    (err) => {
      status.textContent = "โ ูุดู ุชุญุฏูุฏ ุงููููุน";
      console.error(err);
    }
  );
}
</script>
<!-- โ ุฏูุงู ุฑูุน ุงููููุงุช ูุงูุชุญูู ูู ุงูุฅุฏุฎุงู -->
<script>
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  window.currentFile = file;
  document.getElementById('fileStatus').textContent = `๐ธ ุชู ุงุฎุชูุงุฑ: ${file.name}`;
  checkSmartInputState();
}

function checkSmartInputState() {
  const text = document.getElementById('rawObservationInput').value.trim();
  const btn = document.getElementById('processSmartInputBtn');
  btn.disabled = !text && !window.currentFile;
}
</script>
  
<script>
// โ ุฏุงูุฉ ุงูุฅุฏุฎุงู ุงูุฐูู ุงููุทูุฑุฉ (ุนููุงู + ุชุญููู ูุงูู + ุญูุธ ุชููุงุฆู)
async function processSmartInput() {
  const rawText = document.getElementById('rawObservationInput').value.trim();
  const lat = document.getElementById('inputLatitude').value || "ุบูุฑ ูุญุฏุฏ";
  const lon = document.getElementById('inputLongitude').value || "ุบูุฑ ูุญุฏุฏ";

  hide('modalStep1');
  unhide('modalResult');
  setHTML('modalResultContent', '<p>๐ ุฌุงุฑู ุงูุชุญููู ุจุงูุฐูุงุก ุงูุตูุงุนู (Gemini Vision)...</p>');

  try {
    let uploadedUrl = null;
    if (window.currentFile) {
      uploadedUrl = await uploadImageBase64(window.currentFile);
    }

    // ๐ง ุชุญููู ุงูุตูุฑุฉ ุงููุงูู (ุงูุนููุงู + ุงููุตู ุงูููู)
    let aiTitle = rawText;
    let aiDescription = "";
    if (!rawText && uploadedUrl) {
      const ai = await getFullSmartAnalysis(uploadedUrl);
      aiTitle = ai.title || "ููุงุญุธุฉ ููุฏุงููุฉ (ุชุญููู ุชููุงุฆู)";
      aiDescription = ai.description || "";
    } else if (rawText) {
      aiTitle = rawText;
    } else {
      aiTitle = "ููุงุญุธุฉ ููุฏุงููุฉ ุฌุฏูุฏุฉ";
    }

    const newDate = new Date().toISOString().slice(0, 10);
    const payload = {
      title: aiTitle,
      date: newDate,
      type: "ุตูุงูุฉ",
      status: "ุฌุฏูุฏ",
      location: `(${lat}, ${lon})`,
      imagePath: uploadedUrl,
      aiAnalysis: aiDescription, // โ ุงูุชุญููู ุงููุตู ุงููุงูู
      createdAt: Date.now()
    };

    let docId = "local-" + cryptoRandom();
    if (FIREBASE_READY) {
      const ref = await addObservationToFirestore(payload);
      if (ref) docId = ref;
    }

    observationsData.unshift({ docId, ...payload });

    setHTML(
      'modalResultContent',
      `โ ุชูุช ุฅุถุงูุฉ ุงูููุงุญุธุฉ "${aiTitle}" ูุชุญููููุง ุจูุฌุงุญ.<br><br>
      <div class="communication-draft">${aiDescription || "ูู ูุชู ุชูููุฏ ุชุญููู ูุตู."}</div>`
    );
  } catch (err) {
    console.error(err);
    setHTML('modalResultContent', "โ ูุดู ูู ูุนุงูุฌุฉ ุงูููุงุญุธุฉ.");
  }
}

// โ ุชุญููู ุงูุตูุฑุฉ ุจุงุณุชุฎุฏุงู Gemini Vision (ุงูุนููุงู + ุงููุตู ุงูููู)
async function getFullSmartAnalysis(imageUrl) {
  const GEMINI_API_KEY = "AIzaSyCstRnAY_9TO9f4l49TTHEjVaoqjtZriJk";
  try {
    const imageBase64 = await toBase64FromUrl(imageUrl);
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: `ุญูู ุงูุตูุฑุฉ ุงูุชุงููุฉ ุจูุบุฉ JSON ูุฑุชุจุฉ ุชุญุชูู ุนูู:
{
  "title": "ุนููุงู ุงูููุงุญุธุฉ (ูุซูุงู: ุนููุฏ ุฅูุงุฑุฉ ูุงุฆูุ ุญูุฑุฉ ูู ุงูุทุฑููุ ุฃุดุฌุงุฑ ุชุญุชุงุฌ ุชูููู)",
  "description": "ุชุญููู ููู ูุตูุฑ ูุตู ุงูุญุงูุฉุ ุงูุณุจุจ ุงููุญุชููุ ุงูุฅุฌุฑุงุก ุงูููุชุฑุญุ ูุชูููู ุงูุฎุทูุฑุฉ."
}`
                },
                { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
              ]
            }
          ]
        })
      }
    );

    const data = await response.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
    console.log("๐ก ุชุญููู Gemini:", text);
    const parsed = JSON.parse(text || "{}");
    return parsed;
  } catch (error) {
    console.error("โ ูุดู ุชุญููู Gemini:", error);
    return { title: null, description: null };
  }
}

// โ ุชุญููู ุงูุตูุฑุฉ ุฅูู Base64
async function toBase64FromUrl(url) {
  const res = await fetch(url);
  const blob = await res.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(blob);
  });
}
</script>

<script>
// โ ุชุตููุฉ ุงูููุงุญุธุงุช ูู ุงููุงุฆูุฉ
function handleFilterChange() {
  const filter = document.getElementById("observationFilter").value;
  const list = document.getElementById("observationsList");
  if (!list) return;

  list.innerHTML = ""; // ุชูุฑูุบ ุงููุงุฆูุฉ ูุจู ุงูุชุตููุฉ

  const filtered = (filter === "ุงููู")
    ? observationsData
    : observationsData.filter(o => o.type === filter || o.status === filter);

  if (filtered.length === 0) {
    list.innerHTML = `<p class="text-center text-gray-500 mt-4">ูุง ุชูุฌุฏ ููุงุญุธุงุช ูุทุงุจูุฉ.</p>`;
    return;
  }

  filtered.forEach(o => {
    const div = document.createElement("div");
    div.className = "observation-item p-3 rounded-lg bg-gray-50 border cursor-pointer";
    div.innerHTML = `
      <p class="font-bold text-[var(--color-navy)]">${o.title}</p>
      <p class="text-sm text-gray-600">${o.date || ""}</p>
      <p class="text-xs text-gray-500">${o.status || ""}</p>
    `;
    div.onclick = () => showObservationDetail(o.docId);
    list.appendChild(div);
  });
}
</script>
<script>
// โ ุฏุงูุฉ ุฑูุน ุงูุตูุฑุฉ ูุชุญููููุง ุฅูู Base64 (ูุชุงุญุฉ ููุนุงูู)
window.uploadImageBase64 = function(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

// โ ุฏุงูุฉ ุชุตููุฉ ุงูููุงุญุธุงุช ุญุณุจ ุงูููุน ุฃู ุงูุญุงูุฉ
function handleFilterChange() {
  const filter = document.getElementById("observationFilter").value;
  const list = document.getElementById("observationsList");
  if (!list) return;

  list.innerHTML = ""; // ุชูุฑูุบ ุงููุงุฆูุฉ ูุจู ุงูุชุตููุฉ

  const filtered = (filter === "ุงููู")
    ? observationsData
    : observationsData.filter(o => o.type === filter || o.status === filter);

  if (filtered.length === 0) {
    list.innerHTML = `<p class="text-center text-gray-500 mt-4">ูุง ุชูุฌุฏ ููุงุญุธุงุช ูุทุงุจูุฉ.</p>`;
    return;
  }

  filtered.forEach(o => {
    const div = document.createElement("div");
    div.className = "observation-item p-3 rounded-lg bg-gray-50 border cursor-pointer";
    div.innerHTML = `
      <p class="font-bold text-[var(--color-navy)]">${o.title}</p>
      <p class="text-sm text-gray-600">${o.date || ""}</p>
      <p class="text-xs text-gray-500">${o.status || ""}</p>
    `;
    div.onclick = () => showObservationDetail(o.docId);
    list.appendChild(div);
  });
}
</script>

</body>
</html>
