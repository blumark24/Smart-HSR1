<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>
    
    <meta name="description" content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta name="keywords" content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta property="og:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ">
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <link rel="stylesheet" href="output.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap"
        rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            /* Professional & Executive Palette */
            --color-navy: #0A1931; /* Primary Dark Color */
            --color-teal: #18A5A2; /* Accent/Highlight Color */
            --color-light-teal: #ACE2E1; /* Light Accent */
            --color-gray-bg: #F7F9FC; /* Clean Background */
            --color-shadow-base: rgba(10, 25, 49, 0.4); /* Deep Navy Shadow */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--color-gray-bg);
            color: var(--color-navy);
        }

        /* Gradient for Open Reports (Urgency - Red/Orange) */
        .kpi-open-gradient {
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); /* Red to Deep Red */
            color: white;
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.4);
        }

        /* Gradient for Closed Reports (Success - Teal/Green) */
        .kpi-closed-gradient {
            background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%); /* Green to Teal */
            color: white;
            box-shadow: 0 10px 20px rgba(24, 165, 162, 0.4);
        }

        /* Gradient for Total Images (Information - Blue/Navy) */
        .kpi-images-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%); /* Blue to Navy */
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        /* Gradient for Missing Images (Warning - Yellow/Orange) */
        .kpi-missing-gradient {
            background: linear-gradient(135deg, #FCD34D 0%, #F97316 100%); /* Yellow to Orange */
            color: var(--color-navy); /* Dark text for contrast on light gradient */
            box-shadow: 0 10px 20px rgba(253, 211, 77, 0.4);
        }

        /* Common KPI Card Styles */
        .kpi-card-professional {
            transition: all 0.3s ease;
            border-radius: 1.5rem; /* Rounded corners */
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0); /* For hardware acceleration */
        }

        .kpi-card-professional::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: height 0.3s ease;
        }

        .kpi-card-professional:hover {
            transform: translateY(-8px) scale(1.02);
            z-index: 10;
        }

        .kpi-card-professional:hover::before {
            height: 100%;
            opacity: 0.1;
        }

        /* General UI Elements */
        .ai-button-primary {
            background-color: var(--color-teal);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(24, 165, 162, 0.5);
        }

        .ai-button-primary:hover:not(:disabled) {
            background-color: #148f8c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(24, 165, 162, 0.8);
        }

        .ai-button-secondary {
            background-color: var(--color-navy);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(10, 25, 49, 0.6);
        }

        .ai-button-secondary:hover:not(:disabled) {
            background-color: #1a3053;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(10, 25, 49, 0.8);
        }

        /* Vision Button Style (Purple) */
        .ai-button-vision {
            background-color: #9333ea;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(147, 51, 234, 0.5);
        }

        .ai-button-vision:hover:not(:disabled) {
            background-color: #7e22ce;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.8);
        }

        /* Root Cause Button Style (Dark Red/Maroon) */
        .ai-button-root-cause {
            background-color: #881337; /* Maroon 900 */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(136, 19, 55, 0.5);
        }

        .ai-button-root-cause:hover:not(:disabled) {
            background-color: #9f1239;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(136, 19, 55, 0.8);
        }

        /* Communication Button Style (Orange) */
        .ai-button-comm {
            background-color: #F97316; /* Orange */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.5);
        }

        .ai-button-comm:hover:not(:disabled) {
            background-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.8);
        }

        /* Grounding Button Style (Green) */
        .ai-button-grounding {
            background-color: #10B981; /* Green */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5);
        }

        .ai-button-grounding:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-light-teal); /* Use light teal on dark buttons */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        .ai-button-primary .loading-spinner,
        .ai-button-vision .loading-spinner,
        .ai-button-comm .loading-spinner,
        .ai-button-grounding .loading-spinner,
        .ai-button-secondary .loading-spinner,
        .ai-button-root-cause .loading-spinner {
            border-top: 4px solid #0A1931; /* Darker spinner on lighter buttons */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px var(--color-shadow-base);
        }

        .image-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--color-navy);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            border-top-left-radius: 0.75rem;
        }

        .observation-item {
            transition: all 0.2s;
            border-right: 4px solid transparent;
            cursor: pointer;
        }

        .observation-item:hover {
            background-color: #E6F3F3; /* Light teal hover effect */
            border-right-color: var(--color-teal);
        }

        .observation-item.active {
            background-color: #E6F3F3; /* Active state */
            border-right-color: var(--color-navy);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Image Comparison Slider Styles */
        .comparison-wrapper {
            position: relative;
            max-width: 100%;
            overflow: hidden;
            user-select: none;
            cursor: ew-resize; /* East-West resize cursor */
            border-radius: 0.75rem;
        }

        .comparison-wrapper img,
        .comparison-wrapper video {
            display: block;
            width: 100%;
            height: auto;
        }

        .comparison-wrapper .after-image {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 50%; /* Initial mask width */
            overflow: hidden;
        }

        .comparison-wrapper .after-image img,
        .comparison-wrapper .after-image video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Ensure the image fills the container */
            height: auto;
        }

        .comparison-wrapper .comparison-divider {
            position: absolute;
            top: 0;
            left: 50%; /* Initial position */
            width: 4px;
            height: 100%;
            background-color: var(--color-teal);
            transform: translateX(-50%);
            cursor: grab;
            z-index: 10;
            box-shadow: 0 0 10px rgba(24, 165, 162, 0.8);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .comparison-wrapper .comparison-divider:active {
            cursor: grabbing;
        }

        .comparison-wrapper .comparison-divider-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: white;
            border: 3px solid var(--color-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .comparison-label {
            position: absolute;
            z-index: 5;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            opacity: 0.9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .label-before {
            top: 10px;
            right: 10px;
            background-color: #B91C1C; /* Red */
        }

        .label-after {
            top: 10px;
            left: 10px;
            background-color: #10B981; /* Green */
        }

        .communication-draft {
            white-space: pre-wrap;
            text-align: right;
            direction: rtl;
            font-family: 'Tajawal', sans-serif;
            border-right: 4px solid var(--color-teal);
            padding-right: 1rem;
            line-height: 1.8;
            background-color: #f8fafc;
        }

        .kpi-insight-container {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--color-navy);
        }

        .source-link {
            color: #0d9488; /* Teal 600 */
            text-decoration: none;
            transition: color 0.2s;
        }

        .source-link:hover {
            color: var(--color-navy);
            text-decoration: underline;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center; /* Center the modal content vertically */
            justify-content: center; /* Center the modal content horizontally */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slide-up 0.3s ease-out;
            position: relative;
        }

        /* Custom Location/Image Wrapper */
        .input-group-wrapper {
            display: flex;
            gap: 1rem; /* Space between inputs */
        }

        .input-group {
            flex-grow: 1; /* Make inputs fill available space */
            text-align: center;
        }

        /* PDF Print Styles (Hiding unnecessary elements when printing) */
        @media print {
            body {
                background-color: white !important;
                color: black !important;
                /* ุชุญุฏูุฏ ุนุฑุถ ุงูุตูุญุฉ ููู PDF */
                width: 210mm; /* A4 width */
                min-height: 297mm; /* A4 height */
                margin: 0;
            }

            .no-print,
            #observationsList,
            #hero,
            #operational-dashboard,
            #ai-features,
            footer,
            .modal {
                display: none !important;
            }

            #observationDetail {
                display: block !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            .kpi-insight-container,
            .bg-white {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .comparison-wrapper {
                /* Display only the "After" image in comparison view for PDF */
                cursor: default;
            }

            .comparison-divider,
            .comparison-label {
                display: none !important;
            }

            .comparison-wrapper .after-image {
                width: 100% !important;
                overflow: visible !important;
            }

            .comparison-wrapper .after-image img {
                position: static !important;
            }

            /* Adjusting details layout for print */
            .grid.grid-cols-1.md\3a grid-cols-3 {
                display: block !important;
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }

            .grid.grid-cols-1.md\3a grid-cols-3>div {
                border: none !important;
                padding: 5px;
            }

            .print-logo {
                display: block !important;
            }
        }
    </style>
</head>

<body class="text-gray-800">

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <div class="flex justify-start mb-6 no-print">
            <button id="logout-btn"
                class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center shadow-lg transition duration-300 transform hover:scale-105"
                onclick="smartLogout()" title="ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุขูู">
                <i data-lucide="log-out" class="w-4 h-4 ml-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ
            </button>
        </div>

        <section id="hero"
            class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
            <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight"
                style="color: var(--color-navy);">Smart HSR <span style="color: var(--color-teal);">Dashboard</span>
            </h1>
            <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</h2>
            <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">"ููุตุฉ ุชูููุฐูุฉ ุฐููุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงููุฑุงูุจุฉ
                ุงูุฑูููุฉุ ุชููุฑ ุฑุคูุฉ ุฏูููุฉ ููุฃุฏุงุก ูุชุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงููุจูู ุนูู ุงูุจูุงูุงุช."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">ุณุฌู
                    ุงูููุงุญุธุงุช ุงูุชูุงุนูู: ุฏูุฉ ุงูุตูุฑุฉ ูุงููุต</h3>
                <p class="mt-3 text-lg text-gray-600">ุนุฑุถ ุชูุตููู ููููุงุญุธุงุช ุงูููุฏุงููุฉ ูุน ุฃุฏูุงุช ุงูุชุญููู ุงูุขูู.</p>
                <button id="add-observation-btn"
                    class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto"
                    onclick="openModal('smartInputModal')">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ (ุงูุฅุฏุฎุงู ุงูุฐูู)
                </button>
            </div>

            <div
                class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">

                <div
                    class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
                    <h4 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">ุชุตููุฉ ุงูููุงุญุธุงุช</h4>
                    <select id="observationFilter"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300"
                        onchange="handleFilterChange()">
                        <option value="ุงููู">ุนุฑุถ ูู ุงูููุงุญุธุงุช</option>
                        <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
                        <option value="ููุฏ ุงูุชูููุฐ">ููุฏ ุงูุชูููุฐ</option>
                        <option value="ุชูุช ุงููุนุงูุฌุฉ">ุชูุช ุงููุนุงูุฌุฉ</option>
                        <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option>
                        <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
                        <option value="ุณูุงูุฉ">ุณูุงูุฉ</option>
                        <option value="ุจูุฆุฉ">ุจูุฆุฉ</option>
                    </select>
                    <h4 class="text-2xl font-bold mt-8 mb-3" style="color: var(--color-navy);">ุงููููุงุญุธููุงุช</h4>
                    <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-center text-gray-500 mt-10">... ุฌุงุฑู ุชุญููู ุงูููุงุญุธุงุช ูู Firebase ...</div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">

                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 class="text-3xl font-extrabold text-gray-900" style="color: var(--color-navy);">ุชูุฑูุฑ Smart
                            HSR ุงูุชูููุฐู</h2>
                        <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
                    </div>

                    <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2"
                        style="color: var(--color-teal);">ุนุฑุถ ุงูุชูุงุตูู ูุงูุชุญููู (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">

                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุนููุงู:</span>
                                <span id="detailTitle" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุชุตููู:</span>
                                <span id="detailType" class="block font-bold text-teal-600"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ุงููููุน:</span>
                                <span id="detailLocation" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุชุงุฑูุฎ ุงูุจูุงุบ:</span>
                                <span id="detailDate" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุญุงูุฉ ุงููุนุงูุฌุฉ:</span>
                                <span id="detailStatus"
                                    class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ูุนุฑู ุงูุจูุงุบ:</span>
                                <span id="detailID" class="block font-bold text-gray-800"></span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
                            <h5 class="text-xl font-bold mb-3" style="color: var(--color-navy);">ูุตู ุงูููุงุญุธุฉ</h5>
                            <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
                            <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                                <h6 class="font-bold text-teal-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ (Gemini AI)</h6>
                                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer"
                            class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
                            <h5 class="text-xl font-bold mb-3 text-green-700">๐ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู</h5>
                            <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
                            <img id="beforeImage" class="before-image w-full h-auto" alt="ุตูุฑุฉ ูุจู ุงูุฅุตูุงุญ"
                                src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            <div id="afterImageContainer" class="after-image">
                                <img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ"
                                    src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            </div>
                            <div id="comparisonDivider" class="comparison-divider no-print">
                                <div class="comparison-divider-handle">
                                    <i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i>
                                </div>
                            </div>
                            <span class="comparison-label label-before no-print">ูุจู</span>
                            <span class="comparison-label label-after no-print">ุจุนุฏ</span>
                        </div>

                        <div id="mediaContainer" class="image-container mb-6 hidden">
                            <div id="mediaContent" class="w-full h-auto rounded-xl">
                            </div>
                            <span class="image-label">ูุฑูู ุงูููุงุญุธุฉ</span>
                        </div>

                        <div id="noImageMessage"
                            class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
                            <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> ูุง ุชุชููุฑ ุตูุฑุฉ ุฃู
                            ููุฏูู ููุฐู ุงูููุงุญุธุฉ.
                        </div>


                        <div id="aiAnalysisSection"
                            class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
                            <h5 class="text-xl font-bold mb-4" style="color: var(--color-navy);">ุฃุฏูุงุช ุงูุชุญููู ุงูุฐูู
                                (Gemini AI)</h5>
                            <div class="flex flex-wrap gap-3 no-print">
                                <button id="vision-btn"
                                    class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('vision')">
                                    <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
                                </button>
                                <button id="root-cause-btn"
                                    class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('root-cause')">
                                    <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู
                                </button>
                                <button id="comm-btn"
                                    class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generateCommunicationDraft()">
                                    <i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
                                </button>
                                <button id="pdf-report-btn"
                                    class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generatePdfReport()">
                                    <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ุชูููุฏ ุชูุฑูุฑ PDF
                                </button>
                            </div>

                            <div id="aiResultContainer"
                                class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color: var(--color-teal);">
                                </h6>
                                <div id="aiResultContent" class="text-gray-700"></div>
                            </div>
                        </div>

                        <div id="actionButtons"
                            class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
                            <button id="updateStatusBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="updateObservationStatus('ููุฏ ุงูุชูููุฐ')">
                                ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ููุฏ ุงูุชูููุฐ"
                            </button>
                            <button id="completeObservationBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="openModal('closeoutModal')">
                                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> ุงูุฅุบูุงู ุงูุชูููุฐู (ุตูุฑุฉ ุจุนุฏ)
                            </button>
                            <button id="alreadyCompletedBtn"
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden"
                                disabled>
                                <i data-lucide="check" class="w-4 h-4 ml-2"></i> ุงูููุงุญุธุฉ ูุบููุฉ ูููุซูุฉ
                            </button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center space-y-4">
                        <p class="text-gray-500 mt-16 text-lg">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุงูุตูุฑุฉ ูุงููุฐูุฑุฉ
                            ุงูุชูุตูููุฉ.</p>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01" />
                        </svg>
                    </div>
                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="my-20 no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐
                    ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุญูููุฉ (Vital Metrics)</h3>
                <p class="mt-3 text-lg text-gray-600">ุชุชุจุน ุงูุจูุงุบุงุช ูุญุงูุฉ ุงูุชูุซูู ุจุงูุตูุฑ ูุถูุงู ููุงุกุฉ ุงูุฅุบูุงู.</p>
            </div>

            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200">
                    <p class="text-xl font-medium text-gray-500">ุฌุงุฑู ุงูุชุญููู...</p>
                    <p class="text-5xl font-extrabold text-gray-700 mt-2">--</p>
                </div>
            </div>

            <div class="mt-12 text-center">
                <button id="kpi-insight-button"
                    class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                    onclick="generateKpiInsights()">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (Gemini AI)
                </button>
                <div id="kpi-insight-result" class="mt-6 text-sm">
                </div>
            </div>
        </section>

        <section id="ai-features"
            class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐ง
                    ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุตููู ุงูุนูููุฉ</h3>
                <p class="mt-3 text-lg text-gray-600">ุงุณุชูุฏ ูู ููุงุฐุฌ Gemini ูุชุญููู ุงูุจูุงูุงุช ุฅูู ูุฑุงุฑุงุช ูุงุจูุฉ ููุชูููุฐ.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #9333ea;">๐๏ธ</span>
                    <h4 class="font-extrabold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุฑุคูุฉ</h4>
                    <p class="text-xs text-gray-600">ูุตู ุงููุดููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุฎุทุฉ ุนูู ุขููุฉ</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ุฎุทูุงุช ุชูููุฐูุฉ ููุนุงูุฌุฉ ุงูููุงุญุธุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">๐จ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูููู ุงููุฎุงุทุฑ</h4>
                    <p class="text-xs text-gray-600">ุชุญุฏูุฏ ุงูุฃููููุฉ ูุงูุฅุทุงุฑ ุงูุฒููู ูู ูููู JSON.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #881337;">๐ฌ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู</h4>
                    <p class="text-xs text-gray-600">ุงูุชุฑุงุญ ุณุจุจ ุฌุฐุฑู ููุตูุญุฉ ููุงุฆูุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #F97316;">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุตูุงุบุฉ ุงูุงุชุตุงู</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ูุณูุฏุฉ ุฃูุฑ ุนูู ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-navy);">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูุฑูุฑ ุงูุฅุบูุงู ุงูุตูุชู</h4>
                    <p class="text-xs text-gray-600">ุชูุฎูุต ุงูุชูุฑูุฑ ูุชุญูููู ุฅูู ููู ุตูุชู.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #10B981;">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุงูุจุญุซ ุนู ุงููุนุงููุฑ</h4>
                    <p class="text-xs text-gray-600">ุงุณุชุฎุฏุงู ุงูุจุญุซ ุงููุฏุนูู ูุงุณุชุญุถุงุฑ ุงููุนุงููุฑ ุงูุนุงูููุฉ.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
            <div class="max-w-6xl mx-auto px-4">
                <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color: var(--color-navy);"> ุงุจุฏุฃ ุฑุญูุฉ ุงูุชุญูู
                    ุงูุฑููู ูุน Smart HSR </h3>
                <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto"> ูุธุงู ุฐูู ููุญูู ุจูุงูุงุช ุงูููุฏุงู ุฅูู
                    ูุฑุงุฑุงุช ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฐููุฉ </p>
                <a href="http://wa.me/966507006849" target="_blank"
                    class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">
                    ุงุทูุจ ุนุฑุถูุง ุชุฌุฑูุจููุง ุงูุขู </a>
                <div class="mt-12 pt-8 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุญูู ุงููุธุงู</h4>
                            <p>ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงูุฏุนู ุงูููู</h4>
                            <p>Blumark24@gmail.com</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงููุจูุนุงุช ูุงูุงุณุชูุณุงุฑุงุช</h4>
                            <p>0507006849</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <p class="mb-2">&copy; 2025 Smart HSR. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
                        <p id="userInfo">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูู Firebase...</p>
                    </div>
                </div>
            </div>
        </footer>

    </main>

    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color: var(--color-navy);">ูุญุฏุฉ ุงูุฅุฏุฎุงู ุงูุฐูู
                ููููุงุญุธุงุช (Smart HSR)</h2>

            <div id="modalStep1">
                <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุฃุฏุฎู ุชูุงุตูู ุงูููุงุญุธุฉ (ุงููุตุ ุงููููุนุ ุงูุตูุฑุฉ/ุงูููุฏูู)</p>
                <textarea id="rawObservationInput" rows="5"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm"
                    placeholder="ูุซุงู: ููุฌุฏ ุชุฌูุน ููููุงู ุนูู ุทุฑูู ุงูุฎุฏูุฉ ุนูุฏ ุงููููู 52 ุจุงุชุฌุงู ุงูุดุฑูุ ูุชุณุจุจ ูู ุงูุฒูุงู ุงูุณูุงุฑุงุช. ูุญุชุงุฌ ุฅูู ุชุตุฑูู ููุฑู."
                    oninput="checkSmartInputState()"></textarea>

                <div class="mt-4 input-group-wrapper">
                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="locationStatus" class="block text-sm font-medium text-gray-700 mb-2">ุงููููุน
                            ุงูุฌุบุฑุงูู (GPS):</label>
                        <p id="locationStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ</p>
                        <input type="hidden" id="inputLatitude">
                        <input type="hidden" id="inputLongitude">
                        <button id="getLocationBtn"
                            class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full text-sm transition duration-150"
                            onclick="getCurrentLocation()">
                            <i data-lucide="map-pin" class="w-4 h-4 inline-block ml-1"></i> ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู
                        </button>
                    </div>

                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="fileUpload" class="block text-sm font-medium text-gray-700 mb-2">ุงูุตูุฑุฉ ุฃู
                            ุงูููุฏูู:</label>
                        <p id="fileNameDisplay" class="text-sm font-semibold text-gray-500 truncate">ูุง ููุฌุฏ ููู ูุญูู</p>
                        <input type="file" id="fileUpload" class="hidden" accept="image/*,video/*,audio/*"
                            onchange="displayFileName(this)">
                        <button id="uploadFileBtn"
                            class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full text-sm transition duration-150"
                            onclick="document.getElementById('fileUpload').click()">
                            <i data-lucide="upload-cloud" class="w-4 h-4 inline-block ml-1"></i> ุงุฎุชูุงุฑ ููู
                        </button>
                    </div>
                </div>


                <div class="mt-8 flex justify-between items-center border-t pt-4">
                    <button id="smartAnalyzeBtn"
                        class="ai-button-primary rounded-full px-6 py-3 text-lg font-bold flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="smartAnalyzeObservation()" disabled>
                        <i data-lucide="sparkles" class="w-5 h-5 ml-2"></i> ุชุญููู ุฐูู ูุชุตููู (Gemini AI)
                    </button>
                    <p id="smartInputMessage" class="text-red-500 text-sm hidden">ูุฌุจ ุฅุฏุฎุงู ุงููุตู ุงููุตู ุฃููุงู</p>
                </div>
            </div>

            <div id="modalStep2" class="hidden">
                <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 2: ูุฑุงุฌุนุฉ ูุชุฃููุฏ ุงูุจูุงูุงุช</p>

                <div class="p-4 bg-teal-50 rounded-xl mb-4 border border-teal-200">
                    <h5 class="text-xl font-bold mb-2 text-teal-800">ูุชุงุฆุฌ ุงูุชุญููู ุงูุฐูู (Gemini AI)</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-medium text-gray-700">ุงูุนููุงู ุงูููุชุฑุญ:</p>
                            <p id="smartTitle" class="font-bold text-teal-700"></p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700">ุงูุชุตููู ุงูููุชุฑุญ:</p>
                            <p id="smartType" class="font-bold text-teal-700"></p>
                        </div>
                        <div class="col-span-2">
                            <p class="font-medium text-gray-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ:</p>
                            <p id="smartActionPlan" class="text-sm text-gray-600 whitespace-pre-wrap"></p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button
                        class="ai-button-secondary rounded-full px-6 py-3 text-lg font-bold flex items-center justify-center"
                        onclick="saveNewObservation()">
                        <i data-lucide="save" class="w-5 h-5 ml-2"></i> ุญูุธ ููููุงุญุธุฉ ุฌุฏูุฏุฉ
                    </button>
                </div>
            </div>

            <div id="loadingSpinnerModal" class="flex justify-center items-center h-20 hidden">
                <div class="loading-spinner" style="border-top: 4px solid var(--color-navy);"></div>
                <p class="text-lg text-gray-600 mr-3">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
            </div>
        </div>
    </div>


    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('closeoutModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">๐ ุชูุซูู ูุฅุบูุงู ุงูููุงุญุธุฉ</h2>

            <div class="p-4 bg-white rounded-xl shadow-inner border mb-6">
                <p class="text-sm font-medium text-gray-500">ุงูููุงุญุธุฉ ุงูุญุงููุฉ:</p>
                <p id="closeoutTitle" class="text-lg font-bold text-gray-800 mb-3"></p>
            </div>

            <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุงุฑูุน ุตูุฑุฉ "ุจุนุฏ ุงูุฅุบูุงู" (ูุทููุจ)</p>

            <div class="input-group-wrapper">
                <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-green-500 transition-colors">
                    <label for="closeoutFileUpload" class="block text-sm font-medium text-gray-700 mb-2">ุตูุฑุฉ ุงูุฅุบูุงู:</label>
                    <p id="closeoutFileNameDisplay" class="text-sm font-semibold text-gray-500 truncate">ูุง ููุฌุฏ ููู ูุญูู</p>
                    <input type="file" id="closeoutFileUpload" class="hidden" accept="image/*"
                        onchange="displayFileName(this, 'closeoutFileNameDisplay'); checkCloseoutState()">
                    <button
                        class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full text-sm transition duration-150"
                        onclick="document.getElementById('closeoutFileUpload').click()">
                        <i data-lucide="image" class="w-4 h-4 inline-block ml-1"></i> ุงุฎุชูุงุฑ ุตูุฑุฉ ุจุนุฏ
                    </button>
                </div>

                <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ุชุณุฌูู ูุฐูุฑุฉ ุตูุชูุฉ (ุงุฎุชูุงุฑู)</label>
                    <p id="voiceNoteStatus" class="text-sm font-semibold text-gray-500">ูุง ููุฌุฏ ุชุณุฌูู</p>
                    <button id="startRecordingBtn"
                        class="mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full text-sm transition duration-150"
                        onclick="startRecording()">
                        <i data-lucide="mic" class="w-4 h-4 inline-block ml-1"></i> ุจุฏุก ุงูุชุณุฌูู
                    </button>
                    <button id="stopRecordingBtn"
                        class="mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full text-sm transition duration-150 hidden"
                        onclick="stopRecording()">
                        <i data-lucide="square" class="w-4 h-4 inline-block ml-1"></i> ุฅููุงู ุงูุชุณุฌูู
                    </button>
                </div>
            </div>

            <p class="text-lg text-gray-600 mt-6 mb-4">ุงูุฎุทูุฉ 2: ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู (ุงููุต ุฃู ุงูุชุณุฌูู ุงูุตูุชู)</p>
            <textarea id="resolutionNoteInput" rows="4"
                class="w-full p-4 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm"
                placeholder="ุตู ุงูุฅุฌุฑุงุกุงุช ุงูุชู ุชู ุงุชุฎุงุฐูุง ูุฅุบูุงู ุงูููุงุญุธุฉ ูุชูุซูู ุญุงูุฉ ุงูุฅุบูุงู."
                oninput="checkCloseoutState()"></textarea>
            <audio id="audioPlayback" controls class="hidden"></audio>


            <div id="audioAnalysisSection" class="mt-6 p-4 bg-gray-100 rounded-xl border border-gray-200 hidden">
                <h5 class="font-bold text-lg mb-2" style="color: var(--color-navy);">ุชุญููู ุงููุฐูุฑุฉ ุงูุตูุชูุฉ (Gemini AI)
                </h5>
                <button id="analyzeAudioBtn"
                    class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="analyzeAudioNote()" disabled>
                    <i data-lucide="sound-wave" class="w-4 h-4 ml-2"></i> ุชูุฎูุต ูุชุญููู ุฅูู ูุต
                </button>
                <div id="audioSummaryResult" class="mt-3 text-sm text-gray-700 whitespace-pre-wrap hidden"></div>
            </div>


            <div id="closeoutActionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end">
                <button id="finalCloseoutBtn"
                    class="ai-button-primary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="finalizeCloseout()">
                    <i data-lucide="check-circle" class="w-5 h-5 ml-2"></i> ุฅุบูุงู ุงูููุงุญุธุฉ ูุชูุซูููุง
                </button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal no-print">
        <div class="modal-content max-w-md">
            <span class="close-btn" onclick="closeModal('alertModal')">&times;</span>
            <h2 id="alertTitle" class="text-2xl font-extrabold mb-4 pb-2 border-b" style="color: var(--color-navy);">ุชูุจูู
            </h2>
            <p id="alertMessage" class="text-gray-700 text-lg"></p>
            <div class="mt-6 flex justify-end">
                <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold"
                    onclick="closeModal('alertModal')">ุญุณูุงู</button>
            </div>
        </div>
    </div>


    <script>
        // --- 1. Firebase Initialization ---

        // ๐๐๐ ูุงู: ุงุณุชุจุฏู ูุฐู ุงููุชุบูุฑุงุช ุจุฅุนุฏุงุฏุงุช ูุดุฑูุนู ุงูุญูููู ๐๐๐
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT_ID_HERE.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID_HERE",
            storageBucket: "YOUR_PROJECT_ID_HERE.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID_HERE",
            appId: "YOUR_APP_ID_HERE"
        };
        // ๐๐๐ ููุงูุฉ ุฅุนุฏุงุฏุงุช Firebase ๐๐๐

        // Initialize Firebase and get service references
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const storage = firebase.storage();
            const auth = firebase.auth(); // (Used for smartLogout/auth checks)

            // Mockup: Expose to global scope for core functions
            window.db = db;
            window.storage = storage;
            window.auth = auth;

        } else {
            console.error("Firebase SDK not loaded. Check script tags.");
        }
        
        // --- Global State ---
        let observationsData = []; // ุงูุจูุงูุงุช ุณุชุฃุชู ูู Firestore ุงูุขู
        let currentSelectedObservation = null;
        let kpis = {};
        let isRecording = false;
        let audioRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let filteredObservations = [];


        // --- Utility Functions ---

        // Helper to display a custom alert message using the modal
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            openModal('alertModal');
        }

        // Handles opening a modal (smartInputModal or closeoutModal)
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex'; // Use flex to center the content
            if (modalId === 'closeoutModal' && currentSelectedObservation) {
                document.getElementById('closeoutTitle').textContent = currentSelectedObservation.title;
            }
        }

        // Handles closing a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';

            // Reset Smart Input Modal after closing
            if (modalId === 'smartInputModal') {
                document.getElementById('modalStep1').classList.remove('hidden');
                document.getElementById('modalStep2').classList.add('hidden');
                document.getElementById('loadingSpinnerModal').classList.add('hidden');
                document.getElementById('rawObservationInput').value = '';
                document.getElementById('fileNameDisplay').textContent = 'ูุง ููุฌุฏ ููู ูุญูู';
                document.getElementById('locationStatus').textContent = 'ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ';
                document.getElementById('inputLatitude').value = '';
                document.getElementById('inputLongitude').value = '';
                document.getElementById('fileUpload').value = '';
                checkSmartInputState();
            }
            // Reset Closeout Modal after closing
            if (modalId === 'closeoutModal') {
                document.getElementById('resolutionNoteInput').value = '';
                document.getElementById('closeoutFileNameDisplay').textContent = 'ูุง ููุฌุฏ ููู ูุญูู';
                document.getElementById('closeoutFileUpload').value = '';
                document.getElementById('audioPlayback').classList.add('hidden');
                document.getElementById('audioPlayback').src = '';
                document.getElementById('voiceNoteStatus').textContent = 'ูุง ููุฌุฏ ุชุณุฌูู';
                document.getElementById('audioAnalysisSection').classList.add('hidden');
                document.getElementById('audioSummaryResult').classList.add('hidden');
                audioBlob = null;
                checkCloseoutState();
            }
        }

        // Displays the selected file name in the modal
        function displayFileName(input, targetId = 'fileNameDisplay') {
            const display = document.getElementById(targetId);
            if (input.files.length > 0) {
                display.textContent = input.files[0].name;
            } else {
                display.textContent = 'ูุง ููุฌุฏ ููู ูุญูู';
            }
            if (targetId === 'closeoutFileNameDisplay') {
                checkCloseoutState();
            }
            checkSmartInputState();
        }

        // Gets the user's current GPS location
        function getCurrentLocation() {
            const statusElement = document.getElementById('locationStatus');
            statusElement.textContent = 'ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('inputLatitude').value = lat;
                        document.getElementById('inputLongitude').value = lng;
                        statusElement.textContent = `ุชู ุงูุชุญุฏูุฏ: ุฎุท ุนุฑุถ ${lat.toFixed(4)}, ุฎุท ุทูู ${lng.toFixed(4)}`;
                        checkSmartInputState();
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        statusElement.textContent = 'ูุดู ุชุญุฏูุฏ ุงููููุน.';
                        showAlert("ุฎุทุฃ ูู ุงููููุน ุงูุฌุบุฑุงูู", "ุชุนุฐุฑ ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู. ูุฑุฌู ุงูุชุฃูุฏ ูู ุณูุงุญ ุงููุชุตูุญ ุจุงููุตูู ุฅูู ุงููููุน.");
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                statusElement.textContent = 'ุงููุชุตูุญ ูุง ูุฏุนู ุงููููุน.';
                showAlert("ุฎุทุฃ ูู ุงููุชุตูุญ", "ุงููุชุตูุญ ูุง ูุฏุนู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู.");
            }
        }

        // Enables/disables the Smart Analyze button
        function checkSmartInputState() {
            const input = document.getElementById('rawObservationInput').value.trim();
            const analyzeBtn = document.getElementById('smartAnalyzeBtn');
            const message = document.getElementById('smartInputMessage');
            if (input.length > 5) {
                analyzeBtn.disabled = false;
                message.classList.add('hidden');
            } else {
                analyzeBtn.disabled = true;
                message.classList.remove('hidden');
            }
        }

        // Enables/disables the Final Closeout button
        function checkCloseoutState() {
            const imageFile = document.getElementById('closeoutFileUpload').files.length > 0;
            const noteText = document.getElementById('resolutionNoteInput').value.trim().length > 5;
            const finalCloseoutBtn = document.getElementById('finalCloseoutBtn');
            const analyzeAudioBtn = document.getElementById('analyzeAudioBtn');

            // Final Closeout Button logic: requires Image AND (Text OR Audio Blob)
            const isAudioReady = audioBlob !== null;
            if (imageFile && (noteText || isAudioReady)) {
                finalCloseoutBtn.disabled = false;
            } else {
                finalCloseoutBtn.disabled = true;
            }

            // Audio Analysis Button logic: requires Audio Blob
            if (isAudioReady) {
                analyzeAudioBtn.disabled = false;
                document.getElementById('audioAnalysisSection').classList.remove('hidden');
            } else {
                analyzeAudioBtn.disabled = true;
                document.getElementById('audioAnalysisSection').classList.add('hidden');
            }
        }

        // Date formatter utility
        function formatObservationDate(timestamp) {
            const date = timestamp instanceof firebase.firestore.Timestamp ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Status badge color utility
        function getStatusClass(status) {
            switch (status) {
                case 'ุฌุฏูุฏ':
                    return 'bg-blue-500';
                case 'ููุฏ ุงูุชูููุฐ':
                    return 'bg-yellow-500';
                case 'ุชูุช ุงููุนุงูุฌุฉ':
                    return 'bg-green-600';
                default:
                    return 'bg-gray-500';
            }
        }

        // --- 2. Firestore/Storage Integration Functions ---

        async function fetchObservations() {
            if (typeof db === 'undefined') {
                document.getElementById('observationsList').innerHTML = `<div class="text-center text-red-500 mt-10 p-4 bg-red-100 rounded-lg">ุฎุทุฃ: Firebase ุบูุฑ ูููุฃ. ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุฅุนุฏุงุฏุงุช.</div>`;
                return;
            }
            
            document.getElementById('observationsList').innerHTML = `<div class="text-center text-gray-500 mt-10">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>`;
            document.getElementById('userInfo').textContent = 'ุฌุงุฑู ุงูุงุชุตุงู ุจู Firestore...';


            try {
                // Fetch all documents from the 'observations' collection, ordered by creation date
                const snapshot = await db.collection('observations').orderBy('date', 'desc').get();
                
                observationsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        docId: doc.id, // ุชุฎุฒูู ID ุงููุซููุฉ ูุงุณุชุฎุฏุงูู ูู ุงูุชุญุฏูุซ ูุงูุฅุบูุงู
                        id: doc.id, // ุงุณุชุฎุฏุงู doc.id ููุนุฑู ุฑุฆูุณู ููุนุฑุถ
                        date: data.date ? data.date.toDate().getTime() : new Date().getTime() // ุชุญููู Timestamp ุฅูู JavaScript Date
                    };
                });
                
                document.getElementById('userInfo').textContent = `ุชู ุชุญููู ${observationsData.length} ููุงุญุธุฉ ุจูุฌุงุญ ูู Firestore.`;
                calculateAndRenderAll();
                
                if (observationsData.length === 0) {
                    document.getElementById('observationsList').innerHTML = `<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-lg">ูุง ุชูุฌุฏ ููุงุญุธุงุช ุญุงูููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.</div>`;
                }

            } catch (error) {
                console.error("Error fetching observations:", error);
                document.getElementById('observationsList').innerHTML = `<div class="text-center text-red-500 mt-10 p-4 bg-red-100 rounded-lg">ูุดู ุชุญููู ุงูููุงุญุธุงุช: ${error.message}</div>`;
                document.getElementById('userInfo').textContent = 'ูุดู ุงูุงุชุตุงู ุจู Firestore.';
            }
        }

        async function updateObservationStatus(newStatus) {
            if (!currentSelectedObservation || typeof db === 'undefined') return;

            try {
                // ุชุญุฏูุซ ุญุงูุฉ ุงูููุงุญุธุฉ ูู Firestore
                await db.collection('observations').doc(currentSelectedObservation.docId).update({
                    status: newStatus
                });
                
                // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ ูุฅุนุงุฏุฉ ุงูุนุฑุถ
                const index = observationsData.findIndex(obs => obs.docId === currentSelectedObservation.docId);
                if (index !== -1) {
                    observationsData[index].status = newStatus;
                    currentSelectedObservation.status = newStatus;
                }

                showAlert("ูุฌุงุญ ุงูุชุญุฏูุซ", `ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูููุงุญุธุฉ HSR-${currentSelectedObservation.docId.substring(0, 8)} ุฅูู "${newStatus}" ุจูุฌุงุญ.`);
                
                // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุชูุงุตูู ูุงููุงุฆูุฉ
                handleFilterChange();
                showObservationDetail(currentSelectedObservation.docId);


            } catch (error) {
                console.error("Error updating status:", error);
                showAlert("ุฎุทุฃ", `ูุดู ุชุญุฏูุซ ุงูุญุงูุฉ: ${error.message}`);
            }
        }

        // --- Main Rendering Functions ---

        // Renders the list of observations on the left sidebar
        function renderObservationsList(observations) {
            const listElement = document.getElementById('observationsList');
            listElement.innerHTML = ''; // Clear existing list

            if (observations.length === 0) {
                listElement.innerHTML = `<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-lg">ูุง ุชูุฌุฏ ููุงุญุธุงุช ูุทุงุจูุฉ ููุนุงููุฑ ุงูุชุตููุฉ ุงููุญุฏุฏุฉ.</div>`;
                document.getElementById('observationDetail').classList.add('hidden');
                document.getElementById('detailPlaceholder').classList.remove('hidden');
                return;
            }

            observations.forEach(obs => {
                const item = document.createElement('div');
                // ูุณุชุฎุฏู docId ููุนุฑู ูุฑูุฏ ููุถุบุท ุนููู
                item.className = `observation-item p-3 border-b border-gray-200 rounded-xl hover:shadow-md transition duration-200 ${currentSelectedObservation && currentSelectedObservation.docId === obs.docId ? 'active' : ''}`;
                item.setAttribute('onclick', `showObservationDetail('${obs.docId}')`);
                item.innerHTML = `
                    <p class="font-bold truncate text-lg">${obs.title}</p>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <span class="font-medium text-gray-500">${obs.location}</span>
                        <span class="inline-block px-2 py-1 ${getStatusClass(obs.status)} text-white rounded-full font-semibold">${obs.status}</span>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        // Displays the detailed view of a selected observation
        function showObservationDetail(docId) {
            // ูุณุชุฎุฏู docId ููุง ูุฃููุง ุงููุนุฑู ุงููุฑูุฏ ูู Firestore
            const obs = observationsData.find(o => o.docId === docId);
            if (!obs) return;

            currentSelectedObservation = obs;

            // 1. Reset & Show Main Detail Pane
            document.getElementById('detailPlaceholder').classList.add('hidden');
            document.getElementById('observationDetail').classList.remove('hidden');
            document.getElementById('aiResultContainer').classList.add('hidden');
            document.getElementById('resolutionNoteContainer').classList.add('hidden');
            document.getElementById('actionPlanContainer').classList.add('hidden');
            document.getElementById('mediaContainer').classList.add('hidden');
            document.getElementById('imageComparisonWrapper').classList.add('hidden');
            document.getElementById('noImageMessage').classList.add('hidden');
            document.getElementById('alreadyCompletedBtn').classList.add('hidden');
            document.getElementById('updateStatusBtn').classList.remove('hidden');
            document.getElementById('completeObservationBtn').classList.remove('hidden');
            document.getElementById('pdf-report-btn').disabled = false;


            // 2. Render core details
            document.getElementById('detailTitle').textContent = obs.title;
            document.getElementById('detailType').textContent = obs.type;
            document.getElementById('detailLocation').textContent = obs.location;
            document.getElementById('detailDate').textContent = formatObservationDate(obs.date);
            document.getElementById('detailDescription').textContent = obs.description;
            document.getElementById('detailID').textContent = `HSR-${obs.docId.substring(0, 8)}`; // ุนุฑุถ ุฌุฒุก ูู ุงูู ID


            // 3. Status Badge
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = obs.status;
            statusElement.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${getStatusClass(obs.status)}`;

            // 4. Action Plan (If available from AI/Mockup)
            if (obs.actionPlan) {
                document.getElementById('actionPlan').textContent = obs.actionPlan;
                document.getElementById('actionPlanContainer').classList.remove('hidden');
            } else {
                document.getElementById('actionPlanContainer').classList.add('hidden');
            }

            // 5. Resolution Note (If closed)
            if (obs.status === 'ุชูุช ุงููุนุงูุฌุฉ' && obs.resolutionNote) {
                document.getElementById('resolutionNote').textContent = obs.resolutionNote;
                document.getElementById('resolutionNoteContainer').classList.remove('hidden');
                document.getElementById('updateStatusBtn').classList.add('hidden');
                document.getElementById('completeObservationBtn').classList.add('hidden');
                document.getElementById('alreadyCompletedBtn').classList.remove('hidden');
                document.getElementById('pdf-report-btn').disabled = false;

            }

            // 6. Media Display (Before/After or Single)
            const mediaContent = document.getElementById('mediaContent');
            mediaContent.innerHTML = '';
            document.getElementById('vision-btn').disabled = false;


            if (obs.isComparative && obs.resolutionMediaUrl) {
                // COMPARATIVE VIEW (Before/After)
                document.getElementById('imageComparisonWrapper').classList.remove('hidden');
                document.getElementById('mediaContainer').classList.add('hidden');
                document.getElementById('beforeImage').src = obs.mediaUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
                document.getElementById('afterImage').src = obs.resolutionMediaUrl;
                setupImageComparison();
                // Disable Vision button for comparative view, as it's complex for single-prompt analysis
                document.getElementById('vision-btn').disabled = true;

            } else if (obs.mediaUrl && obs.mediaType !== 'none') {
                // SINGLE MEDIA VIEW
                document.getElementById('mediaContainer').classList.remove('hidden');
                document.getElementById('imageComparisonWrapper').classList.add('hidden');
                document.getElementById('vision-btn').disabled = false;


                if (obs.mediaType === 'image') {
                    mediaContent.innerHTML = `<img src="${obs.mediaUrl}" alt="ูุฑูู ุงูููุงุญุธุฉ" class="w-full h-auto rounded-xl">`;
                } else if (obs.mediaType === 'video') {
                    mediaContent.innerHTML = `<video controls src="${obs.mediaUrl}" class="w-full h-auto rounded-xl"></video>`;
                } else if (obs.mediaType === 'audio') {
                     // Display a placeholder image for audio
                    mediaContent.innerHTML = `<img src="audio_placeholder.svg" alt="ูุฑูู ุตูุชู" class="w-full h-auto rounded-xl" style="max-height: 400px; object-fit: contain; background-color: #f0f0f0; padding: 20px;">
                                              <audio controls src="${obs.mediaUrl}" class="mt-4 w-full"></audio>`;
                    document.getElementById('vision-btn').disabled = true;
                }
            } else {
                // NO MEDIA
                document.getElementById('mediaContainer').classList.add('hidden');
                document.getElementById('imageComparisonWrapper').classList.add('hidden');
                document.getElementById('noImageMessage').classList.remove('hidden');
                document.getElementById('vision-btn').disabled = true; // Cannot analyze if no image
            }


            // 7. Re-render list to highlight active item
            renderObservationsList(filteredObservations);

            // 8. Re-render Lucide icons for the detail pane
            lucide.createIcons();
        }

        // --- Filtering Logic ---
        function handleFilterChange() {
            const filterValue = document.getElementById('observationFilter').value;

            if (filterValue === 'ุงููู') {
                filteredObservations = observationsData;
            } else if (['ุฌุฏูุฏ', 'ููุฏ ุงูุชูููุฐ', 'ุชูุช ุงููุนุงูุฌุฉ'].includes(filterValue)) {
                filteredObservations = observationsData.filter(obs => obs.status === filterValue);
            } else if (['ุฌูุฏุฉ', 'ุตูุงูุฉ', 'ุณูุงูุฉ', 'ุจูุฆุฉ'].includes(filterValue)) {
                filteredObservations = observationsData.filter(obs => obs.type === filterValue);
            } else {
                filteredObservations = observationsData; // Default to all
            }

            // Ensure the detail pane is reset if the selected observation is no longer in the filtered list
            if (currentSelectedObservation && !filteredObservations.find(obs => obs.docId === currentSelectedObservation.docId)) {
                currentSelectedObservation = null;
                document.getElementById('observationDetail').classList.add('hidden');
                document.getElementById('detailPlaceholder').classList.remove('hidden');
            } else if (currentSelectedObservation) {
                // If it is in the list, re-show it to ensure button states/etc are correct
                showObservationDetail(currentSelectedObservation.docId);
            }

            renderObservationsList(filteredObservations);
        }

        // --- KPI Logic ---

        function calculateKPIs() {
            kpis.totalObservations = observationsData.length;
            kpis.openObservations = observationsData.filter(obs => obs.status !== 'ุชูุช ุงููุนุงูุฌุฉ').length;
            kpis.closedObservations = observationsData.filter(obs => obs.status === 'ุชูุช ุงููุนุงูุฌุฉ').length;
            kpis.totalImages = observationsData.filter(obs => obs.mediaUrl && obs.mediaType === 'image' || obs.mediaType === 'video').length;
            kpis.imagesWithResolution = observationsData.filter(obs => obs.resolutionMediaUrl).length;
            kpis.missingResolutionImage = observationsData.filter(obs => obs.status === 'ุชูุช ุงููุนุงูุฌุฉ' && !obs.resolutionMediaUrl).length;
            kpis.imageClosureRate = kpis.closedObservations > 0 ? ((kpis.imagesWithResolution / kpis.closedObservations) * 100).toFixed(1) : 0;
        }

        function renderKPIs() {
            const kpiContainer = document.getElementById('kpiContainer');
            kpiContainer.innerHTML = ''; // Clear placeholders

            const kpiList = [
                {
                    title: "ุฅุฌูุงูู ุงูููุงุญุธุงุช",
                    value: kpis.totalObservations,
                    icon: "list-checks",
                    gradient: "kpi-images-gradient"
                },
                {
                    title: "ููุงุญุธุงุช ููุชูุญุฉ",
                    value: kpis.openObservations,
                    icon: "clipboard-list",
                    gradient: "kpi-open-gradient"
                },
                {
                    title: "ููุงุญุธุงุช ูุบููุฉ",
                    value: kpis.closedObservations,
                    icon: "check-circle",
                    gradient: "kpi-closed-gradient"
                },
                {
                    title: "ูุณุจุฉ ุชูุซูู ุงูุฅุบูุงู ุจุงูุตูุฑุฉ",
                    value: `${kpis.imageClosureRate}%`,
                    icon: "camera",
                    gradient: kpis.imageClosureRate < 100 ? "kpi-missing-gradient" : "kpi-closed-gradient",
                    subtitle: `(ุชู ุชูุซูู ${kpis.imagesWithResolution} ูู ${kpis.closedObservations} ููุงุญุธุฉ ูุบููุฉ)`
                }
            ];

            kpiList.forEach(kpi => {
                const card = document.createElement('div');
                card.className = `kpi-card-professional p-6 rounded-2xl shadow-xl ${kpi.gradient} flex items-center justify-between`;
                card.innerHTML = `
                    <div>
                        <p class="text-xl font-medium mb-1 text-white opacity-80">${kpi.title}</p>
                        <p class="text-5xl font-extrabold mt-1">${kpi.value}</p>
                        ${kpi.subtitle ? `<p class="text-sm mt-2 font-medium opacity-80">${kpi.subtitle}</p>` : ''}
                    </div>
                    <i data-lucide="${kpi.icon}" class="w-12 h-12 opacity-30"></i>
                `;
                kpiContainer.appendChild(card);
            });

            lucide.createIcons(); // Re-render Lucide icons for new KPI cards
        }


        // --- Gemini AI Mockup Functions ---

        // Simulates the Smart Analyze function for new observation input
        function smartAnalyzeObservation() {
            const input = document.getElementById('rawObservationInput').value;
            const step1 = document.getElementById('modalStep1');
            const step2 = document.getElementById('modalStep2');
            const loading = document.getElementById('loadingSpinnerModal');

            step1.classList.add('hidden');
            loading.classList.remove('hidden');

            // Mockup delay for AI analysis
            setTimeout(() => {
                loading.classList.add('hidden');
                step2.classList.remove('hidden');

                // Mock AI response generation based on a quick analysis
                let smartTitle = "ุชุตููู ูุชุญููู ูุจุฏุฆู";
                let smartType = "ุนุงู";
                let smartActionPlan = "ูู ูุชู ุชุญุฏูุฏ ุฎุทุฉ ุนูู ุจุนุฏุ ูุฑุฌู ุงููุฑุงุฌุนุฉ ุงููุฏููุฉ.";

                if (input.includes("ููุงู") || input.includes("ุตุฑู ุตุญู") || input.includes("ุจูุฆุฉ")) {
                    smartTitle = "ูุดููุฉ ุจูุฆูุฉ: ุชุณุฑุจ ุฃู ุชุฌูุน ููุงู";
                    smartType = "ุจูุฆุฉ";
                    smartActionPlan = "ุชุญุฏูุฏ ูุตุฏุฑ ุงูุชุณุฑุจุ ุชูููุฑ ุชุตุฑูู ููุฑู ููููุงู ุงููุชุฌูุนุฉุ ูุฅุตูุงุญ ุงูุฃูุงุจูุจ ุงููุชุถุฑุฑุฉ ูู ุงูููุทูุฉ.";
                } else if (input.includes("ุฅุณููุช") || input.includes("ุชุดูู") || input.includes("ุตูุงูุฉ")) {
                    smartTitle = "ููุงุญุธุฉ ุตูุงูุฉ: ุชูู ุงูุทุฑู";
                    smartType = "ุตูุงูุฉ";
                    smartActionPlan = "ุฅุฌุฑุงุก ูุณุญ ูุชูููู ุนูู ุงูุชุดููุงุชุ ุชุทุจูู ุฑูุนุฉ ุฅุณููุชูุฉ ุณุงุฎูุฉุ ูุชุฌุฏูุฏ ุทุจูุฉ ุงูุญูุงูุฉ ุงูุณุทุญูุฉ ููููุทูุฉ.";
                } else if (input.includes("ุณูุงูุฉ") || input.includes("ุฎุทุฑ") || input.includes("ุชุญุฐูุฑ")) {
                    smartTitle = "ุชุญุฐูุฑ ุณูุงูุฉ: ุฎุทุฑ ูุดูู ูู ุงููููุน";
                    smartType = "ุณูุงูุฉ";
                    smartActionPlan = "ูุดุฑ ุนูุงูุงุช ุชุญุฐูุฑ ููุฑูุฉุ ุฅุบูุงู ุงูููุทูุฉ ุงููุชุถุฑุฑุฉ ุฌุฒุฆูุงูุ ูุฅุฑุณุงู ูุฑูู ุณูุงูุฉ ูููุนุงููุฉ.";
                }

                document.getElementById('smartTitle').textContent = smartTitle;
                document.getElementById('smartType').textContent = smartType;
                document.getElementById('smartActionPlan').textContent = smartActionPlan;

            }, 2000);
        }

        // Simulates saving a new observation (Integrated with Firebase Storage/Firestore)
        async function saveNewObservation() {
            if (typeof db === 'undefined' || typeof storage === 'undefined') {
                showAlert("ุฎุทุฃ", "ุฎุฏูุงุช Firebase ุบูุฑ ูููุฃุฉ. ูุง ูููู ุงูุญูุธ.");
                return;
            }

            const rawInput = document.getElementById('rawObservationInput').value;
            const smartTitle = document.getElementById('smartTitle').textContent;
            const smartType = document.getElementById('smartType').textContent;
            const smartActionPlan = document.getElementById('smartActionPlan').textContent;
            const latitude = document.getElementById('inputLatitude').value;
            const longitude = document.getElementById('inputLongitude').value;
            const fileInput = document.getElementById('fileUpload').files[0];

            document.getElementById('loadingSpinnerModal').classList.remove('hidden');

            try {
                let mediaUrl = null;
                let mediaType = 'none';

                // 1. **ุฑูุน ุงูููู ุฅูู Firebase Storage**
                if (fileInput) {
                    const mediaRef = storage.ref().child(`observations/${Date.now()}_${fileInput.name}`);
                    const uploadTask = await mediaRef.put(fileInput);
                    mediaUrl = await uploadTask.ref.getDownloadURL();
                    mediaType = fileInput.type.includes('image') ? 'image' : fileInput.type.includes('video') ? 'video' : fileInput.type.includes('audio') ? 'audio' : 'other';
                }

                let newLocation = latitude && longitude ? `ุฎุท ุนุฑุถ ${parseFloat(latitude).toFixed(4)}, ุฎุท ุทูู ${parseFloat(longitude).toFixed(4)}` : "ูููุน ุบูุฑ ูุญุฏุฏ";

                // 2. **ุฅูุดุงุก ูุงุฆู ุงูุจูุงูุงุช (Payload)**
                const newObservationData = {
                    title: smartTitle,
                    type: smartType,
                    status: "ุฌุฏูุฏ",
                    location: newLocation,
                    description: rawInput,
                    date: firebase.firestore.FieldValue.serverTimestamp(), // ุงุณุชุฎุฏู ููุช ุงูุฎุงุฏู
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    latitude: latitude || null,
                    longitude: longitude || null,
                    isComparative: false,
                    actionPlan: smartActionPlan,
                    resolutionNote: null,
                    resolutionMediaUrl: null,
                    voiceNoteUrl: null,
                    voiceNoteText: null,
                    riskAssessment: {
                        priority: smartType === 'ุณูุงูุฉ' ? 'ุนุงุฌู' : smartType === 'ุตูุงูุฉ' ? 'ูุชูุณุท' : 'ููุฎูุถ',
                        timeframe: smartType === 'ุณูุงูุฉ' ? '24 ุณุงุนุฉ' : 'ุฃุณุจูุน',
                        details: 'ุชู ุงูุชูุฏูุฑ ุจูุงุกู ุนูู ุงูุชุญููู ุงูุฐูู ุงููุจุฏุฆู.'
                    }
                };

                // 3. **ุญูุธ ุงููุงุฆู ูู Firestore**
                const docRef = await db.collection('observations').add(newObservationData);
                
                showAlert("ูุฌุงุญ ุงูุฅุถุงูุฉ", `ุชู ุฅุถุงูุฉ ุงูููุงุญุธุฉ ุงูุฌุฏูุฏุฉ ุจูุฌุงุญ ุจุงููุนุฑูู HSR-${docRef.id.substring(0, 8)}.`);
                closeModal('smartInputModal');
                
                // ุฅุนุงุฏุฉ ุฌูุจ ุงูุจูุงูุงุช ูุชุญุฏูุซ ููุญุฉ ุงูููุงุฏุฉ
                await fetchObservations(); 
                showObservationDetail(docRef.id); 

            } catch (error) {
                console.error("Error saving observation:", error);
                showAlert("ุฎุทุฃ ูู ุงูุญูุธ", `ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูููุงุญุธุฉ: ${error.message}`);
            } finally {
                document.getElementById('loadingSpinnerModal').classList.add('hidden');
            }
        }


        // Simulates the AI Vision/Root Cause analysis
        function analyzeImage(tool) {
            if (!currentSelectedObservation || !currentSelectedObservation.mediaUrl) {
                showAlert("ุฎุทุฃ", "ูุฌุจ ุงุฎุชูุงุฑ ููุงุญุธุฉ ุชุญุชูู ุนูู ูุฑูู ุตูุฑุฉ ุฃู ููุฏูู ูุฅุฌุฑุงุก ุงูุชุญููู.");
                return;
            }

            const isVision = tool === 'vision';
            const buttonId = isVision ? 'vision-btn' : 'root-cause-btn';
            const buttonText = isVision ? 'ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)' : 'ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู';
            const buttonElement = document.getElementById(buttonId);
            const aiResultContainer = document.getElementById('aiResultContainer');
            const aiResultTitle = document.getElementById('aiResultTitle');
            const aiResultContent = document.getElementById('aiResultContent');

            // Start loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<div class="loading-spinner"></div> ุฌุงุฑู ุงููุนุงูุฌุฉ...`;
            aiResultContainer.classList.add('hidden');

            // Mockup delay for AI analysis
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.innerHTML = `<i data-lucide="${isVision ? 'eye' : 'microscope'}" class="w-4 h-4 ml-2"></i> ${buttonText}`;
                aiResultContainer.classList.remove('hidden');

                if (isVision) {
                    // Mock Vision Analysis
                    aiResultTitle.textContent = "๐๏ธ ุชุญููู ุงูุฑุคูุฉ ุงููุชูุฏู (Vision Analysis)";
                    aiResultContent.innerHTML = `
                        <p class="font-bold mb-2">ูุตู ุฏููู ูููุดูุฏ:</p>
                        <p>${currentSelectedObservation.description.replace('ููุฌุฏ', 'ูุธูุฑ ุจูุถูุญ ูุฌูุฏ')}ุ ูุน ุชุญุฏูุฏ ุฏููู ูููููุน. ูุจุฏู ุฃู ุงูุถุฑุฑ ูุชุทูุจ ุชุฏุฎูุงู ููุฑูุงู.</p>
                        <p class="font-bold mt-3 mb-2">ุชูููู ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ:</p>
                        <ul class="list-disc pr-5 text-sm leading-relaxed">
                            <li><i data-lucide="check" class="w-4 h-4 inline text-green-600 ml-1"></i> ุฅุฒุงูุฉ ุงููุณุจุจ ุงูุฑุฆูุณู ูููุดููุฉ (ูุซูุงู: ุชุตุฑูู ุงูููุงู ุฃู ุฅุตูุงุญ ุงูุฅุณููุช).</li>
                            <li><i data-lucide="check" class="w-4 h-4 inline text-green-600 ml-1"></i> ุชูุซูู ุงูุฅุบูุงู ุจุตูุฑุฉ ูุงุถุญุฉ ุชูุธูุฑ ุงุณุชุนุงุฏุฉ ุงูุญุงูุฉ ุงูุฃุตููุฉ ูููููุน.</li>
                            <li><i data-lucide="check" class="w-4 h-4 inline text-green-600 ml-1"></i> ุงูุชุฃูุฏ ูู ูุทุงุจูุฉ ุงูุฅุตูุงุญ ููุนุงููุฑ ุงูุฌูุฏุฉ (ุงูุฌูุฏุฉ).</li>
                        </ul>
                    `;
                } else {
                    // Mock Root Cause Analysis
                    aiResultTitle.textContent = "๐ฌ ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู (Root Cause Analysis)";
                    aiResultContent.innerHTML = `
                        <p class="font-bold mb-2">ุงูุณุจุจ ุงูุฌุฐุฑู ุงูููุชุฑุญ (5 Why's):</p>
                        <p class="communication-draft p-4">
                            <strong>ุงููุดููุฉ:</strong> ${currentSelectedObservation.title}
                            <br>
                            <strong>ุงูุณุจุจ 1 (ููุงุฐุงุ):</strong> ุถุนู ูู ุฅุฌุฑุงุกุงุช ุงููุฑุงูุจุฉ ุงูุฏูุฑูุฉ (ุตูุงูุฉ)
                            <br>
                            <strong>ุงูุณุจุจ 2 (ููุงุฐุงุ):</strong> ุนุฏู ุชููุฑ ููุงุฆู ูุญุต ูุญุฏุฏุฉ ููุนูุงุตุฑ ุงูุญุฑุฌุฉ (ุฌูุฏุฉ)
                            <br>
                            <strong>ุงูุณุจุจ ุงูุฌุฐุฑู ุงูููุงุฆู:</strong> ุบูุงุจ ูุธุงู ุขูู ูููุฑุงูุจุฉ ูุงูุชูุจูู ุงููุจูุฑ (ุนูููุฉ)
                        </p>
                        <p class="font-bold mt-3 mb-2 text-red-700">ุชูุตูุฉ ููุงุฆูุฉ (Preventive Action):</p>
                        <p class="text-sm">ูุฌุจ ุชุทุจูู ูุธุงู ุขูู ูููุฑุงูุจุฉ ุงูุฑูููุฉ ูุงูุชูุจูู ุงููุณุจู ูุชูููู ุงูุงุนุชูุงุฏ ุนูู ุงููุญุต ุงูุจุดุฑู ูู ุงูููุงุทู ุงูุญุฑุฌุฉุ ูุน ุชูููุฑ ุชุฏุฑูุจ ููุซู ููุฑูู ุงูุตูุงูุฉ ุนูู ุฃุณุงููุจ ุงููุดู ุงููุจูุฑ ุนู ุงูุฃุนุทุงู.</p>
                    `;
                }
                lucide.createIcons();
            }, 2500);
        }

        // Simulates generating a communication draft (Work Order/Email)
        function generateCommunicationDraft() {
            if (!currentSelectedObservation) {
                showAlert("ุฎุทุฃ", "ูุฌุจ ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู ูุตูุงุบุฉ ุฃูุฑ ุงูุนูู.");
                return;
            }

            const buttonElement = document.getElementById('comm-btn');
            const aiResultContainer = document.getElementById('aiResultContainer');
            const aiResultTitle = document.getElementById('aiResultTitle');
            const aiResultContent = document.getElementById('aiResultContent');

            // Start loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<div class="loading-spinner"></div> ุฌุงุฑู ุงูุตูุงุบุฉ...`;
            aiResultContainer.classList.add('hidden');

            // Mockup delay for AI generation
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.innerHTML = `<i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู`;
                aiResultContainer.classList.remove('hidden');

                aiResultTitle.textContent = "โ๏ธ ูุณูุฏุฉ ุฃูุฑ ุนูู / ุจุฑูุฏ ุฅููุชุฑููู (Work Order Draft)";
                aiResultContent.innerHTML = `
                    <p class="font-bold mb-2">ุงููุณูุฏุฉ ุงูุชููุงุฆูุฉ:</p>
                    <div class="communication-draft p-4 border rounded-xl shadow-sm bg-white">
                        <p class="font-bold text-lg mb-2">ุฅูู: ูุฑูู ${currentSelectedObservation.type}</p>
                        <p class="font-bold mb-2">ุงูููุถูุน: ุฃูุฑ ุนูู ุนุงุฌู - ูุนุงูุฌุฉ ${currentSelectedObservation.title}</p>
                        <hr class="my-3">
                        <p><strong>ุงููููุน:</strong> ${currentSelectedObservation.location}</p>
                        <p><strong>ูุนุฑู ุงูุจูุงุบ:</strong> HSR-${currentSelectedObservation.docId.substring(0, 8)}</p>
                        <p><strong>ุงูุฃููููุฉ (AI):</strong> ${currentSelectedObservation.riskAssessment.priority}</p>
                        <p><strong>ูุตู ุงููุดููุฉ:</strong> ${currentSelectedObservation.description}</p>
                        <br>
                        <p class="font-bold">ุงูุฅุฌุฑุงุก ุงููุทููุจ (ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ ูู AI):</p>
                        <p class="border-r-4 border-teal-500 pr-3 my-2 text-sm">${currentSelectedObservation.actionPlan || 'ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุตูุฑุฉ ุงููุฑููุฉ ูุงุชุฎุงุฐ ุงูุฅุฌุฑุงุก ุงูุชุตุญูุญู ุงููุงุฒู ููุฑุงู.'}</p>
                        <br>
                        <p>ูุฑุฌู ูููู ุงุชุฎุงุฐ ุงูุฅุฌุฑุงุกุงุช ุงููุงุฒูุฉ ูุฅููุงุก ุงูููุงุญุธุฉ ูุชูุซูู ุงูุฅุบูุงู ุจุตูุฑุฉ 'ุจุนุฏ' ุฎูุงู ุงูุฅุทุงุฑ ุงูุฒููู ุงููุญุฏุฏ: ${currentSelectedObservation.riskAssessment.timeframe}.</p>
                        <p class="mt-4">ูุน ุงูุดูุฑุ<br>ูุธุงู Smart HSR ูููุฑุงูุจุฉ.</p>
                    </div>
                `;
                lucide.createIcons();
            }, 1500);
        }

        // Simulates finalizing the closeout of an observation (Integrated with Firebase Storage/Firestore)
        async function finalizeCloseout() {
            if (!currentSelectedObservation || currentSelectedObservation.status === 'ุชูุช ุงููุนุงูุฌุฉ' || typeof db === 'undefined' || typeof storage === 'undefined') {
                showAlert("ุฎุทุฃ", "ุงูููุงุญุธุฉ ุงูุญุงููุฉ ุฅูุง ุบูุฑ ูุญุฏุฏุฉ ุฃู ุชู ุฅุบูุงููุง ูุณุจูุงูุ ุฃู Firebase ุบูุฑ ูููุฃ.");
                return;
            }

            const resolutionNote = document.getElementById('resolutionNoteInput').value.trim();
            const closeoutFile = document.getElementById('closeoutFileUpload').files[0];
            const finalCloseoutBtn = document.getElementById('finalCloseoutBtn');

            if (!closeoutFile) {
                 showAlert("ุฎุทุฃ", "ุงูุฑุฌุงุก ุฑูุน ุตูุฑุฉ 'ุจุนุฏ ุงูุฅุบูุงู' ูุชูุซูู ุงูุฅุฌุฑุงุก.");
                 return;
            }

            // Start loading state
            finalCloseoutBtn.disabled = true;
            finalCloseoutBtn.innerHTML = `<div class="loading-spinner"></div> ุฌุงุฑู ุงูุฅุบูุงู...`;
            closeModal('closeoutModal'); // Close the input modal to show the dashboard loading (in a real app, you'd show a dedicated loading screen)
            document.getElementById('userInfo').textContent = `ุฌุงุฑู ุฅุบูุงู ุงูููุงุญุธุฉ HSR-${currentSelectedObservation.docId.substring(0, 8)}...`;


            try {
                // 1. **ุฑูุน ุตูุฑุฉ ุงูุฅุบูุงู ุฅูู Storage**
                const closeoutRef = storage.ref().child(`resolutions/${currentSelectedObservation.docId}_${Date.now()}_${closeoutFile.name}`);
                const uploadTask = await closeoutRef.put(closeoutFile);
                const resolutionMediaUrl = await uploadTask.ref.getDownloadURL();

                // 2. **ุฑูุน ูุชุณุฌูู ุงููุฐูุฑุฉ ุงูุตูุชูุฉ (ุฅุฐุง ูุฌุฏุช)**
                let finalVoiceNoteText = resolutionNote;
                let voiceNoteURL = null;

                if (audioBlob) {
                    const audioRef = storage.ref().child(`voice_notes/${currentSelectedObservation.docId}_${Date.now()}.mp3`);
                    const audioUploadTask = await audioRef.put(audioBlob);
                    voiceNoteURL = await audioUploadTask.ref.getDownloadURL();

                    // ุงุณุชุฎุฏุงู ุงููุต ุงูููุฎุต ูู Gemini (Mockup)
                    finalVoiceNoteText = document.getElementById('audioSummaryResult').textContent.includes("ููุฎุต ุงููุฐูุฑุฉ:") 
                                         ? document.getElementById('audioSummaryResult').textContent.split("ููุฎุต ุงููุฐูุฑุฉ:")[1].trim() : resolutionNote;
                }

                // 3. **ุชุญุฏูุซ ุงููุซููุฉ ูู Firestore**
                await db.collection('observations').doc(currentSelectedObservation.docId).update({
                    status: 'ุชูุช ุงููุนุงูุฌุฉ',
                    resolutionNote: finalVoiceNoteText,
                    resolutionMediaUrl: resolutionMediaUrl,
                    voiceNoteUrl: voiceNoteURL,
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isComparative: currentSelectedObservation.mediaUrl ? true : false // If it had a 'before' image, it's now comparative
                });

                showAlert("ูุฌุงุญ ุงูุฅุบูุงู", `ุชู ุฅุบูุงู ุงูููุงุญุธุฉ HSR-${currentSelectedObservation.docId.substring(0, 8)} ุจูุฌุงุญ ูุชูุซูููุง ุจุตูุฑุฉ 'ุจุนุฏ' ูุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ.`);

                // Recalculate and re-render the UI
                await fetchObservations(); 
                showObservationDetail(currentSelectedObservation.docId);

            } catch (error) {
                console.error("Error finalizing closeout:", error);
                showAlert("ุฎุทุฃ ูู ุงูุฅุบูุงู", `ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุบูุงู ุงูููุงุญุธุฉ: ${error.message}`);
            } finally {
                finalCloseoutBtn.disabled = false;
            }
        }

        // Simulates the Audio Note analysis
        function analyzeAudioNote() {
            if (!audioBlob) {
                showAlert("ุฎุทุฃ", "ูุฑุฌู ุชุณุฌูู ููุงุญุธุฉ ุตูุชูุฉ ุฃููุงู.");
                return;
            }

            const buttonElement = document.getElementById('analyzeAudioBtn');
            const summaryResult = document.getElementById('audioSummaryResult');

            // Start loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<div class="loading-spinner" style="border-top: 4px solid var(--color-light-teal);"></div> ุฌุงุฑู ุงูุชูุฎูุต...`;
            summaryResult.classList.add('hidden');

            // Mockup delay for AI analysis
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.innerHTML = `<i data-lucide="sound-wave" class="w-4 h-4 ml-2"></i> ุชูุฎูุต ูุชุญููู ุฅูู ูุต`;
                summaryResult.classList.remove('hidden');

                // Mock transcription/summary from Gemini AI
                const mockTranscription = "ุชู ุชููุฏ ุงููููุน ูุงูุงูุชูุงุก ูู ุฃุนูุงู ุงูุชุตุฑููุ ูู ูุนุฏ ููุงู ุชุฌูุน ููููุงู. ูุงู ูุฑูู ุงูุตูุงูุฉ ุจุชุซุจูุช ูุธุงู ุตุฑู ุฌุฏูุฏ ูุถูุงู ุนุฏู ุชูุฑุงุฑ ุงููุดููุฉ ูู ุงููุณุชูุจู. ุงูุฅุบูุงู ููุตู ุจู.";

                summaryResult.innerHTML = `
                    <p class="font-bold text-teal-700">ูุณุฎ ุตูุชู:</p>
                    <p class="text-sm border-r-4 border-gray-300 pr-3 my-2">${mockTranscription}</p>
                    <p class="font-bold text-teal-700 mt-3">ููุฎุต ุงููุฐูุฑุฉ:</p>
                    <p class="text-sm border-r-4 border-teal-500 pr-3 my-2">ุงูููุงุญุธุฉ ูุบููุฉ. ุชู ุฅูุฌุงุฒ ุฃุนูุงู ุงูุชุตุฑูู ุจุงููุงูู ูุชุฑููุจ ูุธุงู ุตุฑู ุฌุฏูุฏ ูุถูุงู ุงูุงุณุชุฏุงูุฉ. ุฌูุฏุฉ ุงูุนูู ููุชุงุฒุฉ.</p>
                `;

                // Optionally, fill the text area with the transcription if it was empty
                const resolutionNoteInput = document.getElementById('resolutionNoteInput');
                if (resolutionNoteInput.value.trim() === '') {
                    resolutionNoteInput.value = mockTranscription;
                    checkCloseoutState();
                }

                lucide.createIcons();
            }, 3000);
        }

        // Simulates the PDF Report generation (just calls the print function)
        function generatePdfReport() {
            if (!currentSelectedObservation) {
                showAlert("ุฎุทุฃ", "ูุฑุฌู ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู ูุฅูุดุงุก ุงูุชูุฑูุฑ.");
                return;
            }

            document.getElementById('printTitle').textContent = `ุชูุฑูุฑ ููุตู ููููุงุญุธุฉ HSR-${currentSelectedObservation.docId.substring(0, 8)}`;
            window.print();
        }

        // --- Audio Recording Logic ---

        function startRecording() {
            if (!navigator.mediaDevices || !window.MediaRecorder) {
                showAlert("ุฎุทุฃ", "ุงููุชุตูุญ ูุง ูุฏุนู ุชุณุฌูู ุงูุตูุช.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    audioBlob = null;
                    document.getElementById('voiceNoteStatus').textContent = 'ุฌุงุฑู ุงูุชุณุฌูู...';
                    document.getElementById('startRecordingBtn').classList.add('hidden');
                    document.getElementById('stopRecordingBtn').classList.remove('hidden');
                    document.getElementById('audioPlayback').classList.add('hidden');
                    document.getElementById('resolutionNoteInput').value = ''; // Clear text if starting new audio

                    audioRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    audioRecorder.onstop = () => {
                        // ุงุณุชุฎุฏุงู 'audio/mpeg' ุฃู 'audio/wav' ุฃู 'audio/webm' ุญุณุจ ุงูุชูุงูู
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); 
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audioPlayback = document.getElementById('audioPlayback');
                        audioPlayback.src = audioUrl;
                        audioPlayback.classList.remove('hidden');
                        document.getElementById('voiceNoteStatus').textContent = 'ุชู ุชุณุฌูู ููุงุญุธุฉ ุตูุชูุฉ ุจูุฌุงุญ.';
                        checkCloseoutState(); // Recheck button states after successful recording
                    };

                    audioRecorder.start();
                    isRecording = true;
                })
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    showAlert("ุฎุทุฃ ูู ุงููููุฑูููู", "ุชุนุฐุฑ ุงููุตูู ุฅูู ุงููููุฑูููู. ุชุฃูุฏ ูู ุฅุนุทุงุก ุงูุตูุงุญูุฉ ูููุชุตูุญ.");
                    document.getElementById('voiceNoteStatus').textContent = 'ูุดู ุงูุชุณุฌูู.';
                });
        }

        function stopRecording() {
            if (audioRecorder && isRecording) {
                audioRecorder.stop();
                audioRecorder.stream.getTracks().forEach(track => track.stop()); // Stop microphone access
                isRecording = false;
                document.getElementById('startRecordingBtn').classList.remove('hidden');
                document.getElementById('stopRecordingBtn').classList.add('hidden');
            }
        }

        // --- Image Comparison Slider Logic ---
        function setupImageComparison() {
            const wrapper = document.getElementById('imageComparisonWrapper');
            const divider = document.getElementById('comparisonDivider');
            const afterImageContainer = document.getElementById('afterImageContainer');
            if (!wrapper || !divider || !afterImageContainer) return;

            let isDragging = false;

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                let x = e.clientX - rect.left;

                // Clamp the position to be within the image bounds
                x = Math.max(0, Math.min(x, rect.width));

                // Update the divider position (as percentage)
                const percentage = (x / rect.width) * 100;

                divider.style.left = `${percentage}%`;
                afterImageContainer.style.width = `${percentage}%`;
            };

            const onMouseDown = (e) => {
                if (e.target === divider || divider.contains(e.target)) {
                    isDragging = true;
                    wrapper.style.cursor = 'grabbing';
                }
            };

            const onMouseUp = () => {
                isDragging = false;
                wrapper.style.cursor = 'ew-resize';
            };

            // Remove existing listeners to avoid duplicates, only if a previous listener exists
            wrapper.removeEventListener('mousedown', onMouseDown);
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);

            // Add new listeners
            wrapper.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        }

        // --- Logout Mockup ---
        function smartLogout() {
            if (typeof auth !== 'undefined' && auth.signOut) {
                 auth.signOut().then(() => {
                     alert("ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ. ุณูุชู ุชูุฌููู ุฅูู ุตูุญุฉ ุงูุฏุฎูู.");
                     window.location.href = "login.html";
                 }).catch((error) => {
                     console.error("Logout Error:", error);
                     alert("ูุดู ุชุณุฌูู ุงูุฎุฑูุฌ: " + error.message);
                 });
                 return;
             }

            // ูุญุงูุงุฉ ุนูููุฉ ุชุณุฌูู ุงูุฎุฑูุฌ (ุฅุฐุง ูู ูุชู ุชููุฆุฉ Firebase Auth)
            setTimeout(() => {
                alert("ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ (ูุถุน ุงููุญุงูุงุฉ). ุณูุชู ุชูุฌููู ุฅูู ุตูุญุฉ ุงูุฏุฎูู.");
                // ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุฏุฎูู (login.html)
                window.location.href = "login.html"; 
            }, 1000);
        }


        // --- Initialization ---

        function calculateAndRenderAll() {
            calculateKPIs();
            renderKPIs();
            // ูุง ูุญุชุงุฌ ููุฑุฒ ูุจุฏุฆูุ Firestore ูุงู ุจุงููุฑุฒ ุจุชุงุฑูุฎ ุงูุฅูุดุงุก (date: 'desc')
            filteredObservations = observationsData;
            renderObservationsList(observationsData);

            // ุนุฑุถ ุฃูู ููุงุญุธุฉ ุฃู ุชุฑู ุงูููุงู ูุงุฑุบูุง
            if (observationsData.length > 0) {
                showObservationDetail(observationsData[0].docId);
            }
        }

        function initApp() {
            if (typeof firebase !== 'undefined') {
                fetchObservations(); // ุงูุจุฏุก ุจุชุญููู ุงูุจูุงูุงุช ูู Firestore
            } else {
                // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ุฅุฐุง ูู ูุชู ุชุญููู Firebase
                document.getElementById('observationsList').innerHTML = `<div class="text-center text-red-500 mt-10 p-4 bg-red-100 rounded-lg">ุฎุทุฃ: ูู ูุชู ุชุญููู ููุชุจุฉ Firebase.</div>`;
            }
            lucide.createIcons(); // ุชุฃูุฏ ูู ุฅูุดุงุก ุฃููููุงุช lucide ุนูุฏ ุงูุชุญููู
        }

        window.onload = initApp;
    </script>
</body>

</html>
