<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | لوحة القيادة التنفيذية - نظام المراقبة وإدارة الجودة الرقمي</title>
    <meta name="description" content="نظام Smart HSR للمراقبة وإدارة الجودة الرقمي - لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta name="keywords" content="Smart HSR, إدارة الجودة, نظام المراقبة, لوحة تحكم, الذكاء الاصطناعي, تحليل البيانات">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Smart HSR | نظام المراقبة وإدارة الجودة الرقمي">
    <meta property="og:description" content="لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-navy: #0A1931;
            --color-teal: #18A5A2;
            --color-light-teal: #ACE2E1;
            --color-gray-bg: #F7F9FC;
            --color-shadow-base: rgba(10, 25, 49, 0.4);
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--color-gray-bg); color: var(--color-navy); }
        /* KPIs gradients */
        .kpi-open-gradient { background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); color: white; box-shadow: 0 10px 20px rgba(185,28,28,.4); }
        .kpi-closed-gradient { background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%); color: white; box-shadow: 0 10px 20px rgba(24,165,162,.4); }
        .kpi-images-gradient { background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%); color: white; box-shadow: 0 10px 20px rgba(59,130,246,.4); }
        .kpi-card-professional { transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; }
        .kpi-card-professional:hover { transform: translateY(-8px) scale(1.02); z-index:10; }
        .ai-button-primary { background-color: var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5); border:none; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; }
        .ai-button-primary:hover { background-color:#148f8c; transform:translateY(-2px); }
        .ai-button-secondary { background-color: var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6); border:none; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; }
        .image-container { position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base); }
        .image-label { position:absolute; bottom:0; right:0; background-color: var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem; }
        .observation-item { transition:.2s; border-right:4px solid transparent; cursor:pointer; padding:12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; }
        .observation-item:hover, .observation-item.active { background:#E6F3F3; border-right-color: var(--color-teal); }
        .comparison-wrapper { position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem; }
        .comparison-wrapper img { display:block; width:100%; height:auto; }
        .comparison-wrapper .after-image { position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden; }
        .comparison-wrapper .comparison-divider { position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; }
        .label { color:#64748b; font-size:.9rem; }
        .input{ width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100; align-items:center; justify-content:center; }
        .modal .modal-content{ background:#fff; width:90%; max-width:800px; padding:24px; border-radius:24px; }
        @media print {
            body{ background:#fff !important; color:#000 !important; width:210mm; min-height:297mm; margin:0; }
            .no-print, #hero, footer, .modal { display:none !important; }
            #observationDetail { display:block !important; max-width:100% !important; margin:0 !important; padding:0 !important; box-shadow:none !important; border:none !important; }
            .comparison-wrapper .comparison-divider, .comparison-label { display:none !important; }
            .comparison-wrapper .after-image { width:100% !important; overflow:visible !important; }
        }
    </style>
</head>
<body class="text-gray-800">
    <main class="container" style="max-width:1200px; margin:0 auto; padding:24px;">
        <div class="flex justify-start mb-6 no-print" style="display:flex; justify-content:flex-start; margin-bottom:12px;">
            <button id="logout-btn" class="ai-button-secondary" onclick="smartLogout()" title="تسجيل الخروج الآمن">تسجيل الخروج</button>
        </div>

        <section id="hero" class="text-center" style="padding:24px; background:#fff; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-bottom:24px; border-top:8px solid #bfeeed; border-bottom:8px solid #bfeeed;">
            <h1 style="font-size:42px; margin:0 0 8px; color:var(--color-navy)">Smart HSR <span style="color:var(--color-teal)">Dashboard</span></h1>
            <h2 style="margin:0; color:#475569; font-weight:800;">نظام المراقبة وإدارة الجودة الرقمي</h2>
            <p class="label" style="margin-top:6px;">"منصة تنفيذية ذكية لإدارة الجودة والمراقبة الرقمية، توفر رؤية دقيقة للأداء وتدعم اتخاذ القرار المبني على البيانات."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 style="font-size:32px; margin:0 0 6px; color:var(--color-navy)">سجل الملاحظات التفاعلي: دقة الصورة والنص</h3>
                <p class="label">عرض تفصيلي للملاحظات الميدانية مع أدوات التحليل الآلي.</p>
                <button id="add-observation-btn" class="ai-button-primary" onclick="openModal('smartInputModal')">➕ إضافة ملاحظة جديدة (الإدخال الذكي)</button>
            </div>

            <div class="bg-white" style="padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.08); display:grid; grid-template-columns: 1fr 2fr; gap:18px; border:1px solid #e2e8f0;">
                <div class="no-print" style="border-left:1px solid #e2e8f0; padding-left:12px;">
                    <h4 style="margin:0 0 8px; color:var(--color-teal)">تصفية الملاحظات</h4>
                    <select id="observationFilter" class="input" onchange="handleFilterChange()">
                        <option value="ALL">عرض كل الملاحظات</option>
                        <option value="PENDING">جديد</option>
                        <option value="IN_PROGRESS">قيد التنفيذ</option>
                        <option value="COMPLETED">تمت المعالجة</option>
                        <option value="QUALITY">جودة</option>
                        <option value="MAINTENANCE">صيانة</option>
                        <option value="SAFETY">سلامة</option>
                        <option value="ENVIRONMENT">بيئة</option>
                    </select>
                    <h4 style="margin:16px 0 8px; color:var(--color-navy)">الملاحظات</h4>
                    <div id="observationsList" style="max-height:500px; overflow:auto; padding-right:6px;">
                        <div class="label" style="text-align:center; padding:12px;">... جاري تحميل البيانات ...</div>
                    </div>
                </div>

                <div class="bg-gray-50" style="padding:12px; border-radius:18px; border:1px solid #e2e8f0;">
                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 style="font-size:24px; margin:0 0 6px; color:var(--color-navy); font-weight:900;">تقرير Smart HSR التنفيذي</h2>
                        <p id="printTitle" class="label"></p>
                    </div>

                    <h4 style="margin:0 0 8px; color:var(--color-teal); font-weight:900;">عرض التفاصيل والتحليل (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">
                        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; font-size:14px; font-weight:700; margin-bottom:12px; background:#fff; padding:10px; border-radius:12px; border:1px solid #e2e8f0;">
                            <div><span class="label">العنوان:</span><div id="detailTitle"></div></div>
                            <div><span class="label">التصنيف:</span><div id="detailType" class="label" style="font-weight:900; color:var(--color-teal)"></div></div>
                            <div><span class="label">الموقع:</span><div id="detailLocation"></div></div>
                            <div><span class="label">تاريخ البلاغ:</span><div id="detailDate"></div></div>
                            <div><span class="label">حالة المعالجة:</span><div><span id="detailStatus" class="label" style="display:inline-block; padding:4px 10px; border-radius:999px; color:#fff; background:#94a3b8;"></span></div></div>
                            <div><span class="label">معرف البلاغ:</span><div id="detailID"></div></div>
                        </div>

                        <div style="background:#fff; padding:12px; border-radius:12px; border-left:6px solid #14b8a6; margin-bottom:12px;">
                            <h5 style="margin:0 0 6px; color:var(--color-navy); font-weight:900;">وصف الملاحظة</h5>
                            <p id="detailDescription" style="margin:0; color:#334155;"></p>
                            <div id="actionPlanContainer" class="hidden" style="margin-top:8px; background:#ecfeff; padding:10px; border-radius:12px">
                                <b>خطة العمل المقترحة (Gemini AI):</b>
                                <p id="actionPlan" style="margin:6px 0 0;"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer" class="hidden" style="background:#ecfdf5; padding:12px; border-radius:12px; border-left:6px solid #16a34a; margin-bottom:12px;">
                            <b>📝 المذكرة الختامية للإغلاق:</b>
                            <p id="resolutionNote" style="margin-top:6px;"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper hidden" style="margin-bottom:12px;">
                            <img id="beforeImage" alt="صورة قبل الإصلاح">
                            <div id="afterImageContainer" class="after-image"><img id="afterImage" alt="صورة بعد الإصلاح"></div>
                            <div id="comparisonDivider" class="comparison-divider"></div>
                            <span class="comparison-label label-before" style="position:absolute; top:8px; right:8px; background:#B91C1C; color:#fff; padding:6px 10px; border-radius:8px;">قبل</span>
                            <span class="comparison-label label-after" style="position:absolute; top:8px; left:8px; background:#10B981; color:#fff; padding:6px 10px; border-radius:8px;">بعد</span>
                        </div>

                        <div id="mediaContainer" class="image-container hidden" style="margin-bottom:12px;">
                            <div id="mediaContent"></div>
                            <span class="image-label">مرفق الملاحظة</span>
                        </div>

                        <div id="noImageMessage" class="hidden" style="background:#FEF3C7; padding:12px; border-radius:12px; color:#92400E; text-align:center; font-weight:700; margin-bottom:12px;">
                            ⚠️ لا تتوفر صورة أو فيديو لهذه الملاحظة.
                        </div>

                        <div id="aiAnalysisSection" style="background:#fff; padding:12px; border-radius:12px; border-top:4px solid #e5e7eb;">
                            <h5 style="margin:0 0 8px; color:var(--color-navy); font-weight:900;">أدوات التحليل الذكي (Gemini AI)</h5>
                            <div class="no-print" style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button id="vision-btn" class="ai-button-primary" onclick="analyzeImage('vision')">👁️ تحليل الصور (Vision)</button>
                                <button id="root-cause-btn" class="ai-button-primary" style="background:#881337" onclick="analyzeImage('root-cause')">🔬 السبب الجذري</button>
                                <button id="comm-btn" class="ai-button-primary" style="background:#F97316" onclick="generateCommunicationDraft()">✉️ أمر العمل</button>
                                <button id="pdf-report-btn" class="ai-button-primary" style="background:#10B981" onclick="generatePdfReport()">📄 توليد PDF</button>
                            </div>
                            <div id="aiResultContainer" class="hidden" style="margin-top:10px; background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #e2e8f0;">
                                <h6 id="aiResultTitle" style="margin:0 0 6px; color:var(--color-teal); font-weight:900;"></h6>
                                <div id="aiResultContent" style="color:#334155;"></div>
                            </div>
                        </div>

                        <div id="actionButtons" class="no-print" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                            <button id="updateStatusBtn" class="ai-button-secondary" style="background:#9ca3af" onclick="updateToInProgress()">تحديث الحالة إلى "قيد التنفيذ"</button>
                            <button id="completeObservationBtn" class="ai-button-secondary" style="background:#dc2626" onclick="openModal('closeoutModal')">🔒 الإغلاق التنفيذي (صورة بعد)</button>
                            <button id="alreadyCompletedBtn" class="ai-button-secondary hidden" style="background:#16a34a" disabled>✅ الملاحظة مغلقة وموثقة</button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center" style="padding:24px; color:#94a3b8;">
                        الرجاء اختيار ملاحظة من القائمة لعرض التفاصيل.
                    </div>
                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="no-print" style="margin-top:24px;">
            <div class="text-center" style="margin-bottom:12px;">
                <h3 style="font-size:28px; margin:0 0 6px; color:var(--color-navy)">📊 مؤشرات الأداء الحيوية (Vital Metrics)</h3>
                <p class="label">تتبع البلاغات وحالة التوثيق بالصور لضمان كفاءة الإغلاق.</p>
            </div>
            <div id="kpiContainer" style="display:grid; grid-template-columns: repeat(4,1fr); gap:12px;">
                <div class="kpi-card-professional p-6" style="background:#fff; border-top:4px solid #e5e7eb;">
                    <p class="label">جاري التحميل...</p>
                    <p style="font-size:36px; font-weight:900; color:#334155;">--</p>
                </div>
            </div>

            <div class="text-center" style="margin-top:18px;">
                <button id="kpi-insight-button" class="ai-button-secondary" onclick="generateKpiInsights()">✨ توليد تقرير تنفيذي لملخص اللوحة (Gemini AI)</button>
                <div id="kpi-insight-result" class="label" style="margin-top:10px;"></div>
            </div>
        </section>

        <footer class="no-print" style="text-align:center; margin-top:28px; border-top:4px solid #99f6e4; background:#fff; border-radius:24px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.08)">
            <div class="label">© 2025 Smart HSR. جميع الحقوق محفوظة. <span id="userInfo"></span></div>
        </footer>
    </main>

    <!-- Modal: الإدخال الذكي -->
    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-weight:900;">وحدة الإدخال الذكي للملاحظات (Smart HSR)</h3>
                <button class="ai-button-secondary" onclick="closeModal('smartInputModal')">✖</button>
            </div>
            <div style="display:grid; gap:10px; margin-top:12px;">
                <textarea id="rawObservationInput" rows="4" class="input" placeholder="مثال: تجمع مياه على طريق الخدمة عند الكيلو 52 باتجاه الشرق..."></textarea>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <div class="label">الموقع الجغرافي (GPS):</div>
                        <div id="locationStatus" class="label">لم يتم التحديد بعد</div>
                        <input id="inputLatitude" type="hidden"><input id="inputLongitude" type="hidden">
                        <button class="ai-button-primary" onclick="getLocation()" type="button">📍 تحديد الموقع الحالي</button>
                    </div>
                    <div>
                        <div class="label">رفع صورة أو فيديو الملاحظة:</div>
                        <div id="fileStatus" class="label">لم يتم اختيار ملف بعد</div>
                        <input id="fileUploadInput" type="file" accept="image/*,video/*" style="display:none">
                        <button class="ai-button-secondary" onclick="document.getElementById('fileUploadInput').click()" type="button">⤴️ اختيار ملف</button>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <select id="mType" class="input">
                        <option value="QUALITY">جودة</option><option value="MAINTENANCE">صيانة</option>
                        <option value="SAFETY">سلامة</option><option value="ENVIRONMENT">بيئة</option>
                    </select>
                    <input id="mTitle" class="input" placeholder="عنوان مختصر">
                    <select id="mPriority" class="input">
                        <option value="High">أولوية عالية</option><option value="Medium">متوسطة</option><option value="Low">منخفضة</option>
                    </select>
                </div>
                <button id="processSmartInputBtn" class="ai-button-primary" onclick="processSmartInput()" disabled>🚀 بدء التحليل والتسجيل</button>
            </div>
        </div>
    </div>

    <!-- Modal: الإغلاق التنفيذي -->
    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-weight:900;">🔒 لوحة الإغلاق التنفيذي للملاحظة #<span id="closeoutId"></span></h3>
                <button class="ai-button-secondary" onclick="closeModal('closeoutModal'); clearAfterUpload();">✖</button>
            </div>
            <div style="display:grid; gap:10px; margin-top:12px;">
                <div>
                    <div class="label">رفع صورة **بعد الإصلاح** (إلزامي)</div>
                    <div id="afterFileStatus" class="label">لم يتم اختيار ملف بعد</div>
                    <input id="afterFileUploadInput" type="file" accept="image/*" style="display:none">
                    <button class="ai-button-primary" onclick="document.getElementById('afterFileUploadInput').click()" type="button">📷 اختيار صورة الإغلاق</button>
                </div>
                <textarea id="resolutionNoteInput" rows="3" class="input" placeholder="المذكرة الختامية"></textarea>
                <button id="finalCloseoutBtn" class="ai-button-secondary" style="background:#16a34a" onclick="completeObservation()" disabled>✅ تأكيد الإغلاق النهائي للملاحظة</button>
            </div>
        </div>
    </div>

    <!-- Firebase (modular v12) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-storage.js";

        // إعداد Firebase (حسب ما زوّدتني به)
        const firebaseConfig = {
          apiKey: "AIzaSyCRrBnPYtdc86JffEQHERf732uAif7vwho",
          authDomain: "smart-hsr-6c2cf.firebaseapp.com",
          databaseURL: "https://smart-hsr-6c2cf-default-rtdb.firebaseio.com",
          projectId: "smart-hsr-6c2cf",
          storageBucket: "smart-hsr-6c2cf.firebasestorage.app",
          messagingSenderId: "399213527987",
          appId: "1:399213527987:web:4531958edfe9dbb95a81c6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM عناصر
        const logoutBtn = document.getElementById('logout-btn');
        const listEl = document.getElementById('observationsList');
        const filterEl = document.getElementById('observationFilter');

        const detail = document.getElementById('observationDetail');
        const placeholder = document.getElementById('detailPlaceholder');
        const dTitle = document.getElementById('detailTitle');
        const dType = document.getElementById('detailType');
        const dLoc = document.getElementById('detailLocation');
        const dDate = document.getElementById('detailDate');
        const dId = document.getElementById('detailID');
        const dDesc = document.getElementById('detailDescription');
        const dStatus = document.getElementById('detailStatus');
        const actionPlanContainer = document.getElementById('actionPlanContainer');
        const actionPlan = document.getElementById('actionPlan');
        const resolutionNoteContainer = document.getElementById('resolutionNoteContainer');
        const resolutionNote = document.getElementById('resolutionNote');
        const imageComparisonWrapper = document.getElementById('imageComparisonWrapper');
        const beforeImage = document.getElementById('beforeImage');
        const afterImage = document.getElementById('afterImage');
        const afterImageContainer = document.getElementById('afterImageContainer');
        const comparisonDivider = document.getElementById('comparisonDivider');
        const mediaContainer = document.getElementById('mediaContainer');
        const mediaContent = document.getElementById('mediaContent');
        const noImageMessage = document.getElementById('noImageMessage');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const completeObservationBtn = document.getElementById('completeObservationBtn');
        const alreadyCompletedBtn = document.getElementById('alreadyCompletedBtn');
        const printTitle = document.getElementById('printTitle');
        const kAll = document.createElement('div'); // Not used directly; compute in renderKPIs
        const userInfoEl = document.getElementById('userInfo');

        // الإدخال الذكي
        const smartInputModal = document.getElementById('smartInputModal');
        const rawObservationInput = document.getElementById('rawObservationInput');
        const inputLatitude = document.getElementById('inputLatitude');
        const inputLongitude = document.getElementById('inputLongitude');
        const locationStatus = document.getElementById('locationStatus');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const fileStatus = document.getElementById('fileStatus');
        const mType = document.getElementById('mType');
        const mTitle = document.getElementById('mTitle');
        const mPriority = document.getElementById('mPriority');
        const processSmartInputBtn = document.getElementById('processSmartInputBtn');

        // الإغلاق التنفيذي
        const closeoutModal = document.getElementById('closeoutModal');
        const closeoutId = document.getElementById('closeoutId');
        const afterFileUploadInput = document.getElementById('afterFileUploadInput');
        const afterFileStatus = document.getElementById('afterFileStatus');
        const resolutionNoteInput = document.getElementById('resolutionNoteInput');
        const finalCloseoutBtn = document.getElementById('finalCloseoutBtn');

        let observations = [];
        let current = null;
        let currentFile = null;
        let currentAfterFile = null;

        // حماية الدخول
        onAuthStateChanged(auth, user => {
          if(!user){ window.location.href = 'login.html'; } else {
            initRealtime();
          }
        });

        logoutBtn.onclick = () => signOut(auth);

        function initRealtime(){
          const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
          onSnapshot(q, snap=>{
            observations = snap.docs.map(d=>({id:d.id, ...d.data()}));
            renderList(); renderKPIs();
            if(current){ const n = observations.find(x=>x.id===current.id); if(n) showObservationDetail(n.id); }
            userInfoEl.textContent = ' | متصل بـ Firestore (مباشر)';
          });
        }

        // قائمة + فلترة
        filterEl.onchange = () => renderList();
        function renderList(){
          const f = filterEl.value;
          let data = observations;
          if(f !== 'ALL'){
            data = observations.filter(x => x.status===f || x.type===f);
          }
          listEl.innerHTML = (data.length? '' : '<div class="label" style="padding:12px; text-align:center;">لا توجد ملاحظات مطابقة</div>');
          data.forEach(x=>{
            const statusInfo = { PENDING:['#dc2626','قيد الانتظار'], IN_PROGRESS:['#ca8a04','قيد التنفيذ'], COMPLETED:['#16a34a','تمت المعالجة'] }[x.status] || ['#94a3b8', x.status];
            const div = document.createElement('div');
            div.className = 'observation-item' + (current && x.id===current.id ? ' active' : '');
            div.innerHTML = `<div><div style="font-weight:900; color:#0f172a">${escapeHTML(x.title||'-')}</div><div class="label">${fmtDate(x.createdAt)} | ${escapeHTML(x.type||'-')}</div></div><span style="display:inline-block; padding:4px 10px; border-radius:999px; color:#fff; background:${statusInfo[0]}">${statusInfo[1]}</span>`;
            div.onclick = ()=>showObservationDetail(x.id);
            listEl.appendChild(div);
          });
          if(!current && data[0]) showObservationDetail(data[0].id);
        }

        function showObservationDetail(id){
          current = observations.find(x=>x.id===id); if(!current) return;
          document.querySelectorAll('.observation-item').forEach(el=>el.classList.remove('active'));
          // (re)mark active visually
          const items = Array.from(listEl.children);
          const idx = observations.findIndex(x=>x.id===id);
          if(items[idx]) items[idx].classList.add('active');

          placeholder.classList.add('hidden'); detail.classList.remove('hidden');
          dTitle.textContent = current.title||''; printTitle.textContent = 'الملاحظة: ' + (current.title||'');
          dType.textContent = current.type||''; dLoc.textContent = current.location||'';
          dDate.textContent = fmtDate(current.createdAt); dId.textContent = current.id;
          dDesc.innerHTML = escapeHTML(current.details||'').replace(/\n/g,'<br>');
          setStatusBadge(current.status);

          if(current.actionPlan || current.riskAssessment){
            actionPlanContainer.classList.remove('hidden');
            const risk = current.riskAssessment ? `الأولوية: ${current.riskAssessment.priority} | الإطار: ${current.riskAssessment.timeframe}` : '';
            actionPlan.textContent = `${risk} — الخطة: ${current.actionPlan||'-'}`;
          } else { actionPlanContainer.classList.add('hidden'); }

          resolutionNoteContainer.classList.add('hidden');
          mediaContainer.classList.add('hidden');
          imageComparisonWrapper.classList.add('hidden');
          noImageMessage.classList.add('hidden');

          if(current.status==='COMPLETED' && current.afterImageUrl){
            imageComparisonWrapper.classList.remove('hidden');
            beforeImage.src = current.mediaUrl||''; afterImage.src = current.afterImageUrl||'';
            setupCompare();
            if(current.resolutionNote){ resolutionNoteContainer.classList.remove('hidden'); resolutionNote.textContent = current.resolutionNote; }
          } else if(current.mediaUrl){
            mediaContainer.classList.remove('hidden');
            if(current.isVideo){
              mediaContent.innerHTML = `<video controls style="width:100%; height:auto; border-radius:8px"><source src="${current.mediaUrl}" type="${current.mediaMime||'video/mp4'}"></video>`;
            } else {
              mediaContent.innerHTML = `<img src="${current.mediaUrl}" alt="media" style="display:block; width:100%; height:auto">`;
            }
          } else {
            noImageMessage.classList.remove('hidden');
          }

          alreadyCompletedBtn.classList.toggle('hidden', current.status!=='COMPLETED');
          completeObservationBtn.style.display = current.status==='COMPLETED' ? 'none' : 'inline-flex';
          updateStatusBtn.style.display = current.status==='PENDING' ? 'inline-flex' : 'none';
        }

        function setStatusBadge(s){
          const map = { PENDING:['#dc2626','قيد الانتظار'], IN_PROGRESS:['#ca8a04','قيد التنفيذ'], COMPLETED:['#16a34a','تمت المعالجة'] };
          const m = map[s] || ['#94a3b8', s];
          dStatus.style.background = m[0]; dStatus.textContent = m[1];
        }

        // تحديث الحالة
        async function updateToInProgress(){
          if(!current) return;
          await updateDoc(doc(db,'observations',current.id), { status:'IN_PROGRESS' });
        }
        window.updateToInProgress = updateToInProgress;

        // الإدخال الذكي
        window.getLocation = ()=>{
          locationStatus.textContent = '... جاري التحديد';
          navigator.geolocation.getCurrentPosition(pos=>{
            inputLatitude.value = pos.coords.latitude; inputLongitude.value = pos.coords.longitude;
            locationStatus.textContent = `${(+inputLatitude.value).toFixed(5)}, ${(+inputLongitude.value).toFixed(5)}`;
            toggleCreateEnabled();
          }, ()=>{ locationStatus.textContent = 'تعذّر تحديد الموقع'; });
        };
        fileUploadInput.onchange = ()=>{
          const f = fileUploadInput.files[0]; fileStatus.textContent = f ? `${f.name} (${(f.size/1024/1024).toFixed(2)} MB)` : 'لم يتم اختيار ملف'; toggleCreateEnabled();
        };
        rawObservationInput.oninput = toggleCreateEnabled;
        mTitle.oninput = toggleCreateEnabled;
        function toggleCreateEnabled(){ processSmartInputBtn.disabled = !(rawObservationInput.value.trim() || fileUploadInput.files[0] || (inputLatitude.value && inputLongitude.value)); }

        async function processSmartInput(){
          try{
            processSmartInputBtn.disabled = true; processSmartInputBtn.textContent = '... جاري التسجيل';
            const isVideo = fileUploadInput.files[0] ? fileUploadInput.files[0].type.startsWith('video') : false;
            const fileMime = fileUploadInput.files[0] ? fileUploadInput.files[0].type : null;

            const docRef = await addDoc(collection(db,'observations'), {
              type: mType.value, title: mTitle.value || '—', details: rawObservationInput.value || '',
              status: 'PENDING',
              location: (inputLatitude.value && inputLongitude.value) ? `${(+inputLatitude.value).toFixed(5)}, ${(+inputLongitude.value).toFixed(5)}` : '',
              actionPlan: null, riskAssessment: {priority: mPriority.value, timeframe: (mPriority.value==='High'?'24h':'72h')},
              hasImage: !!fileUploadInput.files[0], isVideo, mediaUrl: null, mediaMime: fileMime,
              afterImageUrl: null, resolutionNote: null,
              createdAt: serverTimestamp()
            });

            if(fileUploadInput.files[0]){
              const p = `observations/${docRef.id}/${isVideo?'before.mp4':'before.jpg'}`;
              const r = ref(storage, p);
              await uploadBytesResumable(r, fileUploadInput.files[0]);
              const url = await getDownloadURL(r);
              await updateDoc(doc(db,'observations',docRef.id), { mediaUrl:url });
            }

            closeModal('smartInputModal');
            rawObservationInput.value=''; mTitle.value=''; fileUploadInput.value=''; fileStatus.textContent='لم يتم اختيار ملف'; inputLatitude.value=''; inputLongitude.value=''; locationStatus.textContent='لم يتم التحديد بعد';
          }catch(e){ alert(e.message); } finally { processSmartInputBtn.disabled=false; processSmartInputBtn.textContent='🚀 بدء التحليل والتسجيل'; }
        }
        window.processSmartInput = processSmartInput;

        // الإغلاق التنفيذي
        function openCloseout(){
          if(!current) return;
          document.getElementById('closeoutId').textContent = current.id;
          afterFileUploadInput.value=''; afterFileStatus.textContent='لم يتم اختيار ملف'; resolutionNoteInput.value='';
          document.getElementById('finalCloseoutBtn').disabled = true;
          openModal('closeoutModal');
        }
        completeObservationBtn.addEventListener('click', openCloseout);
        afterFileUploadInput.onchange = ()=>{
          afterFileStatus.textContent = afterFileUploadInput.files[0] ? afterFileUploadInput.files[0].name : 'لم يتم اختيار ملف';
          finalCloseoutBtn.disabled = !afterFileUploadInput.files[0];
        };
        window.completeObservation = async ()=>{
          if(!current || !afterFileUploadInput.files[0]) return;
          try{
            finalCloseoutBtn.disabled=true; finalCloseoutBtn.textContent='... جاري الإغلاق';
            const p = `observations/${current.id}/after.jpg`;
            const r = ref(storage, p);
            await uploadBytes(r, afterFileUploadInput.files[0]);
            const url = await getDownloadURL(r);
            await updateDoc(doc(db,'observations',current.id), {
              status:'COMPLETED', afterImageUrl:url, resolutionNote:(resolutionNoteInput.value.trim()||`تم الإغلاق في ${new Date().toLocaleString('ar-SA')}`)
            });
            closeModal('closeoutModal');
          }catch(e){ alert(e.message); } finally { finalCloseoutBtn.disabled=false; finalCloseoutBtn.textContent='✅ تأكيد الإغلاق النهائي للملاحظة'; }
        };
        window.clearAfterUpload = ()=>{ afterFileUploadInput.value=''; afterFileStatus.textContent='لم يتم اختيار ملف'; resolutionNoteInput.value=''; };

        // KPIs
        function renderKPIs(){
          const total = observations.length;
          const open = observations.filter(x=>x.status!=='COMPLETED').length;
          const closed = total - open;
          const withImg = observations.filter(x=>x.mediaUrl).length;
          const kpiContainer = document.getElementById('kpiContainer');
          kpiContainer.innerHTML = '';
          const data = [
            {title:'إجمالي الملاحظات', value: total, icon:'clipboard-list', cls:'kpi-images-gradient'},
            {title:'مفتوحة/انتظار', value: open, icon:'alert-triangle', cls:'kpi-open-gradient'},
            {title:'مغلقة/معالجة', value: closed, icon:'check-circle', cls:'kpi-closed-gradient'},
            {title:'موثقة بالصور', value: withImg, icon:'image', cls:'kpi-images-gradient'},
          ];
          data.forEach(k=>{
            const el = document.createElement('div');
            el.className = `kpi-card-professional p-6 ${k.cls}`;
            el.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between;">
              <div><p style="margin:0; font-weight:700">${k.title}</p><p style="margin:4px 0 0; font-size:36px; font-weight:900">${k.value}</p></div>
              <span style="font-size:28px; opacity:.8">📊</span>
            </div>`;
            kpiContainer.appendChild(el);
          });
        }

        // مقارنة قبل/بعد
        function setupCompare(){
          let dragging=false;
          const rect = ()=>imageComparisonWrapper.getBoundingClientRect();
          const move = (clientX)=>{
            const r = rect(); let left = Math.max(0, Math.min(clientX - r.left, r.width));
            afterImageContainer.style.width = left+'px';
            comparisonDivider.style.left = left+'px';
          };
          const start = (e)=>{ dragging=true; move((e.touches?e.touches[0].clientX:e.clientX)); };
          const end = ()=>{ dragging=false; };
          const drag = (e)=>{ if(!dragging) return; move((e.touches?e.touches[0].clientX:e.clientX)); };
          imageComparisonWrapper.onmousedown=start; imageComparisonWrapper.onmousemove=drag; window.onmouseup=end;
          imageComparisonWrapper.ontouchstart=start; imageComparisonWrapper.ontouchmove=drag; window.ontouchend=end;
          const r = rect(); move(r.left + r.width/2);
        }

        // PDF (بسيط عبر print)
        window.generatePdfReport = ()=>{ window.print(); };

        // أوامر العمل (صياغة)
        window.generateCommunicationDraft = ()=>{
          if(!current){ alert('اختر ملاحظة أولاً'); return; }
          const content = `
          إلى فريق التشغيل،
          الموضوع: أمر عمل لمعالجة "${current.title}"
          الموقع: ${current.location || '-'}
          الحالة الحالية: ${current.status}
          التفاصيل: ${current.details || '-'}

          المطلوب: تنفيذ خطة معالجة عاجلة وفق الأولوية (${current.riskAssessment?.priority || '-'}) خلال (${current.riskAssessment?.timeframe || '-'})،
          وتحديث الحالة في لوحة Smart HSR فور الانتهاء.
          مع الشكر.`.trim();
          showAI('صياغة أمر العمل', `<pre style="white-space:pre-wrap; direction:rtl; font-family:Tajawal, sans-serif">${escapeHTML(content)}</pre>`);
        };

        // Gemini Vision (اختياري – ضع مفتاحك هنا ليعمل فعليًا)
        const GEMINI_API_KEY = ""; // ضع مفتاح Gemini هنا إن رغبت بالتحليل الفعلي
        async function analyzeImage(kind){
          if(!current){ alert('اختر ملاحظة أولاً'); return; }
          if(!current.mediaUrl){ showAI('تحليل الصور','لا توجد صورة لتحليلها.'); return; }
          try{
            showAI('جارٍ التحليل...','<div class="label">الرجاء الانتظار...</div>');
            const base64 = await toBase64FromUrl(current.mediaUrl);
            let prompt = "";
            if(kind==='vision'){
              prompt = `وصف دقيق لما ترى في الصورة من حيث نوع المشكلة (حفريات/أرصفة/إنارة/حدائق/نفايات/سلامة..)، مستوى الخطورة، وخطوات معالجة مختصرة.`;
            } else {
              prompt = `استخرج السبب الجذري المحتمل للمشكلة الظاهرة بالصورة، وقدّم نصيحة وقائية تمنع تكرارها.`;
            }
            if(!GEMINI_API_KEY){
              // عرض محاكاة محترمة إن لم يُضَع مفتاح
              const fake = (kind==='vision')
                ? 'تحليل (محاكاة): يُحتمل وجود هبوط بسيط في طبقة الإسفلت عند الحافة اليمنى، الأولوية: متوسطة، المعالجة: قص وإعادة رصف الموضع، فحص التصريف.'
                : 'سبب جذري (محاكاة): ضعف التربة تحت الطبقة السطحية نتيجة مياه راكدة. الوقاية: تحسين التصريف، برنامج فحص دوري.';
              showAI(kind==='vision'?'نتيجة تحليل الرؤية':'نتيجة السبب الجذري', `<div>${escapeHTML(fake)}</div>`);
              return;
            }
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                contents: [{
                  parts: [
                    {text: prompt},
                    {inline_data: {mime_type: current.mediaMime || 'image/jpeg', data: base64 }}
                  ]
                }]
              })
            });
            const json = await res.json();
            const text = json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n') || 'تعذر الحصول على نتيجة.';
            showAI(kind==='vision'?'نتيجة تحليل الرؤية':'نتيجة السبب الجذري', `<div>${escapeHTML(text)}</div>`);
          }catch(e){
            showAI('خطأ', `<div>تعذر التحليل: ${escapeHTML(e.message)}</div>`);
          }
        }
        window.analyzeImage = analyzeImage;

        function showAI(title, html){
          const c = document.getElementById('aiResultContainer');
          document.getElementById('aiResultTitle').textContent = title;
          document.getElementById('aiResultContent').innerHTML = html;
          c.classList.remove('hidden');
        }

        async function toBase64FromUrl(url){
          const resp = await fetch(url);
          const blob = await resp.blob();
          return await blobToBase64(blob);
        }
        function blobToBase64(blob){
          return new Promise((resolve,reject)=>{
            const reader = new FileReader();
            reader.onloadend = ()=>{
              const res = reader.result.split(',')[1]; resolve(res);
            };
            reader.onerror = reject; reader.readAsDataURL(blob);
          });
        }

        // KPI Insights (نصي فقط، ويمكن ربطه بالـ Gemini عبر المفتاح)
        async function generateKpiInsights(){
          const total = observations.length;
          const open = observations.filter(x=>x.status!=='COMPLETED').length;
          const closed = total - open;
          const withImg = observations.filter(x=>x.mediaUrl).length;
          const txt = `ملخص تنفيذي: إجمالي ${total}، مفتوح ${open} (${Math.round((open/Math.max(total,1))*100)}%)، مغلق ${closed}، موثّق بالصور ${withImg}. التوصية: التركيز على إغلاق البلاغات عالية الأولوية خلال 24 ساعة وتفعيل حملات توثيق بالصور.`;
          document.getElementById('kpi-insight-result').textContent = txt;
        }
        window.generateKpiInsights = generateKpiInsights;

        // أدوات عامة
        window.openModal = (id)=>document.getElementById(id).style.display='flex';
        window.closeModal = (id)=>document.getElementById(id).style.display='none';
        window.smartLogout = ()=>signOut(auth);
        function fmtDate(ts){
          try{
            if(!ts) return '-';
            if(ts.seconds) return new Date(ts.seconds*1000).toLocaleString('ar-SA');
            return new Date(ts).toLocaleString('ar-SA');
          }catch{ return '-'; }
        }
        function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    </script>
</body>
</html>
