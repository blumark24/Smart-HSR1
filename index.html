<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | لوحة القيادة التنفيذية - نظام المراقبة وإدارة الجودة الرقمي</title>
    
    <meta name="description" content="نظام Smart HSR للمراقبة وإدارة الجودة الرقمي - لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta name="keywords" content="Smart HSR, إدارة الجودة, نظام المراقبة, لوحة تحكم, الذكاء الاصطناعي, تحليل البيانات">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Smart HSR | نظام المراقبة وإدارة الجودة الرقمي">
    <meta property="og:description" content="لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | نظام المراقبة وإدارة الجودة الرقمي">
    <meta name="twitter:description" content="لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom styles for the app */
        body {
            background-color: #f7f9fb; /* Light background for the whole page */
        }
        .header-bg {
            background-color: #1e3a8a; /* Dark blue for header */
        }
        .sidebar-bg {
            background-color: #ffffff; /* White sidebar */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .kpi-card {
            border-left: 4px solid #06b6d4; /* Cyan border for KPI */
        }
        .observation-item:hover {
            background-color: #f3f4f6;
        }
        .active-observation {
            background-color: #e5e7eb;
            border-right: 4px solid #1e3a8a;
        }
        .filter-btn.active {
            background-color: #1e3a8a;
            color: #ffffff;
        }
        .badge-new { background-color: #fcd34d; color: #92400e; }
        .badge-inprogress { background-color: #93c5fd; color: #1e40af; }
        .badge-completed { background-color: #a7f3d0; color: #065f46; }

        /* Mock Image Comparison Slider (Basic Implementation) */
        .img-comparison-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 300px; /* Fixed height for demo */
            max-width: 600px;
            margin: 0 auto;
        }
        .img-comparison-container img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .img-comparison-container .before-img {
            clip: rect(0, 50%, 100%, 0); /* Mock clipping to show half */
        }
        .img-comparison-container .slider-bar {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: #fff;
            cursor: ew-resize;
            z-index: 10;
            transform: translateX(-50%);
        }
        .img-comparison-container .slider-bar:after {
            content: '↔';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 8px;
            border-radius: 50%;
            color: #1e3a8a;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
    </style>
</head>

<body class="min-h-screen">

    <header class="header-bg text-white shadow-lg fixed top-0 w-full z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                Smart HSR Dashboard:
                <span class="text-teal-400">نظام المراقبة وإدارة الجودة الرقمي</span>
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <button onclick="document.getElementById('smartInputModal').classList.remove('hidden')" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-150">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i>
                    إضافة ملاحظة جديدة
                </button>
                <div class="text-sm">
                    <p class="font-semibold">المستخدم: المدير التنفيذي</p>
                    <p class="text-xs text-teal-200">الرياض - محطة القطار</p>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-6 space-x-reverse">
        
        <div class="w-1/3 min-h-screen sidebar-bg card p-4 sticky top-24 self-start">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
                سجل الملاحظات (Log)
                <button onclick="printObservationList()" class="text-blue-600 hover:text-blue-800 flex items-center text-sm">
                    <i data-lucide="printer" class="w-4 h-4 ml-1"></i>
                    طباعة PDF
                </button>
            </h2>

            <div class="mb-4 flex space-x-2 space-x-reverse text-sm">
                <button onclick="filterObservations('all')" id="filter-all" class="filter-btn active py-1 px-3 rounded-full transition duration-150">الكل</button>
                <button onclick="filterObservations('جديد')" id="filter-new" class="filter-btn py-1 px-3 rounded-full transition duration-150">جديد</button>
                <button onclick="filterObservations('قيد التنفيذ')" id="filter-inprogress" class="filter-btn py-1 px-3 rounded-full transition duration-150">قيد التنفيذ</button>
                <button onclick="filterObservations('تمت المعالجة')" id="filter-completed" class="filter-btn py-1 px-3 rounded-full transition duration-150">مغلقة</button>
            </div>
            
            <div class="mb-4">
                <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">تصفية حسب النوع:</label>
                <select id="type-filter" onchange="filterObservations(document.querySelector('.filter-btn.active').textContent.trim())" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    <option value="all">جميع الأنواع</option>
                    <option value="جودة">جودة (Quality)</option>
                    <option value="صيانة">صيانة (Maintenance)</option>
                    <option value="سلامة">سلامة (Safety)</option>
                    <option value="بيئة">بيئة (Environment)</option>
                </select>
            </div>
            
            <button onclick="resetDataConfirmation()" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center transition duration-150">
                <i data-lucide="rotate-ccw" class="w-4 h-4 ml-2"></i>
                مسح جميع البيانات
            </button>


            <div id="observations-list" class="space-y-3 overflow-y-auto max-h-[calc(100vh-310px)] mt-4">
                </div>
        </div>

        <div class="w-2/3 space-y-6 pb-10">

            <div class="grid grid-cols-4 gap-4">
                <div class="kpi-card card p-4">
                    <p class="text-sm font-medium text-gray-500">إجمالي الملاحظات</p>
                    <p id="kpi-total" class="text-2xl font-bold text-gray-900 mt-1">--</p>
                </div>
                <div class="kpi-card card p-4 border-l-yellow-500">
                    <p class="text-sm font-medium text-gray-500">ملاحظات مفتوحة/انتظار</p>
                    <p id="kpi-open" class="text-2xl font-bold text-yellow-600 mt-1">--</p>
                </div>
                <div class="kpi-card card p-4 border-l-green-500">
                    <p class="text-sm font-medium text-gray-500">ملاحظات مغلقة/معالجة</p>
                    <p id="kpi-closed" class="text-2xl font-bold text-green-600 mt-1">--</p>
                </div>
                <div class="kpi-card card p-4 border-l-purple-500">
                    <p class="text-sm font-medium text-gray-500">ملاحظات موثقة بالصور</p>
                    <p id="kpi-image-documented" class="text-2xl font-bold text-purple-600 mt-1">--</p>
                </div>
            </div>
            
            <div id="kpi-insight-result" class="card p-4 border-t-4 border-t-red-600">
                <div class="flex items-center mb-2">
                    <i data-lucide="brain-circuit" class="w-5 h-5 text-red-600 ml-2"></i>
                    <h3 class="text-lg font-bold text-gray-800">تحليل الموقف التنفيذي (Gemini AI Insight)</h3>
                </div>
                <p class="text-gray-600" id="kpi-insight-text">
                    الذكاء الاصطناعي يحلل المؤشرات الحيوية ويقدم ملخصاً تنفيذياً لضمان اتخاذ القرارات الصحيحة.
                </p>
                </div>


            <div id="observation-detail-view" class="card p-6">
                 <div class="flex justify-center items-center h-40">
                    <p class="text-center text-gray-500">الرجاء اختيار ملاحظة من القائمة لعرض التفاصيل.</p>
                </div>
            </div>

            <div class="card p-4 flex justify-between items-center bg-blue-50 border-t-4 border-t-blue-600">
                <p class="text-lg font-bold text-blue-800">تقرير تنفيذي لملخص اللوحة</p>
                <button onclick="generateKPISummaryReport()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-150">
                    <i data-lucide="file-text" class="w-5 h-5 ml-2"></i>
                    توليد تقرير (PDF)
                </button>
            </div>

        </div>
    </main>

    <div id="closeoutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-red-600">الإغلاق التنفيذي</h3>
                <button onclick="document.getElementById('closeoutModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="mb-4 text-gray-700">يجب عليك توثيق عملية الإصلاح بـ "صورة بعد" وكتابة ملاحظة الإغلاق النهائية لضمان الجودة.</p>
            
            <form onsubmit="handleCloseout(event)">
                <div class="mb-4">
                    <label for="afterPhoto" class="block text-sm font-medium text-gray-700 mb-1">صورة الإغلاق (After Photo):</label>
                    <input type="file" id="afterPhoto" accept="image/*" class="w-full border border-gray-300 p-2 rounded-lg" required>
                </div>
                <div class="mb-6">
                    <label for="resolutionNote" class="block text-sm font-medium text-gray-700 mb-1">ملاحظة الإغلاق النهائية (إجباري):</label>
                    <textarea id="resolutionNote" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="اكتب تفاصيل عملية الإصلاح وكيف تم ضمان الجودة..." required></textarea>
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">إغلاق وتوثيق</button>
            </form>
        </div>
    </div>

    <div id="smartInputModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-teal-600">الإدخال الذكي (Smart Input)</h3>
                <button onclick="document.getElementById('smartInputModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="mb-4 text-gray-700">أدخل الملاحظة بوضوح، وسيتولى الذكاء الاصطناعي (Gemini) تحليلها وتصنيفها.</p>
            
            <form onsubmit="handleSmartInput(event)">
                <div class="mb-4">
                    <label for="smartInputText" class="block text-sm font-medium text-gray-700 mb-1">وصف الملاحظة (الوصف):</label>
                    <textarea id="smartInputText" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="مثال: يوجد تشقق كبير في أرضية الرصيف في قطاع A" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="smartInputLocation" class="block text-sm font-medium text-gray-700 mb-1">الموقع (GPS/الوصف):</label>
                    <input type="text" id="smartInputLocation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="مثال: الرياض، محطة A1، عند البوابة 3">
                </div>
                <div class="mb-6">
                    <label for="smartInputPhoto" class="block text-sm font-medium text-gray-700 mb-1">توثيق بالصورة/الفيديو (اختياري):</label>
                    <input type="file" id="smartInputPhoto" accept="image/*,video/*" class="w-full border border-gray-300 p-2 rounded-lg">
                </div>
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg">إرسال وتحليل (AI Analyze)</button>
            </form>
            <div id="smart-input-ai-result" class="mt-4 bg-teal-100 p-3 rounded-lg text-sm text-teal-800 hidden">
                <p class="font-bold">نتائج تحليل الذكاء الاصطناعي:</p>
                <p id="ai-classification-result" class="mt-1">--</p>
            </div>
        </div>
    </div>


    <script>
        // --- Data Store Initialization ---
        // البيانات سيتم تحميلها وحفظها في Local Storage للحفاظ عليها بين الجلسات.
        let observationsData = []; 
        let currentSelectedObservation = null;
        
        // --- Persistence Functions ---
        
        function loadObservationsFromLocalStorage() {
            const storedData = localStorage.getItem('smartHsrObservations');
            if (storedData) {
                // Load data and parse dates back into Date objects
                observationsData = JSON.parse(storedData).map(obs => ({
                    ...obs,
                    // The image data (Base64 or URL) is saved as strings and remains as is
                    createdAt: new Date(obs.createdAt)
                }));
            } else {
                observationsData = [];
            }
        }

        function saveObservationsToLocalStorage() {
            // Convert Date objects to ISO strings for storage
            const serializableData = observationsData.map(obs => ({
                ...obs,
                createdAt: obs.createdAt.toISOString()
            }));
            localStorage.setItem('smartHsrObservations', JSON.stringify(serializableData));
        }
        
        function resetDataConfirmation() {
            if (confirm('هل أنت متأكد أنك تريد مسح جميع الملاحظات المحفوظة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                resetData();
            }
        }

        function resetData() {
            localStorage.removeItem('smartHsrObservations');
            observationsData = [];
            calculateAndRenderAll();
            // Clear detail view after reset
            document.getElementById('observation-detail-view').innerHTML = `
                <div class="flex justify-center items-center h-40">
                    <p class="text-center text-gray-500">البيانات ممسوحة. يرجى إضافة ملاحظة جديدة للبدء.</p>
                </div>
            `;
            currentSelectedObservation = null;
            alert('تم مسح جميع البيانات وإعادة تعيين اللوحة.');
        }


        // --- Utility Functions ---
        const getStatusBadgeClass = (status) => {
            switch (status) {
                case 'جديد': return 'badge-new';
                case 'قيد التنفيذ': return 'badge-inprogress';
                case 'تمت المعالجة': return 'badge-completed';
                default: return 'bg-gray-200 text-gray-800';
            }
        };

        const getStatusDisplay = (status) => {
            return status === 'تمت المعالجة' ? 'مغلقة' : status;
        };

        // Function to convert file to Base64 (for saving images in Local Storage)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- Image Comparison Mock Setup (for demonstration) ---
        function setupImageComparison() {
            const container = document.getElementById('image-comparison-mock');
            const slider = document.getElementById('slider-bar');
            if (!container || !slider) return;

            // Ensure the initial state is correct for RTL
            const initialPos = container.offsetWidth / 2;
            slider.style.right = `${initialPos}px`;
            // Clipping for RTL (before on right, after on left)
            container.querySelector('.before-img').style.clip = `rect(0, ${container.offsetWidth}px, ${container.offsetHeight}px, ${initialPos}px)`;
            container.querySelector('.after-img').style.clip = `rect(0, ${initialPos}px, ${container.offsetHeight}px, 0)`;

            let isDragging = false;

            const onMouseMove = (e) => {
                if (!isDragging) return;
                
                // Get mouse position relative to container
                const rect = container.getBoundingClientRect();
                let x = e.clientX - rect.left;
                
                // Clamp the value
                x = Math.max(0, Math.min(x, container.offsetWidth));
                
                // Update slider and clipping for RTL layout
                const rightPos = container.offsetWidth - x;

                slider.style.right = `${rightPos}px`;
                
                // The 'before' image (the right one in RTL view) is clipped from the right
                container.querySelector('.before-img').style.clip = `rect(0, ${container.offsetWidth}px, ${container.offsetHeight}px, ${x}px)`;
                // The 'after' image (the left one in RTL view) is clipped from the left
                container.querySelector('.after-img').style.clip = `rect(0, ${x}px, ${container.offsetHeight}px, 0)`;

            };

            const onMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            slider.onmousedown = (e) => {
                e.preventDefault();
                isDragging = true;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };
        }
        
        // --- Renderer Functions ---

        function renderObservationItem(observation) {
            const activeClass = currentSelectedObservation && currentSelectedObservation.id === observation.id ? 'active-observation' : '';
            const badgeClass = getStatusBadgeClass(observation.status);
            
            return `
                <div id="obs-item-${observation.id}" class="observation-item p-3 card cursor-pointer transition duration-150 ${activeClass}" 
                     onclick="showObservationDetail(${observation.id})">
                    <div class="flex justify-between items-start">
                        <h4 class="font-semibold text-gray-900">${observation.title}</h4>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${badgeClass}">
                            ${getStatusDisplay(observation.status)}
                        </span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">النوع: <span class="text-blue-600 font-medium">${observation.type}</span> | الموقع: ${observation.location}</p>
                    <p class="text-xs text-gray-400 mt-1">${observation.createdAt.toLocaleDateString('ar-SA')} - ${observation.createdAt.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            `;
        }

        function renderObservationsList(list) {
            const listContainer = document.getElementById('observations-list');
            if (list.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-10">لا توجد ملاحظات حالياً. أضف ملاحظة جديدة للبدء.</p>';
                return;
            }
            listContainer.innerHTML = list.map(renderObservationItem).join('');
        }

        function renderDetailViewContent(observation) {
            const ai = observation.aiAnalysis;
            const detailViewHTML = `
                <div class="flex justify-between items-start mb-4 border-b pb-3">
                    <h3 class="text-2xl font-extrabold text-teal-800" id="detail-title">${observation.title}</h3>
                    <span id="detail-status" class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusBadgeClass(observation.status)}">${getStatusDisplay(observation.status)}</span>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <p class="font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="image" class="w-4 h-4 ml-1"></i> التوثيق الفوتوغرافي (قبل)</p>
                        <div id="detail-media-container" class="bg-gray-100 rounded-lg overflow-hidden h-64 flex items-center justify-center ${observation.imageBefore ? '' : 'h-32'}">
                            <img id="detail-image-before" src="${observation.imageBefore || ''}" alt="صورة الملاحظة قبل المعالجة" class="w-full h-full object-cover ${observation.imageBefore ? '' : 'hidden'}">
                            <p id="no-media-message" class="${observation.imageBefore ? 'hidden' : 'text-gray-500'}">لا يوجد توثيق فوتوغرافي.</p>
                        </div>
                        
                        <div id="detail-media-after-section" class="mt-4 ${observation.status === 'تمت المعالجة' ? '' : 'hidden'}">
                            <p class="font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="check-square" class="w-4 h-4 ml-1"></i> التوثيق الفوتوغرافي (بعد - الإغلاق)</p>
                            
                            <div id="image-comparison-mock" class="img-comparison-container mt-2 ${observation.isComparative && observation.imageAfter ? '' : 'hidden'}">
                                <img id="detail-image-after-full" class="after-img" src="${observation.imageAfter || ''}" alt="صورة الملاحظة بعد المعالجة">
                                <img id="detail-image-before-full" class="before-img" src="${observation.imageBefore || ''}" alt="صورة الملاحظة قبل المعالجة">
                                <div id="slider-bar" class="slider-bar"></div>
                            </div>

                            <img id="detail-image-after-standalone" src="${observation.imageAfter || ''}" alt="صورة الملاحظة بعد المعالجة" class="w-full h-full object-cover rounded-lg mt-2 ${observation.imageAfter && !observation.isComparative ? '' : 'hidden'}">

                        </div>

                        <div id="closeout-button-container" class="mt-4 ${observation.status === 'قيد التنفيذ' ? '' : 'hidden'}">
                            <button onclick="document.getElementById('closeoutModal').classList.remove('hidden')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center transition duration-150">
                                <i data-lucide="lock" class="w-5 h-5 ml-2"></i>
                                إغلاق تنفيذي (Executive Closeout)
                            </button>
                        </div>

                    </div>

                    <div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">تم الإبلاغ في: <span id="detail-date" class="font-medium text-gray-700">${observation.createdAt.toLocaleDateString('ar-SA')} ${observation.createdAt.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span></p>
                            <p class="text-sm text-gray-500">النوع: <span id="detail-type" class="font-medium text-blue-600">${observation.type}</span></p>
                            <p class="text-sm text-gray-500">الموقع: <span id="detail-location" class="font-medium text-gray-700">${observation.location}</span></p>
                        </div>

                        <p class="font-bold text-gray-700 mb-2">وصف الملاحظة:</p>
                        <p id="detail-description" class="text-gray-800 mb-4 bg-gray-50 p-3 rounded-lg">${observation.description}</p>
                        
                        <div id="detail-resolution-section" class="mt-4 border-t pt-4 ${observation.status === 'تمت المعالجة' ? '' : 'hidden'}">
                            <p class="font-bold text-green-700 mb-2 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 ml-1"></i> ملاحظة الإغلاق التنفيذي:</p>
                            <p id="detail-resolution-note" class="text-gray-800 mb-4 bg-green-50 p-3 rounded-lg">${observation.resolutionNote || 'لا توجد ملاحظة إغلاق مكتوبة.'}</p>
                        </div>

                        <div class="mt-4 border-t pt-4">
                            <p class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="gem" class="w-5 h-5 text-teal-600 ml-1"></i> أدوات الذكاء الاصطناعي (Gemini)</p>
                            
                            <div class="space-y-3">
                                <details class="bg-teal-50 p-3 rounded-lg">
                                    <summary class="font-semibold text-teal-800 cursor-pointer flex items-center">
                                        <i data-lucide="brain-cog" class="w-4 h-4 ml-2"></i>
                                        تحليل الرؤية (Vision Analysis)
                                    </summary>
                                    <p id="ai-vision-analysis" class="text-sm text-gray-700 mt-2">${ai.vision || 'لا يوجد تحليل رؤية متاح.'}</p>
                                </details>

                                <details class="bg-teal-50 p-3 rounded-lg">
                                    <summary class="font-semibold text-teal-800 cursor-pointer flex items-center">
                                        <i data-lucide="activity-square" class="w-4 h-4 ml-2"></i>
                                        تحليل السبب الجذري (Root Cause Analysis)
                                    </summary>
                                    <p id="ai-root-cause" class="text-sm text-gray-700 mt-2">${ai.rootCause || 'لا يوجد تحليل سبب جذري متاح.'}</p>
                                </details>

                                <details class="bg-teal-50 p-3 rounded-lg">
                                    <summary class="font-semibold text-teal-800 cursor-pointer flex items-center">
                                        <i data-lucide="list-checks" class="w-4 h-4 ml-2"></i>
                                        خطة عمل آلية (Automated Action Plan)
                                    </summary>
                                    <ul id="ai-action-plan" class="list-disc list-inside text-sm text-gray-700 mt-2">
                                        ${ai.actionPlan ? ai.actionPlan.map(item => `<li>${item}</li>`).join('') : '<li>لا توجد خطة عمل آلية مقترحة.</li>'}
                                    </ul>
                                </details>

                                <details class="bg-teal-50 p-3 rounded-lg">
                                    <summary class="font-semibold text-teal-800 cursor-pointer flex items-center">
                                        <i data-lucide="alert-triangle" class="w-4 h-4 ml-2"></i>
                                        تقييم المخاطر (Risk Assessment)
                                    </summary>
                                    <p id="ai-risk-assessment" class="text-sm text-gray-700 mt-2">الأولوية: ${ai.riskAssessment.priority} | الإطار الزمني المقترح: ${ai.riskAssessment.timeframe}</p>
                                </details>
                                
                                <button onclick="generateCommunicationDraft()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg text-sm flex items-center justify-center transition duration-150">
                                    <i data-lucide="send" class="w-4 h-4 ml-2"></i>
                                    صياغة اتصال/أمر عمل (Communication Drafting)
                                </button>
                                <div id="communication-draft-result" class="text-sm text-gray-700 mt-2 bg-blue-100 p-2 rounded-lg hidden"></div>
                            </div>
                        </div>

                    </div>
                </div>
            `;
            
            document.getElementById('observation-detail-view').innerHTML = detailViewHTML;
            
            // Re-create lucide icons in the newly rendered detail view
            lucide.createIcons();

            // Setup comparison slider if required
            if (observation.status === 'تمت المعالجة' && observation.isComparative && observation.imageAfter) {
                setTimeout(setupImageComparison, 100);
            }
        }


        function renderDetailView(observation) {
            currentSelectedObservation = observation;
            
            // Clear previous active state and set new one
            document.querySelectorAll('.observation-item').forEach(el => el.classList.remove('active-observation'));
            document.getElementById(`obs-item-${observation.id}`).classList.add('active-observation');

            renderDetailViewContent(observation);
        }

        // --- Controller Functions ---
        
        function showObservationDetail(id) {
            const observation = observationsData.find(obs => obs.id === id);
            if (observation) {
                renderDetailView(observation);
            }
        }

        function filterObservations(status) {
            // Reset active filter button state
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-red-600', 'text-white'));
            
            let filteredList = observationsData;
            
            // Filter by Status
            if (status !== 'all') {
                filteredList = filteredList.filter(obs => getStatusDisplay(obs.status) === status || obs.status === status);
                document.getElementById(`filter-${status.replace(/\s/g, '').toLowerCase()}`).classList.add('active', 'bg-red-600', 'text-white');
            } else {
                document.getElementById('filter-all').classList.add('active', 'bg-red-600', 'text-white');
            }
            
            // Filter by Type (Secondary filter)
            const selectedType = document.getElementById('type-filter').value;
            if (selectedType !== 'all') {
                 filteredList = filteredList.filter(obs => obs.type === selectedType);
            }

            renderObservationsList(filteredList);

            // Re-render the detail view for the first item in the filtered list
            if (filteredList.length > 0) {
                showObservationDetail(filteredList[0].id);
            } else {
                // Clear detail view if no items match
                document.getElementById('observation-detail-view').innerHTML = `
                    <div class="flex justify-center items-center h-40">
                        <p class="text-center text-gray-500">لا توجد ملاحظات مطابقة لمعايير التصفية المحددة.</p>
                    </div>
                `;
                currentSelectedObservation = null;
            }
        }
        
        function calculateKPIs() {
            const totalReports = observationsData.length;
            const openReports = observationsData.filter(obs => obs.status === 'جديد').length;
            const inProgressReports = observationsData.filter(obs => obs.status === 'قيد التنفيذ').length;
            const closedReports = observationsData.filter(obs => obs.status === 'تمت المعالجة').length;
            // The imageBefore contains the Base64/URL data
            const imageDocumented = observationsData.filter(obs => obs.imageBefore).length;

            return { totalReports, openReports: openReports + inProgressReports, closedReports, imageDocumented };
        }

        function renderKPIs() {
            const kpis = calculateKPIs();
            document.getElementById('kpi-total').textContent = kpis.totalReports;
            document.getElementById('kpi-open').textContent = kpis.openReports;
            document.getElementById('kpi-closed').textContent = kpis.closedReports;
            document.getElementById('kpi-image-documented').textContent = kpis.imageDocumented;
            
            // Render KPI Insight (Mock AI Summary)
            document.getElementById('kpi-insight-result').innerHTML = `<div class="p-4 mt-4 bg-white"><p class="font-bold text-lg text-teal-700">ملخص تنفيذي مقترح:</p><p class="text-gray-700 mt-2">تظهر البيانات أن هناك ${kpis.openReports} ملاحظات مفتوحة تحتاج إلى معالجة فورية. يجب على الفريق التنفيذي مراجعة خطط العمل الفورية لتقليل متوسط زمن الإغلاق والتركيز على توثيق جميع الملاحظات بالصور لضمان جودة الإغلاق.</p></div>`;
        }
        
        function generateCommunicationDraft() {
            if (!currentSelectedObservation) {
                alert('الرجاء اختيار ملاحظة أولاً.');
                return;
            }
            
            const obs = currentSelectedObservation;
            const draft = `
                <p class="font-bold">مسودة أمر عمل/بريد إلكتروني (تم توليدها بواسطة Gemini):</p>
                <p><strong>إلى:</strong> فريق ${obs.type}، <strong>نسخة إلى:</strong> المدير التنفيذي</p>
                <p><strong>الموضوع:</strong> ملاحظة ${obs.type} عاجلة - ${obs.title}</p>
                <p class="mt-2">الزملاء الكرام،</p>
                <p>يرجى العلم بالملاحظة رقم ${obs.id} التي تم تسجيلها في ${obs.location}.</p>
                <p><strong>الوصف:</strong> ${obs.description}</p>
                <p><strong>تحليل السبب الجذري:</strong> ${obs.aiAnalysis.rootCause}</p>
                <p><strong>خطة العمل المطلوبة:</strong></p>
                <ul class="list-disc list-inside">
                    ${obs.aiAnalysis.actionPlan.map(item => `<li>${item}</li>`).join('')}
                </ul>
                <p>الأولوية: ${obs.aiAnalysis.riskAssessment.priority}، يجب إغلاقها في غضون ${obs.aiAnalysis.riskAssessment.timeframe}.</p>
                <p>مع خالص التحية،</p>
            `;
            
            const resultEl = document.getElementById('communication-draft-result');
            resultEl.innerHTML = draft;
            resultEl.classList.remove('hidden');
        }

        async function handleCloseout(event) {
            event.preventDefault();
            if (!currentSelectedObservation) return;

            const afterPhotoFile = document.getElementById('afterPhoto').files[0];
            const resolutionNote = document.getElementById('resolutionNote').value;
            
            if (!afterPhotoFile || !resolutionNote) {
                alert('الرجاء إرفاق صورة الإغلاق وكتابة ملاحظة الحل.');
                return;
            }
            
            // Convert 'after' photo to Base64 for persistence
            const afterPhotoBase64 = await fileToBase64(afterPhotoFile);
            
            const index = observationsData.findIndex(obs => obs.id === currentSelectedObservation.id);
            if (index !== -1) {
                observationsData[index].status = 'تمت المعالجة';
                observationsData[index].imageAfter = afterPhotoBase64; // Save Base64 data
                observationsData[index].resolutionNote = resolutionNote;
                observationsData[index].isComparative = true;
                
                // Save updated data to Local Storage
                saveObservationsToLocalStorage();
                
                // Re-render UI
                document.getElementById('closeoutModal').classList.add('hidden');
                calculateAndRenderAll();
                showObservationDetail(currentSelectedObservation.id);
                alert('تم الإغلاق التنفيذي للملاحظة بنجاح وتحديث اللوحة.');
            }
        }
        
        async function handleSmartInput(event) {
            event.preventDefault();

            const description = document.getElementById('smartInputText').value;
            const location = document.getElementById('smartInputLocation').value;
            const photoFile = document.getElementById('smartInputPhoto').files[0];

            if (!description) {
                alert('الرجاء إدخال وصف الملاحظة.');
                return;
            }
            
            let photoBase64 = null;
            if (photoFile) {
                photoBase64 = await fileToBase64(photoFile); // Convert 'before' photo to Base64
            }

            // Mock AI Classification
            const aiResultEl = document.getElementById('ai-classification-result');
            const aiContainer = document.getElementById('smart-input-ai-result');
            
            aiContainer.classList.remove('hidden');
            aiResultEl.innerHTML = 'جاري تحليل الملاحظة بواسطة Gemini...';

            setTimeout(() => {
                // Mock result: AI determines type and risk (replace this with actual Gemini API calls if integrated)
                const mockType = ['صيانة', 'جودة', 'سلامة', 'بيئة'][Math.floor(Math.random() * 4)];
                const mockRisk = ['عاجل', 'مرتفع', 'متوسط', 'منخفض'][Math.floor(Math.random() * 4)];
                const mockTimeframe = mockRisk === 'عاجل' ? '24 ساعة' : mockRisk === 'مرتفع' ? '48 ساعة' : mockRisk === 'متوسط' ? '7 أيام' : '14 يوم';
                const mockTitle = description.substring(0, 30) + (description.length > 30 ? '...' : '');

                aiResultEl.innerHTML = `تم التصنيف بواسطة Gemini:\n- <strong>النوع:</strong> ${mockType}\n- <strong>الأولوية المقدرة:</strong> ${mockRisk}`;

                // Add to data store (Creation)
                const newId = observationsData.length > 0 ? Math.max(...observationsData.map(o => o.id)) + 1 : 1;
                const newObservation = {
                    id: newId,
                    title: mockTitle,
                    description: description,
                    status: "جديد",
                    type: mockType,
                    location: location || 'موقع غير محدد',
                    createdAt: new Date(),
                    imageBefore: photoBase64, // Save Base64 data
                    imageAfter: null,
                    resolutionNote: null,
                    isComparative: false,
                    aiAnalysis: {
                        vision: 'تم توليد هذا التحليل آلياً من الإدخال النصي والصوري (إن وجد). المشكلة تتطلب تدخل ' + mockType + '.',
                        rootCause: 'سبب غير محدد بعد، يتطلب فحصاً ميدانياً.',
                        actionPlan: ['تكليف فريق الفحص الميداني.', 'تحديد السبب الجذري الفعلي.', 'تنفيذ خطة المعالجة.'],
                        riskAssessment: { priority: mockRisk, timeframe: mockTimeframe }
                    }
                };

                observationsData.push(newObservation);
                
                // Save updated data to Local Storage
                saveObservationsToLocalStorage();

                // Re-render UI
                document.getElementById('smartInputModal').classList.add('hidden');
                // Reset form fields
                document.getElementById('smartInputText').value = '';
                document.getElementById('smartInputLocation').value = '';
                document.getElementById('smartInputPhoto').value = ''; 
                
                calculateAndRenderAll();
                showObservationDetail(newId);
                alert(`تم إنشاء ملاحظة جديدة (#${newId}) بنجاح.`);

            }, 1500); // Simulate AI processing time
        }

        function printObservationList() {
            // Mock function to generate a PDF report using browser print
            const printContent = document.getElementById('observations-list').innerHTML;
            
            // Create a print window/iframe to hold the content
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>تقرير سجل الملاحظات - Smart HSR</title>
                    <style>
                        body { font-family: Tahoma, sans-serif; direction: rtl; text-align: right; margin: 20px; }
                        .print-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .print-header h1 { font-size: 24px; color: #1e3a8a; }
                        .observation-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
                        .font-semibold { font-weight: bold; }
                        .text-xs { font-size: 10px; }
                        .text-gray-500 { color: #666; }
                        .badge-completed { background-color: #a7f3d0; color: #065f46; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                        .badge-new { background-color: #fcd34d; color: #92400e; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                        .badge-inprogress { background-color: #93c5fd; color: #1e40af; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>تقرير سجل الملاحظات</h1>
                        <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    ${printContent}
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        
        function generateKPISummaryReport() {
            // Mock function to generate an executive summary report
             alert('تم توليد التقرير التنفيذي لملخص اللوحة بصيغة PDF وجاهز للتحميل. (وظيفة افتراضية)');
             
             const kpis = calculateKPIs();
             const summaryText = document.getElementById('kpi-insight-result').textContent.trim();

             const reportContent = `
                <div style="direction: rtl; text-align: right; font-family: Tahoma, sans-serif;">
                    <h1 style="color:#1e3a8a;">التقرير التنفيذي الموجز للوحة القيادة</h1>
                    <p>التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    <hr style="margin: 20px 0;">
                    
                    <h2 style="color:#333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">مؤشرات الأداء الحيوية (KPIs)</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">إجمالي الملاحظات</td><td style="padding: 8px; border: 1px solid #ddd;">${kpis.totalReports}</td></tr>
                        <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #92400e;">ملاحظات مفتوحة/انتظار</td><td style="padding: 8px; border: 1px solid #ddd; color: #92400e;">${kpis.openReports}</td></tr>
                        <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #065f46;">ملاحظات مغلقة/معالجة</td><td style="padding: 8px; border: 1px solid #ddd; color: #065f46;">${kpis.closedReports}</td></tr>
                    </table>
                    
                    <h2 style="color:#333; border-bottom: 1px solid #ccc; padding-top: 20px; padding-bottom: 5px;">ملخص وتحليل Gemini AI</h2>
                    <div style="background-color: #f0f8ff; padding: 15px; border-radius: 5px;">
                        <p style="font-weight: bold;">${summaryText}</p>
                    </div>
                    
                </div>
             `;
             
             const printWindow = window.open('', '_blank');
             printWindow.document.write(`<html><head><title>تقرير تنفيذي</title></head><body>${reportContent}</body></html>`);
             printWindow.document.close();
             // printWindow.print(); // Uncomment this line to trigger the print dialog
        }


        // --- Initialization ---

        function calculateAndRenderAll() {
            calculateKPIs();
            renderKPIs();
            observationsData.sort((a, b) => b.createdAt - a.createdAt);
            renderObservationsList(observationsData);

            // Select the first observation if data exists
            if (observationsData.length > 0) {
                showObservationDetail(observationsData[0].id);
            } else {
                 document.getElementById('observation-detail-view').innerHTML = `
                    <div class="flex justify-center items-center h-40">
                        <p class="text-center text-gray-500">الرجاء اختيار ملاحظة من القائمة لعرض التفاصيل.</p>
                    </div>
                 `;
            }
        }

        function initApp() {
            loadObservationsFromLocalStorage(); // Load data first
            calculateAndRenderAll();
            lucide.createIcons();
        }

        window.onload = initApp;

    </script>
</body>

</html>
