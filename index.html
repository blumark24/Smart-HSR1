<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
    <meta name="description" content="Ù†Ø¸Ø§Ù… Smart HSR Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">
    <meta name="keywords" content="Smart HSR, Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©, Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©, Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…, Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ, ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Smart HSR | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ">
    <meta property="og:description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-navy: #0A1931;
            --color-teal: #18A5A2;
            --color-light-teal: #ACE2E1;
            --color-gray-bg: #F7F9FC;
            --color-shadow-base: rgba(10, 25, 49, 0.4);
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--color-gray-bg); color: var(--color-navy); }
        /* KPIs gradients */
        .kpi-open-gradient { background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); color: white; box-shadow: 0 10px 20px rgba(185,28,28,.4); }
        .kpi-closed-gradient { background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%); color: white; box-shadow: 0 10px 20px rgba(24,165,162,.4); }
        .kpi-images-gradient { background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%); color: white; box-shadow: 0 10px 20px rgba(59,130,246,.4); }
        .kpi-card-professional { transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; }
        .kpi-card-professional:hover { transform: translateY(-8px) scale(1.02); z-index:10; }
        .ai-button-primary { background-color: var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5); border:none; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; }
        .ai-button-primary:hover { background-color:#148f8c; transform:translateY(-2px); }
        .ai-button-secondary { background-color: var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6); border:none; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; }
        .image-container { position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base); }
        .image-label { position:absolute; bottom:0; right:0; background-color: var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem; }
        .observation-item { transition:.2s; border-right:4px solid transparent; cursor:pointer; padding:12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; }
        .observation-item:hover, .observation-item.active { background:#E6F3F3; border-right-color: var(--color-teal); }
        .comparison-wrapper { position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem; }
        .comparison-wrapper img { display:block; width:100%; height:auto; }
        .comparison-wrapper .after-image { position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden; }
        .comparison-wrapper .comparison-divider { position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; }
        .label { color:#64748b; font-size:.9rem; }
        .input{ width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100; align-items:center; justify-content:center; }
        .modal .modal-content{ background:#fff; width:90%; max-width:800px; padding:24px; border-radius:24px; }
        @media print {
            body{ background:#fff !important; color:#000 !important; width:210mm; min-height:297mm; margin:0; }
            .no-print, #hero, footer, .modal { display:none !important; }
            #observationDetail { display:block !important; max-width:100% !important; margin:0 !important; padding:0 !important; box-shadow:none !important; border:none !important; }
            .comparison-wrapper .comparison-divider, .comparison-label { display:none !important; }
            .comparison-wrapper .after-image { width:100% !important; overflow:visible !important; }
        }
    </style>
</head>
<body class="text-gray-800">
    <main class="container" style="max-width:1200px; margin:0 auto; padding:24px;">
        <div class="flex justify-start mb-6 no-print" style="display:flex; justify-content:flex-start; margin-bottom:12px;">
            <button id="logout-btn" class="ai-button-secondary" onclick="smartLogout()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù…Ù†">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>

        <section id="hero" class="text-center" style="padding:24px; background:#fff; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-bottom:24px; border-top:8px solid #bfeeed; border-bottom:8px solid #bfeeed;">
            <h1 style="font-size:42px; margin:0 0 8px; color:var(--color-navy)">Smart HSR <span style="color:var(--color-teal)">Dashboard</span></h1>
            <h2 style="margin:0; color:#475569; font-weight:800;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</h2>
            <p class="label" style="margin-top:6px;">"Ù…Ù†ØµØ© ØªÙ†ÙÙŠØ°ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ ØªÙˆÙØ± Ø±Ø¤ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ ÙˆØªØ¯Ø¹Ù… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 style="font-size:32px; margin:0 0 6px; color:var(--color-navy)">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ: Ø¯Ù‚Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù†Øµ</h3>
                <p class="label">Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù„ÙŠ.</p>
                <button id="add-observation-btn" class="ai-button-primary" onclick="openModal('smartInputModal')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ)</button>
            </div>

            <div class="bg-white" style="padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.08); display:grid; grid-template-columns: 1fr 2fr; gap:18px; border:1px solid #e2e8f0;">
                <div class="no-print" style="border-left:1px solid #e2e8f0; padding-left:12px;">
                    <h4 style="margin:0 0 8px; color:var(--color-teal)">ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
                    <select id="observationFilter" class="input" onchange="handleFilterChange()">
                        <option value="ALL">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
                        <option value="PENDING">Ø¬Ø¯ÙŠØ¯</option>
                        <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                        <option value="COMPLETED">ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                        <option value="QUALITY">Ø¬ÙˆØ¯Ø©</option>
                        <option value="MAINTENANCE">ØµÙŠØ§Ù†Ø©</option>
                        <option value="SAFETY">Ø³Ù„Ø§Ù…Ø©</option>
                        <option value="ENVIRONMENT">Ø¨ÙŠØ¦Ø©</option>
                    </select>
                    <h4 style="margin:16px 0 8px; color:var(--color-navy)">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
                    <div id="observationsList" style="max-height:500px; overflow:auto; padding-right:6px;">
                        <div class="label" style="text-align:center; padding:12px;">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...</div>
                    </div>
                </div>

                <div class="bg-gray-50" style="padding:12px; border-radius:18px; border:1px solid #e2e8f0;">
                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 style="font-size:24px; margin:0 0 6px; color:var(--color-navy); font-weight:900;">ØªÙ‚Ø±ÙŠØ± Smart HSR Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</h2>
                        <p id="printTitle" class="label"></p>
                    </div>

                    <h4 style="margin:0 0 8px; color:var(--color-teal); font-weight:900;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">
                        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; font-size:14px; font-weight:700; margin-bottom:12px; background:#fff; padding:10px; border-radius:12px; border:1px solid #e2e8f0;">
                            <div><span class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span><div id="detailTitle"></div></div>
                            <div><span class="label">Ø§Ù„ØªØµÙ†ÙŠÙ:</span><div id="detailType" class="label" style="font-weight:900; color:var(--color-teal)"></div></div>
                            <div><span class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span><div id="detailLocation"></div></div>
                            <div><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº:</span><div id="detailDate"></div></div>
                            <div><span class="label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span><div><span id="detailStatus" class="label" style="display:inline-block; padding:4px 10px; border-radius:999px; color:#fff; background:#94a3b8;"></span></div></div>
                            <div><span class="label">Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº:</span><div id="detailID"></div></div>
                        </div>

                        <div style="background:#fff; padding:12px; border-radius:12px; border-left:6px solid #14b8a6; margin-bottom:12px;">
                            <h5 style="margin:0 0 6px; color:var(--color-navy); font-weight:900;">ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h5>
                            <p id="detailDescription" style="margin:0; color:#334155;"></p>
                            <div id="actionPlanContainer" class="hidden" style="margin-top:8px; background:#ecfeff; padding:10px; border-radius:12px">
                                <b>Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Gemini AI):</b>
                                <p id="actionPlan" style="margin:6px 0 0;"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer" class="hidden" style="background:#ecfdf5; padding:12px; border-radius:12px; border-left:6px solid #16a34a; margin-bottom:12px;">
                            <b>ğŸ“ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚:</b>
                            <p id="resolutionNote" style="margin-top:6px;"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper hidden" style="margin-bottom:12px;">
                            <img id="beforeImage" alt="ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">
                            <div id="afterImageContainer" class="after-image"><img id="afterImage" alt="ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"></div>
                            <div id="comparisonDivider" class="comparison-divider"></div>
                            <span class="comparison-label label-before" style="position:absolute; top:8px; right:8px; background:#B91C1C; color:#fff; padding:6px 10px; border-radius:8px;">Ù‚Ø¨Ù„</span>
                            <span class="comparison-label label-after" style="position:absolute; top:8px; left:8px; background:#10B981; color:#fff; padding:6px 10px; border-radius:8px;">Ø¨Ø¹Ø¯</span>
                        </div>

                        <div id="mediaContainer" class="image-container hidden" style="margin-bottom:12px;">
                            <div id="mediaContent"></div>
                            <span class="image-label">Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</span>
                        </div>

                        <div id="noImageMessage" class="hidden" style="background:#FEF3C7; padding:12px; border-radius:12px; color:#92400E; text-align:center; font-weight:700; margin-bottom:12px;">
                            âš ï¸ Ù„Ø§ ØªØªÙˆÙØ± ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.
                        </div>

                        <div id="aiAnalysisSection" style="background:#fff; padding:12px; border-radius:12px; border-top:4px solid #e5e7eb;">
                            <h5 style="margin:0 0 8px; color:var(--color-navy); font-weight:900;">Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Gemini AI)</h5>
                            <div class="no-print" style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button id="vision-btn" class="ai-button-primary" onclick="analyzeImage('vision')">ğŸ‘ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± (Vision)</button>
                                <button id="root-cause-btn" class="ai-button-primary" style="background:#881337" onclick="analyzeImage('root-cause')">ğŸ”¬ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ</button>
                                <button id="comm-btn" class="ai-button-primary" style="background:#F97316" onclick="generateCommunicationDraft()">âœ‰ï¸ Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„</button>
                                <button id="pdf-report-btn" class="ai-button-primary" style="background:#10B981" onclick="generatePdfReport()">ğŸ“„ ØªÙˆÙ„ÙŠØ¯ PDF</button>
                            </div>
                            <div id="aiResultContainer" class="hidden" style="margin-top:10px; background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #e2e8f0;">
                                <h6 id="aiResultTitle" style="margin:0 0 6px; color:var(--color-teal); font-weight:900;"></h6>
                                <div id="aiResultContent" style="color:#334155;"></div>
                            </div>
                        </div>

                        <div id="actionButtons" class="no-print" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                            <button id="updateStatusBtn" class="ai-button-secondary" style="background:#9ca3af" onclick="updateToInProgress()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"</button>
                            <button id="completeObservationBtn" class="ai-button-secondary" style="background:#dc2626" onclick="openModal('closeoutModal')">ğŸ”’ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ (ØµÙˆØ±Ø© Ø¨Ø¹Ø¯)</button>
                            <button id="alreadyCompletedBtn" class="ai-button-secondary hidden" style="background:#16a34a" disabled>âœ… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ØºÙ„Ù‚Ø© ÙˆÙ…ÙˆØ«Ù‚Ø©</button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center" style="padding:24px; color:#94a3b8;">
                        Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
                    </div>
                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="no-print" style="margin-top:24px;">
            <div class="text-center" style="margin-bottom:12px;">
                <h3 style="font-size:28px; margin:0 0 6px; color:var(--color-navy)">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ© (Vital Metrics)</h3>
                <p class="label">ØªØªØ¨Ø¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¨Ø§Ù„ØµÙˆØ± Ù„Ø¶Ù…Ø§Ù† ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.</p>
            </div>
            <div id="kpiContainer" style="display:grid; grid-template-columns: repeat(4,1fr); gap:12px;">
                <div class="kpi-card-professional p-6" style="background:#fff; border-top:4px solid #e5e7eb;">
                    <p class="label">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    <p style="font-size:36px; font-weight:900; color:#334155;">--</p>
                </div>
            </div>

            <div class="text-center" style="margin-top:18px;">
                <button id="kpi-insight-button" class="ai-button-secondary" onclick="generateKpiInsights()">âœ¨ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù„ÙˆØ­Ø© (Gemini AI)</button>
                <div id="kpi-insight-result" class="label" style="margin-top:10px;"></div>
            </div>
        </section>

        <footer class="no-print" style="text-align:center; margin-top:28px; border-top:4px solid #99f6e4; background:#fff; border-radius:24px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.08)">
            <div class="label">Â© 2025 Smart HSR. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©. <span id="userInfo"></span></div>
        </footer>
    </main>

    <!-- Modal: Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ -->
    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-weight:900;">ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Smart HSR)</h3>
                <button class="ai-button-secondary" onclick="closeModal('smartInputModal')">âœ–</button>
            </div>
            <div style="display:grid; gap:10px; margin-top:12px;">
                <textarea id="rawObservationInput" rows="4" class="input" placeholder="Ù…Ø«Ø§Ù„: ØªØ¬Ù…Ø¹ Ù…ÙŠØ§Ù‡ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙŠÙ„Ùˆ 52 Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ø±Ù‚..."></textarea>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <div class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS):</div>
                        <div id="locationStatus" class="label">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</div>
                        <input id="inputLatitude" type="hidden"><input id="inputLongitude" type="hidden">
                        <button class="ai-button-primary" onclick="getLocation()" type="button">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                    </div>
                    <div>
                        <div class="label">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</div>
                        <div id="fileStatus" class="label">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</div>
                        <input id="fileUploadInput" type="file" accept="image/*,video/*" style="display:none">
                        <button class="ai-button-secondary" onclick="document.getElementById('fileUploadInput').click()" type="button">â¤´ï¸ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <select id="mType" class="input">
                        <option value="QUALITY">Ø¬ÙˆØ¯Ø©</option><option value="MAINTENANCE">ØµÙŠØ§Ù†Ø©</option>
                        <option value="SAFETY">Ø³Ù„Ø§Ù…Ø©</option><option value="ENVIRONMENT">Ø¨ÙŠØ¦Ø©</option>
                    </select>
                    <input id="mTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ±">
                    <select id="mPriority" class="input">
                        <option value="High">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</option><option value="Medium">Ù…ØªÙˆØ³Ø·Ø©</option><option value="Low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                    </select>
                </div>
                <button id="processSmartInputBtn" class="ai-button-primary" onclick="processSmartInput()" disabled>ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ -->
    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-weight:900;">ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø© #<span id="closeoutId"></span></h3>
                <button class="ai-button-secondary" onclick="closeModal('closeoutModal'); clearAfterUpload();">âœ–</button>
            </div>
            <div style="display:grid; gap:10px; margin-top:12px;">
                <div>
                    <div class="label">Ø±ÙØ¹ ØµÙˆØ±Ø© **Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­** (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</div>
                    <div id="afterFileStatus" class="label">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</div>
                    <input id="afterFileUploadInput" type="file" accept="image/*" style="display:none">
                    <button class="ai-button-primary" onclick="document.getElementById('afterFileUploadInput').click()" type="button">ğŸ“· Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
                <textarea id="resolutionNoteInput" rows="3" class="input" placeholder="Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©"></textarea>
                <button id="finalCloseoutBtn" class="ai-button-secondary" style="background:#16a34a" onclick="completeObservation()" disabled>âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
            </div>
        </div>
    </div>

    <!-- Firebase (modular v12) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-storage.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø­Ø³Ø¨ Ù…Ø§ Ø²ÙˆÙ‘Ø¯ØªÙ†ÙŠ Ø¨Ù‡)
        const firebaseConfig = {
          apiKey: "AIzaSyCRrBnPYtdc86JffEQHERf732uAif7vwho",
          authDomain: "smart-hsr-6c2cf.firebaseapp.com",
          databaseURL: "https://smart-hsr-6c2cf-default-rtdb.firebaseio.com",
          projectId: "smart-hsr-6c2cf",
          storageBucket: "smart-hsr-6c2cf.firebasestorage.app",
          messagingSenderId: "399213527987",
          appId: "1:399213527987:web:4531958edfe9dbb95a81c6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Ø¹Ù†Ø§ØµØ±
        const logoutBtn = document.getElementById('logout-btn');
        const listEl = document.getElementById('observationsList');
        const filterEl = document.getElementById('observationFilter');

        const detail = document.getElementById('observationDetail');
        const placeholder = document.getElementById('detailPlaceholder');
        const dTitle = document.getElementById('detailTitle');
        const dType = document.getElementById('detailType');
        const dLoc = document.getElementById('detailLocation');
        const dDate = document.getElementById('detailDate');
        const dId = document.getElementById('detailID');
        const dDesc = document.getElementById('detailDescription');
        const dStatus = document.getElementById('detailStatus');
        const actionPlanContainer = document.getElementById('actionPlanContainer');
        const actionPlan = document.getElementById('actionPlan');
        const resolutionNoteContainer = document.getElementById('resolutionNoteContainer');
        const resolutionNote = document.getElementById('resolutionNote');
        const imageComparisonWrapper = document.getElementById('imageComparisonWrapper');
        const beforeImage = document.getElementById('beforeImage');
        const afterImage = document.getElementById('afterImage');
        const afterImageContainer = document.getElementById('afterImageContainer');
        const comparisonDivider = document.getElementById('comparisonDivider');
        const mediaContainer = document.getElementById('mediaContainer');
        const mediaContent = document.getElementById('mediaContent');
        const noImageMessage = document.getElementById('noImageMessage');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const completeObservationBtn = document.getElementById('completeObservationBtn');
        const alreadyCompletedBtn = document.getElementById('alreadyCompletedBtn');
        const printTitle = document.getElementById('printTitle');
        const kAll = document.createElement('div'); // Not used directly; compute in renderKPIs
        const userInfoEl = document.getElementById('userInfo');

        // Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ
        const smartInputModal = document.getElementById('smartInputModal');
        const rawObservationInput = document.getElementById('rawObservationInput');
        const inputLatitude = document.getElementById('inputLatitude');
        const inputLongitude = document.getElementById('inputLongitude');
        const locationStatus = document.getElementById('locationStatus');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const fileStatus = document.getElementById('fileStatus');
        const mType = document.getElementById('mType');
        const mTitle = document.getElementById('mTitle');
        const mPriority = document.getElementById('mPriority');
        const processSmartInputBtn = document.getElementById('processSmartInputBtn');

        // Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ
        const closeoutModal = document.getElementById('closeoutModal');
        const closeoutId = document.getElementById('closeoutId');
        const afterFileUploadInput = document.getElementById('afterFileUploadInput');
        const afterFileStatus = document.getElementById('afterFileStatus');
        const resolutionNoteInput = document.getElementById('resolutionNoteInput');
        const finalCloseoutBtn = document.getElementById('finalCloseoutBtn');

        let observations = [];
        let current = null;
        let currentFile = null;
        let currentAfterFile = null;

        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, user => {
          if(!user){ window.location.href = 'login.html'; } else {
            initRealtime();
          }
        });

        logoutBtn.onclick = () => signOut(auth);

        function initRealtime(){
          const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
          onSnapshot(q, snap=>{
            observations = snap.docs.map(d=>({id:d.id, ...d.data()}));
            renderList(); renderKPIs();
            if(current){ const n = observations.find(x=>x.id===current.id); if(n) showObservationDetail(n.id); }
            userInfoEl.textContent = ' | Ù…ØªØµÙ„ Ø¨Ù€ Firestore (Ù…Ø¨Ø§Ø´Ø±)';
          });
        }

        // Ù‚Ø§Ø¦Ù…Ø© + ÙÙ„ØªØ±Ø©
        filterEl.onchange = () => renderList();
        function renderList(){
          const f = filterEl.value;
          let data = observations;
          if(f !== 'ALL'){
            data = observations.filter(x => x.status===f || x.type===f);
          }
          listEl.innerHTML = (data.length? '' : '<div class="label" style="padding:12px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>');
          data.forEach(x=>{
            const statusInfo = { PENDING:['#dc2626','Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'], IN_PROGRESS:['#ca8a04','Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'], COMPLETED:['#16a34a','ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'] }[x.status] || ['#94a3b8', x.status];
            const div = document.createElement('div');
            div.className = 'observation-item' + (current && x.id===current.id ? ' active' : '');
            div.innerHTML = `<div><div style="font-weight:900; color:#0f172a">${escapeHTML(x.title||'-')}</div><div class="label">${fmtDate(x.createdAt)} | ${escapeHTML(x.type||'-')}</div></div><span style="display:inline-block; padding:4px 10px; border-radius:999px; color:#fff; background:${statusInfo[0]}">${statusInfo[1]}</span>`;
            div.onclick = ()=>showObservationDetail(x.id);
            listEl.appendChild(div);
          });
          if(!current && data[0]) showObservationDetail(data[0].id);
        }

        function showObservationDetail(id){
          current = observations.find(x=>x.id===id); if(!current) return;
          document.querySelectorAll('.observation-item').forEach(el=>el.classList.remove('active'));
          // (re)mark active visually
          const items = Array.from(listEl.children);
          const idx = observations.findIndex(x=>x.id===id);
          if(items[idx]) items[idx].classList.add('active');

          placeholder.classList.add('hidden'); detail.classList.remove('hidden');
          dTitle.textContent = current.title||''; printTitle.textContent = 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ' + (current.title||'');
          dType.textContent = current.type||''; dLoc.textContent = current.location||'';
          dDate.textContent = fmtDate(current.createdAt); dId.textContent = current.id;
          dDesc.innerHTML = escapeHTML(current.details||'').replace(/\n/g,'<br>');
          setStatusBadge(current.status);

          if(current.actionPlan || current.riskAssessment){
            actionPlanContainer.classList.remove('hidden');
            const risk = current.riskAssessment ? `Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${current.riskAssessment.priority} | Ø§Ù„Ø¥Ø·Ø§Ø±: ${current.riskAssessment.timeframe}` : '';
            actionPlan.textContent = `${risk} â€” Ø§Ù„Ø®Ø·Ø©: ${current.actionPlan||'-'}`;
          } else { actionPlanContainer.classList.add('hidden'); }

          resolutionNoteContainer.classList.add('hidden');
          mediaContainer.classList.add('hidden');
          imageComparisonWrapper.classList.add('hidden');
          noImageMessage.classList.add('hidden');

          if(current.status==='COMPLETED' && current.afterImageUrl){
            imageComparisonWrapper.classList.remove('hidden');
            beforeImage.src = current.mediaUrl||''; afterImage.src = current.afterImageUrl||'';
            setupCompare();
            if(current.resolutionNote){ resolutionNoteContainer.classList.remove('hidden'); resolutionNote.textContent = current.resolutionNote; }
          } else if(current.mediaUrl){
            mediaContainer.classList.remove('hidden');
            if(current.isVideo){
              mediaContent.innerHTML = `<video controls style="width:100%; height:auto; border-radius:8px"><source src="${current.mediaUrl}" type="${current.mediaMime||'video/mp4'}"></video>`;
            } else {
              mediaContent.innerHTML = `<img src="${current.mediaUrl}" alt="media" style="display:block; width:100%; height:auto">`;
            }
          } else {
            noImageMessage.classList.remove('hidden');
          }

          alreadyCompletedBtn.classList.toggle('hidden', current.status!=='COMPLETED');
          completeObservationBtn.style.display = current.status==='COMPLETED' ? 'none' : 'inline-flex';
          updateStatusBtn.style.display = current.status==='PENDING' ? 'inline-flex' : 'none';
        }

        function setStatusBadge(s){
          const map = { PENDING:['#dc2626','Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'], IN_PROGRESS:['#ca8a04','Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'], COMPLETED:['#16a34a','ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'] };
          const m = map[s] || ['#94a3b8', s];
          dStatus.style.background = m[0]; dStatus.textContent = m[1];
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        async function updateToInProgress(){
          if(!current) return;
          await updateDoc(doc(db,'observations',current.id), { status:'IN_PROGRESS' });
        }
        window.updateToInProgress = updateToInProgress;

        // Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ
        window.getLocation = ()=>{
          locationStatus.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
          navigator.geolocation.getCurrentPosition(pos=>{
            inputLatitude.value = pos.coords.latitude; inputLongitude.value = pos.coords.longitude;
            locationStatus.textContent = `${(+inputLatitude.value).toFixed(5)}, ${(+inputLongitude.value).toFixed(5)}`;
            toggleCreateEnabled();
          }, ()=>{ locationStatus.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; });
        };
        fileUploadInput.onchange = ()=>{
          const f = fileUploadInput.files[0]; fileStatus.textContent = f ? `${f.name} (${(f.size/1024/1024).toFixed(2)} MB)` : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'; toggleCreateEnabled();
        };
        rawObservationInput.oninput = toggleCreateEnabled;
        mTitle.oninput = toggleCreateEnabled;
        function toggleCreateEnabled(){ processSmartInputBtn.disabled = !(rawObservationInput.value.trim() || fileUploadInput.files[0] || (inputLatitude.value && inputLongitude.value)); }

        async function processSmartInput(){
          try{
            processSmartInputBtn.disabled = true; processSmartInputBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
            const isVideo = fileUploadInput.files[0] ? fileUploadInput.files[0].type.startsWith('video') : false;
            const fileMime = fileUploadInput.files[0] ? fileUploadInput.files[0].type : null;

            const docRef = await addDoc(collection(db,'observations'), {
              type: mType.value, title: mTitle.value || 'â€”', details: rawObservationInput.value || '',
              status: 'PENDING',
              location: (inputLatitude.value && inputLongitude.value) ? `${(+inputLatitude.value).toFixed(5)}, ${(+inputLongitude.value).toFixed(5)}` : '',
              actionPlan: null, riskAssessment: {priority: mPriority.value, timeframe: (mPriority.value==='High'?'24h':'72h')},
              hasImage: !!fileUploadInput.files[0], isVideo, mediaUrl: null, mediaMime: fileMime,
              afterImageUrl: null, resolutionNote: null,
              createdAt: serverTimestamp()
            });

            if(fileUploadInput.files[0]){
              const p = `observations/${docRef.id}/${isVideo?'before.mp4':'before.jpg'}`;
              const r = ref(storage, p);
              await uploadBytesResumable(r, fileUploadInput.files[0]);
              const url = await getDownloadURL(r);
              await updateDoc(doc(db,'observations',docRef.id), { mediaUrl:url });
            }

            closeModal('smartInputModal');
            rawObservationInput.value=''; mTitle.value=''; fileUploadInput.value=''; fileStatus.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'; inputLatitude.value=''; inputLongitude.value=''; locationStatus.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯';
          }catch(e){ alert(e.message); } finally { processSmartInputBtn.disabled=false; processSmartInputBtn.textContent='ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„'; }
        }
        window.processSmartInput = processSmartInput;

        // Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ
        function openCloseout(){
          if(!current) return;
          document.getElementById('closeoutId').textContent = current.id;
          afterFileUploadInput.value=''; afterFileStatus.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'; resolutionNoteInput.value='';
          document.getElementById('finalCloseoutBtn').disabled = true;
          openModal('closeoutModal');
        }
        completeObservationBtn.addEventListener('click', openCloseout);
        afterFileUploadInput.onchange = ()=>{
          afterFileStatus.textContent = afterFileUploadInput.files[0] ? afterFileUploadInput.files[0].name : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
          finalCloseoutBtn.disabled = !afterFileUploadInput.files[0];
        };
        window.completeObservation = async ()=>{
          if(!current || !afterFileUploadInput.files[0]) return;
          try{
            finalCloseoutBtn.disabled=true; finalCloseoutBtn.textContent='... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚';
            const p = `observations/${current.id}/after.jpg`;
            const r = ref(storage, p);
            await uploadBytes(r, afterFileUploadInput.files[0]);
            const url = await getDownloadURL(r);
            await updateDoc(doc(db,'observations',current.id), {
              status:'COMPLETED', afterImageUrl:url, resolutionNote:(resolutionNoteInput.value.trim()||`ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ ${new Date().toLocaleString('ar-SA')}`)
            });
            closeModal('closeoutModal');
          }catch(e){ alert(e.message); } finally { finalCloseoutBtn.disabled=false; finalCloseoutBtn.textContent='âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©'; }
        };
        window.clearAfterUpload = ()=>{ afterFileUploadInput.value=''; afterFileStatus.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'; resolutionNoteInput.value=''; };

        // KPIs
        function renderKPIs(){
          const total = observations.length;
          const open = observations.filter(x=>x.status!=='COMPLETED').length;
          const closed = total - open;
          const withImg = observations.filter(x=>x.mediaUrl).length;
          const kpiContainer = document.getElementById('kpiContainer');
          kpiContainer.innerHTML = '';
          const data = [
            {title:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', value: total, icon:'clipboard-list', cls:'kpi-images-gradient'},
            {title:'Ù…ÙØªÙˆØ­Ø©/Ø§Ù†ØªØ¸Ø§Ø±', value: open, icon:'alert-triangle', cls:'kpi-open-gradient'},
            {title:'Ù…ØºÙ„Ù‚Ø©/Ù…Ø¹Ø§Ù„Ø¬Ø©', value: closed, icon:'check-circle', cls:'kpi-closed-gradient'},
            {title:'Ù…ÙˆØ«Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±', value: withImg, icon:'image', cls:'kpi-images-gradient'},
          ];
          data.forEach(k=>{
            const el = document.createElement('div');
            el.className = `kpi-card-professional p-6 ${k.cls}`;
            el.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between;">
              <div><p style="margin:0; font-weight:700">${k.title}</p><p style="margin:4px 0 0; font-size:36px; font-weight:900">${k.value}</p></div>
              <span style="font-size:28px; opacity:.8">ğŸ“Š</span>
            </div>`;
            kpiContainer.appendChild(el);
          });
        }

        // Ù…Ù‚Ø§Ø±Ù†Ø© Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯
        function setupCompare(){
          let dragging=false;
          const rect = ()=>imageComparisonWrapper.getBoundingClientRect();
          const move = (clientX)=>{
            const r = rect(); let left = Math.max(0, Math.min(clientX - r.left, r.width));
            afterImageContainer.style.width = left+'px';
            comparisonDivider.style.left = left+'px';
          };
          const start = (e)=>{ dragging=true; move((e.touches?e.touches[0].clientX:e.clientX)); };
          const end = ()=>{ dragging=false; };
          const drag = (e)=>{ if(!dragging) return; move((e.touches?e.touches[0].clientX:e.clientX)); };
          imageComparisonWrapper.onmousedown=start; imageComparisonWrapper.onmousemove=drag; window.onmouseup=end;
          imageComparisonWrapper.ontouchstart=start; imageComparisonWrapper.ontouchmove=drag; window.ontouchend=end;
          const r = rect(); move(r.left + r.width/2);
        }

        // PDF (Ø¨Ø³ÙŠØ· Ø¹Ø¨Ø± print)
        window.generatePdfReport = ()=>{ window.print(); };

        // Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¹Ù…Ù„ (ØµÙŠØ§ØºØ©)
        window.generateCommunicationDraft = ()=>{
          if(!current){ alert('Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
          const content = `
          Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ
          Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø£Ù…Ø± Ø¹Ù…Ù„ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© "${current.title}"
          Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${current.location || '-'}
          Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${current.status}
          Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${current.details || '-'}

          Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø§Ø¬Ù„Ø© ÙˆÙÙ‚ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (${current.riskAssessment?.priority || '-'}) Ø®Ù„Ø§Ù„ (${current.riskAssessment?.timeframe || '-'})ØŒ
          ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù„ÙˆØ­Ø© Smart HSR ÙÙˆØ± Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.
          Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±.`.trim();
          showAI('ØµÙŠØ§ØºØ© Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„', `<pre style="white-space:pre-wrap; direction:rtl; font-family:Tajawal, sans-serif">${escapeHTML(content)}</pre>`);
        };

        // Gemini Vision (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ Ù„ÙŠØ¹Ù…Ù„ ÙØ¹Ù„ÙŠÙ‹Ø§)
        const GEMINI_API_KEY = ""; // Ø¶Ø¹ Ù…ÙØªØ§Ø­ Gemini Ù‡Ù†Ø§ Ø¥Ù† Ø±ØºØ¨Øª Ø¨Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
        async function analyzeImage(kind){
          if(!current){ alert('Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
          if(!current.mediaUrl){ showAI('ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±','Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§.'); return; }
          try{
            showAI('Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...','<div class="label">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>');
            const base64 = await toBase64FromUrl(current.mediaUrl);
            let prompt = "";
            if(kind==='vision'){
              prompt = `ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚ Ù„Ù…Ø§ ØªØ±Ù‰ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø­ÙŠØ« Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (Ø­ÙØ±ÙŠØ§Øª/Ø£Ø±ØµÙØ©/Ø¥Ù†Ø§Ø±Ø©/Ø­Ø¯Ø§Ø¦Ù‚/Ù†ÙØ§ÙŠØ§Øª/Ø³Ù„Ø§Ù…Ø©..)ØŒ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©ØŒ ÙˆØ®Ø·ÙˆØ§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø®ØªØµØ±Ø©.`;
            } else {
              prompt = `Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙˆÙ‚Ø¯Ù‘Ù… Ù†ØµÙŠØ­Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ© ØªÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø±Ù‡Ø§.`;
            }
            if(!GEMINI_API_KEY){
              // Ø¹Ø±Ø¶ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø­ØªØ±Ù…Ø© Ø¥Ù† Ù„Ù… ÙŠÙØ¶ÙØ¹ Ù…ÙØªØ§Ø­
              const fake = (kind==='vision')
                ? 'ØªØ­Ù„ÙŠÙ„ (Ù…Ø­Ø§ÙƒØ§Ø©): ÙŠÙØ­ØªÙ…Ù„ ÙˆØ¬ÙˆØ¯ Ù‡Ø¨ÙˆØ· Ø¨Ø³ÙŠØ· ÙÙŠ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¥Ø³ÙÙ„Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ØŒ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ù…ØªÙˆØ³Ø·Ø©ØŒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: Ù‚Øµ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±ØµÙ Ø§Ù„Ù…ÙˆØ¶Ø¹ØŒ ÙØ­Øµ Ø§Ù„ØªØµØ±ÙŠÙ.'
                : 'Ø³Ø¨Ø¨ Ø¬Ø°Ø±ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©): Ø¶Ø¹Ù Ø§Ù„ØªØ±Ø¨Ø© ØªØ­Øª Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³Ø·Ø­ÙŠØ© Ù†ØªÙŠØ¬Ø© Ù…ÙŠØ§Ù‡ Ø±Ø§ÙƒØ¯Ø©. Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©: ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµØ±ÙŠÙØŒ Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙØ­Øµ Ø¯ÙˆØ±ÙŠ.';
              showAI(kind==='vision'?'Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¤ÙŠØ©':'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ', `<div>${escapeHTML(fake)}</div>`);
              return;
            }
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                contents: [{
                  parts: [
                    {text: prompt},
                    {inline_data: {mime_type: current.mediaMime || 'image/jpeg', data: base64 }}
                  ]
                }]
              })
            });
            const json = await res.json();
            const text = json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n') || 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©.';
            showAI(kind==='vision'?'Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¤ÙŠØ©':'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ', `<div>${escapeHTML(text)}</div>`);
          }catch(e){
            showAI('Ø®Ø·Ø£', `<div>ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${escapeHTML(e.message)}</div>`);
          }
        }
        window.analyzeImage = analyzeImage;

        function showAI(title, html){
          const c = document.getElementById('aiResultContainer');
          document.getElementById('aiResultTitle').textContent = title;
          document.getElementById('aiResultContent').innerHTML = html;
          c.classList.remove('hidden');
        }

        async function toBase64FromUrl(url){
          const resp = await fetch(url);
          const blob = await resp.blob();
          return await blobToBase64(blob);
        }
        function blobToBase64(blob){
          return new Promise((resolve,reject)=>{
            const reader = new FileReader();
            reader.onloadend = ()=>{
              const res = reader.result.split(',')[1]; resolve(res);
            };
            reader.onerror = reject; reader.readAsDataURL(blob);
          });
        }

        // KPI Insights (Ù†ØµÙŠ ÙÙ‚Ø·ØŒ ÙˆÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù€ Gemini Ø¹Ø¨Ø± Ø§Ù„Ù…ÙØªØ§Ø­)
        async function generateKpiInsights(){
          const total = observations.length;
          const open = observations.filter(x=>x.status!=='COMPLETED').length;
          const closed = total - open;
          const withImg = observations.filter(x=>x.mediaUrl).length;
          const txt = `Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ: Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total}ØŒ Ù…ÙØªÙˆØ­ ${open} (${Math.round((open/Math.max(total,1))*100)}%)ØŒ Ù…ØºÙ„Ù‚ ${closed}ØŒ Ù…ÙˆØ«Ù‘Ù‚ Ø¨Ø§Ù„ØµÙˆØ± ${withImg}. Ø§Ù„ØªÙˆØµÙŠØ©: Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø­Ù…Ù„Ø§Øª ØªÙˆØ«ÙŠÙ‚ Ø¨Ø§Ù„ØµÙˆØ±.`;
          document.getElementById('kpi-insight-result').textContent = txt;
        }
        window.generateKpiInsights = generateKpiInsights;

        // Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø©
        window.openModal = (id)=>document.getElementById(id).style.display='flex';
        window.closeModal = (id)=>document.getElementById(id).style.display='none';
        window.smartLogout = ()=>signOut(auth);
        function fmtDate(ts){
          try{
            if(!ts) return '-';
            if(ts.seconds) return new Date(ts.seconds*1000).toLocaleString('ar-SA');
            return new Date(ts).toLocaleString('ar-SA');
          }catch{ return '-'; }
        }
        function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    </script>
</body>
</html>
