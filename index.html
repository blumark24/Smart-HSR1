<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | لوحة القيادة التنفيذية - نظام المراقبة وإدارة الجودة الرقمي</title>
    
    <meta name="description" content="نظام Smart HSR للمراقبة وإدارة الجودة الرقمي - لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta name="keywords" content="Smart HSR, إدارة الجودة, نظام المراقبة, لوحة تحكم, الذكاء الاصطناعي, تحليل البيانات">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Smart HSR | نظام المراقبة وإدارة الجودة الرقمي">
    <meta property="og:description" content="لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية وتحليل البيانات بتقنية الذكاء الاصطناعي">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | نظام المراقبة وإدارة الجودة الرقمي">
    <meta name="twitter:description" content="لوحة تحكم تنفيذية متقدمة لإدارة الملاحظات الميدانية">
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <link rel="stylesheet" href="output.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Professional & Executive Palette */
            --color-navy: #0A1931;
            /* Primary Dark Color */
            --color-teal: #18A5A2;
            /* Accent/Highlight Color */
            --color-light-teal: #ACE2E1;
            /* Light Accent */
            --color-gray-bg: #F7F9FC;
            /* Clean Background */
            --color-shadow-base: rgba(10, 25, 49, 0.4);
            /* Deep Navy Shadow */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--color-gray-bg);
            color: var(--color-navy);
        }

        /* Gradient for Open Reports (Urgency - Red/Orange) */
        .kpi-open-gradient {
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            /* Red to Deep Red */
            color: white;
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.4);
        }

        /* Gradient for Closed Reports (Success - Teal/Green) */
        .kpi-closed-gradient {
            background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%);
            /* Green to Teal */
            color: white;
            box-shadow: 0 10px 20px rgba(24, 165, 162, 0.4);
        }

        /* Gradient for Total Images (Information - Blue/Navy) */
        .kpi-images-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%);
            /* Blue to Navy */
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        /* Gradient for Missing Images (Warning - Yellow/Orange) */
        .kpi-missing-gradient {
            background: linear-gradient(135deg, #FCD34D 0%, #F97316 100%);
            /* Yellow to Orange */
            color: var(--color-navy);
            /* Dark text for contrast on light gradient */
            box-shadow: 0 10px 20px rgba(253, 211, 77, 0.4);
        }

        /* Common KPI Card Styles */
        .kpi-card-professional {
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            /* Rounded corners */
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0);
            /* For hardware acceleration */
        }

        .kpi-card-professional::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: height 0.3s ease;
        }

        .kpi-card-professional:hover {
            transform: translateY(-8px) scale(1.02);
            z-index: 10;
        }

        .kpi-card-professional:hover::before {
            height: 100%;
            opacity: 0.1;
        }

        /* General UI Elements */
        .ai-button-primary {
            background-color: var(--color-teal);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(24, 165, 162, 0.5);
        }

        .ai-button-primary:hover:not(:disabled) {
            background-color: #148f8c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(24, 165, 162, 0.8);
        }

        .ai-button-secondary {
            background-color: var(--color-navy);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(10, 25, 49, 0.6);
        }

        .ai-button-secondary:hover:not(:disabled) {
            background-color: #1a3053;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(10, 25, 49, 0.8);
        }

        /* Vision Button Style (Purple) */
        .ai-button-vision {
            background-color: #9333ea;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(147, 51, 234, 0.5);
        }

        .ai-button-vision:hover:not(:disabled) {
            background-color: #7e22ce;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.8);
        }

        /* Root Cause Button Style (Dark Red/Maroon) */
        .ai-button-root-cause {
            background-color: #881337;
            /* Maroon 900 */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(136, 19, 55, 0.5);
        }

        .ai-button-root-cause:hover:not(:disabled) {
            background-color: #9f1239;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(136, 19, 55, 0.8);
        }

        /* Communication Button Style (Orange) */
        .ai-button-comm {
            background-color: #F97316;
            /* Orange */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.5);
        }

        .ai-button-comm:hover:not(:disabled) {
            background-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.8);
        }

        /* Grounding Button Style (Green) */
        .ai-button-grounding {
            background-color: #10B981;
            /* Green */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5);
        }

        .ai-button-grounding:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-light-teal);
            /* Use light teal on dark buttons */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        .ai-button-primary .loading-spinner,
        .ai-button-vision .loading-spinner,
        .ai-button-comm .loading-spinner,
        .ai-button-grounding .loading-spinner,
        .ai-button-secondary .loading-spinner,
        .ai-button-root-cause .loading-spinner {
            border-top: 4px solid #0A1931;
            /* Darker spinner on lighter buttons */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px var(--color-shadow-base);
        }

        .image-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--color-navy);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            border-top-left-radius: 0.75rem;
        }

        .observation-item {
            transition: all 0.2s;
            border-right: 4px solid transparent;
            cursor: pointer;
        }

        .observation-item:hover {
            background-color: #E6F3F3;
            /* Light teal hover effect */
            border-right-color: var(--color-teal);
        }

        .observation-item.active {
            background-color: #E6F3F3;
            /* Active state */
            border-right-color: var(--color-navy);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Image Comparison Slider Styles */
        .comparison-wrapper {
            position: relative;
            max-width: 100%;
            overflow: hidden;
            user-select: none;
            cursor: ew-resize;
            /* East-West resize cursor */
            border-radius: 0.75rem;
        }

        .comparison-wrapper img,
        .comparison-wrapper video {
            display: block;
            width: 100%;
            height: auto;
        }

        .comparison-wrapper .after-image {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 50%;
            /* Initial mask width */
            overflow: hidden;
        }

        .comparison-wrapper .after-image img,
        .comparison-wrapper .after-image video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            /* Ensure the image fills the container */
            height: auto;
        }

        .comparison-wrapper .comparison-divider {
            position: absolute;
            top: 0;
            left: 50%;
            /* Initial position */
            width: 4px;
            height: 100%;
            background-color: var(--color-teal);
            transform: translateX(-50%);
            cursor: grab;
            z-index: 10;
            box-shadow: 0 0 10px rgba(24, 165, 162, 0.8);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .comparison-wrapper .comparison-divider:active {
            cursor: grabbing;
        }

        .comparison-wrapper .comparison-divider-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: white;
            border: 3px solid var(--color-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .comparison-label {
            position: absolute;
            z-index: 5;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            opacity: 0.9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .label-before {
            top: 10px;
            right: 10px;
            background-color: #B91C1C;
            /* Red */
        }

        .label-after {
            top: 10px;
            left: 10px;
            background-color: #10B981;
            /* Green */
        }

        .communication-draft {
            white-space: pre-wrap;
            text-align: right;
            direction: rtl;
            font-family: 'Tajawal', sans-serif;
            border-right: 4px solid var(--color-teal);
            padding-right: 1rem;
            line-height: 1.8;
            background-color: #f8fafc;
        }

        .kpi-insight-container {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--color-navy);
        }

        .source-link {
            color: #0d9488;
            /* Teal 600 */
            text-decoration: none;
            transition: color 0.2s;
        }

        .source-link:hover {
            color: var(--color-navy);
            text-decoration: underline;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            /* Center the modal content vertically */
            justify-content: center;
            /* Center the modal content horizontally */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slide-up 0.3s ease-out;
            position: relative;
        }

        /* Custom Location/Image Wrapper */
        .input-group-wrapper {
            display: flex;
            gap: 1rem;
            /* Space between inputs */
        }

        .input-group {
            flex-grow: 1;
            /* Make inputs fill available space */
            text-align: center;
        }

        /* PDF Print Styles (Hiding unnecessary elements when printing) */
        @media print {
            body {
                background-color: white !important;
                color: black !important;
                /* تحديد عرض الصفحة للـ PDF */
                width: 210mm;
                /* A4 width */
                min-height: 297mm;
                /* A4 height */
                margin: 0;
            }

            .no-print,
            #observationsList,
            #hero,
            #operational-dashboard,
            #ai-features,
            footer,
            .modal {
                display: none !important;
            }

            #observationDetail {
                display: block !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            .kpi-insight-container,
            .bg-white {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .comparison-wrapper {
                /* Display only the "After" image in comparison view for PDF */
                cursor: default;
            }

            .comparison-divider,
            .comparison-label {
                display: none !important;
            }

            .comparison-wrapper .after-image {
                width: 100% !important;
                overflow: visible !important;
            }

            .comparison-wrapper .after-image img {
                position: static !important;
            }

            /* Adjusting details layout for print */
            .grid.grid-cols-1.md\3a grid-cols-3 {
                display: block !important;
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }

            .grid.grid-cols-1.md\3a grid-cols-3>div {
                border: none !important;
                padding: 5px;
            }

            .print-logo {
                display: block !important;
            }
        }
    </style>
</head>

<body class="text-gray-800">

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <div class="flex justify-start mb-6 no-print">
            <button id="logout-btn"
                class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center shadow-lg transition duration-300 transform hover:scale-105"
                onclick="smartLogout()" title="تسجيل الخروج الآمن">
                <i data-lucide="log-out" class="w-4 h-4 ml-2"></i> تسجيل الخروج
            </button>
        </div>
        <section id="hero"
            class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
            <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight"
                style="color: var(--color-navy);">Smart HSR <span style="color: var(--color-teal);">Dashboard</span>
            </h1>
            <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">نظام المراقبة وإدارة الجودة الرقمي</h2>
            <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">"منصة تنفيذية ذكية لإدارة الجودة والمراقبة الرقمية، توفر رؤية دقيقة للأداء وتدعم اتخاذ القرار المبني على البيانات."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">سجل
                    الملاحظات التفاعلي: دقة الصورة والنص</h3>
                <p class="mt-3 text-lg text-gray-600">عرض تفصيلي للملاحظات الميدانية مع أدوات التحليل الآلي.</p>
                <button id="add-observation-btn"
                    class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto"
                    onclick="openModal('smartInputModal')">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> إضافة ملاحظة جديدة (الإدخال الذكي)
                </button>
            </div>

            <div
                class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">

                <div
                    class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
                    <h4 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">تصفية الملاحظات</h4>
                    <select id="observationFilter"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300"
                        onchange="handleFilterChange()">
                        <option value="الكل">عرض كل الملاحظات</option>
                        <option value="جديد">جديد</option>
                        <option value="قيد التنفيذ">قيد التنفيذ</option>
                        <option value="تمت المعالجة">تمت المعالجة</option>
                        <option value="جودة">جودة</option>
                        <option value="صيانة">صيانة</option>
                        <option value="سلامة">سلامة</option>
                        <option value="بيئة">بيئة</option>
                    </select>
                    <h4 class="text-2xl font-bold mt-8 mb-3" style="color: var(--color-navy);">المـلاحظــات</h4>
                    <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-center text-gray-500 mt-10">... جاري تحميل البيانات الثابتة...</div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">

                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 class="text-3xl font-extrabold text-gray-900" style="color: var(--color-navy);">تقرير Smart
                            HSR التنفيذي</h2>
                        <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
                    </div>

                    <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2"
                        style="color: var(--color-teal);">عرض التفاصيل والتحليل (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">

                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">العنوان:</span>
                                <span id="detailTitle" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">التصنيف:</span>
                                <span id="detailType" class="block font-bold text-teal-600"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">الموقع:</span>
                                <span id="detailLocation" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">تاريخ البلاغ:</span>
                                <span id="detailDate" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">حالة المعالجة:</span>
                                <span id="detailStatus"
                                    class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">معرف البلاغ:</span>
                                <span id="detailID" class="block font-bold text-gray-800"></span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
                            <h5 class="text-xl font-bold mb-3" style="color: var(--color-navy);">وصف الملاحظة</h5>
                            <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
                            <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                                <h6 class="font-bold text-teal-700">خطة العمل المقترحة (Gemini AI)</h6>
                                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer"
                            class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
                            <h5 class="text-xl font-bold mb-3 text-green-700">📝 المذكرة الختامية للإغلاق</h5>
                            <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
                            <img id="beforeImage" class="before-image w-full h-auto" alt="صورة قبل الإصلاح"
                                src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            <div id="afterImageContainer" class="after-image">
                                <img id="afterImage" class="w-full h-auto" alt="صورة بعد الإصلاح"
                                    src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            </div>
                            <div id="comparisonDivider" class="comparison-divider no-print">
                                <div class="comparison-divider-handle">
                                    <i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i>
                                </div>
                            </div>
                            <span class="comparison-label label-before no-print">قبل</span>
                            <span class="comparison-label label-after no-print">بعد</span>
                        </div>

                        <div id="mediaContainer" class="image-container mb-6 hidden">
                            <div id="mediaContent" class="w-full h-auto rounded-xl">
                            </div>
                            <span class="image-label">مرفق الملاحظة</span>
                        </div>

                        <div id="noImageMessage"
                            class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
                            <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> لا تتوفر صورة أو
                            فيديو لهذه الملاحظة.
                        </div>


                        <div id="aiAnalysisSection"
                            class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
                            <h5 class="text-xl font-bold mb-4" style="color: var(--color-navy);">أدوات التحليل الذكي
                                (Gemini AI)</h5>
                            <div class="flex flex-wrap gap-3 no-print">
                                <button id="vision-btn"
                                    class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('vision')">
                                    <i data-lucide="eye" class="w-4 h-4 ml-2"></i> تحليل الصور بالرؤية (Vision)
                                </button>
                                <button id="root-cause-btn"
                                    class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('root-cause')">
                                    <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> تحليل السبب الجذري
                                </button>
                                <button id="comm-btn"
                                    class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generateCommunicationDraft()">
                                    <i data-lucide="send" class="w-4 h-4 ml-2"></i> صياغة أمر العمل
                                </button>
                                <button id="pdf-report-btn"
                                    class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generatePdfReport()">
                                    <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> توليد تقرير PDF
                                </button>
                            </div>

                            <div id="aiResultContainer"
                                class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color: var(--color-teal);">
                                </h6>
                                <div id="aiResultContent" class="text-gray-700"></div>
                            </div>
                        </div>

                        <div id="actionButtons"
                            class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
                            <button id="updateStatusBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="updateStatusToInProgress()">
                                تحديث الحالة إلى "قيد التنفيذ"
                            </button>
                            <button id="completeObservationBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="openModal('closeoutModal')">
                                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> الإغلاق التنفيذي (صورة بعد)
                            </button>
                            <button id="alreadyCompletedBtn"
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden"
                                disabled>
                                <i data-lucide="check" class="w-4 h-4 ml-2"></i> الملاحظة مغلقة وموثقة
                            </button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center space-y-4">
                        <p class="text-gray-500 mt-16 text-lg">الرجاء اختيار ملاحظة من القائمة لعرض الصورة والمذكرة
                            التفصيلية.</p>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01" />
                        </svg>
                    </div>
                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="my-20 no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">📊
                    مؤشرات الأداء الحيوية (Vital Metrics)</h3>
                <p class="mt-3 text-lg text-gray-600">تتبع البلاغات وحالة التوثيق بالصور لضمان كفاءة الإغلاق.</p>
            </div>
            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div id="kpiOpen"
                    class="kpi-card-professional kpi-open-gradient p-6 rounded-2xl shadow-xl border-b-8 border-white">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-medium">ملاحظات مفتوحة</h4>
                        <i data-lucide="bell" class="w-6 h-6"></i>
                    </div>
                    <p id="openCount" class="text-5xl font-extrabold mt-2">--</p>
                    <p class="mt-1 text-sm opacity-80">بلاغ يتطلب إجراء فوري</p>
                </div>

                <div id="kpiClosed"
                    class="kpi-card-professional kpi-closed-gradient p-6 rounded-2xl shadow-xl border-b-8 border-white">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-medium">ملاحظات مغلقة</h4>
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                    </div>
                    <p id="closedCount" class="text-5xl font-extrabold mt-2">--</p>
                    <p class="mt-1 text-sm opacity-80">تم إغلاقها وتوثيقها</p>
                </div>

                <div id="kpiTotalImages"
                    class="kpi-card-professional kpi-images-gradient p-6 rounded-2xl shadow-xl border-b-8 border-white">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-medium">إجمالي التوثيق</h4>
                        <i data-lucide="image" class="w-6 h-6"></i>
                    </div>
                    <p id="totalMediaCount" class="text-5xl font-extrabold mt-2">--</p>
                    <p class="mt-1 text-sm opacity-80">مرفقات صور وفيديو</p>
                </div>

                <div id="kpiMissingComparison"
                    class="kpi-card-professional kpi-missing-gradient p-6 rounded-2xl shadow-xl border-b-8 border-white">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-medium text-gray-900">توثيق "ما بعد" مفقود</h4>
                        <i data-lucide="camera-off" class="w-6 h-6 text-gray-900"></i>
                    </div>
                    <p id="missingCloseoutCount" class="text-5xl font-extrabold mt-2 text-gray-900">--</p>
                    <p class="mt-1 text-sm opacity-80 text-gray-900">ملاحظات مفتوحة بدون صورة إغلاق</p>
                </div>
            </div>

            <div class="mt-12 text-center">
                <button id="kpi-insight-button"
                    class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                    onclick="generateKpiInsights()">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> ✨ توليد تقرير تنفيذي لملخص اللوحة (Gemini AI)
                </button>
                <div id="kpi-insight-result" class="mt-6 text-sm">
                </div>
            </div>

        </section>

        <section id="ai-features" class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">🧠
                    الذكاء الاصطناعي في صميم العملية</h3>
                <p class="mt-3 text-lg text-gray-600">استفد من نماذج Gemini لتحويل البيانات إلى قرارات قابلة للتنفيذ.
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #9333ea;">👁️</span>
                    <h4 class="font-extrabold text-lg mb-1" style="color: var(--color-navy);">تحليل الرؤية</h4>
                    <p class="text-xs text-gray-600">وصف المشكلة وتحديد حالة الإغلاق المثالية.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">⚙️</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">خطة عمل آلية</h4>
                    <p class="text-xs text-gray-600">توليد خطوات تنفيذية لمعالجة الملاحظة.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">🚨</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">تقييم المخاطر</h4>
                    <p class="text-xs text-gray-600">تحديد الأولوية والإطار الزمني في هيكل JSON.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #881337;">🔬</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">تحليل السبب الجذري</h4>
                    <p class="text-xs text-gray-600">اقتراح سبب جذري ونصيحة وقائية.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #F97316;">✉️</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">صياغة الاتصال</h4>
                    <p class="text-xs text-gray-600">توليد مسودة أمر عمل أو بريد إلكتروني.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-navy);">🔊</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">تقرير الإغلاق الصوتي</h4>
                    <p class="text-xs text-gray-600">تلخيص التقرير وتحويله إلى ملف صوتي.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #10B981;">🌐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">البحث عن المعايير</h4>
                    <p class="text-xs text-gray-600">استخدام البحث المدعوم لاستحضار المعايير العالمية.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
            <div class="max-w-6xl mx-auto px-4">
                <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color: var(--color-navy);"> ابدأ رحلة التحول
                    الرقمي مع Smart HSR </h3>
                <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto"> نظام ذكي يُحول بيانات الميدان إلى
                    قرارات استراتيجية تنفيذيّة </p>
                <a href="http://wa.me/966507006849" target="_blank"
                    class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">
                    اطلب عرضًا تجريبيًا الآن </a>
                <div class="mt-12 pt-8 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">حول النظام</h4>
                            <p>نظام Smart HSR للمراقبة وإدارة الجودة الرقمي</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">الدعم الفني</h4>
                            <p>Blumark24@gmail.com</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">المبيعات والاستفسارات</h4>
                            <p>0507006849</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <p class="mb-2">&copy; 2025 Smart HSR. جميع الحقوق محفوظة.</p>
                        <p id="userInfo">جاري تهيئة التطبيق والاتصال بقاعدة البيانات...</p>
                    </div>
                </div>
            </div>
        </footer>

 </main>

    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color: var(--color-navy);">وحدة الإدخال الذكي
                للملاحظات (Smart HSR)</h2>

            <div id="modalStep1">
                <p class="text-lg text-gray-600 mb-4">الخطوة 1: أدخل تفاصيل الملاحظة (النص، الموقع، الصورة/الفيديو)</p>
                <textarea id="rawObservationInput" rows="5"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm"
                    placeholder="مثال: يوجد تجمع للمياه على طريق الخدمة عند الكيلو 52 باتجاه الشرق، يتسبب في انزلاق السيارات. نحتاج إلى تصريف فوري."
                    oninput="checkSmartInputState()"></textarea>

                <div class="mt-4 input-group-wrapper">
                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="locationStatus" class="block text-sm font-medium text-gray-700 mb-2">الموقع الجغرافي
                            (GPS):</label>
                        <p id="locationStatus" class="text-sm font-semibold text-gray-500">لم يتم التحديد بعد</p>
                        <input type="hidden" id="inputLatitude">
                        <input type="hidden" id="inputLongitude">
                        <button id="getLocationBtn"
                            class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                            onclick="getLocation()" type="button">
                            <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> تحديد الموقع الحالي
                        </button>
                    </div>

                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="fileUploadInput" class="block text-sm font-medium text-gray-700 mb-2">رفع صورة أو
                            فيديو الملاحظة:</label>
                        <p id="fileStatus" class="text-sm font-semibold text-gray-500">لم يتم اختيار ملف بعد</p>
                        <input type="file" id="fileUploadInput" accept="image/*,video/*" class="hidden"
                            onchange="handleFileUpload(event)">
                        <button
                            class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                            onclick="document.getElementById('fileUploadInput').click()" type="button">
                            <i data-lucide="upload" class="w-4 h-4 ml-2"></i> اختيار ملف
                        </button>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button id="processSmartInputBtn"
                        class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                        onclick="processSmartInput()" disabled>
                        <i data-lucide="cpu" class="w-5 h-5 ml-2"></i> بدء التحليل الذكي وتوليد التقرير
                    </button>
                </div>
            </div>

            <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">الخطوة 2: معالجة البيانات بواسطة
                    الذكاء الاصطناعي</h3>
                <div id="modalResultContent">
                </div>
                <div class="mt-6 text-center">
                    <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold"
                        onclick="closeModal('smartInputModal')">
                        إغلاق ومراجعة التقرير الجديد
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">🔒 لوحة الإغلاق التنفيذي للملاحظة
                #<span id="closeoutId"></span></h2>

            <p class="text-lg text-gray-600 mb-4">لإغلاق الملاحظة، يجب توثيق عملية الإصلاح بـ **صورة "بعد الإصلاح"
                إلزامية** ومذكرة ختامية.</p>

            <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold mb-3" style="color: var(--color-navy);">1. توثيق صورة الإغلاق (After Photo)
                </h3>

                <div
                    class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white hover:border-red-500 transition-colors">
                    <label for="afterFileUploadInput" class="block text-sm font-medium text-gray-700 mb-2">رفع صورة
                        **بعد الإصلاح/المعالجة** (<span class="text-red-500 font-bold">إلزامي</span>):</label>
                    <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">لم يتم اختيار ملف بعد</p>
                    <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden"
                        onchange="handleAfterFileUpload(event)">
                    <button
                        class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                        onclick="document.getElementById('afterFileUploadInput').click()" type="button">
                        <i data-lucide="camera" class="w-4 h-4 ml-2"></i> اختيار صورة الإغلاق
                    </button>
                </div>

                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-navy);">2. المذكرة الختامية</h3>
                <textarea id="resolutionNoteInput" rows="4"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm"
                    placeholder="اكتب المذكرة الختامية التي توضح الإجراءات التي تم اتخاذها لإغلاق الملاحظة نهائياً..."></textarea>
            </div>

            <div class="mt-6 text-center">
                <button id="finalCloseoutBtn"
                    class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto transition-colors"
                    onclick="completeObservation()" disabled>
                    <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> تأكيد الإغلاق النهائي للملاحظة
                </button>
            </div>
        </div>
    </div>

    <script>
        // START: 1. Firebase Configuration and Initialization
        // *** ⚠️ استبدل هذه القيم ببيانات اعتماد مشروعك في Firebase ⚠️ ***
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", // مثلاً smart-hsr-2025
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // تهيئة Firebase والخدمات الأساسية
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); // قاعدة البيانات (Firestore)
        const storage = app.storage(); // التخزين (Cloud Storage)
        const auth = app.auth(); // المصادقة (Auth)
        const OBSERVATIONS_COLLECTION = "observations"; // اسم المجموعة في Firestore

        // END: 1. Firebase Configuration and Initialization


        // --- Helper Functions ---

        // تحويل التاريخ إلى صيغة عربية مختصرة
        function formatDate(date) {
            if (!date) return 'غير محدد';
            // التحقق من نوع البيانات، قد تكون Timestamp من Firestore
            if (date.toDate) {
                date = date.toDate();
            }
            return new Intl.DateTimeFormat('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        // عرض تفاصيل الملاحظة المختارة
        function showObservationDetail(id) {
            const observation = observationsData.find(o => o.id === id);
            if (!observation) return;

            currentSelectedObservation = observation;

            // تحديث العناصر النشطة
            document.querySelectorAll('.observation-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`obs-item-${id}`).classList.add('active');

            // إخفاء الـ Placeholder وعرض التفاصيل
            document.getElementById('detailPlaceholder').classList.add('hidden');
            document.getElementById('observationDetail').classList.remove('hidden');

            // ... (بقية منطق تحديث الواجهة بالتفاصيل يظل كما هو)
            document.getElementById('detailTitle').textContent = observation.title;
            document.getElementById('printTitle').textContent = observation.title;
            document.getElementById('detailType').textContent = observation.type;
            document.getElementById('detailLocation').textContent = observation.location;
            document.getElementById('detailDate').textContent = formatDate(observation.createdAt);
            document.getElementById('detailID').textContent = observation.id;
            document.getElementById('detailDescription').textContent = observation.description;

            const statusEl = document.getElementById('detailStatus');
            statusEl.textContent = observation.status;
            statusEl.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full text-white';
            const actionPlanContainer = document.getElementById('actionPlanContainer');
            const resolutionNoteContainer = document.getElementById('resolutionNoteContainer');
            const completeObservationBtn = document.getElementById('completeObservationBtn');
            const alreadyCompletedBtn = document.getElementById('alreadyCompletedBtn');
            const updateStatusBtn = document.getElementById('updateStatusBtn');

            // تحديث الحالة والأزرار
            if (observation.status === 'جديد') {
                statusEl.classList.add('bg-red-600');
                completeObservationBtn.classList.remove('hidden');
                alreadyCompletedBtn.classList.add('hidden');
                updateStatusBtn.classList.remove('hidden');
            } else if (observation.status === 'قيد التنفيذ') {
                statusEl.classList.add('bg-orange-500');
                completeObservationBtn.classList.remove('hidden');
                alreadyCompletedBtn.classList.add('hidden');
                updateStatusBtn.classList.add('hidden'); // إخفاء زر التحديث لقيد التنفيذ
            } else {
                statusEl.classList.add('bg-green-600');
                completeObservationBtn.classList.add('hidden');
                alreadyCompletedBtn.classList.remove('hidden');
                updateStatusBtn.classList.add('hidden');
            }

            // عرض خطة العمل
            if (observation.actionPlan) {
                actionPlanContainer.classList.remove('hidden');
                document.getElementById('actionPlan').textContent = observation.actionPlan;
            } else {
                actionPlanContainer.classList.add('hidden');
            }

            // عرض مذكرة الإغلاق
            if (observation.resolutionNote) {
                resolutionNoteContainer.classList.remove('hidden');
                document.getElementById('resolutionNote').textContent = observation.resolutionNote;
            } else {
                resolutionNoteContainer.classList.add('hidden');
            }

            // تحديث محتوى الميديا (صورة قبل، بعد، أو فيديو)
            const mediaContainer = document.getElementById('mediaContainer');
            const mediaContent = document.getElementById('mediaContent');
            const imageComparisonWrapper = document.getElementById('imageComparisonWrapper');
            const noImageMessage = document.getElementById('noImageMessage');
            
            mediaContainer.classList.add('hidden');
            imageComparisonWrapper.classList.add('hidden');
            noImageMessage.classList.add('hidden');
            mediaContent.innerHTML = ''; // تنظيف المحتوى السابق

            if (observation.mediaUrl && observation.isComparative && observation.afterMediaUrl) {
                // عرض مقارنة الصور (قبل وبعد)
                imageComparisonWrapper.classList.remove('hidden');
                document.getElementById('beforeImage').src = observation.mediaUrl;
                document.getElementById('afterImage').src = observation.afterMediaUrl;
                setupImageComparison();
            } else if (observation.mediaUrl) {
                // عرض صورة/فيديو/صوت فردي (قبل)
                mediaContainer.classList.remove('hidden');
                if (observation.mediaUrl.match(/\.(jpeg|jpg|png|gif|webp)$/i)) {
                    mediaContent.innerHTML = `<img src="${observation.mediaUrl}" alt="مرفق الملاحظة" class="w-full h-auto rounded-xl shadow-lg">`;
                } else if (observation.mediaUrl.match(/\.(mp4|webm|ogg)$/i)) {
                    mediaContent.innerHTML = `<video src="${observation.mediaUrl}" controls class="w-full h-auto rounded-xl shadow-lg"></video>`;
                } else if (observation.mediaUrl.match(/\.(mp3|wav|ogg)$/i)) {
                    mediaContent.innerHTML = `<audio src="${observation.mediaUrl}" controls></audio>`;
                } else {
                    noImageMessage.classList.remove('hidden');
                    mediaContainer.classList.add('hidden');
                }
            } else {
                noImageMessage.classList.remove('hidden');
            }
        }

        // إنشاء عنصر الملاحظة في القائمة
        function createObservationItem(observation) {
            // ... (منطق إنشاء العنصر يظل كما هو)
            const statusColor = observation.status === 'تمت المعالجة' ? 'text-green-600' : 'text-red-600';
            const icon = observation.status === 'تمت المعالجة' ? 'check-circle' : 'alert-triangle';
            const item = document.createElement('div');
            item.className = 'observation-item p-4 rounded-lg bg-white shadow-sm hover:shadow-md';
            item.id = `obs-item-${observation.id}`;
            item.onclick = () => showObservationDetail(observation.id);
            item.innerHTML = `
                <div class="flex items-start justify-between">
                    <h5 class="font-bold text-gray-900">${observation.title}</h5>
                    <i data-lucide="${icon}" class="w-5 h-5 ${statusColor} flex-shrink-0 mr-2"></i>
                </div>
                <p class="text-sm text-gray-600 mt-1">${observation.description.substring(0, 60)}...</p>
                <div class="flex justify-between items-center text-xs mt-2">
                    <span class="font-medium text-gray-500">${formatDate(observation.createdAt)}</span>
                    <span class="font-semibold ${statusColor}">${observation.status}</span>
                </div>
            `;
            return item;
        }

        // عرض قائمة الملاحظات
        function renderObservationsList(data) {
            const listContainer = document.getElementById('observationsList');
            listContainer.innerHTML = '';
            if (data.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-gray-500 mt-10 p-4">لا توجد ملاحظات لعرضها ضمن الفلتر الحالي.</div>`;
                return;
            }
            data.forEach(observation => {
                listContainer.appendChild(createObservationItem(observation));
            });
            lucide.createIcons();
        }

        // التعامل مع الفلتر
        function handleFilterChange() {
            const filterValue = document.getElementById('observationFilter').value;
            let filteredData = observationsData;

            if (filterValue !== 'الكل') {
                if (['جديد', 'قيد التنفيذ', 'تمت المعالجة'].includes(filterValue)) {
                    filteredData = observationsData.filter(obs => obs.status === filterValue);
                } else {
                    filteredData = observationsData.filter(obs => obs.type === filterValue);
                }
            }
            renderObservationsList(filteredData);
        }

        // حساب مؤشرات الأداء (KPIs)
        function calculateKPIs() {
            // ... (منطق حساب KPIs يظل كما هو ولكن يستخدم observationsData المحملة من Firebase)
            const openCount = observationsData.filter(obs => obs.status !== 'تمت المعالجة').length;
            const closedCount = observationsData.filter(obs => obs.status === 'تمت المعالجة').length;
            const totalMediaCount = observationsData.filter(obs => obs.mediaUrl).length + observationsData.filter(obs => obs.afterMediaUrl).length;
            const missingCloseoutCount = observationsData.filter(obs => obs.status !== 'تمت المعالجة' && !obs.afterMediaUrl).length;

            window.kpi = {
                openCount,
                closedCount,
                totalMediaCount,
                missingCloseoutCount,
                total: observationsData.length
            };
        }

        // عرض مؤشرات الأداء (KPIs)
        function renderKPIs() {
            // ... (منطق عرض KPIs يظل كما هو)
            if (!window.kpi) return;
            document.getElementById('openCount').textContent = window.kpi.openCount;
            document.getElementById('closedCount').textContent = window.kpi.closedCount;
            document.getElementById('totalMediaCount').textContent = window.kpi.totalMediaCount;
            document.getElementById('missingCloseoutCount').textContent = window.kpi.missingCloseoutCount;
        }

        // ... (بقية الدوال المساعدة مثل setButtonLoading, getLocation, updateFileName, checkSmartInputState, checkCloseoutState, toggleModal, openModal, closeModal, setupImageComparison تظل كما هي) ...

        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = '<span class="flex items-center"><span class="loading-spinner"></span> جاري المعالجة...</span>';
            } else {
                // إعادة الأيقونة الأصلية حسب نوع الزر
                if (buttonId === 'smartProcessBtn') {
                    button.innerHTML = `<i data-lucide="send" class="w-5 h-5 ml-2"></i> تحليل وإرسال الملاحظة`;
                } else if (buttonId === 'closeoutProcessBtn') {
                    button.innerHTML = `<i data-lucide="lock" class="w-5 h-5 ml-2"></i> تأكيد الإغلاق وتوثيق المعالجة`;
                } else if (buttonId === 'vision-btn') {
                    button.innerHTML = `<i data-lucide="eye" class="w-4 h-4 ml-2"></i> تحليل الصور بالرؤية (Vision)`;
                } else if (buttonId === 'root-cause-btn') {
                    button.innerHTML = `<i data-lucide="microscope" class="w-4 h-4 ml-2"></i> تحليل السبب الجذري`;
                } else if (buttonId === 'comm-btn') {
                    button.innerHTML = `<i data-lucide="send" class="w-4 h-4 ml-2"></i> صياغة أمر العمل`;
                } else if (buttonId === 'kpi-insight-button') {
                    button.innerHTML = `<i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> ✨ توليد تقرير تنفيذي لملخص اللوحة (Gemini AI)`;
                }
                lucide.createIcons();
            }
        }

        function getLocation() {
            const statusEl = document.getElementById('locationStatus');
            const latInput = document.getElementById('inputLatitude');
            const lonInput = document.getElementById('inputLongitude');
            statusEl.textContent = 'جاري تحديد الموقع...';
            statusEl.classList.remove('text-gray-500', 'text-red-500');
            statusEl.classList.add('text-teal-600');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        statusEl.textContent = `تم التحديد: ${lat}, ${lon}`;
                        latInput.value = lat;
                        lonInput.value = lon;
                        statusEl.classList.remove('text-red-500');
                        statusEl.classList.add('text-teal-600');
                        checkSmartInputState();
                    },
                    (error) => {
                        statusEl.textContent = 'فشل تحديد الموقع!';
                        statusEl.classList.remove('text-teal-600');
                        statusEl.classList.add('text-red-500');
                        latInput.value = '';
                        lonInput.value = '';
                        checkSmartInputState();
                    }
                );
            } else {
                statusEl.textContent = 'المتصفح لا يدعم تحديد الموقع.';
                statusEl.classList.remove('text-teal-600');
                statusEl.classList.add('text-red-500');
            }
        }

        function updateFileName(fileInputId, nameElementId) {
            const fileInput = document.getElementById(fileInputId);
            const nameEl = document.getElementById(nameElementId);
            if (fileInput.files.length > 0) {
                nameEl.textContent = fileInput.files[0].name;
                nameEl.classList.remove('text-gray-500');
                nameEl.classList.add('text-teal-600');
            } else {
                nameEl.textContent = 'لم يتم اختيار ملف';
                nameEl.classList.remove('text-teal-600');
                nameEl.classList.add('text-gray-500');
            }
        }

        function checkSmartInputState() {
            const rawInput = document.getElementById('rawObservationInput').value.trim();
            const mediaFile = document.getElementById('mediaFile').files.length > 0;
            const submitBtn = document.getElementById('smartProcessBtn');

            // يجب وجود نص (حد أدنى 10 أحرف) أو مرفق لتمكين الإرسال
            if (rawInput.length >= 10 || mediaFile) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function checkCloseoutState() {
            const resolutionNote = document.getElementById('resolutionNoteInput').value.trim();
            const afterMediaFile = document.getElementById('afterMediaFile').files.length > 0;
            const submitBtn = document.getElementById('closeoutProcessBtn');

            if (resolutionNote.length >= 10 && afterMediaFile) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // دوال المودال (تبقى كما هي)
        function toggleModal(modalId) {
            document.getElementById(modalId).style.display = document.getElementById(modalId).style.display === 'flex' ? 'none' : 'flex';
        }

        function openModal(modalId) {
            if (modalId === 'closeoutModal') {
                if (!currentSelectedObservation) {
                    alert('يجب اختيار ملاحظة أولاً.');
                    return;
                }
                document.getElementById('closeoutObservationId').textContent = currentSelectedObservation.id;
                document.getElementById('resolutionNoteInput').value = '';
                document.getElementById('afterMediaFile').value = '';
                document.getElementById('afterMediaFileName').textContent = 'لم يتم اختيار ملف';
                document.getElementById('closeoutProcessBtn').disabled = true;
            } else if (modalId === 'smartInputModal') {
                // إعادة تعيين حالة الإدخال الذكي عند الفتح
                document.getElementById('rawObservationInput').value = '';
                document.getElementById('locationStatus').textContent = 'لم يتم التحديد بعد';
                document.getElementById('locationStatus').classList.remove('text-teal-600');
                document.getElementById('locationStatus').classList.add('text-gray-500');
                document.getElementById('inputLatitude').value = '';
                document.getElementById('inputLongitude').value = '';
                document.getElementById('mediaFile').value = '';
                document.getElementById('mediaFileName').textContent = 'لم يتم اختيار ملف';
                document.getElementById('smartProcessBtn').disabled = true;
            }
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // تنظيف نتيجة الذكاء الاصطناعي عند إغلاق أي مودال (في حالة وجوده)
            document.getElementById('aiResultContainer').classList.add('hidden');
        }

        // مقارنة الصور (تبقى كما هي)
        function setupImageComparison() {
            const wrapper = document.getElementById('imageComparisonWrapper');
            const divider = document.getElementById('comparisonDivider');
            const afterImageContainer = document.getElementById('afterImageContainer');

            let isDragging = false;

            // تحديد موقع الـ divider بناءً على موضع الماوس
            function moveDivider(x) {
                const rect = wrapper.getBoundingClientRect();
                let percentage = (x - rect.left) / rect.width;

                // تحديد الحدود
                if (percentage < 0.1) percentage = 0.1;
                if (percentage > 0.9) percentage = 0.9;

                const newWidth = percentage * 100;

                afterImageContainer.style.width = `${newWidth}%`;
                divider.style.left = `${newWidth}%`;
            }

            // تفعيل السحب
            divider.onmousedown = (e) => {
                isDragging = true;
                e.preventDefault();
                divider.style.cursor = 'grabbing';
            };
            wrapper.onmousemove = (e) => {
                if (!isDragging) return;
                moveDivider(e.clientX);
            };
            wrapper.onmouseup = () => {
                isDragging = false;
                divider.style.cursor = 'grab';
            };

            // تهيئة الموضع الأولي
            moveDivider(wrapper.getBoundingClientRect().left + wrapper.offsetWidth / 2);
        }

        // --- Firebase Data Structures (Now Dynamically Loaded) ---

        let currentSelectedObservation = null;

        // البيانات الآن سيتم تخزينها هنا بعد جلبها من Firestore
        let observationsData = []; 

        // ------------------------------------------------------------------------------------
        // START: 2. Firebase Database Operations
        // ------------------------------------------------------------------------------------

        // دالة جلب البيانات الرئيسية من Firestore
        async function fetchObservations() {
            try {
                // عرض رسالة التحميل
                const listContainer = document.getElementById('observationsList');
                listContainer.innerHTML = `<div class="text-center text-gray-500 mt-10 p-4">جاري تحميل الملاحظات من Firebase...</div>`;

                // استخدام orderBy للفرز حسب تاريخ الإنشاء (الأحدث أولاً)
                const snapshot = await db.collection(OBSERVATIONS_COLLECTION).orderBy('createdAt', 'desc').get();
                
                observationsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        id: doc.id, // استخدام معرف المستند كمعرف للملاحظة
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date() // تحويل Timestamp إلى Date
                    };
                });

                // تحديث مؤشرات الأداء وعرض القائمة
                calculateKPIs();
                renderKPIs();
                renderObservationsList(observationsData);

                // عرض تفاصيل أول ملاحظة أو ترك المكان فارغاً
                if (observationsData.length > 0) {
                    // محاكاة اختيار الملاحظة رقم 4 أو أول ملاحظة
                    const logoObservation = observationsData.find(obs => obs.id === '4'); // إذا كان لديك مستند برقم 4
                    if (logoObservation) {
                        showObservationDetail(logoObservation.id);
                    } else {
                        showObservationDetail(observationsData[0].id);
                    }
                } else {
                    document.getElementById('observationDetail').classList.add('hidden');
                    document.getElementById('detailPlaceholder').classList.remove('hidden');
                }

                document.getElementById('userInfo').textContent = `تم تحميل ${observationsData.length} ملاحظة بنجاح من Firestore.`;

            } catch (error) {
                console.error("Error fetching documents from Firestore: ", error);
                document.getElementById('observationsList').innerHTML = `<div class="text-center text-red-500 mt-10 p-4 border border-red-200 rounded-lg">فشل تحميل البيانات! تحقق من اتصال Firebase وقواعد الأمان.</div>`;
                document.getElementById('userInfo').textContent = `فشل الاتصال بقاعدة البيانات.`;
            }
        }
        
        // ------------------------------------------------------------------------------------
        // START: 3. Core Logic Modifications (CRUD)
        // ------------------------------------------------------------------------------------
        
        // الإغلاق التنفيذي - تحديث وحفظ صورة "بعد" في Storage
        async function processCloseout() {
            if (!currentSelectedObservation) return;

            const resolutionNote = document.getElementById('resolutionNoteInput').value;
            const afterMediaFile = document.getElementById('afterMediaFile').files[0];

            if (!afterMediaFile || resolutionNote.trim() === '') {
                alert("يجب إرفاق صورة بعد المعالجة وكتابة مذكرة ختامية للإغلاق.");
                return;
            }

            const buttonId = 'closeoutProcessBtn';
            setButtonLoading(buttonId, true);
            
            try {
                let afterMediaDownloadUrl = null;
                
                // 1. تحميل صورة ما بعد المعالجة إلى Cloud Storage
                const fileExtension = afterMediaFile.name.split('.').pop();
                const fileName = `observations/${currentSelectedObservation.id}_after_${new Date().getTime()}.${fileExtension}`;
                const fileRef = storage.ref(fileName);
                
                await fileRef.put(afterMediaFile);
                afterMediaDownloadUrl = await fileRef.getDownloadURL();
                
                // 2. تحديث المستند في Firestore
                await db.collection(OBSERVATIONS_COLLECTION).doc(currentSelectedObservation.id).update({
                    status: 'تمت المعالجة',
                    resolutionNote: resolutionNote,
                    afterMediaUrl: afterMediaDownloadUrl, // تخزين رابط التخزين لصورة "بعد"
                    isComparative: true,
                    closedAt: firebase.firestore.Timestamp.fromDate(new Date())
                });
                
                alert(`تم إغلاق الملاحظة رقم ${currentSelectedObservation.id} بنجاح وتوثيقها بصورة بعد المعالجة.`);

                // 3. إعادة تحميل البيانات وعرض التفاصيل المحدثة
                closeModal('closeoutModal');
                await fetchObservations(); 

            } catch (error) {
                console.error("Error processing closeout or saving to Firebase: ", error);
                alert("حدث خطأ أثناء إغلاق الملاحظة: " + error.message);
            } finally {
                setButtonLoading(buttonId, false);
                document.getElementById('closeoutProcessBtn').disabled = true;
            }
        }

        // الإدخال الذكي - حفظ البيانات والصور في Firebase
        async function processSmartInput() {
            const rawInput = document.getElementById('rawObservationInput').value;
            const latitude = document.getElementById('inputLatitude').value;
            const longitude = document.getElementById('inputLongitude').value;
            const mediaFile = document.getElementById('mediaFile').files[0];
            
            // تحقق بسيط من المدخلات
            if (rawInput.trim().length < 10 && !mediaFile) {
                alert('يجب إدخال وصف كافٍ أو إرفاق ملف لإنشاء الملاحظة.');
                return;
            }
            
            setButtonLoading('smartProcessBtn', true);

            try {
                let mediaDownloadUrl = null;
                
                // 1. تحميل الملف إلى Firebase Storage (إذا كان موجوداً)
                if (mediaFile) {
                    const fileExtension = mediaFile.name.split('.').pop();
                    const fileName = `observations/${new Date().getTime()}_before.${fileExtension}`;
                    const fileRef = storage.ref(fileName);
                    
                    await fileRef.put(mediaFile);
                    mediaDownloadUrl = await fileRef.getDownloadURL();
                    console.log("File uploaded successfully:", mediaDownloadUrl);
                }
                
                // 2. محاكاة تحليل Gemini (نحافظ عليه كـ Mock مؤقتاً)
                const mockAIAnalysis = {
                    title: rawInput.length > 50 ? rawInput.substring(0, 47) + '...' : rawInput,
                    type: rawInput.includes('مياه') || rawInput.includes('انزلاق') ? 'سلامة' : (rawInput.includes('طلاء') ? 'جودة' : 'صيانة'),
                    actionPlan: "إصدار أمر عمل عاجل. يجب التنسيق مع فريق الصيانة للتوجه الفوري للموقع وإجراء المعالجة المطلوبة وفقاً للوصف وتفاصيل الموقع الجغرافي.",
                };
                
                // 3. تخزين البيانات في Firestore
                const newObservationData = {
                    title: mockAIAnalysis.title,
                    description: rawInput,
                    location: latitude && longitude ? `${latitude}, ${longitude}` : 'موقع غير محدد',
                    type: mockAIAnalysis.type,
                    status: "جديد",
                    mediaUrl: mediaDownloadUrl || null, // تخزين رابط التخزين
                    afterMediaUrl: null,
                    isComparative: false,
                    resolutionNote: null,
                    actionPlan: mockAIAnalysis.actionPlan,
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date()) // استخدام Timestamp
                };

                const docRef = await db.collection(OBSERVATIONS_COLLECTION).add(newObservationData);
                
                alert(`تم إنشاء الملاحظة برقم ${docRef.id} بنجاح وحفظها في Firebase.`);

                // 4. إعادة تحميل البيانات وعرض التفاصيل
                closeModal('smartInputModal');
                await fetchObservations(); 
                

            } catch (error) {
                console.error("Error processing smart input or saving to Firebase: ", error);
                alert("حدث خطأ أثناء حفظ الملاحظة: " + error.message);
            } finally {
                setButtonLoading('smartProcessBtn', false);
                document.getElementById('smartProcessBtn').disabled = true;
            }
        }
        
        // تحديث الحالة إلى "قيد التنفيذ"
        async function updateStatusToInProgress() {
            if (!currentSelectedObservation) return;

            const updateStatusBtn = document.getElementById('updateStatusBtn');
            updateStatusBtn.disabled = true;
            updateStatusBtn.innerHTML = '<span class="flex items-center"><span class="loading-spinner"></span> تحديث...</span>';
            lucide.createIcons();
            
            try {
                 await db.collection(OBSERVATIONS_COLLECTION).doc(currentSelectedObservation.id).update({
                    status: 'قيد التنفيذ',
                    inProgressAt: firebase.firestore.Timestamp.fromDate(new Date())
                });
                
                alert(`تم تحديث حالة الملاحظة رقم ${currentSelectedObservation.id} إلى "قيد التنفيذ" بنجاح.`);
                
                await fetchObservations(); 

            } catch (error) {
                console.error("Error updating status to in-progress in Firebase: ", error);
                alert("حدث خطأ أثناء تحديث الحالة: " + error.message);
            } finally {
                updateStatusBtn.disabled = false;
                updateStatusBtn.innerHTML = 'تحديث الحالة إلى "قيد التنفيذ"';
                lucide.createIcons();
            }
        }

        // ------------------------------------------------------------------------------------
        // END: 3. Core Logic Modifications (CRUD)
        // ------------------------------------------------------------------------------------


        // دوال الذكاء الاصطناعي (تبقى كما هي كمحاكاة)
        
        async function analyzeImage(type) {
            // محاكاة استدعاء نموذج Gemini
            // ...
        }
        
        function generateCommunicationDraft() {
            // محاكاة صياغة مسودة
            // ...
        }

        function generatePdfReport() {
            // محاكاة توليد تقرير PDF
            window.print();
        }

        function generateKpiInsights() {
            // محاكاة توليد تقرير KPIs
            // ...
        }

        // ------------------------------------------------------------------------------------
        // START: 4. Initialization and Authentication
        // ------------------------------------------------------------------------------------

        // وظيفة تسجيل الخروج تستخدم Firebase Auth
        function smartLogout() {
             auth.signOut().then(() => {
                 // في حالة نجاح تسجيل الخروج، يتم التوجيه لصفحة الدخول
                 window.location.href = "login.html"; 
             }).catch((error) => {
                 console.error("Logout Error:", error);
                 alert("فشل تسجيل الخروج: " + error.message);
             });
        }


        // الوظيفة الأساسية لتهيئة التطبيق - الآن تستدعي fetchObservations
        function initApp() {
            fetchObservations(); // 👈 ستبدأ عملية التحميل من Firebase
            lucide.createIcons();
        }

        // استدعاء التهيئة عند تحميل الصفحة
        window.onload = initApp;

        // ------------------------------------------------------------------------------------
        // END: 4. Initialization and Authentication
        // ------------------------------------------------------------------------------------

    </script>
</body>

</html>
