<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>

  <!-- META -->
  <meta name="description" content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช">
  <meta name="keywords" content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
  <meta name="author" content="Smart HSR">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
  <meta property="og:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar_SA">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
  <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ">

  <!-- ASSETS -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.svg">
  <!-- ููุงุญุธุฉ: ุฅู ูุงู ูุฏูู output.css (ุชุงูููููุฏ ูุฌูุน) ุฃุจููุ ูุฅูุง ุงุญุฐู ูุฐุง ุงูุณุทุฑ -->
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <!-- STYLES ูุทุงุจูุฉ ููุชุตููู ุงูุฃุตูู -->
  <style>
    :root { --color-navy:#0A1931; --color-teal:#18A5A2; --color-light-teal:#ACE2E1; --color-gray-bg:#F7F9FC; --color-shadow-base:rgba(10,25,49,.4);}
    body { font-family:'Tajawal',sans-serif; background-color:var(--color-gray-bg); color:var(--color-navy);}
    .kpi-open-gradient{background:linear-gradient(135deg,#EF4444 0%,#B91C1C 100%);color:#fff;box-shadow:0 10px 20px rgba(185,28,28,.4)}
    .kpi-closed-gradient{background:linear-gradient(135deg,#10B981 0%,#18A5A2 100%);color:#fff;box-shadow:0 10px 20px rgba(24,165,162,.4)}
    .kpi-images-gradient{background:linear-gradient(135deg,#3B82F6 0%,#0A1931 100%);color:#fff;box-shadow:0 10px 20px rgba(59,130,246,.4)}
    .kpi-card-professional{transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; transform:perspective(1px) translateZ(0)}
    .kpi-card-professional::before{content:""; position:absolute; bottom:0; left:0; right:0; height:5px; background-color:rgba(255,255,255,.2); transition:height .3s}
    .kpi-card-professional:hover{transform:translateY(-8px) scale(1.02); z-index:10}
    .kpi-card-professional:hover::before{height:100%; opacity:.1}
    .ai-button-primary{background:var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5)}
    .ai-button-primary:hover:not(:disabled){background:#148f8c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(24,165,162,.8)}
    .ai-button-secondary{background:var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6)}
    .ai-button-secondary:hover:not(:disabled){background:#1a3053; transform:translateY(-2px); box-shadow:0 6px 15px rgba(10,25,49,.8)}
    .ai-button-vision{background:#9333ea; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(147,51,234,.5)}
    .ai-button-vision:hover:not(:disabled){background:#7e22ce; transform:translateY(-2px); box-shadow:0 8px 20px rgba(147,51,234,.8)}
    .ai-button-root-cause{background:#881337; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(136,19,55,.5)}
    .ai-button-root-cause:hover:not(:disabled){background:#9f1239; transform:translateY(-2px); box-shadow:0 8px 20px rgba(136,19,55,.8)}
    .ai-button-comm{background:#F97316; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(249,115,22,.5)}
    .ai-button-comm:hover:not(:disabled){background:#ea580c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(249,115,22,.8)}
    .ai-button-grounding{background:#10B981; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(16,185,129,.5)}
    .ai-button-grounding:hover:not(:disabled){background:#059669; transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.8)}
    .loading-spinner{border:4px solid rgba(255,255,255,.3); border-top:4px solid var(--color-light-teal); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:8px}
    .ai-button-primary .loading-spinner,.ai-button-vision .loading-spinner,.ai-button-comm .loading-spinner,.ai-button-grounding .loading-spinner,.ai-button-secondary .loading-spinner,.ai-button-root-cause .loading-spinner{border-top:4px solid #0A1931}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .image-container{position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base)}
    .image-label{position:absolute; bottom:0; right:0; background:var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem}
    .observation-item{transition:.2s; border-right:4px solid transparent; cursor:pointer}
    .observation-item:hover{background:#E6F3F3; border-right-color:var(--color-teal)}
    .observation-item.active{background:#E6F3F3; border-right-color:var(--color-navy); box-shadow:0 0 10px rgba(0,0,0,.1)}
    .comparison-wrapper{position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem}
    .comparison-wrapper img,.comparison-wrapper video{display:block; width:100%; height:auto}
    .comparison-wrapper .after-image{position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden}
    .comparison-wrapper .after-image img,.comparison-wrapper .after-image video{position:absolute; top:0; left:0; width:100%; height:auto}
    .comparison-wrapper .comparison-divider{position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; transition:width .1s}
    .comparison-wrapper .comparison-divider:active{cursor:grabbing}
    .comparison-wrapper .comparison-divider-handle{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; background:#fff; border:3px solid var(--color-teal); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 15px rgba(0,0,0,.3)}
    .comparison-label{position:absolute; z-index:5; padding:.5rem 1rem; font-size:.875rem; font-weight:700; color:#fff; border-radius:.5rem; opacity:.9; box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .label-before{top:10px; right:10px; background:#B91C1C}
    .label-after{top:10px; left:10px; background:#10B981}
    .communication-draft{white-space:pre-wrap; text-align:right; direction:rtl; font-family:'Tajawal',sans-serif; border-right:4px solid var(--color-teal); padding-right:1rem; line-height:1.8; background:#f8fafc}
    .kpi-insight-container{border-radius:1.5rem; box-shadow:0 10px 30px rgba(0,0,0,.1); border-top:5px solid var(--color-navy)}
    .source-link{color:#0d9488; text-decoration:none; transition:color .2s}
    .source-link:hover{color:var(--color-navy); text-decoration:underline}
    audio{width:100%; margin-top:10px}
    .modal{display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.6); align-items:center; justify-content:center}
    .modal-content{background:#fefefe; margin:5% auto; padding:30px; border-radius:1.5rem; width:90%; max-width:800px; box-shadow:0 10px 40px rgba(0,0,0,.3); animation:slide-up .3s ease-out; position:relative}
    .input-group-wrapper{display:flex; gap:1rem}
    .input-group{flex-grow:1; text-align:center}
    @media print{
      body{background:#fff!important; color:#000!important; width:210mm; min-height:297mm; margin:0}
      .no-print,#observationsList,#hero,#operational-dashboard,#ai-features,footer,.modal{display:none!important}
      #observationDetail{display:block!important; max-width:100%!important; margin:0!important; padding:0!important; box-shadow:none!important; border:none!important}
      .kpi-insight-container,.bg-white{box-shadow:none!important; border:none!important; padding:0!important; margin:0!important}
      .comparison-wrapper{cursor:default}
      .comparison-divider,.comparison-label{display:none!important}
      .comparison-wrapper .after-image{width:100%!important; overflow:visible!important}
      .comparison-wrapper .after-image img{position:static!important}
      .grid.grid-cols-1.md\3a grid-cols-3{display:block!important; border:1px solid #ccc; margin-bottom:10px}
      .grid.grid-cols-1.md\3a grid-cols-3>div{border:none!important; padding:5px}
      .print-logo{display:block!important}
    }

    /* ุดุงุดุฉ ุงูุฏุฎูู */
    #loginOverlay{position:fixed; inset:0; background:linear-gradient(135deg, rgba(10,25,49,.96), rgba(24,165,162,.96)); display:flex; align-items:center; justify-content:center; z-index:200}
    #loginCard{background:#fff; border-radius:1.5rem; box-shadow:0 25px 60px rgba(0,0,0,.35); width:95%; max-width:560px; padding:28px}
    .role-pill{padding:.5rem 1rem; border-radius:999px; border:2px solid #e5e7eb; cursor:pointer; user-select:none}
    .role-pill.active{border-color:var(--color-teal); color:#0A1931; background:#E6F3F3; font-weight:800}
    .muted{color:#6b7280; font-size:.875rem}
  </style>
</head>

<body class="text-gray-800">

  <!-- ุดุฑูุท ุนููู ุตุบูุฑ ููุถุญ ุงููุณุชุฎุฏู + ุฎุฑูุฌ -->
  <div class="no-print" style="position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid #e5e7eb;">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <div class="text-sm font-bold" style="color:var(--color-navy);">Smart HSR โ ูุณุฎุฉ ุงูุนุฑุถ ุงููุญููุฉ</div>
      <div class="flex items-center gap-2">
        <span id="currentUserBadge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold" style="background:#E6F3F3; color:#0A1931;">ุบูุฑ ูุณุฌู</span>
        <button id="logout-btn" class="ai-button-secondary rounded-full px-3 py-1 text-xs font-bold flex items-center shadow-lg" onclick="appLogout()" title="ุชุณุฌูู ุงูุฎุฑูุฌ">
          <i data-lucide="log-out" class="w-4 h-4 ml-1"></i> ุฎุฑูุฌ
        </button>
      </div>
    </div>
  </div>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- HERO -->
    <section id="hero" class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
      <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight" style="color:var(--color-navy);">
        Smart HSR <span style="color:var(--color-teal);">Dashboard</span>
      </h1>
      <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</h2>
      <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">
        "ููุตุฉ ุชูููุฐูุฉ ุฐููุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงููุฑุงูุจุฉ ุงูุฑูููุฉุ ุชููุฑ ุฑุคูุฉ ุฏูููุฉ ููุฃุฏุงุก ูุชุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงููุจูู ุนูู ุงูุจูุงูุงุช."
      </p>
    </section>

    <!-- OBSERVATIONS -->
    <section id="observations-log" class="my-20">
      <div class="text-center mb-12 no-print">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ุณุฌู ุงูููุงุญุธุงุช ุงูุชูุงุนูู: ุฏูุฉ ุงูุตูุฑุฉ ูุงููุต</h3>
        <p class="mt-3 text-lg text-gray-600">ุนุฑุถ ุชูุตููู ููููุงุญุธุงุช ุงูููุฏุงููุฉ ูุน ุฃุฏูุงุช ุงูุชุญููู ุงูุขูู.</p>
        <button id="add-observation-btn" class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto" onclick="openModal('smartInputModal')">
          <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ (ุงูุฅุฏุฎุงู ุงูุฐูู)
        </button>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">
        <!-- List + Filter -->
        <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
          <h4 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ุชุตููุฉ ุงูููุงุญุธุงุช</h4>
          <select id="observationFilter" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300" onchange="handleFilterChange()">
            <option value="ุงููู">ุนุฑุถ ูู ุงูููุงุญุธุงุช</option>
            <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
            <option value="ููุฏ ุงูุชูููุฐ">ููุฏ ุงูุชูููุฐ</option>
            <option value="ุชูุช ุงููุนุงูุฌุฉ">ุชูุช ุงููุนุงูุฌุฉ</option>
            <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option>
            <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
            <option value="ุณูุงูุฉ">ุณูุงูุฉ</option>
            <option value="ุจูุฆุฉ">ุจูุฆุฉ</option>
          </select>

          <h4 class="text-2xl font-bold mt-8 mb-3" style="color:var(--color-navy);">ุงููููุงุญุธููุงุช</h4>
          <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            <div class="text-center text-gray-500 mt-10">... ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ...</div>
          </div>
        </div>

        <!-- Details -->
        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">
          <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
            <h2 class="text-3xl font-extrabold text-gray-900" style="color:var(--color-navy);">ุชูุฑูุฑ Smart HSR ุงูุชูููุฐู</h2>
            <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
          </div>

          <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2" style="color:var(--color-teal);">
            ุนุฑุถ ุงูุชูุงุตูู ูุงูุชุญููู (AI Insights)
          </h4>

          <div id="observationDetail" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุงูุนููุงู:</span><span id="detailTitle" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุงูุชุตููู:</span><span id="detailType" class="block font-bold text-teal-600"></span></div>
              <div class="p-2"><span class="block text-gray-500">ุงููููุน:</span><span id="detailLocation" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุชุงุฑูุฎ ุงูุจูุงุบ:</span><span id="detailDate" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ุญุงูุฉ ุงููุนุงูุฌุฉ:</span><span id="detailStatus" class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span></div>
              <div class="p-2"><span class="block text-gray-500">ูุนุฑู ุงูุจูุงุบ:</span><span id="detailID" class="block font-bold text-gray-800"></span></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
              <h5 class="text-xl font-bold mb-3" style="color:var(--color-navy);">ูุตู ุงูููุงุญุธุฉ</h5>
              <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
              <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                <h6 class="font-bold text-teal-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ (HSR Vision AI ๐คโจ)</h6>
                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
              </div>
            </div>

            <div id="resolutionNoteContainer" class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
              <h5 class="text-xl font-bold mb-3 text-green-700">๐ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู</h5>
              <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
              <img id="beforeImage" class="before-image w-full h-auto" alt="ุตูุฑุฉ ูุจู ุงูุฅุตูุงุญ" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
              <div id="afterImageContainer" class="after-image"><img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="></div>
              <div id="comparisonDivider" class="comparison-divider no-print"><div class="comparison-divider-handle"><i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i></div></div>
              <span class="comparison-label label-before no-print">ูุจู</span><span class="comparison-label label-after no-print">ุจุนุฏ</span>
            </div>

            <div id="mediaContainer" class="image-container mb-6 hidden"><div id="mediaContent" class="w-full h-auto rounded-xl"></div><span class="image-label">ูุฑูู ุงูููุงุญุธุฉ</span></div>

            <div id="noImageMessage" class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
              <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> ูุง ุชุชููุฑ ุตูุฑุฉ ุฃู ููุฏูู ููุฐู ุงูููุงุญุธุฉ.
            </div>

            <div id="aiAnalysisSection" class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
              <h5 class="text-xl font-bold mb-4" style="color:var(--color-navy);">
                ุฃุฏูุงุช ุงูุชุญููู ุงูุฐูู <span style="color: var(--color-teal); font-weight:900;">(HSR Vision AI ๐คโจ)</span>
              </h5>
              <div class="flex flex-wrap gap-3 no-print">
                <button class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="runAI('vision')">
                  <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
                </button>
                <button class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="runAI('root')">
                  <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู
                </button>
                <button class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generateCommunicationDraft()">
                  <i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
                </button>
                <button class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generatePdfReport()">
                  <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ุชูููุฏ ุชูุฑูุฑ PDF
                </button>
              </div>

              <div id="aiResultContainer" class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color:var(--color-teal);"></h6>
                <div id="aiResultContent" class="text-gray-700"></div>
              </div>
            </div>

            <div id="actionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
              <button id="updateStatusBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="roleGuard('contractor') && markInProgress()">
                ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ููุฏ ุงูุชูููุฐ"
              </button>
              <button id="completeObservationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="roleGuard('contractor') && openModal('closeoutModal')">
                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> ุงูุฅุบูุงู ุงูุชูููุฐู (ุตูุฑุฉ ุจุนุฏ)
              </button>
              <button id="alreadyCompletedBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden" disabled>
                <i data-lucide="check" class="w-4 h-4 ml-2"></i> ุงูููุงุญุธุฉ ูุบููุฉ ูููุซูุฉ
              </button>
            </div>
          </div>

          <div id="detailPlaceholder" class="text-center space-y-4">
            <p class="text-gray-500 mt-16 text-lg">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุงูุตูุฑุฉ ูุงููุฐูุฑุฉ ุงูุชูุตูููุฉ.</p>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01"/>
            </svg>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="operational-dashboard" class="my-20 no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุญูููุฉ (Vital Metrics)</h3>
        <p class="mt-3 text-lg text-gray-600">ุชุชุจุน ุงูุจูุงุบุงุช ูุญุงูุฉ ุงูุชูุซูู ุจุงูุตูุฑ ูุถูุงู ููุงุกุฉ ุงูุฅุบูุงู.</p>
      </div>

      <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200">
          <p class="text-xl font-medium text-gray-500">ุฌุงุฑู ุงูุชุญููู...</p>
          <p class="text-5xl font-extrabold text-gray-700 mt-2">--</p>
        </div>
      </div>

      <div class="mt-12 text-center">
        <button id="kpi-insight-button" class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="generateKpiInsights()">
          <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (HSR Vision AI ๐คโจ)
        </button>
        <div id="kpi-insight-result" class="mt-6 text-sm"></div>
      </div>
    </section>

    <!-- AI features (static) -->
    <section id="ai-features" class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">๐ง ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุตููู ุงูุนูููุฉ</h3>
        <p class="mt-3 text-lg text-gray-600">ุงุณุชูุฏ ูู ููุงุฐุฌ HSR Vision AI ๐ค ูุชุญููู ุงูุจูุงูุงุช ุฅูู ูุฑุงุฑุงุช ูุงุจูุฉ ููุชูููุฐ.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#9333ea;">๐๏ธ</span><h4 class="font-extrabold text-lg mb-1" style="color:var(--color-navy);">ุชุญููู ุงูุฑุคูุฉ</h4>
          <p class="text-xs text-gray-600">ูุตู ุงููุดููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">โ๏ธ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุฎุทุฉ ุนูู ุขููุฉ</h4>
          <p class="text-xs text-gray-600">ุชูููุฏ ุฎุทูุงุช ุชูููุฐูุฉ ููุนุงูุฌุฉ ุงูููุงุญุธุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">๐จ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชูููู ุงููุฎุงุทุฑ</h4>
          <p class="text-xs text-gray-600">ุชุญุฏูุฏ ุงูุฃููููุฉ ูุงูุฅุทุงุฑ ุงูุฒููู ูู ูููู JSON.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#881337;">๐ฌ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู</h4>
          <p class="text-xs text-gray-600">ุงูุชุฑุงุญ ุณุจุจ ุฌุฐุฑู ููุตูุญุฉ ููุงุฆูุฉ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#F97316;">โ๏ธ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุตูุงุบุฉ ุงูุงุชุตุงู</h4>
          <p class="text-xs text-gray-600">ุชูููุฏ ูุณูุฏุฉ ุฃูุฑ ุนูู ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-navy);">๐</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุชูุฑูุฑ ุงูุฅุบูุงู ุงูุตูุชู</h4>
          <p class="text-xs text-gray-600">ุชูุฎูุต ุงูุชูุฑูุฑ ูุชุญูููู ุฅูู ููู ุตูุชู.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#10B981;">๐</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ุงูุจุญุซ ุนู ุงููุนุงููุฑ</h4>
          <p class="text-xs text-gray-600">ุงุณุชุฎุฏุงู ุงูุจุญุซ ุงููุฏุนูู ูุงุณุชุญุถุงุฑ ุงููุนุงููุฑ ุงูุนุงูููุฉ.</p>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
      <div class="max-w-6xl mx-auto px-4">
        <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color:var(--color-navy);">ุงุจุฏุฃ ุฑุญูุฉ ุงูุชุญูู ุงูุฑููู ูุน Smart HSR</h3>
        <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">ูุธุงู ุฐูู ููุญูู ุจูุงูุงุช ุงูููุฏุงู ุฅูู ูุฑุงุฑุงุช ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฐููุฉ</p>
        <a href="http://wa.me/966507006849" target="_blank" class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">ุงุทูุจ ุนุฑุถูุง ุชุฌุฑูุจููุง ุงูุขู</a>
        <div class="mt-12 pt-8 border-t border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
            <div><h4 class="font-bold text-gray-800 mb-2">ุญูู ุงููุธุงู</h4><p>ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">ุงูุฏุนู ุงูููู</h4><p>Blumark24@gmail.com</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">ุงููุจูุนุงุช ูุงูุงุณุชูุณุงุฑุงุช</h4><p>0507006849</p></div>
          </div>
          <div class="text-xs text-gray-500">
            <p class="mb-2">&copy; 2025 Smart HSR. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            <p id="userInfo">ูุณุฎุฉ ูุญููุฉ โ ูุง ููุฌุฏ ุงุชุตุงู ุฎุงุฑุฌู.</p>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- MODALS -->
  <div id="smartInputModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color:var(--color-navy);">ูุญุฏุฉ ุงูุฅุฏุฎุงู ุงูุฐูู ููููุงุญุธุงุช (Smart HSR)</h2>

      <div id="modalStep1">
        <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุฃุฏุฎู ุชูุงุตูู ุงูููุงุญุธุฉ (ุงููุตุ ุงููููุนุ ุงูุตูุฑุฉ)</p>
        <textarea id="rawObservationInput" rows="5" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm" placeholder="ูุซุงู: ููุฌุฏ ุชุฌูุน ููููุงู ุนูู ุทุฑูู ุงูุฎุฏูุฉ ุนูุฏ ุงููููู 52..." oninput="checkSmartInputState()"></textarea>

        <div class="mt-4 input-group-wrapper">
          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">ุงููููุน ุงูุฌุบุฑุงูู (GPS):</label>
            <p id="locationStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ</p>
            <input type="hidden" id="inputLatitude"><input type="hidden" id="inputLongitude">
            <button id="getLocationBtn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="getLocation()" type="button">
              <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู
            </button>
          </div>

          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ ุงูููุงุญุธุฉ:</label>
            <p id="fileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
            <input type="file" id="fileUploadInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('fileUploadInput').click()" type="button">
              <i data-lucide="upload" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ููู
            </button>
          </div>
        </div>

        <div class="mt-6 text-center">
          <button id="processSmartInputBtn" class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="processSmartInput()" disabled>
            <i data-lucide="cpu" class="w-5 h-5 ml-2"></i> ุจุฏุก ุงูุชุญููู ุงูุฐูู ูุชูููุฏ ุงูุชูุฑูุฑ
          </button>
        </div>
      </div>

      <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงูุจูุงูุงุช</h3>
        <div id="modalResultContent"></div>
        <div class="mt-6 text-center">
          <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold" onclick="closeModal('smartInputModal')">ุฅุบูุงู ููุฑุงุฌุนุฉ ุงูุชูุฑูุฑ ุงูุฌุฏูุฏ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="closeoutModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">๐ ููุญุฉ ุงูุฅุบูุงู ุงูุชูููุฐู ููููุงุญุธุฉ #<span id="closeoutId"></span></h2>
      <p class="text-lg text-gray-600 mb-4">ูุฅุบูุงู ุงูููุงุญุธุฉุ ูุฌุจ ุชูุซูู ุนูููุฉ ุงูุฅุตูุงุญ ุจู <b>ุตูุฑุฉ "ุจุนุฏ ุงูุฅุตูุงุญ"</b> ููุฐูุฑุฉ ุฎุชุงููุฉ.</p>

      <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
        <h3 class="text-xl font-bold mb-3" style="color:var(--color-navy);">1. ุชูุซูู ุตูุฑุฉ ุงูุฅุบูุงู (After Photo)</h3>
        <div class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white hover:border-red-500 transition-colors">
          <label class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ <b>ุจุนุฏ ุงูุฅุตูุงุญ/ุงููุนุงูุฌุฉ</b> (<span class="text-red-500 font-bold">ุฅูุฒุงูู</span>):</label>
          <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
          <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden" onchange="handleAfterFileUpload(event)">
          <button class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('afterFileUploadInput').click()" type="button">
            <i data-lucide="camera" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ุตูุฑุฉ ุงูุฅุบูุงู
          </button>
        </div>

        <h3 class="text-xl font-bold mt-6 mb-3" style="color:var(--color-navy);">2. ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ</h3>
        <textarea id="resolutionNoteInput" rows="4" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm" placeholder="ุงูุชุจ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ..."></textarea>
      </div>

      <div class="mt-6 text-center">
        <button id="finalCloseoutBtn" class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto transition-colors" onclick="roleGuard('contractor') && completeObservation()" disabled>
          <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ุชุฃููุฏ ุงูุฅุบูุงู ุงูููุงุฆู ููููุงุญุธุฉ
        </button>
      </div>
    </div>
  </div>

  <!-- ุดุงุดุฉ ุงูุฏุฎูู (ุตูุงุญูุงุช ูุญููุฉ) -->
  <div id="loginOverlay">
    <div id="loginCard">
      <h2 class="text-3xl font-extrabold mb-2" style="color:var(--color-navy);">ุชุณุฌูู ุงูุฏุฎูู</h2>
      <p class="muted mb-4">ุงุฎุชุฑ ููุน ุงููุณุชุฎุฏู ุซู ุฃุฏุฎู ุจูุงูุงุช ุงูุฏุฎูู. (ูุณุฎุฉ ูุญููุฉ ููุนุฑุถ)</p>

      <div class="flex gap-3 mb-4">
        <div id="pill-inspector" class="role-pill active" onclick="pickRole('inspector')">๐ทโโ๏ธ ูุฑุงูุจ</div>
        <div id="pill-contractor" class="role-pill" onclick="pickRole('contractor')">๐๏ธ ููุงูู</div>
      </div>

      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="block text-sm font-bold mb-1">ุงุณู ุงููุณุชุฎุฏู</label>
          <input id="login-username" class="w-full p-3 border rounded-xl" placeholder="inspector ุฃู contractor" value="inspector"/>
        </div>
        <div>
          <label class="block text-sm font-bold mb-1">ูููุฉ ุงููุฑูุฑ</label>
          <input id="login-password" type="password" class="w-full p-3 border rounded-xl" placeholder="1234 ุฃู 4321" value="1234"/>
        </div>
        <button class="ai-button-secondary rounded-full px-6 py-3 text-md font-bold flex items-center justify-center" onclick="doLogin()">
          <i data-lucide="log-in" class="w-5 h-5 ml-2"></i> ุฏุฎูู
        </button>
        <div class="muted">ุจูุงูุงุช ุงูุนุฑุถ: ุงููุฑุงูุจ (inspector/1234) โ ุงูููุงูู (contractor/4321)</div>
      </div>
    </div>
  </div>

  <!-- APP LOGIC (ูุญูู ุจุงููุงูู) -->
  <script>
    // =============================
    // ุจูุงูุงุช ุงููุณุชุฎุฏููู + ุฌูุณุฉ ุงูุฏุฎูู (ูุญูู)
    // =============================
    const USERS = [
      { role:'inspector', username:'inspector', password:'1234', name:'ุงููุฑุงูุจ' },
      { role:'contractor', username:'contractor', password:'4321', name:'ุงูููุงูู' }
    ];
    let CURRENT_USER = null; // {role, username, name}

    function pickRole(role){
      document.getElementById('pill-inspector').classList.toggle('active', role==='inspector');
      document.getElementById('pill-contractor').classList.toggle('active', role==='contractor');
      const u = role==='inspector' ? {u:'inspector',p:'1234'} : {u:'contractor',p:'4321'};
      document.getElementById('login-username').value = u.u;
      document.getElementById('login-password').value = u.p;
    }

    function doLogin(){
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value.trim();
      const match = USERS.find(x=>x.username===u && x.password===p);
      if(!match){ alert('ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ'); return; }
      CURRENT_USER = { role: match.role, username: match.username, name: match.name };
      localStorage.setItem('SmartHSR_currentUser', JSON.stringify(CURRENT_USER));
      document.getElementById('loginOverlay').style.display='none';
      setCurrentUserBadge();
      // ุชูุนูู/ุชุนุทูู ุฒุฑ ุฅุถุงูุฉ ููุงุญุธุฉ ุญุณุจ ุงูุฏูุฑ
      document.getElementById('add-observation-btn').disabled = (CURRENT_USER.role!=='inspector');
      initAppUIAfterLogin();
    }

    function appLogout(){
      localStorage.removeItem('SmartHSR_currentUser');
      location.reload();
    }

    function setCurrentUserBadge(){
      const badge = document.getElementById('currentUserBadge');
      if(!CURRENT_USER){ badge.textContent='ุบูุฑ ูุณุฌู'; return; }
      const label = CURRENT_USER.role==='inspector' ? '๐ทโโ๏ธ ุงููุฑุงูุจ' : '๐๏ธ ุงูููุงูู';
      badge.textContent = label;
    }

    function roleGuard(requiredRole){
      if(!CURRENT_USER){ alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู'); return false; }
      if(CURRENT_USER.role !== requiredRole){
        alert('๐ซ ููุณ ูุฏูู ุตูุงุญูุฉ ููุฐุง ุงูุฅุฌุฑุงุก.');
        return false;
      }
      return true;
    }

    // =============================
    // ุงูุจูุงูุงุช (ูุญูููุง ุนุจุฑ localStorage)
    // =============================
    const LS_KEY = 'SmartHSR_observations_shared';
    let observationsData = []; // ุงููู ูุดูู ููุณ ุงููุงุฆูุฉ (ุดูุงููุฉ)

    // ุฎุฑูุทุฉ ุงูุญุงูุงุช
    const statusMap = {
      "PENDING": { color:'bg-red-600', text:'ููุฏ ุงูุงูุชุธุงุฑ' },
      "IN_PROGRESS": { color:'bg-yellow-600', text:'ููุฏ ุงูุชูููุฐ' },
      "COMPLETED": { color:'bg-green-600', text:'ุชูุช ุงููุนุงูุฌุฉ' }
    };

    // ุนูุงุตุฑ ุญุงูุฉ ุงูุฑูุน
    let currentFile = null, currentFileUrl = null;           // BEFORE
    let currentAfterFile = null, currentAfterFileUrl = null; // AFTER
    let currentSelectedObservation = null;

    // =============================
    // ุฃุฏูุงุช ูุณุงุนุฏุฉ UI
    // =============================
    function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent = text ?? ''; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML = html ?? ''; }
    function hide(id){ const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
    function unhide(id){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
    function toggleHidden(id, cond){ const el=document.getElementById(id); if(el) cond?el.classList.add('hidden'):el.classList.remove('hidden'); }
    function loaderHTML(msg){ return `<div class="text-center py-10"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24,165,162,.3); margin:0 auto; width:40px; height:40px;"></div><p class="mt-4 text-xl font-extrabold text-teal-700">${msg}</p></div>`; }
    function successHTML(msg){ return `<div class="p-6 bg-green-50 rounded-xl border-4 border-green-200 text-center"><i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-600 mb-3"></i><h4 class="text-2xl font-extrabold text-green-700">${msg}</h4></div>`; }
    function errorHTML(msg){ return `<div class="p-6 bg-red-50 rounded-xl border-4 border-red-200 text-center"><i data-lucide="x-circle" class="w-10 h-10 mx-auto text-red-600 mb-3"></i><h4 class="text-2xl font-extrabold text-red-700">${msg}</h4></div>`; }
    function escapeHTML(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function cryptoRandom(){ return (crypto.getRandomValues(new Uint32Array(2)).join('')); }

    // =============================
    // GPS ุจุฏูุฉ ุนุงููุฉ
    // =============================
    async function getLocation() {
      const statusEl = document.getElementById("locationStatus");
      if (!navigator.geolocation) {
        statusEl.innerText = "ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู.";
        return;
      }
      statusEl.innerHTML = "๐ก ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน ุจุฏูุฉ ุนุจุฑ GPS...";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lon = pos.coords.longitude.toFixed(6);
          document.getElementById("inputLatitude").value = lat;
          document.getElementById("inputLongitude").value = lon;
          const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
          statusEl.innerHTML = `โ ุชู ุชุญุฏูุฏ ุงููููุน: ${lat}, ${lon} <br><a href="${googleMapsLink}" target="_blank" class="source-link">ูุชุญ ุนูู ุงูุฎุฑูุทุฉ ๐</a>`;
          checkSmartInputState();
        },
        (err) => {
          statusEl.innerText = (err.code===1)
            ? "โ๏ธ ุงูุฑุฌุงุก ุงูุณูุงุญ ุจุงููุตูู ูููููุน ูู ุฅุนุฏุงุฏุงุช ุงููุชุตูุญ."
            : "โ๏ธ ุชุนุฐูุฑ ุงูุญุตูู ุนูู ุงููููุน. ุญุงูู ูุฌุฏุฏูุง ุจุงูุฎุงุฑุฌ (ุฅุดุงุฑุฉ GPS).";
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    }

    // =============================
    // ุญูุธ/ุชุญููู ุงูููุงุญุธุงุช
    // =============================
    function saveAll(){ localStorage.setItem(LS_KEY, JSON.stringify(observationsData)); }
    function loadAll(){
      try{
        observationsData = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      }catch{ observationsData=[]; }
      if(!observationsData || !Array.isArray(observationsData)) observationsData=[];
      // ูู ุญุงู ูุงุฑุบุฉ โ ูุถูู ุนููุงุช
      if(observationsData.length===0){
        seedLocalDemo();
        saveAll();
      }
    }

    function kpis() {
      const totalReports = observationsData.length;
      const openReports  = observationsData.filter(o => o.status !== 'COMPLETED').length;
      const closedReports = totalReports - openReports;
      const reportsWithImages = observationsData.filter(o => !!o.imagePath).length;
      return { totalReports, openReports, closedReports, reportsWithImages };
    }

    function renderKPIs() {
      const { totalReports, openReports, closedReports, reportsWithImages } = kpis();
      const kpiContainer = document.getElementById('kpiContainer');
      kpiContainer.innerHTML = '';
      const kpiData = [
        {title:'ุฅุฌูุงูู ุงูููุงุญุธุงุช', value:totalReports, icon:'clipboard-list', gradientClass:'kpi-closed-gradient'},
        {title:'ููุงุญุธุงุช ููุชูุญุฉ/ุงูุชุธุงุฑ', value:openReports, icon:'alert-triangle', gradientClass:'kpi-open-gradient'},
        {title:'ููุงุญุธุงุช ูุบููุฉ/ูุนุงูุฌุฉ', value:closedReports, icon:'check-circle', gradientClass:'kpi-closed-gradient'},
        {title:'ููุงุญุธุงุช ููุซูุฉ ุจุงูุตูุฑ', value:reportsWithImages, icon:'image', gradientClass:'kpi-images-gradient'}
      ];
      kpiData.forEach(kpi=>{
        kpiContainer.innerHTML += `
          <div class="kpi-card-professional p-6 ${kpi.gradientClass} flex items-center justify-between shadow-2xl">
            <div><p class="text-sm md:text-md font-medium">${kpi.title}</p>
            <p class="text-4xl md:text-5xl font-extrabold mt-1">${kpi.value}</p></div>
            <i data-lucide="${kpi.icon}" class="w-10 h-10 opacity-70"></i>
          </div>`;
      });
      lucide.createIcons();
    }

    function renderObservationsList(observations) {
      const list = document.getElementById('observationsList');
      list.innerHTML = '';
      if (!observations || observations.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-xl">ูุง ุชูุฌุฏ ููุงุญุธุงุช.</div>';
        document.getElementById('detailPlaceholder').classList.remove('hidden');
        document.getElementById('observationDetail').classList.add('hidden');
        return;
      }
      observations.forEach(obs=>{
        const st = statusMap[obs.status] || {color:'bg-gray-500', text:obs.status};
        const isSel = currentSelectedObservation && obs.docId === currentSelectedObservation.docId ? 'active':'';
        list.innerHTML += `
          <div class="observation-item p-3 rounded-lg flex justify-between items-center ${isSel}" onclick="showObservationDetail('${obs.docId}')">
            <div>
              <p class="text-md font-bold text-gray-800 truncate max-w-[200px]">${escapeHTML(obs.title || '')}</p>
              <p class="text-xs text-gray-500 mt-1">${obs.date || ''} | ${escapeHTML(obs.type || '')}</p>
            </div>
            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${st.color} text-white">${st.text}</span>
          </div>`;
      });
    }

    // =============================
    // ุงูุฅุฏุฎุงู ุงูุฐูู (ุจุฏูู ููุงุชูุญ โ ูุญูู)
    // =============================
    function checkSmartInputState(){
      const text = document.getElementById('rawObservationInput').value.trim();
      const lat = document.getElementById('inputLatitude').value;
      document.getElementById('processSmartInputBtn').disabled = !(text.length>0 || currentFile || lat);
    }

    function handleFileUpload(e){
      const file = e.target.files[0];
      if (!file) {
        currentFile = null; currentFileUrl = null;
        setText('fileStatus','ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ'); checkSmartInputState(); return;
      }
      if (!file.type.startsWith('image/')) {
        alert('ุญุงููุงู ูุชู ุฏุนู ุงูุตูุฑ ููุท.');
        e.target.value = ''; return;
      }
      currentFile = file;
      setText('fileStatus', `ุชู ุงุฎุชูุงุฑ ุงูููู: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
      checkSmartInputState();
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(r.result);
        r.onerror=reject;
        r.readAsDataURL(file);
      });
    }

    async function processSmartInput(){
      if(!CURRENT_USER) { alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู'); return; }
      if(CURRENT_USER.role!=='inspector'){ alert('๐ซ ููุณ ูุฏูู ุตูุงุญูุฉ ุฅุถุงูุฉ ุงูููุงุญุธุงุช.'); return; }

      const rawText = document.getElementById('rawObservationInput').value.trim();
      const lat = document.getElementById('inputLatitude').value || "ุบูุฑ ูุญุฏุฏ";
      const lon = document.getElementById('inputLongitude').value || "ุบูุฑ ูุญุฏุฏ";

      if (!rawText && !currentFile) { alert('ุฃุฏุฎู ูุตูุงู ุฃู ุตูุฑุฉ.'); return; }

      hide('modalStep1'); unhide('modalResult');
      setHTML('modalResultContent', loaderHTML('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุจูุงูุงุช...'));

      try {
        let uploadedUrl = null;
        if (currentFile) {
          uploadedUrl = await fileToBase64(currentFile); // ูุฎุฒู Base64 ุฏุงุฎู ุงูููุงุญุธุฉ
        }

        const nextDisplayId = (observationsData.reduce((m,o)=>Math.max(m,o.id||0),0) + 1) || 1;
        const newDate = new Date().toISOString().slice(0,10);

        // ุชุญููู ูุญูู ุณุฑูุน ูุฅูุชุงุฌ ุฎุทุฉ + ูุฎุงุทุฑุฉ
        const localAnalysis = localAIDescribe(rawText);

        const payload = {
          docId: 'local-' + cryptoRandom(),
          id: nextDisplayId,
          type: "MAINTENANCE",
          date: newDate,
          title: rawText ? rawText.substring(0,50) + (rawText.length>50?'...':'') : 'ููุงุญุธุฉ ุจุฏูู ูุต',
          status: "PENDING",
          details: `**ุชู ุชูููุฏ ูุฐุง ุงูุชูุฑูุฑ ุขููุงู.**\nุงููุตู ุงูุฃููู: "${rawText || 'ูุง ููุฌุฏ'}"\nุงููููุน: (${lat}, ${lon})`,
          imagePath: uploadedUrl,
          isComparative: false,
          location: (lat && lon) ? `${lat}, ${lon}` : 'ุบูุฑ ูุญุฏุฏ',
          actionPlan: localAnalysis.actionPlan,
          riskAssessment: localAnalysis.risk,
          resolutionNote: null,
          afterImagePath: null,
          createdAt: Date.now(),
          createdBy: CURRENT_USER.role
        };

        observationsData.unshift(payload);
        saveAll();
        renderObservationsList(observationsData);
        showObservationDetail(payload.docId);

        setHTML('modalResultContent', successHTML('ุชูุช ูุนุงูุฌุฉ ุงูููุงุญุธุฉ ูุฅุถุงูุชูุง ุจูุฌุงุญ.'));

        // ุชูุธูู
        currentFile = null; currentFileUrl = null;
        document.getElementById('fileUploadInput').value = '';
        document.getElementById('rawObservationInput').value = '';
        setText('fileStatus','ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ');
        setText('locationStatus','ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ');
        document.getElementById('inputLatitude').value='';
        document.getElementById('inputLongitude').value='';
        document.getElementById('processSmartInputBtn').disabled = true;

      } catch (err) {
        console.error(err);
        setHTML('modalResultContent', errorHTML('ุชุนุฐุฑ ุฅุถุงูุฉ ุงูููุงุญุธุฉ. ุชุญูู ูู ุงููุชุตูุญ.'));
      } finally {
        renderKPIs();
        lucide.createIcons();
      }
    }

    // =============================
    // ุนุฑุถ ุงูุชูุงุตูู + ุงูุฃุฒุฑุงุฑ ุญุณุจ ุงูุญุงูุฉ
    // =============================
    function showObservationDetail(docId) {
      const obs = observationsData.find(o=>o.docId===docId);
      if (!obs) return;
      currentSelectedObservation = obs;

      document.querySelectorAll('.observation-item').forEach(i=>i.classList.remove('active'));
      const lis = Array.from(document.querySelectorAll('.observation-item'));
      const li = lis.find(el=>el.getAttribute('onclick')===`showObservationDetail('${docId}')`);
      if (li) li.classList.add('active');

      const st = statusMap[obs.status] || {color:'bg-gray-500', text:obs.status};
      setText('detailTitle', obs.title); setText('printTitle', `ุงูููุงุญุธุฉ: ${obs.title}`);
      setText('detailType', obs.type); setText('detailDate', obs.date);
      setText('detailID', obs.id || '-'); setText('detailLocation', obs.location || '-');
      const ds = document.getElementById('detailStatus');
      ds.textContent = st.text; ds.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${st.color}`;
      document.getElementById('detailDescription').innerHTML = (obs.details || '').replace(/\n/g,'<br>');
      setText('actionPlan', `ุงูุฃููููุฉ: ${obs.riskAssessment?.priority||'-'} | ุงูุฅุทุงุฑ ุงูุฒููู: ${obs.riskAssessment?.timeframe||'-'}. ุงูุฎุทุฉ: ${obs.actionPlan||'-'}`);
      document.getElementById('actionPlanContainer').classList.remove('hidden');

      // ุงููุณุงุฆุท
      hide('mediaContainer'); hide('imageComparisonWrapper'); hide('noImageMessage'); hide('resolutionNoteContainer');
      const mediaContent = document.getElementById('mediaContent'); mediaContent.innerHTML = '';
      if (obs.status==='COMPLETED' && obs.afterImagePath) {
        unhide('imageComparisonWrapper');
        document.getElementById('beforeImage').src = obs.imagePath || '';
        document.getElementById('afterImage').src  = obs.afterImagePath || '';
        setupImageComparison();
        setText('resolutionNote', obs.resolutionNote || 'ูู ูุชู ุชูููุฑ ูุฐูุฑุฉ ุฅุบูุงู ุชูุตูููุฉ.');
        unhide('resolutionNoteContainer');
      } else if (obs.imagePath) {
        unhide('mediaContainer');
        mediaContent.innerHTML = `<img class="w-full h-auto rounded-xl shadow-lg" alt="ุตูุฑุฉ ุงูููุงุญุธุฉ" src="${obs.imagePath}">`;
      } else {
        unhide('noImageMessage');
      }

      const isCompleted = obs.status==='COMPLETED';
      toggleHidden('updateStatusBtn', isCompleted);
      toggleHidden('completeObservationBtn', isCompleted);
      toggleHidden('alreadyCompletedBtn', !isCompleted);

      hide('detailPlaceholder'); unhide('observationDetail'); hide('aiResultContainer');
      lucide.createIcons();
    }

    function handleFilterChange() {
      const v = document.getElementById('observationFilter').value;
      let filtered = observationsData;
      if (v !== 'ุงููู') {
        const map = {"ุฌุฏูุฏ":"PENDING","ููุฏ ุงูุชูููุฐ":"IN_PROGRESS","ุชูุช ุงููุนุงูุฌุฉ":"COMPLETED","ุฌูุฏุฉ":"QUALITY","ุตูุงูุฉ":"MAINTENANCE","ุณูุงูุฉ":"SAFETY","ุจูุฆุฉ":"ENVIRONMENT"};
        const key = map[v] || v;
        filtered = observationsData.filter(o => o.type===key || o.status===key);
      }
      renderObservationsList(filtered);
      if (filtered.length>0) showObservationDetail(filtered[0].docId);
      else { unhide('detailPlaceholder'); hide('observationDetail'); }
    }

    // =============================
    // ููุงุฑูุฉ ุงูุตูุฑ + ุงูุฅุบูุงู
    // =============================
    function clearAfterUpload(){
      currentAfterFile = null; currentAfterFileUrl = null;
      document.getElementById('afterFileUploadInput').value='';
      setHTML('afterFileStatus','ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ <span class="text-red-500 font-bold">(ุฅูุฒุงูู)</span>');
      document.getElementById('resolutionNoteInput').value='';
      document.getElementById('finalCloseoutBtn').disabled = true;
    }

    function handleAfterFileUpload(e){
      const file = e.target.files[0];
      if (!file) { currentAfterFile=null; currentAfterFileUrl=null; setHTML('afterFileStatus','ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ <span class="text-red-500 font-bold">(ุฅูุฒุงูู)</span>'); document.getElementById('finalCloseoutBtn').disabled=true; return; }
      if (!file.type.startsWith('image/')) { alert('ูุฌุจ ุฑูุน ุตูุฑุฉ ูุฅุบูุงู ุงูููุงุญุธุฉ.'); e.target.value=''; return; }
      currentAfterFile = file;
      setHTML('afterFileStatus', `<span class="text-green-600">ุชู ุงุฎุชูุงุฑ ุงูููู:</span> ${file.name}`);
      document.getElementById('finalCloseoutBtn').disabled = false;
    }

    async function completeObservation(){
      if (!currentSelectedObservation) return;
      if (!currentAfterFile) { alert('ุงูุฑุฌุงุก ุฑูุน ุตูุฑุฉ "ุจุนุฏ ุงูุฅุตูุงุญ".'); return; }
      if(!roleGuard('contractor')) return;

      const note = (document.getElementById('resolutionNoteInput').value || '').trim()
        || `ุชู ุงูุฅุบูุงู ุงูุชูููุฐู ูู ${new Date().toLocaleString('ar-SA')} ูุชูุซููู ุจุงูุตูุฑุฉ ุงููุฑููุฉ.`;

      // ุงุฑูุน AFTER ูุญูููุง (Base64)
      const afterUrl = await fileToBase64(currentAfterFile);

      currentSelectedObservation.status = 'COMPLETED';
      currentSelectedObservation.isComparative = true;
      currentSelectedObservation.afterImagePath = afterUrl;
      currentSelectedObservation.resolutionNote = note;

      saveAll();
      closeModal('closeoutModal'); clearAfterUpload();
      handleFilterChange();
      showObservationDetail(currentSelectedObservation.docId);
      alert(`ุชู ุฅุบูุงู ุงูููุงุญุธุฉ ุฑูู ${currentSelectedObservation.id} ูุชูุซูููุง ุจูุฌุงุญ!`);
      renderKPIs();
    }

    function markInProgress(){
      if (!currentSelectedObservation) return;
      if(!roleGuard('contractor')) return;

      if(currentSelectedObservation.status==='COMPLETED'){
        alert('ูุฐู ุงูููุงุญุธุฉ ูุบููุฉ ุจุงููุนู.'); return;
      }
      currentSelectedObservation.status='IN_PROGRESS';
      saveAll();
      handleFilterChange();
      showObservationDetail(currentSelectedObservation.docId);
    }

// =============================
// ๐น Gemini AI Integration (ุจุฏูู OpenAI)
// =============================
const GEMINI_API_KEY = "AIzaSyCstRnAY_9TO9f4l49TTHEjVaoqjtZriJk"; // ููุชุงุญู ูู Google AI Studio

async function runAI(mode) {
  const titleMap = { vision: "ุชุญููู ุงูุฑุคูุฉ (Vision)", root: "ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู" };
  setText("aiResultTitle", `๐ ุฌุงุฑู ${titleMap[mode] || "ุงูุชุญููู"} ุนุจุฑ HSR Vision AI...`);
  setHTML(
    "aiResultContent",
    `<div class='flex items-center text-teal-700 font-bold'>
      <div class='loading-spinner' style='border-top-color: var(--color-teal); margin-left:8px;'></div>
      ุฌุงุฑู ุงูุชุญููู ุนุจุฑ Gemini AI...
    </div>`
  );
  unhide("aiResultContainer");

  const obs = currentSelectedObservation || {};
  const imageUrl = obs.imagePath;

  // ูุต ุงูุชุญููู ุญุณุจ ููุน ุงููุถุน
  const prompt =
    mode === "vision"
      ? "ูู ุจุชุญููู ุงูุตูุฑุฉ ููุฑุงูุจ ุฌูุฏุฉ ููุฏุงููุ ูุงุดุฑุญ ููุน ุงููุดููุฉ ุงูุธุงูุฑุฉ ูุงูุชุฑุญ ุงูุฅุฌุฑุงุก ุงูุชุตุญูุญู ุงูููุงุณุจ ููู ูุนุงููุฑ ุงูุฌูุฏุฉ."
      : "ูู ุจุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู ูููุดููุฉ ุงูุธุงูุฑุฉ ุจุงุณุชุฎุฏุงู ูููุฌูุฉ 5 Whysุ ูุงูุชุฑุญ ุฅุฌุฑุงุก ููุงุฆู ูุนุงู.";

  try {
    const result = await analyzeWithGemini(imageUrl, prompt);
    setText("aiResultTitle", `โ ูุชุงุฆุฌ ${titleMap[mode] || "ุงูุชุญููู"} โ HSR Vision AI ๐คโจ`);
    setHTML(
      "aiResultContent",
      `<div class='communication-draft'>${result}</div>
       <p class="text-xs text-gray-500 mt-4 italic border-t pt-2">
       ๐ง ุชู ุงูุชุญููู ูุนูููุง ุนุจุฑ Gemini 1.5 Flash (Google AI)
       </p>`
    );
  } catch (err) {
    console.error(err);
    setText("aiResultTitle", "โ ูุดู ุงูุชุญููู ุนุจุฑ Gemini AI");
    setHTML(
      "aiResultContent",
      `<p class='text-red-600'>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญููู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.</p>`
    );
  }
}

async function analyzeWithGemini(imageUrl, prompt) {
  try {
    let imageBase64 = imageUrl;
    if (!imageUrl.startsWith("data:image")) {
      imageBase64 = await toBase64FromUrl(imageUrl);
    }

    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                { text: prompt },
                {
                  inline_data: {
                    mime_type: "image/jpeg",
                    data: imageBase64.split(",")[1],
                  },
                },
              ],
            },
          ],
        }),
      }
    );

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return (
      data?.candidates?.[0]?.content?.parts?.[0]?.text ||
      "โ๏ธ ูู ูุชููู Gemini AI ูู ุชูููุฏ ุชุญููู ูุงุถุญ."
    );
  } catch (e) {
    console.error("Gemini AI Error:", e);
    return "โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู Gemini AI.";
  }
}


    function generateCommunicationDraft(){
      const o = currentSelectedObservation || {};
      setText('aiResultTitle','ุตูุงุบุฉ ุฃูุฑ ุงูุนูู ุงูุขูู...');
      setHTML('aiResultContent', `<div class="flex items-center text-teal-700 font-bold"><div class="loading-spinner" style="border-top-color: var(--color-teal); margin-left:8px;"></div> ุฌุงุฑู ุงูุชูููุฏ...</div>`);
      unhide('aiResultContainer');
      setTimeout(()=>{
        setText('aiResultTitle','ุตูุงุบุฉ ุฃูุฑ ุงูุนูู ุงูุขูู (ููุชููุฉ):');
        setHTML('aiResultContent', `
          <div class="communication-draft p-4 border rounded-lg">
            <p class="font-bold text-lg mb-2 text-red-800">ุฃูุฑ ุนูู: ูุนุงูุฌุฉ ${escapeHTML(o.title||'โ')} [ID: ${o.id||'โ'}]</p>
            <p class="mt-2">๐ ุงููููุน: ${escapeHTML(o.location||'-')}</p>
            <p class="mt-1">ุงูุฃููููุฉ: ${o.riskAssessment?.priority||'-'} | ุงูุฅุทุงุฑ ุงูุฒููู ุงููุณุชูุฏู: ${o.riskAssessment?.timeframe||'-'}</p>
            <p class="mt-3">ุงูุฅุฌุฑุงุก: ${escapeHTML(o.actionPlan||'-')}</p>
          </div>`);
      }, 700);
    }

    function generateKpiInsights(){
      const { openReports } = kpis();
      setHTML('kpi-insight-result', `
        <div class="kpi-insight-container p-4 mt-4 bg-white">
          <p class="font-bold text-lg text-teal-700">ููุฎุต ุชูููุฐู:</p>
          <p class="text-gray-700 mt-2">ููุฌุฏ ${openReports} ููุงุญุธุฉ ููุชูุญุฉ. ููุตู ุจุชุณุฑูุน ุชูุซูู ุตูุฑ ุงูุฅุบูุงูุ ูุชูุนูู ุชูุจูู ุฏุงุฎูู ุฃุณุจูุนู ููููุงุญุธุงุช ุงููุชุฃุฎุฑุฉ.</p>
        </div>`);
    }

    function generatePdfReport(){ window.print(); }

    // ููุงุฑูุฉ ุงูุตูุฑ
    function setupImageComparison(){
      const wrapper = document.getElementById('imageComparisonWrapper');
      const divider = document.getElementById('comparisonDivider');
      const afterImageContainer = document.getElementById('afterImageContainer');
      if (!wrapper) return;
      afterImageContainer.style.width = '50%'; divider.style.left = '50%';
      let isDragging = false;
      const onMove = (clientX)=>{
        if(!isDragging) return;
        const r = wrapper.getBoundingClientRect();
        let left = Math.max(0, Math.min(clientX - r.left, r.width));
        divider.style.left = `${left}px`; afterImageContainer.style.width = `${left}px`;
      };
      const onMouseMove = e=>onMove(e.clientX);
      const onTouchMove = e=>onMove(e.touches[0].clientX);
      const onMouseUp = ()=>{
        isDragging=false; wrapper.classList.remove('dragging');
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('mouseup', onMouseUp);
        window.removeEventListener('touchend', onMouseUp);
      };
      const onMouseDown = e=>{
        e.preventDefault(); isDragging=true; wrapper.classList.add('dragging');
        onMove(e.clientX || (e.touches&&e.touches[0].clientX));
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('touchmove', onTouchMove);
        window.addEventListener('mouseup', onMouseUp);
        window.addEventListener('touchend', onMouseUp);
      };
      divider.addEventListener('mousedown', onMouseDown);
      divider.addEventListener('touchstart', onMouseDown);
      wrapper.addEventListener('mousedown', onMouseDown);
      wrapper.addEventListener('touchstart', onMouseDown);
    }

    // ููุงูุฐ
    function openModal(id){
      if(id==='smartInputModal' && CURRENT_USER?.role==='contractor'){
        alert('๐ซ ููุณ ูุฏูู ุตูุงุญูุฉ ุฅุถุงูุฉ ุงูููุงุญุธุงุช.'); return;
      }
      document.getElementById(id).style.display = "flex";
      if (id==='closeoutModal' && currentSelectedObservation){
        setText('closeoutId', currentSelectedObservation.id || '-');
        clearAfterUpload();
      }
      if (id==='smartInputModal'){
        document.getElementById('rawObservationInput').value = '';
        setText('locationStatus','ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ');
        setText('fileStatus','ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ');
        document.getElementById('inputLatitude').value='';
        document.getElementById('inputLongitude').value='';
        currentFile = null; currentFileUrl = null;
        document.getElementById('fileUploadInput').value='';
        document.getElementById('processSmartInputBtn').disabled = true;
      }
    }
    function closeModal(id){ document.getElementById(id).style.display = "none"; }

    // ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุฃูููุฉ
    function seedLocalDemo(){
      observationsData = [
        { docId:'local-4', id:4, type:'QUALITY', date:'2024-09-20', title:'ุชุขูู ูู ููุญุฉ ุฅุฑุดุงุฏูุฉ (ุงูุดุนุงุฑ ุบูุฑ ูุงุถุญ)', status:'PENDING', details:'ุชุขูู ูุงุถุญ ุจููุญุฉ ุฅุฑุดุงุฏูุฉ.', location:'24.5247, 46.7135', imagePath:'', isComparative:false, actionPlan:'ุงุณุชุจุฏุงู ุงูููุญุฉ.', riskAssessment:{priority:'High', timeframe:'7 days'}, resolutionNote:null, afterImagePath:null, createdAt: Date.now()-86400*1000*30, createdBy:'inspector' },
        { docId:'local-2', id:2, type:'QUALITY', date:'2024-09-28', title:'ุชุตุฏุน ูู ุงูุฃุณููุช ูุฅุนุงุฏุฉ ุฑุตู', status:'COMPLETED', details:'ุชู ุฅุบูุงูู ุจุนุฏ ุงูุฅุตูุงุญ ุงููุงูู.', location:'24.5247, 46.7135', imagePath:'', isComparative:true, actionPlan:'ุฅุนุงุฏุฉ ุจูุงุก ุงูุทุจูุงุช.', riskAssessment:{priority:'Low', timeframe:'7 days'}, resolutionNote:'ุชู ุงูุฅุบูุงู ุญุณุจ ุงูููุงุตูุงุช.', afterImagePath:'', createdAt: Date.now()-86400*1000*25, createdBy:'contractor' },
        { docId:'local-3', id:3, type:'MAINTENANCE', date:'2024-09-25', title:'ุนุทู ูู ูุธุงู ุงูุชุจุฑูุฏ ุงูุฑุฆูุณู', status:'IN_PROGRESS', details:'ุฅุฑุณุงู ูุฑูู ุนุงุฌู.', location:'24.5247, 46.7135', imagePath:'', isComparative:false, actionPlan:'ุชูููุฑ ูุทุน ุงูุบูุงุฑ.', riskAssessment:{priority:'Medium', timeframe:'48 hours'}, resolutionNote:null, afterImagePath:null, createdAt: Date.now()-86400*1000*27, createdBy:'inspector' },
        { docId:'local-1', id:1, type:'SAFETY', date:'2024-10-01', title:'ููุงุญุธุฉ ุนุฏู ุงุฑุชุฏุงุก ูุนุฏุงุช ุงูุญูุงูุฉ', status:'PENDING', details:'ูุฑูู ุจุฏูู ุฎูุฐุงุช ุฃูุงู.', location:'24.5247, 46.7135', imagePath:'', isComparative:false, actionPlan:'ุชุนุฒูุฒ ุงูุงูุชุฒุงู ุจู PPE.', riskAssessment:{priority:'High', timeframe:'24 hours'}, resolutionNote:null, afterImagePath:null, createdAt: Date.now()-86400*1000*20, createdBy:'inspector' }
      ].sort((a,b)=>b.createdAt-a.createdAt);
    }

    function initApp(){
      // ุงุณุชุฑุฌุงุน ุฌูุณุฉ ุงููุณุชุฎุฏู ุฅู ูุฌุฏุช
      try{
        CURRENT_USER = JSON.parse(localStorage.getItem('SmartHSR_currentUser')||'null');
      }catch{ CURRENT_USER=null; }
      if(CURRENT_USER){
        document.getElementById('loginOverlay').style.display='none';
        setCurrentUserBadge();
      }

      loadAll();
      renderKPIs();
      observationsData.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      renderObservationsList(observationsData);
      if (observationsData.length>0) showObservationDetail(observationsData[0].docId);

      // ุตูุงุญูุฉ ุฒุฑ ุฅุถุงูุฉ ููุงุญุธุฉ
      document.getElementById('add-observation-btn').disabled = (CURRENT_USER?.role!=='inspector');

      lucide.createIcons();
    }

    function initAppUIAfterLogin(){
      renderKPIs();
      renderObservationsList(observationsData);
      if (observationsData.length>0) showObservationDetail(observationsData[0].docId);
      lucide.createIcons();
    }

    window.onload = initApp;
  </script>
  
  <script>
/* ========= HSR Local Vision AI (offline) =========
   ูููุชุฌ ุซูุงุซ ูุฎุฑุฌุงุช: Vision, Root Cause, Repair Recommendation
   ุงูุฅุฏุฎุงู: { title, details, imagePath }
   ุงูุงุณุชุฎุฏุงู: renderAIResults(currentSelectedObservation)
=================================================== */

// ุงุณุชุฎุฑุงุฌ ูููุงุช ููุชุงุญูุฉ ุจุณูุทุฉ ูู ุงููุต
function keywordsAR(s=''){
  s = (s||'').toLowerCase();
  const keys = [];
  const add = k => { if(!keys.includes(k)) keys.push(k); };
  if(/ุดู|ุชุตุฏุน|ุชุดููุงุช|ูุณุฑ/.test(s)) add('crack');
  if(/ูุจูุท|ุชุนุฑู|ุญูุฑ|ุญูุฑุฉ/.test(s)) add('pothole');
  if(/ููุงู|ุชุฌูุน|ุณููู|ุตุฑู/.test(s)) add('water');
  if(/ููุญุฉ|ุฅุฑุดุงุฏ|ุนูุงูุฉ|ุฏูุงู/.test(s)) add('sign');
  if(/ุตุฏุฃ|ุชุขูู|ูุดุท/.test(s)) add('corrosion');
  if(/ุณูุงูุฉ|ppe|ุฎูุฐ|ุญูุงูุฉ/.test(s)) add('safety');
  if(/ุชูุฏูุฏ|ููุฑุจ|ูุงุจู|ูุงุณูุฑุฉ|ุชุตุฑูู/.test(s)) add('utility');
  return keys;
}

// ุชูููุฏ ุงููุตู ุงูุจุตุฑู (Vision)
function visionDescription(obs){
  const t = `${obs?.title||''} ${obs?.details||''}`;
  const k = keywordsAR(t);
  if (k.includes('crack')) {
    return `ุชุธูุฑ ุชุดููุงุช/ุชุตุฏุนุงุช ุณุทุญูุฉ ุฅูู ูุชูุณุทุฉ ุงูุงุชุณุงุน. ูุฏ ุชุณูุญ ุจููุงุฐ ุงูููุงู ูุชูุงูู ุงูุชูู ูุน ุงูุฒููุ ุฎุตูุตูุง ูุน ุงููุฑูุฑ ูุงูุฃุญูุงู.`;
  }
  if (k.includes('pothole')) {
    return `ุชูุฌุฏ ุญูุฑุฉ/ูุจูุท ููุถุนู ูุงุถุญ ูู ุงูุทุจูุฉ ุงูุฅุณููุชูุฉ ูุน ุญูุงู ูุชูุณุฑุฉ ูุงุญุชูุงู ุชุฌูุน ููุงู ุฏุงุฎููุง.`;
  }
  if (k.includes('water')) {
    return `ุชุฌูุน ููุงู ุณุทุญู ูุดูุฑ ุฅูู ูุตูุฑ ูู ุงูููู ุงูุทููู/ุงูุนุฑุถู ุฃู ุงูุณุฏุงุฏ ูู ุตุฑู ุงูููุงูุ ูุง ูุฑูุน ูุฎุงุทุฑ ุงูุงูุฒูุงู ูุชูู ุงูุฑุงุจุทุฉ.`;
  }
  if (k.includes('sign')) {
    return `ูุดููุฉ ูู ุงูุนูุตุฑ ุงูุฅุฑุดุงุฏู/ุงูุนูุงูุงุช (ุจูุชุงู/ุชุขูู/ุนุฏู ูุถูุญ) ุจูุง ูุคุซุฑ ุนูู ูุถูุญ ุงูุฑุณุงูุฉ ููุณุงุฆููู.`;
  }
  if (k.includes('corrosion')) {
    return `ุจูุงุฏุฑ ุชุขูู/ุตุฏุฃ ุนูู ุงูุนูุตุฑ ุงููุนุฏูู ูุฏ ุชูุถุนู ุงููุชุงูุฉ ูุชุฒูุฏ ุงุญุชูุงููุฉ ุงููุดู ูุน ุงูุฒูู.`;
  }
  if (k.includes('safety')) {
    return `ูุฎุงููุฉ ุงุดุชุฑุงุทุงุช ุงูุณูุงูุฉ (PPE/ุชูุธูู ุงููููุน) ูุง ูุฑูุน ุงุญุชูุงููุฉ ุงูุฅุตุงุจุงุช ูุงูุญูุงุฏุซ.`;
  }
  if (k.includes('utility')) {
    return `ุงุญุชูุงู ุชุนุงุฑุถ/ุชุนุทู ูู ุนูุงุตุฑ ุงูุฎุฏูุงุช (ูุงุจูุงุช/ุชูุฏูุฏุงุช/ุตุฑู) ูุชุทูุจ ูุนุงูุฌุฉ ูู ุงูุฌูุฉ ุงููุฎุชุตุฉ.`;
  }
  // ุงูุชุฑุงุถู
  return `ุชุธูุฑ ูุคุดุฑุงุช ุฎูู ููุถุนู ูู ุงูููุทุนุ ููุฑุฌูุญ ุฃูู ูุงุจู ููุงุชุณุงุน ูุน ูุฑูุฑ ุงูููุช ุฅู ูู ุชุชู ุงููุนุงูุฌุฉ.`;
}

// ุชูููุฏ ุงูุณุจุจ ุงูุฌุฐุฑู (Root Cause)
function rootCause(obs){
  const t = `${obs?.title||''} ${obs?.details||''}`;
  const k = keywordsAR(t);
  if (k.includes('water')) {
    return `ุงูุณุจุจ ุงููุฑุฌูุญ: ูุตูุฑ ุชุตุฑูู/ุงูุณุฏุงุฏ ูุตุงุฑู ุฃู ูููู ุบูุฑ ูุงููุฉุ ูุง ุฃุฏู ูุชุฌูุน ููุงู ูุชุฏููุฑ ุงูุฑุงุจุทุฉ ุงูุฅุณููุชูุฉ.`;
  }
  if (k.includes('crack')) {
    return `ุงูุณุจุจ ุงููุฑุฌูุญ: ุชุนุจ ูุฑูุฑู/ุดูุฎูุฎุฉ ุฑุงุจุทุฉ ูุน ุงุญุชูุงููุฉ ุถุนู ูู ุงูุฃุณุงุณ ุฃู ุชุณุฑุจ ููุงู ุฃุฏู ูุชุดููุงุช ุดุจููุฉ.`;
  }
  if (k.includes('pothole')) {
    return `ุงูุณุจุจ ุงููุฑุฌูุญ: ุงูููุงุฑ ููุถุนู ููุทุจูุงุช ูุชูุฌุฉ ุชุดุจูุน ุฑุทูุจู/ุญูู ุฒุงุฆุฏ ูุน ุชุฃุฎุฑ ุฅุตูุงุญ ุงูุดููู ุงูุฃูููุฉ.`;
  }
  if (k.includes('sign')) {
    return `ุงูุณุจุจ ุงููุฑุฌูุญ: ุชุนุฑุถ ุทููู ููุนูุงูู ุงูุฌููุฉ/ุฃุดุนุฉ ุงูุดูุณ ูุนุฏู ุงุณุชุจุฏุงู ุฏูุฑู ุฃู ููุงุฏ ุบูุฑ ูุทุงุจูุฉ ููููุงุตูุงุช.`;
  }
  if (k.includes('corrosion')) {
    return `ุงูุณุจุจ ุงููุฑุฌูุญ: ุชุนุฑุถ ูุณุชูุฑ ููุฑุทูุจุฉ/ุงูุฃููุงุญ ุจุฏูู ูุนุงูุฌุฉ ุณุทุญูุฉ ูุงููุฉ ูุตูุงูุฉ ุฏูุฑูุฉ.`;
  }
  if (k.includes('safety')) {
    return `ุงูุณุจุจ ุงูุฌุฐุฑู: ุถุนู ุงูุงูุชุฒุงู ุจุงูุฅุฌุฑุงุกุงุช/ุงูุฑูุงุจุฉ ุนูู ูุนุฏุงุช ุงูููุงูุฉ ูุงูุชูุธูู ุงููููุนู.`;
  }
  return `ุงูุณุจุจ ุงููุฑุฌูุญ: ุตูุงูุฉ ุฏูุฑูุฉ ุบูุฑ ูุงููุฉ ูุชุฃุฎุฑ ูู ุงููุนุงูุฌุฉ ูุน ุนูุงูู ุจูุฆูุฉ/ูุฑูุฑูุฉ ุณุงููุช ูู ุงูุชุฏููุฑ.`;
}

// ุชูููุฏ ุชูุตูุฉ ุงูุฅุตูุงุญ (Repair Recommendation)
function repairRecommendation(obs){
  const t = `${obs?.title||''} ${obs?.details||''}`;
  const k = keywordsAR(t);

  if (k.includes('pothole')) {
    return `ุฅุฒุงูุฉ ุงูุฃุฌุฒุงุก ุงูููููุฉ ุญูู ุงูุญูุฑุฉ ููุตู ุญุฏูุฏ ููุชุธูุฉุ ุชูุธูู ูุชุฌููู ุงููุงุนุ ุชุทุจูู ุทุจูุฉ ุฑุงุจุทุฉ (Tack Coat)ุ
ุซู ุฑุฏู ุจุทุจูุชูู ูู ุฎูุทุฉ ุฅุณููุชูุฉ ุญุงุฑุฉ ูุน ุฏูู ุทุจููุ ูุถุจุท ุงูููุงุณูุจ ูุชุตุฑูู ุงูููุงู.`;
  }
  if (k.includes('crack')) {
    return `ุชูุธูู ุงูุดููู ุจุงูููุงุก/ุงููุฑุดุงุฉุ ููุก ุจูุงุฏุฉ ุณููุงูุช/ูุงุณุชู ููุงุณุจุฉุ ููุน ุงูุดููู ุงูุดุจููุฉ ููููููุฐ ูุตู ูุฅุนุงุฏุฉ ุฑุตู ููุถุนู (Patching) ุจุนุฏ ุทุจูุฉ ุฑุงุจุทุฉ.`;
  }
  if (k.includes('water')) {
    return `ูุชุญ ูุชูุธูู ูุตุงุฑู ุงูุฃูุทุงุฑ/ุงูุนุจูุงุฑุงุชุ ุชุตุญูุญ ุงููููู ุงูุทูููุฉ/ุงูุนุฑุถูุฉ ุฅู ูุฒูุ ูุนุงูุฌุฉ ููุงุถุน ุงูุชูู ุงูุฅุณููุชู ูุฅุนุงุฏุฉ ุงูุฅุบูุงู ุจุนุฏ ุงุฎุชุจุงุฑ ุงูุชุตุฑูู.`;
  }
  if (k.includes('sign')) {
    return `ุงุณุชุจุฏุงู ุงูููุญุฉ/ุฅุนุงุฏุฉ ุฏูุงู ุจุนูุงูุณ ูุทุงุจูุฉ ููููุงุตูุงุช (Grade ููุงุณุจ)ุ ุชุซุจูุช ุงูููุงุนุฏุ ูุงูุชุญูู ูู ุงูุงุฑุชูุงุน ูููุถุน ุงูุฑุคูุฉ.`;
  }
  if (k.includes('corrosion')) {
    return `ุฅุฒุงูุฉ ุงูุตุฏุฃ ูููุงูููููุงุ ุฏูุงู ุจุทุจูุฉ ุจุฑุงููุฑ ูุงูุนุฉ ููุชุขูู ุซู ุทุจูุงุช ูุงููุฉุ ูุงุณุชุจุฏุงู ุงูุนูุงุตุฑ ุงูุถุนููุฉ ุฅู ูุฒู.`;
  }
  if (k.includes('safety')) {
    return `ูุฑุถ ุงูุชุฒุงู ูุงูู ุจู PPE (ุฎูุฐุฉุ ุตุฏูุฑู ุนุงูุณุ ููุงุฒุงุช)ุ ุชูุธูู ุงููููุน ุจุญูุงุฌุฒ ูููุญุงุช ุชุญุฐูุฑุ ูุชูุนูู ุชูุชูุด ุณูุงูุฉ ุฏูุฑู.`;
  }
  return `ูุนุงูุฌุฉ ููุถุนูุฉ: ูุตู ุงูุฌุฒุก ุงููุชุถุฑุฑุ ุชูุธูู ุงูุญูุงูุ ุทุจูุฉ ุฑุงุจุทุฉุ ุฑูุนุฉ ุฅุณููุชูุฉ ูุน ุฏูู ุทุจููุ ุซู ูุญุต ุฌูุฏุฉ ุจุตุฑู ูุถุจุท ููุณูุจ ุงูููุงู.`;
}

// ุงููุฌููุน: ููุฑุฌุน ูุงุฆู ุจุซูุงุซุฉ ูุตูุต
function runLocalVisionAI(obs){
  return {
    vision: visionDescription(obs),
    root:  rootCause(obs),
    repair: repairRecommendation(obs)
  };
}

// ุฏุงูุฉ ุนุฑุถ ุงููุชุงุฆุฌ ูู ุตูุฏูู ุงููุชุงุฆุฌ ุงูุญุงูู ุจุงููุงุฌูุฉ
function renderAIResults(obs){
  const res = runLocalVisionAI(obs||{});
  const wrap = document.getElementById('aiResultContainer');
  const title = document.getElementById('aiResultTitle');
  const content = document.getElementById('aiResultContent');

  title.textContent = 'ูุชุงุฆุฌ ุงูุชุญููู โ HSR Vision AI (ูุญูู)';
  content.innerHTML = `
    <div class="communication-draft">
      <p><b>๐ ุชุญููู ุงูุตูุฑ (Vision):</b><br>${res.vision}</p>
      <p class="mt-3"><b>๐งช ุชุญููู ุณุจุจ ุงููุดููุฉ:</b><br>${res.root}</p>
      <p class="mt-3"><b>๐๏ธ ุชูุตูุฉ ุทุฑููุฉ ุงูุฅุตูุงุญ:</b><br>${res.repair}</p>
    </div>
    <p class="text-xs text-gray-500 mt-4 italic border-t pt-2">ุชู ุงูุชูููุฏ ูุญูููุง โ ูุง ุญุงุฌุฉ ูููุชุงุญ ุฃู ุฅูุชุฑูุช.</p>`;
  wrap.classList.remove('hidden');
}

// ุงุฑุจุท ุงูุฃุฒุฑุงุฑ ุงูููุฌูุฏุฉ ุนูุฏู ุจูุฐู ุงูุฏูุงู:
window.runAI = function(mode){
  // ุชุฌููุฑ ูุงุฌูุฉ ุงูุงูุชุธุงุฑ
  const title = document.getElementById('aiResultTitle');
  const content = document.getElementById('aiResultContent');
  const wrap = document.getElementById('aiResultContainer');
  title.textContent = (mode==='vision' ? 'ุชุญููู ุงูุตูุฑ (Vision)' : 'ุงูุชุญููู');
  content.innerHTML = `<div class='flex items-center text-teal-700 font-bold'><div class='loading-spinner' style='border-top-color: var(--color-teal); margin-left:8px;'></div> ุฌุงุฑู ุงูุชุญููู...</div>`;
  wrap.classList.remove('hidden');

  // ุงุณุชุฎุฏู ุงูููุงุญุธุฉ ุงูุญุงููุฉ ุงููุนุฑูุถุฉ
  setTimeout(()=> renderAIResults(window.currentSelectedObservation || {}), 700);
};
</script>

</body>
</html>
