<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>
    
    <meta name="description" content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta name="keywords" content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta property="og:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ">
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <link rel="stylesheet" href="output.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --color-navy: #0A1931;
            --color-teal: #18A5A2;
            --color-light-teal: #ACE2E1;
            --color-gray-bg: #F7F9FC;
            --color-shadow-base: rgba(10, 25, 49, 0.4);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--color-gray-bg);
            color: var(--color-navy);
        }

        .kpi-open-gradient {
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.4);
        }
        .kpi-closed-gradient {
            background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(24, 165, 162, 0.4);
        }
        .kpi-images-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }
        .kpi-missing-gradient {
            background: linear-gradient(135deg, #FCD34D 0%, #F97316 100%);
            color: var(--color-navy);
            box-shadow: 0 10px 20px rgba(253, 211, 77, 0.4);
        }

        .kpi-card-professional {
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0);
        }
        .kpi-card-professional::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: height 0.3s ease;
        }
        .kpi-card-professional:hover {
            transform: translateY(-8px) scale(1.02);
            z-index: 10;
        }
        .kpi-card-professional:hover::before { height: 100%; opacity: 0.1; }

        .ai-button-primary {
            background-color: var(--color-teal);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(24, 165, 162, 0.5);
        }
        .ai-button-primary:hover:not(:disabled) {
            background-color: #148f8c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(24, 165, 162, 0.8);
        }

        .ai-button-secondary {
            background-color: var(--color-navy);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(10, 25, 49, 0.6);
        }
        .ai-button-secondary:hover:not(:disabled) {
            background-color: #1a3053;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(10, 25, 49, 0.8);
        }

        .ai-button-vision { background-color: #9333ea; color: white; transition: all 0.3s ease; box-shadow: 0 6px 15px rgba(147, 51, 234, 0.5); }
        .ai-button-vision:hover:not(:disabled) { background-color: #7e22ce; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(147, 51, 234, 0.8); }
        .ai-button-root-cause { background-color: #881337; color: white; transition: all 0.3s ease; box-shadow: 0 6px 15px rgba(136, 19, 55, 0.5); }
        .ai-button-root-cause:hover:not(:disabled) { background-color: #9f1239; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(136, 19, 55, 0.8); }
        .ai-button-comm { background-color: #F97316; color: white; transition: all 0.3s ease; box-shadow: 0 6px 15px rgba(249, 115, 22, 0.5); }
        .ai-button-comm:hover:not(:disabled) { background-color: #ea580c; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(249, 115, 22, 0.8); }
        .ai-button-grounding { background-color: #10B981; color: white; transition: all 0.3s ease; box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5); }
        .ai-button-grounding:hover:not(:disabled) { background-color: #059669; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8); }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-light-teal);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        .ai-button-primary .loading-spinner,
        .ai-button-vision .loading-spinner,
        .ai-button-comm .loading-spinner,
        .ai-button-grounding .loading-spinner,
        .ai-button-secondary .loading-spinner,
        .ai-button-root-cause .loading-spinner { border-top: 4px solid #0A1931; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

        .image-container { position: relative; overflow: hidden; border-radius: 0.75rem; box-shadow: 0 4px 10px var(--color-shadow-base); }
        .image-label { position: absolute; bottom: 0; right: 0; background-color: var(--color-navy); color: white; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 700; border-top-left-radius: 0.75rem; }
        .observation-item { transition: all 0.2s; border-right: 4px solid transparent; cursor: pointer; }
        .observation-item:hover { background-color: #E6F3F3; border-right-color: var(--color-teal); }
        .observation-item.active { background-color: #E6F3F3; border-right-color: var(--color-navy); box-shadow: 0 0 10px rgba(0,0,0,0.1); }

        .comparison-wrapper { position: relative; max-width: 100%; overflow: hidden; user-select: none; cursor: ew-resize; border-radius: 0.75rem; }
        .comparison-wrapper img, .comparison-wrapper video { display: block; width: 100%; height: auto; }
        .comparison-wrapper .after-image { position: absolute; top: 0; left: 0; height: 100%; width: 50%; overflow: hidden; }
        .comparison-wrapper .after-image img, .comparison-wrapper .after-image video { position: absolute; top: 0; left: 0; width: 100%; height: auto; }
        .comparison-wrapper .comparison-divider { position: absolute; top: 0; left: 50%; width: 4px; height: 100%; background-color: var(--color-teal); transform: translateX(-50%); cursor: grab; z-index: 10; box-shadow: 0 0 10px rgba(24,165,162,0.8); border-radius: 2px; transition: width 0.1s ease; }
        .comparison-wrapper .comparison-divider:active { cursor: grabbing; }
        .comparison-wrapper .comparison-divider-handle { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 40px; height: 40px; background-color: white; border: 3px solid var(--color-teal); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        .comparison-label { position: absolute; z-index: 5; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 700; color: white; border-radius: 0.5rem; opacity: 0.9; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .label-before { top: 10px; right: 10px; background-color: #B91C1C; }
        .label-after { top: 10px; left: 10px; background-color: #10B981; }

        .communication-draft { white-space: pre-wrap; text-align: right; direction: rtl; font-family: 'Tajawal', sans-serif; border-right: 4px solid var(--color-teal); padding-right: 1rem; line-height: 1.8; background-color: #f8fafc; }

        .kpi-insight-container { border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--color-navy); }
        .source-link { color: #0d9488; text-decoration: none; transition: color 0.2s; }
        .source-link:hover { color: var(--color-navy); text-decoration: underline; }
        audio { width: 100%; margin-top: 10px; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 1.5rem; width: 90%; max-width: 800px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slide-up 0.3s ease-out; position: relative; }

        .input-group-wrapper { display: flex; gap: 1rem; }
        .input-group { flex-grow: 1; text-align: center; }

        @media print {
            body { background-color: white !important; color: black !important; width: 210mm; min-height: 297mm; margin: 0; }
            .no-print, #observationsList, #hero, #operational-dashboard, #ai-features, footer, .modal { display: none !important; }
            #observationDetail { display: block !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; }
            .kpi-insight-container, .bg-white { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .comparison-wrapper { cursor: default; }
            .comparison-divider, .comparison-label { display: none !important; }
            .comparison-wrapper .after-image { width: 100% !important; overflow: visible !important; }
            .comparison-wrapper .after-image img { position: static !important; }
            .grid.grid-cols-1.md\3a grid-cols-3 { display: block !important; border: 1px solid #ccc; margin-bottom: 10px; }
            .grid.grid-cols-1.md\3a grid-cols-3>div { border: none !important; padding: 5px; }
            .print-logo { display: block !important; }
        }
    </style>
</head>

<body class="text-gray-800">

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <div class="flex justify-start mb-6 no-print">
            <button id="logout-btn"
                class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold flex items-center shadow-lg transition duration-300 transform hover:scale-105"
                onclick="smartLogout()" title="ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุขูู">
                <i data-lucide="log-out" class="w-4 h-4 ml-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ
            </button>
        </div>
        <section id="hero"
            class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
            <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight"
                style="color: var(--color-navy);">Smart HSR <span style="color: var(--color-teal);">Dashboard</span>
            </h1>
            <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</h2>
            <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">"ููุตุฉ ุชูููุฐูุฉ ุฐููุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงููุฑุงูุจุฉ ุงูุฑูููุฉุ ุชููุฑ ุฑุคูุฉ ุฏูููุฉ ููุฃุฏุงุก ูุชุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงููุจูู ุนูู ุงูุจูุงูุงุช."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 class="text-4xl md:text-5xl font-extrabููุฏ text-gray-900 mb-3" style="color: var(--color-navy);">ุณุฌู
                    ุงูููุงุญุธุงุช ุงูุชูุงุนูู: ุฏูุฉ ุงูุตูุฑุฉ ูุงููุต</h3>
                <p class="mt-3 text-lg text-gray-600">ุนุฑุถ ุชูุตููู ููููุงุญุธุงุช ุงูููุฏุงููุฉ ูุน ุฃุฏูุงุช ุงูุชุญููู ุงูุขูู.</p>
                <button id="add-observation-btn"
                    class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto"
                    onclick="openModal('smartInputModal')">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ (ุงูุฅุฏุฎุงู ุงูุฐูู)
                </button>
            </div>

            <div
                class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">

                <div
                    class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
                    <h4 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">ุชุตููุฉ ุงูููุงุญุธุงุช</h4>
                    <select id="observationFilter"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300"
                        onchange="handleFilterChange()">
                        <option value="ุงููู">ุนุฑุถ ูู ุงูููุงุญุธุงุช</option>
                        <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
                        <option value="ููุฏ ุงูุชูููุฐ">ููุฏ ุงูุชูููุฐ</option>
                        <option value="ุชูุช ุงููุนุงูุฌุฉ">ุชูุช ุงููุนุงูุฌุฉ</option>
                        <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option>
                        <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
                        <option value="ุณูุงูุฉ">ุณูุงูุฉ</option>
                        <option value="ุจูุฆุฉ">ุจูุฆุฉ</option>
                    </select>
                    <h4 class="text-2xl font-bold mt-8 mb-3" style="color: var(--color-navy);">ุงููููุงุญุธููุงุช</h4>
                    <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-center text-gray-500 mt-10">... ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ...</div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">

                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 class="text-3xl font-extrabold text-gray-900" style="color: var(--color-navy);">ุชูุฑูุฑ Smart
                            HSR ุงูุชูููุฐู</h2>
                        <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
                    </div>

                    <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2"
                        style="color: var(--color-teal);">ุนุฑุถ ุงูุชูุงุตูู ูุงูุชุญููู (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">

                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุนููุงู:</span>
                                <span id="detailTitle" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุชุตููู:</span>
                                <span id="detailType" class="block font-bold text-teal-600"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ุงููููุน:</span>
                                <span id="detailLocation" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุชุงุฑูุฎ ุงูุจูุงุบ:</span>
                                <span id="detailDate" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุญุงูุฉ ุงููุนุงูุฌุฉ:</span>
                                <span id="detailStatus"
                                    class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ูุนุฑู ุงูุจูุงุบ:</span>
                                <span id="detailID" class="block font-bold text-gray-800"></span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
                            <h5 class="text-xl font-bold mb-3" style="color: var(--color-navy);">ูุตู ุงูููุงุญุธุฉ</h5>
                            <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
                            <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                                <h6 class="font-bold text-teal-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ (Gemini AI)</h6>
                                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer"
                            class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
                            <h5 class="text-xl font-bold mb-3 text-green-700">๐ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู</h5>
                            <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
                            <img id="beforeImage" class="before-image w-full h-auto" alt="ุตูุฑุฉ ูุจู ุงูุฅุตูุงุญ"
                                src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            <div id="afterImageContainer" class="after-image">
                                <img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ"
                                    src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            </div>
                            <div id="comparisonDivider" class="comparison-divider no-print">
                                <div class="comparison-divider-handle">
                                    <i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i>
                                </div>
                            </div>
                            <span class="comparison-label label-before no-print">ูุจู</span>
                            <span class="comparison-label label-after no-print">ุจุนุฏ</span>
                        </div>

                        <div id="mediaContainer" class="image-container mb-6 hidden">
                            <div id="mediaContent" class="w-full h-auto rounded-xl">
                            </div>
                            <span class="image-label">ูุฑูู ุงูููุงุญุธุฉ</span>
                        </div>

                        <div id="noImageMessage"
                            class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
                            <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> ูุง ุชุชููุฑ ุตูุฑุฉ ุฃู
                            ููุฏูู ููุฐู ุงูููุงุญุธุฉ.
                        </div>


                        <div id="aiAnalysisSection"
                            class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
                            <h5 class="text-xl font-bold mb-4" style="color: var(--color-navy);">ุฃุฏูุงุช ุงูุชุญููู ุงูุฐูู
                                (Gemini AI)</h5>
                            <div class="flex flex-wrap gap-3 no-print">
                                <button id="vision-btn"
                                    class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('vision')">
                                    <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
                                </button>
                                <button id="root-cause-btn"
                                    class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('root-cause')">
                                    <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู
                                </button>
                                <button id="comm-btn"
                                    class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generateCommunicationDraft()">
                                    <i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
                                </button>
                                <button id="pdf-report-btn"
                                    class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generatePdfReport()">
                                    <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ุชูููุฏ ุชูุฑูุฑ PDF
                                </button>
                            </div>

                            <div id="aiResultContainer"
                                class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color: var(--color-teal);">
                                </h6>
                                <div id="aiResultContent" class="text-gray-700"></div>
                            </div>
                        </div>

                        <div id="actionButtons"
                            class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
                            <button id="updateStatusBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="alert('ุชู ุชุญููู ุงูุญุงูุฉ ุฅูู ููุฏ ุงูุชูููุฐ (ุชุฌุฑูุจู)')">
                                ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ููุฏ ุงูุชูููุฐ"
                            </button>
                            <button id="completeObservationBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="openModal('closeoutModal')">
                                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> ุงูุฅุบูุงู ุงูุชูููุฐู (ุตูุฑุฉ ุจุนุฏ)
                            </button>
                            <button id="alreadyCompletedBtn"
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden"
                                disabled>
                                <i data-lucide="check" class="w-4 h-4 ml-2"></i> ุงูููุงุญุธุฉ ูุบููุฉ ูููุซูุฉ
                            </button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center space-y-4">
                        <p class="text-gray-500 mt-16 text-lg">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุงูุตูุฑุฉ ูุงููุฐูุฑุฉ
                            ุงูุชูุตูููุฉ.</p>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01" />
                        </svg>
                    </div>

                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="my-20 no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐
                    ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุญูููุฉ (Vital Metrics)</h3>
                <p class="mt-3 text-lg text-gray-600">ุชุชุจุน ุงูุจูุงุบุงุช ูุญุงูุฉ ุงูุชูุซูู ุจุงูุตูุฑ ูุถูุงู ููุงุกุฉ ุงูุฅุบูุงู.</p>
            </div>

            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200">
                    <p class="text-xl font-medium text-gray-500">ุฌุงุฑู ุงูุชุญููู...</p>
                    <p class="text-5xl font-extrabold text-gray-700 mt-2">--</p>
                </div>
            </div>

            <div class="mt-12 text-center">
                <button id="kpi-insight-button"
                    class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                    onclick="generateKpiInsights()">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (Gemini AI)
                </button>
                <div id="kpi-insight-result" class="mt-6 text-sm">
                </div>
            </div>
        </section>

        <section id="ai-features"
            class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐ง
                    ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุตููู ุงูุนูููุฉ</h3>
                <p class="mt-3 text-lg text-gray-600">ุงุณุชูุฏ ูู ููุงุฐุฌ Gemini ูุชุญููู ุงูุจูุงูุงุช ุฅูู ูุฑุงุฑุงุช ูุงุจูุฉ ููุชูููุฐ.
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #9333ea;">๐๏ธ</span>
                    <h4 class="font-extrabold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุฑุคูุฉ</h4>
                    <p class="text-xs text-gray-600">ูุตู ุงููุดููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุฎุทุฉ ุนูู ุขููุฉ</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ุฎุทูุงุช ุชูููุฐูุฉ ููุนุงูุฌุฉ ุงูููุงุญุธุฉ.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">๐จ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูููู ุงููุฎุงุทุฑ</h4>
                    <p class="text-xs text-gray-600">ุชุญุฏูุฏ ุงูุฃููููุฉ ูุงูุฅุทุงุฑ ุงูุฒููู ูู ูููู JSON.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #881337;">๐ฌ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู</h4>
                    <p class="text-xs text-gray-600">ุงูุชุฑุงุญ ุณุจุจ ุฌุฐุฑู ููุตูุญุฉ ููุงุฆูุฉ.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #F97316;">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุตูุงุบุฉ ุงูุงุชุตุงู</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ูุณูุฏุฉ ุฃูุฑ ุนูู ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-navy);">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูุฑูุฑ ุงูุฅุบูุงู ุงูุตูุชู</h4>
                    <p class="text-xs text-gray-600">ุชูุฎูุต ุงูุชูุฑูุฑ ูุชุญูููู ุฅูู ููู ุตูุชู.</p>
                </div>
                <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #10B981;">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุงูุจุญุซ ุนู ุงููุนุงููุฑ</h4>
                    <p class="text-xs text-gray-600">ุงุณุชุฎุฏุงู ุงูุจุญุซ ุงููุฏุนูู ูุงุณุชุญุถุงุฑ ุงููุนุงููุฑ ุงูุนุงูููุฉ.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
            <div class="max-w-6xl mx-auto px-4">
                <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color: var(--color-navy);">
                    ุงุจุฏุฃ ุฑุญูุฉ ุงูุชุญูู ุงูุฑููู ูุน Smart HSR
                </h3>
                <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
                    ูุธุงู ุฐูู ููุญูู ุจูุงูุงุช ุงูููุฏุงู ุฅูู ูุฑุงุฑุงุช ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฐููุฉ
                </p>
                
                <a href="http://wa.me/966507006849" target="_blank"
                    class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">
                    ุงุทูุจ ุนุฑุถูุง ุชุฌุฑูุจููุง ุงูุขู
                </a>
                
                <div class="mt-12 pt-8 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุญูู ุงููุธุงู</h4>
                            <p>ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงูุฏุนู ุงูููู</h4>
                            <p><a href="mailto:Blumark24@gmail.com">Blumark24@gmail.com</a></p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงููุจูุนุงุช ูุงูุงุณุชูุณุงุฑุงุช</h4>
                            <p>0507006849</p>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <p class="mb-2">&copy; 2025 Smart HSR. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
                        <p id="userInfo">ุชู ุชุญููู ุงูุตูุญุฉ โ ูู ุงูุชุธุงุฑ ุงูุจูุงูุงุช</p>
                    </div>
                </div>
            </div>
        </footer>

    </main>

    <!-- Modals -->
    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color: var(--color-navy);">ูุญุฏุฉ ุงูุฅุฏุฎุงู ุงูุฐูู
                ููููุงุญุธุงุช (Smart HSR)</h2>

            <div id="modalStep1">
                <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุฃุฏุฎู ุชูุงุตูู ุงูููุงุญุธุฉ (ุงููุตุ ุงููููุนุ ุงูุตูุฑุฉ/ุงูููุฏูู)</p>
                <textarea id="rawObservationInput" rows="5"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm"
                    placeholder="ูุซุงู: ููุฌุฏ ุชุฌูุน ููููุงู ุนูู ุทุฑูู ุงูุฎุฏูุฉ ุนูุฏ ุงููููู 52 ุจุงุชุฌุงู ุงูุดุฑูุ ูุชุณุจุจ ูู ุงูุฒูุงู ุงูุณูุงุฑุงุช. ูุญุชุงุฌ ุฅูู ุชุตุฑูู ููุฑู."
                    oninput="checkSmartInputState()"></textarea>

                <div class="mt-4 input-group-wrapper">
                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="locationStatus" class="block text-sm font-medium text-gray-700 mb-2">ุงููููุน ุงูุฌุบุฑุงูู
                            (GPS):</label>
                        <p id="locationStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ</p>
                        <input type="hidden" id="inputLatitude">
                        <input type="hidden" id="inputLongitude">
                        <button id="getLocationBtn"
                            class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                            onclick="getLocation()" type="button">
                            <i data-lucide="map-pin" class="w-4 ู-4 ml-2"></i> ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู
                        </button>
                    </div>

                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="fileUploadInput" class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ ุฃู
                            ููุฏูู ุงูููุงุญุธุฉ:</label>
                        <p id="fileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
                        <input type="file" id="fileUploadInput" accept="image/*,video/*" class="hidden"
                            onchange="handleFileUpload(event)">
                        <button
                            class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                            onclick="document.getElementById('fileUploadInput').click()" type="button">
                            <i data-lucide="upload" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ููู
                        </button>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button id="processSmartInputBtn"
                        class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                        onclick="processSmartInput()" disabled>
                        <i data-lucide="cpu" class="w-5 h-5 ml-2"></i> ุจุฏุก ุงูุชุญููู ุงูุฐูู ูุชูููุฏ ุงูุชูุฑูุฑ
                    </button>
                </div>
            </div>

            <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุจูุงุณุทุฉ
                    ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h3>
                <div id="modalResultContent"></div>
                <div class="mt-6 text-center">
                    <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold"
                        onclick="closeModal('smartInputModal')">
                        ุฅุบูุงู ููุฑุงุฌุนุฉ ุงูุชูุฑูุฑ ุงูุฌุฏูุฏ
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">๐ ููุญุฉ ุงูุฅุบูุงู ุงูุชูููุฐู ููููุงุญุธุฉ
                #<span id="closeoutId"></span></h2>

            <p class="text-lg text-gray-600 mb-4">ูุฅุบูุงู ุงูููุงุญุธุฉุ ูุฌุจ ุชูุซูู ุนูููุฉ ุงูุฅุตูุงุญ ุจู <b>ุตูุฑุฉ "ุจุนุฏ ุงูุฅุตูุงุญ"</b>
                ุฅูุฒุงููุฉ ููุฐูุฑุฉ ุฎุชุงููุฉ.</p>

            <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold mb-3" style="color: var(--color-navy);">1. ุชูุซูู ุตูุฑุฉ ุงูุฅุบูุงู (After Photo)
                </h3>

                <div
                    class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white hover:border-red-500 transition-colors">
                    <label for="afterFileUploadInput" class="block text-sm font-medium text-gray-700 mb-2">ุฑูุน ุตูุฑุฉ
                        <b>ุจุนุฏ ุงูุฅุตูุงุญ/ุงููุนุงูุฌุฉ</b> (<span class="text-red-500 font-bold">ุฅูุฒุงูู</span>):</label>
                    <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ</p>
                    <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden"
                        onchange="handleAfterFileUpload(event)">
                    <button
                        class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                        onclick="document.getElementById('afterFileUploadInput').click()" type="button">
                        <i data-lucide="camera" class="w-4 h-4 ml-2"></i> ุงุฎุชูุงุฑ ุตูุฑุฉ ุงูุฅุบูุงู
                    </button>
                </div>

                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-navy);">2. ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ</h3>
                <textarea id="resolutionNoteInput" rows="4"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm"
                    placeholder="ุงูุชุจ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ุงูุชู ุชูุถุญ ุงูุฅุฌุฑุงุกุงุช ุงูุชู ุชู ุงุชุฎุงุฐูุง ูุฅุบูุงู ุงูููุงุญุธุฉ ููุงุฆูุงู..."></textarea>
            </div>

            <div class="mt-6 text-center">
                <button id="finalCloseoutBtn"
                    class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto transition-colors"
                    onclick="completeObservation()" disabled>
                    <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ุชุฃููุฏ ุงูุฅุบูุงู ุงูููุงุฆู ููููุงุญุธุฉ
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- ุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ (ุณูุชู ุงุณุชุจุฏุงููุง ุจุงูู Firestore ูุจุงุดุฑุฉ) ---
        const observationsData = [];
        let currentSelectedObservation = null;
        const statusMap = {
            "PENDING": {color: 'bg-red-600', text: 'ููุฏ ุงูุงูุชุธุงุฑ'},
            "IN_PROGRESS": {color: 'bg-yellow-600', text: 'ููุฏ ุงูุชูููุฐ'},
            "COMPLETED": {color: 'bg-green-600', text: 'ุชูุช ุงููุนุงูุฌุฉ'}
        };

        let currentFile = null; let currentFileUrl = null;
        let currentAfterFile = null; let currentAfterFileUrl = null;

        function calculateKPIs() {
            const totalReports = observationsData.length;
            const openReports = observationsData.filter(obs => obs.status !== 'COMPLETED').length;
            const closedReports = totalReports - openReports;
            const reportsWithImages = observationsData.filter(obs => obs.hasImage).length;
            return {totalReports, openReports, closedReports, reportsWithImages};
        }

        function renderKPIs() {
            const kpis = calculateKPIs();
            const kpiContainer = document.getElementById('kpiContainer');
            kpiContainer.innerHTML = '';

            const kpiData = [
                {title: 'ุฅุฌูุงูู ุงูููุงุญุธุงุช', value: kpis.totalReports, icon: 'clipboard-list', gradientClass: 'kpi-closed-gradient'},
                {title: 'ููุงุญุธุงุช ููุชูุญุฉ/ุงูุชุธุงุฑ', value: kpis.openReports, icon: 'alert-triangle', gradientClass: 'kpi-open-gradient'},
                {title: 'ููุงุญุธุงุช ูุบููุฉ/ูุนุงูุฌุฉ', value: kpis.closedReports, icon: 'check-circle', gradientClass: 'kpi-closed-gradient'},
                {title: 'ููุงุญุธุงุช ููุซูุฉ ุจุงูุตูุฑ', value: kpis.reportsWithImages, icon: 'image', gradientClass: 'kpi-images-gradient'}
            ];

            kpiData.forEach(kpi => {
                const kpiHTML = `
                    <div class="kpi-card-professional p-6 ${kpi.gradientClass} flex items-center justify-between shadow-2xl">
                        <div>
                            <p class="text-sm md:text-md font-medium">${kpi.title}</p>
                            <p class="text-4xl md:text-5xl font-extrabold mt-1">${kpi.value}</p>
                        </div>
                        <i data-lucide="${kpi.icon}" class="w-10 h-10 opacity-70"></i>
                    </div>
                `;
                kpiContainer.innerHTML += kpiHTML;
            });
            lucide.createIcons();
            const ui = document.getElementById('userInfo');
            if (ui) ui.textContent = 'ุจูุงูุงุช ูุจุงุดุฑุฉ ูู Firestore โ';
        }

        function renderObservationsList(observations) {
            const list = document.getElementById('observationsList');
            list.innerHTML = '';

            if (observations.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-xl">ูุง ุชูุฌุฏ ููุงุญุธุงุช ูุทุงุจูุฉ ููุนูุงุฑ ุงูุชุตููุฉ.</div>';
                document.getElementById('detailPlaceholder').classList.remove('hidden');
                document.getElementById('observationDetail').classList.add('hidden');
                return;
            }

            observations.forEach(obs => {
                const statusInfo = statusMap[obs.status] || {color: 'bg-gray-500', text: obs.status};
                const isSelected = obs.id === (currentSelectedObservation ? currentSelectedObservation.id : null) ? 'active' : '';

                const obsHTML = `
                    <div class="observation-item p-3 rounded-lg flex justify-between items-center ${isSelected}" onclick="showObservationDetail('${obs.id}')">
                        <div>
                            <p class="text-md font-bold text-gray-800 truncate max-w-[200px]">${obs.title}</p>
                            <p class="text-xs text-gray-500 mt-1">${obs.date} | ${obs.type}</p>
                        </div>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.color} text-white">${statusInfo.text}</span>
                    </div>
                `;
                list.innerHTML += obsHTML;
            });
        }

        function showObservationDetail(id) {
            currentSelectedObservation = observationsData.find(obs => obs.id === id);
            if (!currentSelectedObservation) return;

            document.querySelectorAll('.observation-item').forEach(item => item.classList.remove('active'));
            const obsElement = Array.from(document.querySelectorAll('#observationsList .observation-item')).find(x=>x.textContent.includes(currentSelectedObservation.title));
            if (obsElement) obsElement.classList.add('active');

            const statusInfo = statusMap[currentSelectedObservation.status] || {color: 'bg-gray-500', text: currentSelectedObservation.status};
            document.getElementById('detailTitle').textContent = currentSelectedObservation.title;
            document.getElementById('printTitle').textContent = `ุงูููุงุญุธุฉ: ${currentSelectedObservation.title}`;
            document.getElementById('detailType').textContent = currentSelectedObservation.type;
            document.getElementById('detailDate').textContent = currentSelectedObservation.date;
            document.getElementById('detailID').textContent = currentSelectedObservation.id;
            document.getElementById('detailLocation').textContent = currentSelectedObservation.location || '';
            document.getElementById('detailStatus').textContent = statusInfo.text;
            document.getElementById('detailStatus').className = `inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${statusInfo.color}`;
            document.getElementById('detailDescription').innerHTML = (currentSelectedObservation.details||'').replace(/\\n/g, '<br>');
            const ra = currentSelectedObservation.riskAssessment || {priority:'Medium', timeframe:'72h'};
            document.getElementById('actionPlan').textContent = `ุงูุฃููููุฉ: ${ra.priority} | ุงูุฅุทุงุฑ ุงูุฒููู: ${ra.timeframe}. ุงูุฎุทุฉ: ${currentSelectedObservation.actionPlan || '-'}`;
            document.getElementById('actionPlanContainer').classList.remove('hidden');

            document.getElementById('mediaContainer').classList.add('hidden');
            document.getElementById('imageComparisonWrapper').classList.add('hidden');
            document.getElementById('noImageMessage').classList.add('hidden');
            document.getElementById('resolutionNoteContainer').classList.add('hidden');

            const mediaContent = document.getElementById('mediaContent');
            mediaContent.innerHTML = '';

            if (currentSelectedObservation.status === 'COMPLETED' && currentSelectedObservation.afterImagePath) {
                document.getElementById('imageComparisonWrapper').classList.remove('hidden');
                document.getElementById('beforeImage').src = currentSelectedObservation.imagePath;
                document.getElementById('afterImage').src = currentSelectedObservation.afterImagePath;
                setupImageComparison();
                document.getElementById('resolutionNote').textContent = currentSelectedObservation.resolutionNote || "ูู ูุชู ุชูููุฑ ูุฐูุฑุฉ ุฅุบูุงู ุชูุตูููุฉ.";
                document.getElementById('resolutionNoteContainer').classList.remove('hidden');
            } else if (currentSelectedObservation.hasImage) {
                document.getElementById('mediaContainer').classList.remove('hidden');
                if (currentSelectedObservation.isVideo) {
                    const mimeType = currentSelectedObservation.fileMimeType || 'video/mp4';
                    mediaContent.innerHTML = `
                        <video controls class="w-full h-auto rounded-xl shadow-lg border-4 border-gray-300">
                            <source src="${currentSelectedObservation.imagePath}" type="${mimeType}">
                            ูุชุตูุญู ูุง ูุฏุนู ุนุฑุถ ุงูููุฏูู ุงููุถูู.
                        </video>
                         <p class="image-label">ููุฏูู ุงูููุงุญุธุฉ - (${mimeType})</p>
                    `;
                } else {
                    mediaContent.innerHTML = `<img class="w-full h-auto rounded-xl shadow-lg" alt="ุตูุฑุฉ ุงูููุงุญุธุฉ" src="${currentSelectedObservation.imagePath}">`;
                }
            } else {
                document.getElementById('noImageMessage').classList.remove('hidden');
            }

            const isCompleted = currentSelectedObservation.status === 'COMPLETED';
            document.getElementById('updateStatusBtn').classList.toggle('hidden', isCompleted);
            document.getElementById('completeObservationBtn').classList.toggle('hidden', isCompleted);
            document.getElementById('alreadyCompletedBtn').classList.toggle('hidden', !isCompleted);

            document.getElementById('detailPlaceholder').classList.add('hidden');
            document.getElementById('observationDetail').classList.remove('hidden');
            document.getElementById('aiResultContainer').classList.add('hidden');
        }

        function openModal(id) {
            document.getElementById(id).style.display = "flex";
            if (id === 'closeoutModal') {
                if (currentSelectedObservation) document.getElementById('closeoutId').textContent = currentSelectedObservation.id;
                clearAfterUpload();
            }
            if (id === 'smartInputModal') {
                document.getElementById('rawObservationInput').value = '';
                document.getElementById('locationStatus').innerText = 'ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ';
                document.getElementById('fileStatus').innerText = 'ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ';
                document.getElementById('inputLatitude').value = '';
                document.getElementById('inputLongitude').value = '';
                currentFile = null; currentFileUrl = null;
                document.getElementById('fileUploadInput').value = '';
                document.getElementById('processSmartInputBtn').disabled = true;
                document.getElementById('getLocationBtn').disabled = false;
                document.getElementById('modalResult').classList.add('hidden');
                document.getElementById('modalStep1').classList.remove('hidden');
            }
        }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        function clearAfterUpload() {
            currentAfterFile = null;
            currentAfterFileUrl = null;
            document.getElementById('afterFileUploadInput').value = '';
            document.getElementById('afterFileStatus').innerHTML = 'ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ <span class="text-red-500 font-bold">(ุฅูุฒุงูู)</span>';
            document.getElementById('resolutionNoteInput').value = '';
            document.getElementById('finalCloseoutBtn').disabled = true;
        }

        function handleAfterFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentAfterFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentAfterFileUrl = e.target.result;
                    document.getElementById('finalCloseoutBtn').disabled = false;
                };
                reader.readAsDataURL(file);
                document.getElementById('afterFileStatus').innerHTML = `<span class="text-green-600">ุชู ุงุฎุชูุงุฑ ุงูููู:</span> ${file.name}`;
            } else {
                currentAfterFile = null;
                currentAfterFileUrl = null;
                document.getElementById('afterFileStatus').innerHTML = 'ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ <span class="text-red-500 font-bold">(ุฅูุฒุงูู)</span>';
                document.getElementById('finalCloseoutBtn').disabled = true;
            }
        }

        function completeObservation() {
            if (!currentAfterFile) {
                alert("ุงูุฑุฌุงุก ุชุญููู ุตูุฑุฉ 'ุจุนุฏ ุงูุฅุตูุงุญ' ูุฅุชูุงู ุงูุฅุบูุงู.");
                return;
            }
            const note = document.getElementById('resolutionNoteInput').value.trim() || `ุชู ุงูุฅุบูุงู ุงูุชูููุฐู ูู ${new Date().toLocaleString('ar-SA')} ูุชูุซููู ุจุงูุตูุฑุฉ ุงููุฑููุฉ.`;
            if (window.SmartHSR && currentSelectedObservation) {
                SmartHSR.completeObservation(currentSelectedObservation.id, currentAfterFile, note)
                  .then(()=>{
                    closeModal('closeoutModal'); clearAfterUpload();
                    alert(`ุชู ุฅุบูุงู ุงูููุงุญุธุฉ ุฑูู ${currentSelectedObservation.id} ูุชูุซูููุง ุจุงูุตูุฑุฉ ุงูููุงุฆูุฉ.`);
                  })
                  .catch(e=>{
                    console.error(e); alert('ุชุนุฐุฑ ุงูุฅุบูุงู โ ุชุญูู ูู ุงูุตูุงุญูุงุช/ุงูููุงุนุฏ.');
                  });
            } else {
                alert('ูู ูุชู ุชููุฆุฉ Firebase ุจุนุฏ.');
            }
        }

        function generatePdfReport() { window.print(); }

        function handleFilterChange() {
            const filterValue = document.getElementById('observationFilter').value;
            let filteredList = observationsData;

            if (filterValue !== 'ุงููู') {
                const filterKey = {
                    "ุฌุฏูุฏ": "PENDING",
                    "ููุฏ ุงูุชูููุฐ": "IN_PROGRESS",
                    "ุชูุช ุงููุนุงูุฌุฉ": "COMPLETED",
                    "ุฌูุฏุฉ": "QUALITY",
                    "ุตูุงูุฉ": "MAINTENANCE",
                    "ุณูุงูุฉ": "SAFETY",
                    "ุจูุฆุฉ": "ENVIRONMENT"
                }[filterValue] || filterValue;

                filteredList = observationsData.filter(obs => obs.type === filterKey || obs.status === filterKey);
            }

            renderObservationsList(filteredList);

            if (filteredList.length > 0) {
                showObservationDetail(filteredList[0].id);
            } else {
                document.getElementById('detailPlaceholder').classList.remove('hidden');
                document.getElementById('observationDetail').classList.add('hidden');
            }
        }

        function setupImageComparison() {
            const wrapper = document.getElementById('imageComparisonWrapper');
            const divider = document.getElementById('comparisonDivider');
            const afterImageContainer = document.getElementById('afterImageContainer');
            if (!wrapper) return;
            afterImageContainer.style.width = '50%';
            divider.style.left = '50%';
            let isDragging = false;

            const onMove = (clientX) => {
                if (!isDragging) return;
                const wrapperRect = wrapper.getBoundingClientRect();
                let newLeft = clientX - wrapperRect.left;
                newLeft = Math.max(0, Math.min(newLeft, wrapperRect.width));
                divider.style.left = `${newLeft}px`;
                afterImageContainer.style.width = `${newLeft}px`;
            };

            const onMouseMove = (e) => onMove(e.clientX);
            const onTouchMove = (e) => onMove(e.touches[0].clientX);

            const onMouseUp = () => {
                isDragging = false;
                wrapper.classList.remove('dragging');
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('touchmove', onTouchMove);
                window.removeEventListener('mouseup', onMouseUp);
                window.removeEventListener('touchend', onMouseUp);
            };

            const onMouseDown = (e) => {
                e.preventDefault();
                isDragging = true;
                wrapper.classList.add('dragging');
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                onMove(clientX);
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('touchmove', onTouchMove);
                window.addEventListener('mouseup', onMouseUp);
                window.addEventListener('touchend', onMouseUp);
            };
            const onTouchStart = (e) => onMouseDown(e);
            divider.addEventListener('mousedown', onMouseDown);
            divider.addEventListener('touchstart', onTouchStart);
            wrapper.addEventListener('mousedown', onMouseDown);
            wrapper.addEventListener('touchstart', onTouchStart);
        }

        function getLocation() {
            document.getElementById('locationStatus').innerHTML = '<span class="text-yellow-600">ุฌุงุฑู ุงูุจุญุซ...</span>';
            document.getElementById('getLocationBtn').disabled = true;
            navigator.geolocation?.getCurrentPosition((pos)=>{
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                document.getElementById('inputLatitude').value = lat;
                document.getElementById('inputLongitude').value = lon;
                document.getElementById('locationStatus').innerHTML = `<span class="text-green-600">ุชู ุงูุชุญุฏูุฏ:</span> ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                document.getElementById('getLocationBtn').disabled = false;
                checkSmartInputState();
            }, ()=>{
                setTimeout(()=>{
                    const lat = 24.5247; const lon = 46.7135;
                    document.getElementById('inputLatitude').value = lat;
                    document.getElementById('inputLongitude').value = lon;
                    document.getElementById('locationStatus').innerHTML = `<span class="text-green-600">ุชู ุงูุชุญุฏูุฏ:</span> ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    document.getElementById('getLocationBtn').disabled = false;
                    checkSmartInputState();
                },1500);
            });
        }
        function checkSmartInputState() {
            const rawText = document.getElementById('rawObservationInput').value.trim();
            const lat = document.getElementById('inputLatitude').value;
            if (rawText.length > 0 || currentFile || lat) {
                document.getElementById('processSmartInputBtn').disabled = false;
            } else {
                document.getElementById('processSmartInputBtn').disabled = true;
            }
        }
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                const reader = new FileReader();
                reader.onload = function (e) { currentFileUrl = e.target.result; checkSmartInputState(); };
                reader.readAsDataURL(file);
                document.getElementById('fileStatus').innerText = `ุชู ุงุฎุชูุงุฑ ุงูููู: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            } else {
                currentFile = null; currentFileUrl = null;
                document.getElementById('fileStatus').innerText = 'ูู ูุชู ุงุฎุชูุงุฑ ููู ุจุนุฏ';
                checkSmartInputState();
            }
        }

        function processSmartInput() {
            const rawText = document.getElementById('rawObservationInput').value.trim();
            const lat = document.getElementById('inputLatitude').value || "";
            const lon = document.getElementById('inputLongitude').value || "";
            if (!rawText && !currentFile) { alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ุฃู ุชุญููู ููู (ุตูุฑุฉ/ููุฏูู)."); return; }

            document.getElementById('modalStep1').classList.add('hidden');
            document.getElementById('modalResult').classList.remove('hidden');
            document.getElementById('modalResultContent').innerHTML = `
                <div class="text-center py-10">
                    <div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24, 165, 162, 0.3); margin: 0 auto; width: 40px; height: 40px;"></div>
                    <p class="mt-4 text-xl font-extrabold text-teal-700">ุฌุงุฑู ุงูุญูุธ ูุงูุชุญููู...</p>
                </div>`;

            if (window.SmartHSR) {
                SmartHSR.addObservation({
                    type: "MAINTENANCE",
                    title: rawText.substring(0, 50) || "ููุงุญุธุฉ ููุฏุงููุฉ",
                    details: rawText,
                    priority: "High",
                    lat: lat ? Number(lat) : undefined,
                    lng: lon ? Number(lon) : undefined,
                    file: currentFile || undefined
                }).then(()=>{
                    document.getElementById('modalResultContent').innerHTML = `
                        <div class="p-6 bg-green-50 rounded-xl border-4 border-green-200 text-center">
                            <i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-600 mb-3"></i>
                            <h4 class="text-2xl font-extrabold text-green-700">ุชูุช ุฅุถุงูุฉ ุงูููุงุญุธุฉ ุจูุฌุงุญ!</h4>
                            <p class="text-lg text-gray-700 mt-2">ุณุชุธูุฑ ูู ุงููุงุฆูุฉ ุชููุงุฆููุง.</p>
                        </div>`;
                    lucide.createIcons();
                }).catch(e=>{
                    console.error(e);
                    document.getElementById('modalResultContent').innerHTML = `<div class="p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-700">ุชุนุฐุฑ ุงูุญูุธ โ ุชุญูู ูู ููุงุนุฏ Firestore/ุงูุชุฎุฒูู.</div>`;
                });
            } else {
                document.getElementById('modalResultContent').innerHTML = `<div class="p-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl text-yellow-800">Firebase ุบูุฑ ููููุฃ.</div>`;
            }
        }

        function analyzeImage(tool) {
            const title = {'vision': 'ุชุญููู ุงูุฑุคูุฉ (Vision)', 'root-cause': 'ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู'}[tool] || 'ุงูุชุญููู';
            document.getElementById('aiResultTitle').textContent = `ุฌุงุฑู ุชูููุฐ ${title}...`;
            document.getElementById('aiResultContent').innerHTML = `<div class="flex items-center text-teal-700 font-bold"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24, 165, 162, 0.3); margin-left: 8px;"></div> ูุฑุฌู ุงูุงูุชุธุงุฑ</div>`;
            document.getElementById('aiResultContainer').classList.remove('hidden');
            setTimeout(()=>{
                document.getElementById('aiResultTitle').textContent = `ูุชุงุฆุฌ ${title} ููุชููุฉ:`;
                document.getElementById('aiResultContent').innerHTML = `<div class="text-gray-600">ุณูุชู ุฅุธูุงุฑ ูุชูุฌุฉ Gemini ุงููุญููุธุฉ ุจูุฌุฑุฏ ุงูุชุญููู.</div>`;
            },1000);
        }

        function generateCommunicationDraft() {
            document.getElementById('aiResultTitle').textContent = 'ุตูุงุบุฉ ุฃูุฑ ุงูุนูู ุงูุขูู...';
            document.getElementById('aiResultContent').innerHTML = `<div class="flex items-center text-teal-700 font-bold"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24, 165, 162, 0.3); margin-left: 8px;"></div> ูุฑุฌู ุงูุงูุชุธุงุฑ</div>`;
            document.getElementById('aiResultContainer').classList.remove('hidden');
            setTimeout(() => {
                const o = currentSelectedObservation || { id:'โ', title:'โ', riskAssessment:{priority:'-', timeframe:'-'} };
                document.getElementById('aiResultTitle').textContent = 'ุตูุงุบุฉ ุฃูุฑ ุงูุนูู ุงูุขูู (ููุชููุฉ):';
                document.getElementById('aiResultContent').innerHTML = `
                    <div class="communication-draft p-4 border rounded-lg">
                        <p class="font-bold text-lg mb-2 text-red-800">ุฃูุฑ ุนูู ุนุงุฌู: ูุนุงูุฌุฉ ${o.title} [ID: ${o.id}]</p>
                        <p class="mt-3 font-bold text-sm text-red-600">ุงูุฃููููุฉ: ${o.riskAssessment.priority} | ุงูุฅุทุงุฑ ุงูุฒููู ุงููุณุชูุฏู: ${o.riskAssessment.timeframe}</p>
                    </div>`;
            }, 1200);
        }

        function smartLogout() {
            const button = document.getElementById('logout-btn');
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner" style="border-top: 4px solid var(--color-teal);"></div> ุฌุงุฑู ุชุณุฌูู ุงูุฎุฑูุฌ...';
            button.classList.add('flex-row-reverse', 'justify-center');
            button.style.backgroundColor = 'gray';
            setTimeout(() => { window.location.href = "login.html"; }, 800);
        }

        function initApp() {
            lucide.createIcons();
        }
        window.onload = initApp;
    </script>

<!-- Firebase Patch (v12.4.0) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp, query, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCRrBnPYtdc86JffEQHERf732uAif7vwho",
    authDomain: "smart-hsr-6c2cf.firebaseapp.com",
    databaseURL: "https://smart-hsr-6c2cf-default-rtdb.firebaseio.com",
    projectId: "smart-hsr-6c2cf",
    storageBucket: "smart-hsr-6c2cf.firebasestorage.app",
    messagingSenderId: "399213527987",
    appId: "1:399213527987:web:4531958edfe9dbb95a81c6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  setPersistence(auth, browserLocalPersistence).catch(()=>{});

  onAuthStateChanged(auth, (user) => {
    // ุฅู ุฃุฑุฏุช ุญูุงูุฉ ุงูุตูุญุฉุ ุฃุนุฏ ุงูุชูุฌูู ูุตูุญุฉ login.html ุนูุฏ ุนุฏู ูุฌูุฏ ูุณุชุฎุฏู
    // const here = (location.pathname || '').toLowerCase();
    // if (!user && !here.endsWith('login.html')) { window.location.href = 'login.html'; }
  });

  window.SmartHSR = {
    auth, db, storage,
    emailSignup: (email,pass)=>createUserWithEmailAndPassword(auth,email,pass).then(c=>c.user),
    emailLogin: (email,pass)=>signInWithEmailAndPassword(auth,email,pass).then(c=>c.user),
    logout: ()=>signOut(auth),
    onAuth: (fn)=>onAuthStateChanged(auth, fn),

    observeObservations(cb){
      const qy = query(collection(db,'observations'), orderBy('createdAt','desc'));
      return onSnapshot(qy, s=>cb(s.docs.map(d=>({id:d.id, ...d.data()}))));
    },

    async addObservation({type,title,details,priority,lat,lng,file}={}){
      const isVideo = file ? (file.type||'').startsWith('video') : false;
      const mediaMime = file ? file.type : null;
      const refDoc = await addDoc(collection(db,'observations'), {
        type: type||'QUALITY',
        title: title||'โ',
        details: details||'',
        status: 'PENDING',
        location: (lat!=null && lng!=null) ? `${(+lat).toFixed(5)}, ${(+lng).toFixed(5)}` : '',
        actionPlan: null,
        riskAssessment: { priority: (priority||'Medium'), timeframe: (priority==='High'?'24h':'72h') },
        hasImage: !!file, isVideo, mediaUrl: null, mediaMime,
        afterImageUrl: null, resolutionNote: null,
        createdAt: serverTimestamp()
      });
      if(file){
        const p = `observations/${refDoc.id}/${isVideo?'before.mp4':'before.jpg'}`;
        const r = ref(storage, p);
        await uploadBytesResumable(r, file);
        const url = await getDownloadURL(r);
        await updateDoc(doc(db,'observations',refDoc.id), { mediaUrl: url });
      }
      return refDoc.id;
    },

    updateStatus: (id,status)=>updateDoc(doc(db,'observations',id), { status }),

    async completeObservation(id, afterFile, note){
      if(afterFile){
        const p = `observations/${id}/after.jpg`;
        const r = ref(storage, p);
        await uploadBytes(r, afterFile);
        const url = await getDownloadURL(r);
        await updateDoc(doc(db,'observations',id), {
          status:'COMPLETED',
          afterImageUrl:url,
          resolutionNote: (note || `ุชู ุงูุฅุบูุงู ูู ${new Date().toLocaleString('ar-SA')}`)
        });
      } else {
        await updateDoc(doc(db,'observations',id), {
          status:'COMPLETED',
          resolutionNote: (note || `ุชู ุงูุฅุบูุงู ูู ${new Date().toLocaleString('ar-SA')}`)
        });
      }
    },

    async getKpis(){
      const s = await getDocs(query(collection(db,'observations')));
      const arr = s.docs.map(d=>({id:d.id, ...d.data()}));
      const total = arr.length;
      const open = arr.filter(x=>x.status!=='COMPLETED').length;
      const closed = total - open;
      const withImg = arr.filter(x=>x.mediaUrl).length;
      return { total, open, closed, withImg };
    },

    async analyzeNow(id){
      const dref = doc(db, 'observations', id);
      const snap = await getDoc(dref);
      if(!snap.exists()) return false;
      const data = snap.data();
      if(!data?.mediaUrl) return false;
      try{
        const ai = await window.__geminiAnalyzeImage({
          mediaUrl: data.mediaUrl, mediaMime: data.mediaMime, title: data.title, details: data.details
        });
        await updateDoc(dref, {
          ai: {
            summary: ai.summary || null,
            category: ai.category || null,
            severity: ai.severity || null,
            action: ai.action || null,
            confidence: ai.confidence ?? null,
            analyzedAt: serverTimestamp()
          }
        });
        return true;
      }catch{ return false; }
    }
  };

  // Live bind to UI
  SmartHSR.observeObservations(async (rows)=>{
      const mapped = rows.map(r=>{
        let ts = Date.now();
        try {
          if (r.createdAt?.toMillis) ts = r.createdAt.toMillis();
          else if (r.createdAt?.seconds) ts = r.createdAt.seconds*1000;
        } catch {}
        const dateStr = new Date(ts).toISOString().slice(0,10);
        return {
          id: r.id,
          type: r.type || 'QUALITY',
          date: dateStr,
          title: r.title || 'โ',
          status: r.status || 'PENDING',
          details: r.details || '',
          hasImage: !!r.mediaUrl,
          isComparative: !!r.afterImageUrl,
          location: r.location || '',
          isVideo: !!r.isVideo,
          imagePath: r.mediaUrl || '',
          fileMimeType: r.mediaMime || '',
          actionPlan: r.actionPlan || '',
          riskAssessment: r.riskAssessment || { priority: 'Medium', timeframe: '72h' },
          resolutionNote: r.resolutionNote || null,
          afterImagePath: r.afterImageUrl || null,
          createdAt: ts,
          ai: r.ai || null
        };
      });
      const selId = (window.currentSelectedObservation && window.currentSelectedObservation.id) || null;
      // ุฅุตูุงุญ ุงูุฎุทุฃ: ูุง ูุณุชุฎุฏู *mapped
      window.observationsData.length = 0;
      window.observationsData.push(...mapped);
      // ุฅุนุงุฏุฉ ุงูุนุฑุถ
      window.handleFilterChange();
      if (selId && window.observationsData.find(o=>o.id===selId)) {
        window.showObservationDetail(selId);
      }
      try {
        const el = document.getElementById('userInfo');
        if (el) el.textContent = 'ุจูุงูุงุช ูุจุงุดุฑุฉ ูู Firestore โ';
      } catch {}
      // KPIs
      try { renderKPIs(); } catch {}
  });

  // ุญุฐู ููุงุญุธุฉ + ุตูุฑูุง
  window.deleteObservation = async function(id){
    try{
      if(!id){ alert("ูู ูุชู ุชูุฑูุฑ ุฑูู ุงูููุงุญุธุฉ"); return; }
      const ok = confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงูููุงุญุธุฉ ูุตูุฑูุงุ");
      if(!ok) return;
      await updateDoc(doc(SmartHSR.db, 'observations', id), {deletedAt: serverTimestamp()}).catch(()=>{});
      await deleteObject(ref(SmartHSR.storage, `observations/${id}/before.jpg`)).catch(()=>{});
      await deleteObject(ref(SmartHSR.storage, `observations/${id}/after.jpg`)).catch(()=>{});
      alert("ุชู ุงูุญุฐู โ");
    }catch(e){
      console.error("Delete failed:", e);
      alert("ุชุนุฐุฑ ุงูุญุฐู. ุชุญูู ูู Console.");
    }
  }
</script>

<!-- Gemini Vision (uses your API key) -->
<script type="module">
  const GEMINI_API_KEY = "AIzaSyCstRnAY_9TO9f4l49TTHEjVaoqjtZriJk"; // ููุชุงุญ ุงููุณุชุฎุฏู
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const safeLog = (...a) => { try { console.log("[SmartHSR-AI]", ...a); } catch {} };
  const safeErr = (...a) => { try { console.error("[SmartHSR-AI]", ...a); } catch {} };

  async function urlToBase64(url){
    const resp = await fetch(url);
    const blob = await resp.blob();
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onloadend = ()=>resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  function extractAI(text){
    const out = { summary: (text||'').trim() };
    const lc = (text||'').toLowerCase();
    if(lc.includes('ุญูุฑ') || lc.includes('ูุจูุท') || lc.includes('asphalt') || lc.includes('pothole')) out.category = 'PAVEMENT';
    if(lc.includes('ุฅูุงุฑุฉ') || lc.includes('light')) out.category = (out.category ? out.category + '+LIGHT' : 'LIGHT');
    if(lc.includes('ููุงูุงุช') || lc.includes('waste')) out.category = (out.category ? out.category + '+WASTE' : 'WASTE');
    if(lc.includes('ุนุงูู') || lc.includes('high')) out.severity = 'HIGH';
    else if(lc.includes('ูุชูุณุท') || lc.includes('medium')) out.severity = 'MEDIUM';
    else out.severity = 'LOW';
    out.confidence = lc.length > 50 ? 0.8 : 0.6;
    const m = (text||'').match(/(?:ููุจุบู|ูููุตุญ|ุงูุชูุตูุฉ|ุงููุนุงูุฌุฉ|fix|repair|inspect|clean).{0,140}/i);
    if(m) out.action = m[0];
    return out;
  }

  async function geminiAnalyzeImage({mediaUrl, mediaMime, title, details}){
    if(!GEMINI_API_KEY){
      return { summary:"ุชุญููู (ูุญุงูุงุฉ)", category:"MAINTENANCE", severity:"MEDIUM", action:"ูุญุต ุฎูุงู 48 ุณุงุนุฉ.", confidence:0.7 };
    }
    try{
      const base64 = await urlToBase64(mediaUrl);
      const prompt = `ุญููู ุงูุตูุฑุฉ ุงูุชุงููุฉ ูููุงุญุธุฉ ููุฏุงููุฉ ูู ูุดุฑูุน ุทุฑู (Smart HSR).
      ุฃุนุทูู ูุตููุง ูุฎุชุตุฑูุงุ ุชุตููููุง ูููุดููุฉุ ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ (LOW/MEDIUM/HIGH)ุ
      ูุชูุตูุฉ ุนูููุฉ ูุตูุฑุฉ ูุงุจูุฉ ููุชูููุฐ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.`;

      const body = {
        contents: [{
          parts: [
            { text: prompt + `\nุงูุนููุงู: ${title||'-'}\nุงููุตู: ${details||'-'}` },
            { inline_data: { mime_type: mediaMime || 'image/jpeg', data: base64 } }
          ]
        }]
      };
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const json = await res.json();
      const text = json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n') || 'ูู ุชูุนุฏ ุงูููุงุฐุฌ ูุชูุฌุฉ.';
      return extractAI(text);
    }catch(err){
      safeErr("Gemini call failed:", err);
      return { summary: "ุชุนุฐูุฑ ุฅุชูุงู ุงูุชุญููู", severity:"LOW", confidence:0.0 };
    }
  }

  window.__geminiAnalyzeImage = geminiAnalyzeImage;

  // ุฒุฑ "ุชุญููู" ููุฑุฃ ูู ุงูุญูู ai ููุทูู ุงูุชุญููู ุนูุฏ ุนุฏู ูุฌูุฏู
  window.analyzeImage = async function(tool){
    const titleMap = {'vision':'ุชุญููู ุงูุฑุคูุฉ (Vision)', 'root-cause':'ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู'};
    const obs = window.currentSelectedObservation;
    const titleEl = document.getElementById('aiResultTitle');
    const box = document.getElementById('aiResultContainer');
    const content = document.getElementById('aiResultContent');
    titleEl.textContent = `ูุชุงุฆุฌ ${titleMap[tool]||'ุงูุชุญููู'}:`;
    box.classList.remove('hidden');

    if (tool === 'vision') {
      if (obs?.ai) {
        const conf = (obs.ai.confidence!=null) ? Math.round(obs.ai.confidence*100)+'%' : '-';
        content.innerHTML = `
          <div class="communication-draft">
            <b>ููุฎุต:</b> ${obs.ai.summary||'-'}<br>
            <b>ุชุตููู:</b> ${obs.ai.category||'-'}<br>
            <b>ุงูุฎุทูุฑุฉ:</b> ${obs.ai.severity||'-'} โข <b>ุงูุซูุฉ:</b> ${conf}<br>
            <b>ุชูุตูุฉ:</b> ${obs.ai.action||'-'}
          </div>`;
      } else if (obs?.imagePath) {
        content.innerHTML = `<div class="text-gray-600">ุฌุงุฑู ุทูุจ ุงูุชุญููู ููุตูุฑุฉ ุงููุนููุฉโฆ ุฃุนุฏ ุงูููุฑ ุจุนุฏ ุซูุงูู.</div>`;
        try { await SmartHSR.analyzeNow(obs.id); } catch(e){ console.error(e); }
      } else {
        content.innerHTML = `<div class="text-gray-600">ูุง ุชูุฌุฏ ุตูุฑุฉ ูุฑุชุจุทุฉ ุจูุฐู ุงูููุงุญุธุฉ.</div>`;
      }
    } else {
      content.innerHTML = `<div class="text-gray-600">ุณูุชู ุงุดุชูุงู ุงูุณุจุจ ุงูุฌุฐุฑู ูู ููุฎุต AI.</div>`;
    }
  };
</script>
</body>
</html>
